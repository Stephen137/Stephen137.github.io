<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Stephen Barrie">
<meta name="dcterms.date" content="2022-12-23">

<title>Into the Unknown - Walk with fastai</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Into the Unknown</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">Stephen Barrie</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"><i class="bi bi-rss" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Stephen137"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://linkedin.com/in/sjbarrie"><i class="bi bi-linkedin" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Walk with fastai</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">fastai</div>
                <div class="quarto-category">Vision</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Stephen Barrie </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 23, 2022</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#lesson-1" id="toc-lesson-1" class="nav-link active" data-scroll-target="#lesson-1">Lesson 1</a>
  <ul class="collapse">
  <li><a href="#classifying-cats-and-dogs" id="toc-classifying-cats-and-dogs" class="nav-link" data-scroll-target="#classifying-cats-and-dogs">1.1 Classifying Cats and Dogs</a>
  <ul class="collapse">
  <li><a href="#what-is-our-goal-today" id="toc-what-is-our-goal-today" class="nav-link" data-scroll-target="#what-is-our-goal-today">What is our goal today?</a></li>
  <li><a href="#lets-grab-the-library" id="toc-lets-grab-the-library" class="nav-link" data-scroll-target="#lets-grab-the-library">Let’s grab the library:</a></li>
  <li><a href="#general-deep-learning-pipeline" id="toc-general-deep-learning-pipeline" class="nav-link" data-scroll-target="#general-deep-learning-pipeline">General Deep Learning Pipeline:</a></li>
  <li><a href="#looking-at-data" id="toc-looking-at-data" class="nav-link" data-scroll-target="#looking-at-data">Looking at Data</a></li>
  </ul></li>
  <li><a href="#what-is-the-fastai-application-programming-interface-api" id="toc-what-is-the-fastai-application-programming-interface-api" class="nav-link" data-scroll-target="#what-is-the-fastai-application-programming-interface-api">1.2 What is the fastai Application Programming Interface (API)?</a>
  <ul class="collapse">
  <li><a href="#vision" id="toc-vision" class="nav-link" data-scroll-target="#vision">Vision</a></li>
  <li><a href="#tabular" id="toc-tabular" class="nav-link" data-scroll-target="#tabular">Tabular</a></li>
  <li><a href="#text" id="toc-text" class="nav-link" data-scroll-target="#text">Text</a></li>
  <li><a href="#what-are-our-options" id="toc-what-are-our-options" class="nav-link" data-scroll-target="#what-are-our-options">What are our options?</a></li>
  <li><a href="#building-some-dataloaders" id="toc-building-some-dataloaders" class="nav-link" data-scroll-target="#building-some-dataloaders">Building some DataLoaders</a></li>
  <li><a href="#back-to-dataloaders" id="toc-back-to-dataloaders" class="nav-link" data-scroll-target="#back-to-dataloaders">Back to DataLoaders</a></li>
  <li><a href="#time-to-make-and-train-a-model" id="toc-time-to-make-and-train-a-model" class="nav-link" data-scroll-target="#time-to-make-and-train-a-model">Time to make and train a model!</a></li>
  <li><a href="#analyzing-how-the-model-performed" id="toc-analyzing-how-the-model-performed" class="nav-link" data-scroll-target="#analyzing-how-the-model-performed">Analyzing how the model performed</a></li>
  <li><a href="#unfreezing-our-data-fine-tuning-and-our-learning-rates" id="toc-unfreezing-our-data-fine-tuning-and-our-learning-rates" class="nav-link" data-scroll-target="#unfreezing-our-data-fine-tuning-and-our-learning-rates">Unfreezing our data, fine-tuning, and our learning rates</a></li>
  </ul></li>
  <li><a href="#custom-datasets-with-kaggle" id="toc-custom-datasets-with-kaggle" class="nav-link" data-scroll-target="#custom-datasets-with-kaggle">1.3 Custom Datasets with Kaggle</a>
  <ul class="collapse">
  <li><a href="#lets-download-the-dataset" id="toc-lets-download-the-dataset" class="nav-link" data-scroll-target="#lets-download-the-dataset">Let’s download the dataset</a></li>
  <li><a href="#exploring-the-dataset" id="toc-exploring-the-dataset" class="nav-link" data-scroll-target="#exploring-the-dataset">Exploring the dataset</a></li>
  <li><a href="#images" id="toc-images" class="nav-link" data-scroll-target="#images">Images</a></li>
  <li><a href="#dataframe" id="toc-dataframe" class="nav-link" data-scroll-target="#dataframe">DataFrame</a></li>
  <li><a href="#can-we-do-fastai-already" id="toc-can-we-do-fastai-already" class="nav-link" data-scroll-target="#can-we-do-fastai-already">Can we do fastai already?</a></li>
  <li><a href="#creating-a-learner-and-fine-tuning" id="toc-creating-a-learner-and-fine-tuning" class="nav-link" data-scroll-target="#creating-a-learner-and-fine-tuning">Creating a Learner and fine-tuning</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#lesson-2" id="toc-lesson-2" class="nav-link" data-scroll-target="#lesson-2">Lesson 2</a>
  <ul class="collapse">
  <li><a href="#low-level-api-with-mnist" id="toc-low-level-api-with-mnist" class="nav-link" data-scroll-target="#low-level-api-with-mnist">2.1 Low-Level API with MNIST</a>
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#working-with-the-data" id="toc-working-with-the-data" class="nav-link" data-scroll-target="#working-with-the-data">Working with the data</a></li>
  <li><a href="#building-a-model-and-training" id="toc-building-a-model-and-training" class="nav-link" data-scroll-target="#building-a-model-and-training">Building a Model and Training!</a></li>
  </ul></li>
  <li><a href="#using-raw-pytorch" id="toc-using-raw-pytorch" class="nav-link" data-scroll-target="#using-raw-pytorch">2.2 Using Raw PyTorch</a>
  <ul class="collapse">
  <li><a href="#introduction-1" id="toc-introduction-1" class="nav-link" data-scroll-target="#introduction-1">Introduction</a></li>
  <li><a href="#removing-the-data-api" id="toc-removing-the-data-api" class="nav-link" data-scroll-target="#removing-the-data-api">Removing the Data API</a></li>
  <li><a href="#defining-our-transforms" id="toc-defining-our-transforms" class="nav-link" data-scroll-target="#defining-our-transforms">Defining our Transforms</a></li>
  <li><a href="#make-a-pytorch-dataset" id="toc-make-a-pytorch-dataset" class="nav-link" data-scroll-target="#make-a-pytorch-dataset">Make a PyTorch Dataset</a></li>
  <li><a href="#prepare-for-the-dataset" id="toc-prepare-for-the-dataset" class="nav-link" data-scroll-target="#prepare-for-the-dataset">Prepare for the Dataset</a></li>
  <li><a href="#labels-as-encoded-classes" id="toc-labels-as-encoded-classes" class="nav-link" data-scroll-target="#labels-as-encoded-classes">Labels as encoded classes</a></li>
  <li><a href="#splitting-the-dataset" id="toc-splitting-the-dataset" class="nav-link" data-scroll-target="#splitting-the-dataset">Splitting the dataset</a></li>
  <li><a href="#creating-our-datasets" id="toc-creating-our-datasets" class="nav-link" data-scroll-target="#creating-our-datasets">Creating our Datasets</a></li>
  <li><a href="#creating-pytorch-dataloaders" id="toc-creating-pytorch-dataloaders" class="nav-link" data-scroll-target="#creating-pytorch-dataloaders">Creating PyTorch Dataloaders</a></li>
  <li><a href="#creating-a-pytorch-model" id="toc-creating-a-pytorch-model" class="nav-link" data-scroll-target="#creating-a-pytorch-model">Creating a PyTorch Model</a></li>
  <li><a href="#gradual-unfreezing" id="toc-gradual-unfreezing" class="nav-link" data-scroll-target="#gradual-unfreezing">Gradual Unfreezing</a></li>
  <li><a href="#creating-an-optimizer" id="toc-creating-an-optimizer" class="nav-link" data-scroll-target="#creating-an-optimizer">Creating an Optimizer</a></li>
  <li><a href="#bringing-in-fastai-and-training" id="toc-bringing-in-fastai-and-training" class="nav-link" data-scroll-target="#bringing-in-fastai-and-training">Bringing in fastai and Training!</a></li>
  <li><a href="#getting-predictions" id="toc-getting-predictions" class="nav-link" data-scroll-target="#getting-predictions">Getting Predictions</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#lesson-3" id="toc-lesson-3" class="nav-link" data-scroll-target="#lesson-3">Lesson 3</a>
  <ul class="collapse">
  <li><a href="#multi-label-classification" id="toc-multi-label-classification" class="nav-link" data-scroll-target="#multi-label-classification">3.1 Multi-Label Classification</a>
  <ul class="collapse">
  <li><a href="#introduction-2" id="toc-introduction-2" class="nav-link" data-scroll-target="#introduction-2">Introduction</a></li>
  <li><a href="#exploring-the-data" id="toc-exploring-the-data" class="nav-link" data-scroll-target="#exploring-the-data">Exploring the data</a></li>
  <li><a href="#working-with-fastai-datasets" id="toc-working-with-fastai-datasets" class="nav-link" data-scroll-target="#working-with-fastai-datasets">Working with fastai Datasets</a></li>
  <li><a href="#building-some-dataloaders-1" id="toc-building-some-dataloaders-1" class="nav-link" data-scroll-target="#building-some-dataloaders-1">Building some DataLoaders</a></li>
  <li><a href="#training-a-model" id="toc-training-a-model" class="nav-link" data-scroll-target="#training-a-model">Training a Model</a></li>
  <li><a href="#predictions-in-the-wild" id="toc-predictions-in-the-wild" class="nav-link" data-scroll-target="#predictions-in-the-wild">Predictions in the wild</a></li>
  </ul></li>
  <li><a href="#recognizing-unknown-images-or-the-unknown-label-problem" id="toc-recognizing-unknown-images-or-the-unknown-label-problem" class="nav-link" data-scroll-target="#recognizing-unknown-images-or-the-unknown-label-problem">3.2 Recognizing Unknown Images, or the Unknown Label Problem</a>
  <ul class="collapse">
  <li><a href="#introduction-3" id="toc-introduction-3" class="nav-link" data-scroll-target="#introduction-3">Introduction</a></li>
  <li><a href="#fake-it-till-you-make-it-turn-single-label-to-multilabel" id="toc-fake-it-till-you-make-it-turn-single-label-to-multilabel" class="nav-link" data-scroll-target="#fake-it-till-you-make-it-turn-single-label-to-multilabel">Fake it till you make it, turn single label to multilabel</a></li>
  <li><a href="#train-the-model" id="toc-train-the-model" class="nav-link" data-scroll-target="#train-the-model">Train the model!</a></li>
  <li><a href="#model-evaluation" id="toc-model-evaluation" class="nav-link" data-scroll-target="#model-evaluation">Model Evaluation</a></li>
  </ul></li>
  <li><a href="#cross-validation-and-ensembling" id="toc-cross-validation-and-ensembling" class="nav-link" data-scroll-target="#cross-validation-and-ensembling">3.3 Cross Validation and Ensembling</a>
  <ul class="collapse">
  <li><a href="#what-is-cross-validation" id="toc-what-is-cross-validation" class="nav-link" data-scroll-target="#what-is-cross-validation">What is Cross Validation?</a></li>
  <li><a href="#lets-begin" id="toc-lets-begin" class="nav-link" data-scroll-target="#lets-begin">Let’s begin</a></li>
  <li><a href="#creating-the-splits" id="toc-creating-the-splits" class="nav-link" data-scroll-target="#creating-the-splits">Creating the splits</a></li>
  <li><a href="#the-training-loop" id="toc-the-training-loop" class="nav-link" data-scroll-target="#the-training-loop">The Training Loop</a></li>
  <li><a href="#performing-the-ensemble" id="toc-performing-the-ensemble" class="nav-link" data-scroll-target="#performing-the-ensemble">Performing the Ensemble</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#lesson-4" id="toc-lesson-4" class="nav-link" data-scroll-target="#lesson-4">Lesson 4</a>
  <ul class="collapse">
  <li><a href="#semantic-segmentation-and-the-unet" id="toc-semantic-segmentation-and-the-unet" class="nav-link" data-scroll-target="#semantic-segmentation-and-the-unet">4.1 Semantic Segmentation and the Unet</a>
  <ul class="collapse">
  <li><a href="#what-is-semantic-segmentation" id="toc-what-is-semantic-segmentation" class="nav-link" data-scroll-target="#what-is-semantic-segmentation">What is Semantic Segmentation?</a></li>
  <li><a href="#the-dataset" id="toc-the-dataset" class="nav-link" data-scroll-target="#the-dataset">The Dataset</a></li>
  <li><a href="#checking-the-labels" id="toc-checking-the-labels" class="nav-link" data-scroll-target="#checking-the-labels">Checking the Labels</a></li>
  <li><a href="#building-the-dataloaders" id="toc-building-the-dataloaders" class="nav-link" data-scroll-target="#building-the-dataloaders">Building the Dataloaders</a></li>
  <li><a href="#datablock" id="toc-datablock" class="nav-link" data-scroll-target="#datablock">DataBlock</a></li>
  <li><a href="#with-datasets" id="toc-with-datasets" class="nav-link" data-scroll-target="#with-datasets">With Datasets</a></li>
  <li><a href="#the-u-net" id="toc-the-u-net" class="nav-link" data-scroll-target="#the-u-net">The U-Net</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">




<section id="lesson-1" class="level1">
<h1>Lesson 1</h1>
<section id="classifying-cats-and-dogs" class="level2">
<h2 class="anchored" data-anchor-id="classifying-cats-and-dogs">1.1 Classifying Cats and Dogs</h2>
<section id="what-is-our-goal-today" class="level3">
<h3 class="anchored" data-anchor-id="what-is-our-goal-today">What is our goal today?</h3>
<ul>
<li>learn about the fastai framework through a vision application</li>
<li>create a neural network that can distinguish between 26 different breeds of animals</li>
<li>become familiar with the different sub-libraries of fastai</li>
</ul>
</section>
<section id="lets-grab-the-library" class="level3">
<h3 class="anchored" data-anchor-id="lets-grab-the-library">Let’s grab the library:</h3>
<p>The fastai library is segmented between</p>
<ul>
<li><em>vision</em></li>
<li><em>text</em></li>
<li><em>tabular</em></li>
<li><em>collab</em></li>
</ul>
<p>spanning across each of these applications.</p>
<p>While this course is only focused on the first, by the end of these 7 weeks this understanding will easily be able to propagate into the other 3 applications. Since this course will be on vision, we import the vision module:</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Author’s Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This import * is an <strong>extremely bad</strong> practice in modern Python programming. This shouldn’t be done in production, and each lecture will have all of the “exact” imports for everything used as a reference to both see what you should do and understand where everything comes from.</p>
</div>
</div>
</section>
<section id="general-deep-learning-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="general-deep-learning-pipeline">General Deep Learning Pipeline:</h3>
<p>flowchart TD A[Gather Data] –&gt; B[Clean Data] B –&gt; C[Build <code>DataLoaders</code>] C ==&gt; D[Build a <code>Learner</code>] D ==&gt; E[Train with modern best practices] E ==&gt; F[Deploy] F –&gt; A E ==&gt; C</p>
<p>We’ll be focusing on a small subset of this pipeline:</p>
<p>flowchart TD C[“Build DataLoaders”] ==&gt; D[“Build a Learner”] D ==&gt; E[“Train with modern best practices”] E ==&gt; F[“Deploy”] E ==&gt; C</p>
</section>
<section id="looking-at-data" class="level3">
<h3 class="anchored" data-anchor-id="looking-at-data">Looking at Data</h3>
<p>Since we’re focusing on only those 4 latter, this course will rely on other curated datasets for our analysis. For today’s problem we will attempt to identify between 12 species of cats and 25 species of dogs (37 in total). 7 years ago state-of-the-art was considered 59% error.</p>
<p>Today, this is now &lt; 10.</p>
<p>What we will try and do is build a world-class <strong>image classifier</strong> using the fastai API and achieve this in less than 10 minutes. First we need this dataset. <em>fastai</em> has a <em>data</em> class to do so, through something called <em>untar_data</em>. If we call <em>help</em> on <em>untar_data</em>, we can see it’s documentation description:</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="bu">help</span>(untar_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Help on function untar_data in module fastai.data.external:

untar_data(url: 'str', archive: 'Path' = None, data: 'Path' = None, c_key: 'str' = 'data', force_download: 'bool' = False, base: 'str' = '~/.fastai') -&gt; 'Path'
    Download `url` using `FastDownload.get`
</code></pre>
</div>
</div>
<p>The first thing you may notice is this doesn’t say much. To get a bit better of a description you can rely on a framework called <em><a href="https://nbdev.fast.ai/">nbdev</a></em> (what fastai is built upon), which enables their special documentation-writing schema to appear when asking for more information:</p>
<p>untar_data</p>
<p>untar_data (url:str, archive:pathlib.Path=None, data:pathlib.Path=None, c_key:str=‘data’, force_download:bool=False, base:str=‘~/.fastai’)</p>
<p>Download url using FastDownload.get</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Walkwithfastai_files/figure-html/d70c7cc8-f65f-4966-a4e6-790c6c4907a6.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">table_1.JPG</figcaption><p></p>
</figure>
</div>
<p>fastai has a few preset datasets stored in a set of URLs. For our problem this lives in PETS, which contains the Oxford Pets dataset. This dataset is designed around identifying cats and dogs by species. Let’s download the dataset:</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.PETS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And set our seed to ensure we have reproduceability:</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How is our data setup?</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>path.ls()[:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>(#2) [Path('/home/stephen137/.fastai/data/oxford-iiit-pet/annotations'),Path('/home/stephen137/.fastai/data/oxford-iiit-pet/images')]</code></pre>
</div>
</div>
<p>Seperated between <em>images</em> and <em>annotations</em></p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>(path<span class="op">/</span><span class="st">'images'</span>).ls()[:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>(#3) [Path('/home/stephen137/.fastai/data/oxford-iiit-pet/images/Birman_115.jpg'),Path('/home/stephen137/.fastai/data/oxford-iiit-pet/images/leonberger_142.jpg'),Path('/home/stephen137/.fastai/data/oxford-iiit-pet/images/Bombay_68.jpg')]</code></pre>
</div>
</div>
<p>Let’s build a <strong>DataLoaders</strong>. First we’ll need the <em>path</em> to our data, some filenames, and the regex pattern to extract our labels:</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.PETS)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>fnames <span class="op">=</span> get_image_files(path<span class="op">/</span><span class="st">'images'</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>pat <span class="op">=</span> <span class="vs">r'(.+)_\d+.jpg$'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some basic transforms for getting all of our images the same size <strong>(item_tfms)</strong>, and some augmentations and Normalization to be done on the GPU <strong>(batch_tfms)</strong></p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>item_tfms <span class="op">=</span> RandomResizedCrop(<span class="dv">460</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>, ratio<span class="op">=</span>(<span class="fl">1.</span>,<span class="fl">1.</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>batch_tfms <span class="op">=</span> [<span class="op">*</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, max_warp<span class="op">=</span><span class="dv">0</span>), Normalize.from_stats(<span class="op">*</span>imagenet_stats)]</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>bs<span class="op">=</span><span class="dv">64</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
This has to be done because images must be the same size before they can be pushed to the GPU and have these augmentations be applied.
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
</section>
</section>
<section id="what-is-the-fastai-application-programming-interface-api" class="level2">
<h2 class="anchored" data-anchor-id="what-is-the-fastai-application-programming-interface-api">1.2 What is the fastai Application Programming Interface (API)?</h2>
<p>Consists of three <a href="https://en.wikipedia.org/wiki/API">API</a> levels:</p>
<p><strong>DataLoaders</strong> - Highest level of the API, but not much flexibility</p>
<p><strong>DataBlock</strong> - medium level API (debateable) - medium flexibility - building blocks of the framework - what we will focus on</p>
<p><strong>Pipeline and Datasets</strong> - lowest Level - highest Flexibility - hardest to learn due to so much magic - consists of the “groundwork” for all the other wrappers</p>
<section id="vision" class="level3">
<h3 class="anchored" data-anchor-id="vision">Vision</h3>
<ul>
<li>PILBase</li>
<li>PILImage</li>
<li>PILImageBW</li>
<li>PILMask</li>
<li>TensorPoint</li>
<li>TensorBBox</li>
<li>LabelBBox</li>
<li>PointScaler</li>
<li>BBoxLabeler</li>
</ul>
</section>
<section id="tabular" class="level3">
<h3 class="anchored" data-anchor-id="tabular">Tabular</h3>
<ul>
<li>Tabular</li>
</ul>
</section>
<section id="text" class="level3">
<h3 class="anchored" data-anchor-id="text">Text</h3>
<ul>
<li>TensorText</li>
<li>LMTensorText</li>
<li>Tokenizer</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Walkwithfastai_files/figure-html/048810d4-e7b2-4187-bc8d-252c64ec8ffd.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">intertwine.JPG</figcaption><p></p>
</figure>
</div>
</section>
<section id="what-are-our-options" class="level3">
<h3 class="anchored" data-anchor-id="what-are-our-options">What are our options?</h3>
<p><strong>Getters and number of inputs</strong> - get_x - get_y - get_items - n_inp</p>
<p><strong>Splitting the data</strong> - ColSplitter - EndSplitter - FileSplitter - FuncSplitter - GrandparentSplitter - IndexSplitter - MaskSplitter - RandomSplitter - RandomSubsetSplitter - TrainTestSplitter</p>
<p><strong>Labelling the data</strong> - Categorize - ColReader - MultiCategorize - RegexLabeller - RegressionSetup - parent_label</p>
</section>
<section id="building-some-dataloaders" class="level3">
<h3 class="anchored" data-anchor-id="building-some-dataloaders">Building some DataLoaders</h3>
<p>When we are ready to create our DataLoaders, we pass in the items to use, a batch_size, and the transforms to be performed to the DataLoader constructor:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Walkwithfastai_files/figure-html/065dac20-2306-472b-823a-2afece555cbe.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">dataloader.JPG</figcaption><p></p>
</figure>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Why are Item and Batch Transforms handled differently?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Item transforms are happened <strong>first</strong> and are used to prepare a batch. This includes transformations such as converting to a torch.tensor, ensuring that images, text, or tabular data can be collated together (the same size/shape).</p>
<p>Batch transforms are performed on an entire subset of data (after they have all been through the item transforms) at once as a big matrix. Examples can include further resizing, normalizing the data, and other data augmentation. As a result they are multitudes faster.</p>
</div>
</div>
</div>
</section>
<section id="back-to-dataloaders" class="level3">
<h3 class="anchored" data-anchor-id="back-to-dataloaders">Back to DataLoaders</h3>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_name_re(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    path, <span class="co"># The location of the data</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    fnames, <span class="co"># A list of filenames</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    pat, <span class="co"># A regex pattern to extract the labels</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>item_tfms, <span class="co"># Transform augmentations to be applied per item</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>batch_tfms, <span class="co"># Transform augmentations to be applied per batch</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    bs<span class="op">=</span>bs <span class="co"># How many examples should be drawn each time</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s rebuild using the <em>DataBlock</em> API, which explains a bit more of the magic occurring. We’ll need to define:</p>
<ul>
<li>what our input and outputs should be (An <strong>Image</strong> and a <strong>Category</strong> for classification)</li>
<li>how to get our items</li>
<li>how to split our data</li>
<li>how to extract our labels</li>
<li>and our augmentation</li>
</ul>
<p>as before:</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>pets <span class="op">=</span> DataBlock(blocks<span class="op">=</span>(ImageBlock, CategoryBlock),</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                 get_items<span class="op">=</span>get_image_files,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                 splitter<span class="op">=</span>RandomSplitter(),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                 get_y<span class="op">=</span>RegexLabeller(pat <span class="op">=</span> <span class="vs">r'/([^/]+)_\d+.*'</span>),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                 item_tfms<span class="op">=</span>item_tfms,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                 batch_tfms<span class="op">=</span>batch_tfms)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>path_im <span class="op">=</span> path<span class="op">/</span><span class="st">'images'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> pets.dataloaders(path_im, bs<span class="op">=</span>bs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can take a look at a batch of our images using <strong>show_batch</strong>, pass in a maximum number of images to show, and how large we want to view them as:</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch(max_n<span class="op">=</span><span class="dv">9</span>, figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">7</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Walkwithfastai_files/figure-html/cell-14-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>If we want to see how many classes we have, and the names of them we can simply call <strong>dls.vocab</strong>. The first is the number of classes, the second is the names of our classes. This is another special wrapper class, think of it as a special list of sorts, called <strong>L</strong>.</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>dls.vocab</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>['Abyssinian', 'Bengal', 'Birman', 'Bombay', 'British_Shorthair', 'Egyptian_Mau', 'Maine_Coon', 'Persian', 'Ragdoll', 'Russian_Blue', 'Siamese', 'Sphynx', 'american_bulldog', 'american_pit_bull_terrier', 'basset_hound', 'beagle', 'boxer', 'chihuahua', 'english_cocker_spaniel', 'english_setter', 'german_shorthaired', 'great_pyrenees', 'havanese', 'japanese_chin', 'keeshond', 'leonberger', 'miniature_pinscher', 'newfoundland', 'pomeranian', 'pug', 'saint_bernard', 'samoyed', 'scottish_terrier', 'shiba_inu', 'staffordshire_bull_terrier', 'wheaten_terrier', 'yorkshire_terrier']</code></pre>
</div>
</div>
<p>In a more pythonic-fashion, the vocab also has an <strong>o2i</strong> (object to index) we can utilize instead:</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>dls.vocab.o2i</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>{'Abyssinian': 0,
 'Bengal': 1,
 'Birman': 2,
 'Bombay': 3,
 'British_Shorthair': 4,
 'Egyptian_Mau': 5,
 'Maine_Coon': 6,
 'Persian': 7,
 'Ragdoll': 8,
 'Russian_Blue': 9,
 'Siamese': 10,
 'Sphynx': 11,
 'american_bulldog': 12,
 'american_pit_bull_terrier': 13,
 'basset_hound': 14,
 'beagle': 15,
 'boxer': 16,
 'chihuahua': 17,
 'english_cocker_spaniel': 18,
 'english_setter': 19,
 'german_shorthaired': 20,
 'great_pyrenees': 21,
 'havanese': 22,
 'japanese_chin': 23,
 'keeshond': 24,
 'leonberger': 25,
 'miniature_pinscher': 26,
 'newfoundland': 27,
 'pomeranian': 28,
 'pug': 29,
 'saint_bernard': 30,
 'samoyed': 31,
 'scottish_terrier': 32,
 'shiba_inu': 33,
 'staffordshire_bull_terrier': 34,
 'wheaten_terrier': 35,
 'yorkshire_terrier': 36}</code></pre>
</div>
</div>
</section>
<section id="time-to-make-and-train-a-model" class="level3">
<h3 class="anchored" data-anchor-id="time-to-make-and-train-a-model">Time to make and train a model!</h3>
<p>We will be using a convolutional neural network backbone and a fully connected head with a single hidden layer as our classifier. Don’t worry if thats a bunch of nonsense for now. Right now, just know this: we are piggybacking off of a model to help us classify images into 37 categories.</p>
<p>Modern applied computer vision never starts from scratch. Instead we utilize a technique called <strong><a href="https://en.wikipedia.org/wiki/Transfer_learning">transfer learning</a></strong>. Let someone else with much more compute than you build a state-of-the-art model, then piggyback off of this trained model for your own custom datasets.</p>
<p>In practice, this requires removing the last layer of the model and restructuring it to your problem.</p>
<p>Most commonly this comes in the form of a model trained on the ImageNet dataset (1,000 classes) and then downstreaming it to your own problem (37 classes).</p>
<p>To do so, we need 5 requirements:</p>
<ul>
<li>DataLoaders</li>
<li>some architecture</li>
<li>an evaluation metric</li>
<li>a loss function</li>
<li>an optimizer</li>
</ul>
<p>The fastai library will then wrap all of these items needed for training into the <strong>Learner</strong>. Oftentimes these don’t need to specified, as defaults are carefully picked out to have excellent performance right away.</p>
<p>Each module has their own **_learner** function that returns a <strong>Learner</strong> to facilitate training. Since we have a vision problem we utilize the <strong>cnn_learner</strong> (convolutional). With these defaults, we also only need to pass in the <strong>DataLoaders</strong>, a model architecture, and the metric:</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet34, metrics<span class="op">=</span>error_rate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/stephen137/mambaforge/lib/python3.10/site-packages/torchvision/models/_utils.py:208: UserWarning: The parameter 'pretrained' is deprecated since 0.13 and will be removed in 0.15, please use 'weights' instead.
  warnings.warn(
/home/stephen137/mambaforge/lib/python3.10/site-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for 'weights' are deprecated since 0.13 and will be removed in 0.15. The current behavior is equivalent to passing `weights=ResNet34_Weights.IMAGENET1K_V1`. You can also use `weights=ResNet34_Weights.DEFAULT` to get the most up-to-date weights.
  warnings.warn(msg)</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
resnet34
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is a very common machine learning model to start with hosted by <strong>torchvision</strong>. Much like the example earlier it was trained on the ImageNet dataset of 1,000 classes.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
error_rate
</div>
</div>
<div class="callout-body-container callout-body">
<p>Our problem is graded by “amount wrong”, which takes the form of the error_rate metric.</p>
</div>
</div>
<p>Some assumptions being made here:</p>
<ul>
<li>loss function is assumed as classification, so <strong>CrossEntropyFlat</strong> is used</li>
<li>optimizer defaults to the <strong>AdamW optimizer</strong>, a commonly used optimizer that has been considered as a good starting place in the Deep Learning community for the past few years</li>
</ul>
<p>With this now, we can train the model.</p>
<p>There’s a variety of “fit” functions fastai provides, each with their own set of hyperparameters to train a model. Generally <strong>fit_one_cycle</strong> <strong><em>(the One Cycle policy)</em></strong> or <strong>fit_flat_cos</strong> <strong><em>(Consine Annealing)</em></strong> are the best methods of training, which fastai simplifies to a simple one-line function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Afterwards we can save the model weights:</p>
<p><img src="electro-harmonix-freeze.jpg" width="400" height="400"></p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>learn.save(<span class="st">'stage_1'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>Path('models/stage_1.pth')</code></pre>
</div>
</div>
</section>
<section id="analyzing-how-the-model-performed" class="level3">
<h3 class="anchored" data-anchor-id="analyzing-how-the-model-performed">Analyzing how the model performed</h3>
<p>With the model trained, the next step in the feedback loop is looking at where it messed up. What species did it have trouble differentiating between? So long as the misidentifications are not too bad, our model is actually working.</p>
<p>What counts as being “too bad” is never an exact science, often when working on problems a deep learning engineer should be paired with an expert in the respective problem field so that these analysis have the proper context</p>
<p>We can plot our losses and make a confusion matrix to visualize these through the <strong>ClassificationInterpretation</strong> interface:</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>interp <span class="op">=</span> ClassificationInterpretation.from_learner(learn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<p><strong>plot_top_losses</strong> needs x number of images to examine, and a figure size:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>interp.plot_top_losses(<span class="dv">9</span>, figsize<span class="op">=</span>(<span class="dv">15</span>,<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>plot_confusion_matrix</strong> just needs a figure size. dpi adjusts the quality:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>interp.plot_confusion_matrix(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">12</span>), dpi<span class="op">=</span><span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can also directly grab our most confused (A raw version of the confusion matrix), and pass in a threshold:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>interp.most_confused(min_val<span class="op">=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="unfreezing-our-data-fine-tuning-and-our-learning-rates" class="level3">
<h3 class="anchored" data-anchor-id="unfreezing-our-data-fine-tuning-and-our-learning-rates">Unfreezing our data, fine-tuning, and our learning rates</h3>
<p>So, we have the model. Let’s fine tune it. First, we need to load our model back in:</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>learn.load(<span class="st">'stage_1'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we will <strong>unfreeze</strong> and train more:</p>
<p><img src="thaw.jpg" width="400" height="400"></p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>learn.unfreeze()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now when we unfreeze, we unfreeze <strong><em>all</em></strong> the layers. To find a proper new learning rate we can use the learning rate finder to help:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Alright so if we look here, we don’t start really spiking our losses until ~10^-2 so a good spot is between 1e-6 and 1e-4. We can pass this in as a maximum learning rate:</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">4</span>, lr_max<span class="op">=</span><span class="bu">slice</span>(<span class="fl">1e-6</span>, <span class="fl">1e-4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.254449</td>
      <td>0.195619</td>
      <td>0.067659</td>
      <td>07:37</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.230073</td>
      <td>0.179268</td>
      <td>0.058187</td>
      <td>07:40</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.193608</td>
      <td>0.179975</td>
      <td>0.061570</td>
      <td>07:38</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.190089</td>
      <td>0.177946</td>
      <td>0.061570</td>
      <td>07:36</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>We can see that picking a proper learning rate can help achieve a lower error rate and train a better model.</p>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>learn.save(<span class="st">'stage_2'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>Path('models/stage_2.pth')</code></pre>
</div>
</div>
</section>
</section>
<section id="custom-datasets-with-kaggle" class="level2">
<h2 class="anchored" data-anchor-id="custom-datasets-with-kaggle">1.3 Custom Datasets with Kaggle</h2>
<p>So far, we’ve learned how to:</p>
<ul>
<li>load some data in</li>
<li>create a basic DataBlock</li>
<li>create a cnn_learner</li>
<li>train a model</li>
</ul>
<p>Let’s now apply this to a non-fastai dataset, the <a href="https://www.kaggle.com/datasets/agrigorev/clothing-dataset-full">Clothing dataset</a>.</p>
<section id="lets-download-the-dataset" class="level3">
<h3 class="anchored" data-anchor-id="lets-download-the-dataset">Let’s download the dataset</h3>
<p>To download the dataset, you will need kaggle installed and have a kaggle.json stored in ~/.kaggle. You can get your token by going to Your Profile -&gt; Account -&gt; Create New API Token. If you don’t have a Kaggle account, you can make one for free <a href="https://www.kaggle.com/account/login?phase=startRegisterTab&amp;returnUrl=%2F">here</a>.</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install kaggle <span class="op">&gt;&gt;</span> <span class="op">/</span>dev<span class="op">/</span>null</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And run the API command provided:</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>kaggle datasets download <span class="op">-</span>d agrigorev<span class="op">/</span>clothing<span class="op">-</span>dataset<span class="op">-</span>full</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>clothing-dataset-full.zip: Skipping, found more recently modified local copy (use --force to force download)</code></pre>
</div>
</div>
<p>It’s now been saved to the clothing-dataset-full.zip file here on our local system:</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.xtras <span class="im">import</span> Path</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>zip_path <span class="op">=</span> Path(<span class="st">"clothing-dataset-full.zip"</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>zip_path.exists()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>True</code></pre>
</div>
</div>
<p>Let’s go ahead and unzip this with zipfile:</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> zipfile</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> zipfile.ZipFile(zip_path, <span class="st">"r"</span>) <span class="im">as</span> zip_ref:</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    zip_ref.extractall(<span class="st">"data"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>with zipfile.ZipFile(zip_path, 'r'):</code></pre>
<p>This is a <strong>context manager</strong> pointing at our <em>zip_path</em> and opens it as a data stream to read in from.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>zip_ref.extractall(data)</code></pre>
<p>This will extract all of our data into a new directory ‘data’.</p>
</div>
</div>
<p>Let’s look in the folder:</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>data_path <span class="op">=</span> Path(<span class="st">"data"</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>data_path.ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>(#3) [Path('data/images_original'),Path('data/images_compressed'),Path('data/images.csv')]</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>data_path.ls()</code></pre>
<p><em>fastcore</em> adds a number of monkey-patch improvements to existing classes, which is why we imported <em>from fastcore.xtras import Path</em> and not <em>from pathlib import Path</em>. Being able to run <em>ls()</em> using a <em>Path</em> is one of the perks.</p>
</div>
</div>
<p>We see a file named images.csv, compressed folder, and original images.</p>
</section>
<section id="exploring-the-dataset" class="level3">
<h3 class="anchored" data-anchor-id="exploring-the-dataset">Exploring the dataset</h3>
<p>The first thing a good Data Scientist should do is look at the <strong>data</strong>. Especially when we want to fit it into the fastai framework. Let’s first investigate these compressed vs original images.</p>
</section>
<section id="images" class="level3">
<h3 class="anchored" data-anchor-id="images">Images</h3>
<p>We’ll import the vision library from fastai so that we have some useful imports already existing for us:</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next let’s look at the folder’s contents:</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>(data_path<span class="op">/</span><span class="st">"images_compressed"</span>).ls()[:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>(#3) [Path('data/images_compressed/41aa66b1-debe-4669-aa91-a117d0a83519.jpg'),Path('data/images_compressed/7ead4877-766e-4b71-ae4b-151f26d320e2.jpg'),Path('data/images_compressed/7e3b9ab4-5fa2-4f6f-b6e3-db65bca8acaa.jpg')]</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>data_path/images_compressed).ls()   </code></pre>
<p>When you want to use a function that is determinstic by the output of whatever came before it, you can wrap it in parenthesis and call the subsequent class’ function afterwards, kind of like PEMDAS.</p>
</div>
</div>
<p>As expected, a variety of images. Let’s open one up and look at it:</p>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>im_path <span class="op">=</span> (data_path<span class="op">/</span><span class="st">"images_compressed"</span>).ls()[<span class="dv">0</span>]</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> Image.<span class="bu">open</span>(im_path)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>im</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<p><img src="Walkwithfastai_files/figure-html/cell-36-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We can also check it’s size:</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>im.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>(533, 400)</code></pre>
</div>
</div>
<p>Let’s see how that compares to a bigger sized image:</p>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>im_path <span class="op">=</span> (data_path<span class="op">/</span><span class="st">"images_original"</span>).ls()[<span class="dv">0</span>]</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> Image.<span class="bu">open</span>(im_path)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>im.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>(4000, 3000)</code></pre>
</div>
</div>
<p><em>Way</em> bigger. We’ll train on the smaller dataset so it’s faster.</p>
<p>Now that we know how the images are laid out, we need to understand how the data is labeled.</p>
</section>
<section id="dataframe" class="level3">
<h3 class="anchored" data-anchor-id="dataframe">DataFrame</h3>
<p>We’ll load the csv file we saw with pandas:</p>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'data/images.csv'</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>image</th>
      <th>sender_id</th>
      <th>label</th>
      <th>kids</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>4285fab0-751a-4b74-8e9b-43af05deee22</td>
      <td>124</td>
      <td>Not sure</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>ea7b6656-3f84-4eb3-9099-23e623fc1018</td>
      <td>148</td>
      <td>T-Shirt</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>00627a3f-0477-401c-95eb-92642cbe078d</td>
      <td>94</td>
      <td>Not sure</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ea2ffd4d-9b25-4ca8-9dc2-bd27f1cc59fa</td>
      <td>43</td>
      <td>T-Shirt</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3b86d877-2b9e-4c8b-a6a2-1d87513309d0</td>
      <td>189</td>
      <td>Shoes</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
pd.read_csv
</div>
</div>
<div class="callout-body-container callout-body">
<p>We are reading in a CSV file, so we use the pandas (pd) read_csv constructor and pass in the path.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>df.head()</code></pre>
<p>head will print the first n rows of a pandas DataFrame. By default it’s 5.</p>
</div>
</div>
<p>We can see the <em>label</em> and <em>image columns</em>, which correspond to our data, but something doesn’t look right does it. That “Not sure” label. Let’s see how many there are:</p>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(df[df[<span class="st">"label"</span>] <span class="op">==</span> <span class="st">"Not sure"</span>]), <span class="bu">len</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>(228, 5403)</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>df[label]</code></pre>
<p>This first part returns a mask of where the condition is met, think an array of True or False.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>df[...]</code></pre>
<p>This next part indexes into the array based on the mask inside of it, everywhere “label” was “Not sure”.</p>
</div>
</div>
<p>A good chunk of our data is messy! We should drop those rows. To select the inverse of a mask, use the ~:</p>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(df[<span class="op">~</span>(df[<span class="st">"label"</span>] <span class="op">==</span> <span class="st">"Not sure"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>5175</code></pre>
</div>
</div>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>clean_df <span class="op">=</span> df[<span class="op">~</span>(df[<span class="st">"label"</span>] <span class="op">==</span> <span class="st">"Not sure"</span>)]</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>clean_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>image</th>
      <th>sender_id</th>
      <th>label</th>
      <th>kids</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>ea7b6656-3f84-4eb3-9099-23e623fc1018</td>
      <td>148</td>
      <td>T-Shirt</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ea2ffd4d-9b25-4ca8-9dc2-bd27f1cc59fa</td>
      <td>43</td>
      <td>T-Shirt</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3b86d877-2b9e-4c8b-a6a2-1d87513309d0</td>
      <td>189</td>
      <td>Shoes</td>
      <td>False</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5d3a1404-697f-479f-9090-c1ecd0413d27</td>
      <td>138</td>
      <td>Shorts</td>
      <td>False</td>
    </tr>
    <tr>
      <th>6</th>
      <td>b0c03127-9dfb-4573-8934-1958396937bf</td>
      <td>138</td>
      <td>Shirt</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Great! Now let’s see what our classes are:</p>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>clean_df[<span class="st">"label"</span>].unique(), <span class="bu">len</span>(clean_df[<span class="st">"label"</span>].unique())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>(array(['T-Shirt', 'Shoes', 'Shorts', 'Shirt', 'Pants', 'Skirt', 'Other',
        'Top', 'Outwear', 'Dress', 'Body', 'Longsleeve', 'Undershirt',
        'Hat', 'Polo', 'Blouse', 'Hoodie', 'Skip', 'Blazer'], dtype=object),
 19)</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>.unique()</code></pre>
<p>This will list out all the unique classes in our DataFrame.</p>
</div>
</div>
<p>Much like our PETs classification problem, we’ll be classifying 19 different clothing items.</p>
</section>
<section id="can-we-do-fastai-already" class="level3">
<h3 class="anchored" data-anchor-id="can-we-do-fastai-already">Can we do fastai already?</h3>
<p>So let’s go over what we know again:</p>
<ol type="1">
<li>Our data is stored in folders named “images_compressed”</li>
<li>To get the label from an image, we need to read it in through a pandas DataFrame</li>
<li>There are 19 different clothing items we’re trying to classify.</li>
</ol>
<p>Now that our problem is setup, let’s see how it can fit into the DataBlock API:</p>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>blocks <span class="op">=</span> (ImageBlock, CategoryBlock)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>(ImageBlock, CategoryBlock)</code></pre>
<p>This problem has an image going in, and a category going out.</p>
</div>
</div>
<p>Then how to get our data:</p>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>get_x <span class="op">=</span> ColReader(<span class="st">"image"</span>, pref<span class="op">=</span>(data_path<span class="op">/</span><span class="st">"images_compressed"</span>), suff<span class="op">=</span><span class="st">".jpg"</span>)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>get_y <span class="op">=</span> ColReader(<span class="st">"label"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>ColReader(label)</code></pre>
<p>We utilize the ColReader class here, which knows to read in from a Pandas column.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>ColReader(... pref=.., suff=..)</code></pre>
<p>add it in on the fly rather than having to mess with the DataFrame.</p>
</div>
</div>
<p>Next our Transforms:</p>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>item_tfms <span class="op">=</span> [Resize(<span class="dv">224</span>)]</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>batch_tfms <span class="op">=</span> [<span class="op">*</span>aug_transforms(), Normalize.from_stats(<span class="op">*</span>imagenet_stats, cuda<span class="op">=</span><span class="va">False</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And finally build our DataBlock:</p>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>blocks,</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    get_x<span class="op">=</span>get_x,</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>get_y,</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>item_tfms,</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>batch_tfms</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>All that’s left is to convert them to dataloaders:</p>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dblock.dataloaders(clean_df, device<span class="op">=</span><span class="st">"cpu"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Walkwithfastai_files/figure-html/cell-50-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Great! Our data looks good to train on.</p>
</section>
<section id="creating-a-learner-and-fine-tuning" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-learner-and-fine-tuning">Creating a Learner and fine-tuning</h3>
<p>Now let’s create the vision_learner and fine-tune:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet34, metrics<span class="op">=</span>accuracy)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
cnn_learner has been deprecated
</div>
</div>
<div class="callout-body-container callout-body">
<p>Use vision_learner instead.</p>
</div>
</div>
<p>And we’re done! In the next section we’ll look at the low-level API with MNIST, building a model from scratch, and start to peel away some of the layers of fastai and think of it more as an extension to PyTorch.</p>
</section>
</section>
</section>
<section id="lesson-2" class="level1 page-columns page-full">
<h1>Lesson 2</h1>
<section id="low-level-api-with-mnist" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="low-level-api-with-mnist">2.1 Low-Level API with MNIST</h2>
<section id="introduction" class="level3">
<h3 class="anchored" data-anchor-id="introduction">Introduction</h3>
<p>In the previous lesson we saw how the fastai API is built and applied it to classify Cats and Dogs as well as on a real Kaggle dataset. In this lesson we’re going to go back to some Machine Learning basics and use the lowest-level API of fastai to train a hand-written digit classifier!</p>
<p>As this is a vision problem, we will import the vision library:</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="working-with-the-data" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="working-with-the-data">Working with the data</h3>
<p>The dataset for today is the MNIST handwritten digits dataset. It contains digits written from 0 -&gt; 9 on an image.</p>
<p>Let’s download the data:</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.MNIST)<span class="op">;</span> path, path.ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>(Path('/home/stephen137/.fastai/data/mnist_png'),
 (#2) [Path('/home/stephen137/.fastai/data/mnist_png/training'),Path('/home/stephen137/.fastai/data/mnist_png/testing')])</code></pre>
</div>
</div>
<p>We can see it downloaded it to a folder called mnist_png and has two folders, training and testing. Let’s grab all the images from these directories:</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>We actually call get_image_files this time, and it brings us all of the images in both the testing/ and training/ folders.</p>
</div></div><div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>items <span class="op">=</span> get_image_files(path)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>items[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>(#10) [Path('/home/stephen137/.fastai/data/mnist_png/training/4/47823.png'),Path('/home/stephen137/.fastai/data/mnist_png/training/4/45709.png'),Path('/home/stephen137/.fastai/data/mnist_png/training/4/49105.png'),Path('/home/stephen137/.fastai/data/mnist_png/training/4/746.png'),Path('/home/stephen137/.fastai/data/mnist_png/training/4/13451.png'),Path('/home/stephen137/.fastai/data/mnist_png/training/4/54187.png'),Path('/home/stephen137/.fastai/data/mnist_png/training/4/30554.png'),Path('/home/stephen137/.fastai/data/mnist_png/training/4/30886.png'),Path('/home/stephen137/.fastai/data/mnist_png/training/4/52580.png'),Path('/home/stephen137/.fastai/data/mnist_png/training/4/38515.png')]</code></pre>
</div>
</div>
<p>Next we need to try opening an image. Last time we used PIL.Image directly, this time we will use the fastai API:</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> PILImageBW.create(items[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>PILImage</code></pre>
<p>This is the main image class that handles opening the image and setting it up to be used in the fastai data framework.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>PILImageBW</code></pre>
<p>We have a black and white image (two channel), so we need to open it through the black and white specific PILImage class.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>.create()</code></pre>
<p>This is the class constructor that will create a new PILImageBW object from whatever is passed in.</p>
</div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>im.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>&lt;AxesSubplot: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Walkwithfastai_files/figure-html/cell-56-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>.show()</code></pre>
<p>We want to visually plot the data to the screen, and most of the lowest level data API’s contain a show functionality to do so.</p>
</div>
</div>
<p>Next we need to figure out how to split the dataset. Since our data is split by testing and training folders, the GrandparentSplitter is the one we want:</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>splitter <span class="op">=</span> GrandparentSplitter(</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>    train_name<span class="op">=</span><span class="st">"training"</span>,</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    valid_name<span class="op">=</span><span class="st">"testing"</span>,</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>train_name="training",  valid_name="testing",</code></pre>
<p>This splitter works by passing in the folder for the training dataset and the test dataset, and we assume that it’s possible to extract the labels from them seperately (as splits and labelling are two seperate stages)</p>
</div>
</div>
<p>As the name implies, splitters are designed to be applied to some list of data so let’s do that:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>splits <span class="op">=</span> splitter(items)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>splits[<span class="dv">0</span>][:<span class="dv">5</span>], splits[<span class="dv">1</span>][:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>([0, 1, 2, 3, 4], [60000, 60001, 60002, 60003, 60004])</code></pre>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>splits[0] correlates to our training dataset and splits[1] correlates to our validation set. If you write a custom splitter or splits technically you can have n split datasets!</p>
</div></div><div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(splits[<span class="dv">0</span>]), <span class="bu">len</span>(splits[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>(60000, 10000)</code></pre>
</div>
</div>
<p>We can see the train dataset has 60,000 items and our validation has 10,000</p>
<p>The next step is to build a Datasets object. This is fastai’s equivalent to a torch.data.Dataset object and handles seperating out items into different lists, creating said dataset based on the inputs passed in, and so forth:</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>dsrc <span class="op">=</span> Datasets(</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>    items,</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>    tfms<span class="op">=</span>[[PILImageBW.create], [parent_label, Categorize]],</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    splits<span class="op">=</span>splits</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>Datasets</code></pre>
<p>The datasets object needs to take in some items that count as our dataset, how to open them, and how to split them.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>tfms</code></pre>
<p>These are directions on transforms to be applied to each object that is returned from one item.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>[parent_label, Categorize]</code></pre>
<p>This is how we label our data (or the y). parent_label looks at the parent folder for the name, and Categorize will perform label encoding.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>splits = splits</code></pre>
<p>Finally these are our splits generated earlier based on the GrandparentSplitter.</p>
</div>
</div>
<p>To take a look at an item in the dataset, fastai has a function called show_at which takes an datasource and an index and tries to view it:</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>show_at(dsrc.train, <span class="dv">3</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Walkwithfastai_files/figure-html/cell-61-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>dsrc.train</code></pre>
<p>The training dataset.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<p>3 The fourth item in the dataset.</p>
</div>
</div>
<p>We can see that the data is a number 4 with a label of 4. Next we need to transform the data into something we can train on. Remember the role of item transforms were to get the image to the same size, and we also need to turn this data into a PyTorch tensor.</p>
<p>The transforms to do so are:</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>item_tfms <span class="op">=</span> [CropPad(<span class="dv">34</span>), RandomCrop(size<span class="op">=</span><span class="dv">28</span>), ToTensor()]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>CropPad(34)</code></pre>
<p>This will either crop or pad the image to a particular size.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>RandomCrop(size=28)</code></pre>
<p>This will randomly take a 28x28 pixel chunk of the image and crop to that.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>ToTensor()</code></pre>
<p>This is what will convert our PILImage into a TensorImage.</p>
</div>
</div>
<p>As they are item transforms, these will be cpu bound. Now that the data is all the same size, we can perform the batch transforms, which should convert the data into a float tensor (to be computationally efficient) and normalize the data:</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>When we call Normalize without giving it any statistics, it will base the normalization values on the first batch of data in the dataset. This has generally been found to give a very good approximiation of the full dataset’s values</p>
</div></div><div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>batch_tfms <span class="op">=</span> [IntToFloatTensor(), Normalize()]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>IntToFloatTensor</code></pre>
<p>This will convert tensors from integers to floats.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>Normalize</code></pre>
<p>This will perform normalization on the data and make training a bit faster.</p>
</div>
</div>
<p>And the last step is to turn them into a set of training and validation dataloaders by passing in all of our information. Since the data is so small we can use a larger batch size:</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dsrc.dataloaders(</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>    bs<span class="op">=</span><span class="dv">128</span>,</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>    after_item<span class="op">=</span>item_tfms,</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    after_batch<span class="op">=</span>batch_tfms</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
About after_item and after_batch
</div>
</div>
<div class="callout-body-container callout-body">
<p>When outside the DataBlock API, item_tfms and batch_tfms will always be referenced as after_item and after_batch, including inside the dataloader itself.</p>
</div>
</div>
<p>Then we can show a batch of data with augmentations performed:</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Walkwithfastai_files/figure-html/cell-65-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>From here we can get the raw values from a single batch of data through the one_batch function:</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>xb, yb <span class="op">=</span> dls.one_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>xb</code></pre>
<p>xb denotes a batch of the x’s (inputs)</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>yb</code></pre>
<p>yb denotes a batch of the y’s (labels)</p>
</div>
</div>
<p>We can view the shapes of the data:</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>xb.shape, yb.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>(torch.Size([128, 1, 28, 28]), torch.Size([128]))</code></pre>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>Remember a torch tensor is an array of some shape. So our x’s are 128 different arrays of shape 28x28 pixels, and our y’s are a single array of 128 numbers</p>
</div></div><p>Lastly we can see that fastai was able to automatically calculate the number of different y’s we had (classes) in the training dataset and throws them into an attribute called c:</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>dls.c</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>10</code></pre>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>The dataset also had this, try running dsrc.c.</p>
</div></div><div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>dsrc.c</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>10</code></pre>
</div>
</div>
</section>
<section id="building-a-model-and-training" class="level3">
<h3 class="anchored" data-anchor-id="building-a-model-and-training">Building a Model and Training!</h3>
<p>Next we’ll follow what we did in the previous lesson and grab a model to use. For this particular problem we’ll use a resnet18 architecture and fastai’s cnn_learner. We won’t use a pretrained model however this time!</p>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Why should we not use a pretrained model?
</div>
</div>
<div class="callout-body-container callout-body">
<p>First, we used a different normalization schema earlier rather than .from_stats. Second, think about it. Are handwritten digits the same as ImageNet in any way? Not really. So it’s better to use a completely random model here for this small problem.</p>
</div>
</div>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Note - I removed .cuda() </span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> resnet18( num_classes<span class="op">=</span>dls.c)<span class="op">;</span> model.fc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>Linear(in_features=512, out_features=10, bias=True)</code></pre>
</div>
</div>
<p>This changed our outputs to be the number of classes, but is this enough?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>model(xb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>RuntimeError: Given groups=1, weight of size [64, 3, 7, 7], expected input[128, 1, 28, 28] to have 3 channels, but got 1 channels instead</p>
<p>Basically what this error tells us is the first layer of the model is expecting a three channel image, and we gave it a single channel instead. Which makes perfect sense! Let’s look at that first layer to see what it looks like:</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>model.conv1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>Conv2d(3, 64, kernel_size=(7, 7), stride=(2, 2), padding=(3, 3), bias=False)</code></pre>
</div>
</div>
<p>In order for our model to work well, we need a Conv2d layer that can work on single channel images, but is roughly the same size. We can achieve this by just reducing that 3 to 1:</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>model.conv1 <span class="op">=</span> nn.Conv2d(</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>    in_channels<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    out_channels<span class="op">=</span><span class="dv">64</span>, </span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>    kernel_size<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">7</span>), </span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    stride<span class="op">=</span>(<span class="dv">2</span>,<span class="dv">2</span>), </span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>    padding<span class="op">=</span>(<span class="dv">3</span>,<span class="dv">3</span>), </span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>    bias<span class="op">=</span><span class="va">False</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now we can see it works!</p>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>model(xb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>TensorImageBW([[ 0.0836, -0.9386, -0.5319,  ..., -0.0669,  0.2010, -0.4584],
               [ 0.4728, -0.6382,  0.1301,  ..., -0.2985,  0.5969, -0.3663],
               [ 0.5367, -0.8538, -0.2605,  ..., -0.2483, -0.8470,  0.2892],
               ...,
               [ 0.1610, -0.4887,  0.2123,  ...,  0.1796, -0.2528, -0.5856],
               [ 0.6665,  0.8018,  0.1648,  ...,  0.4285,  0.9411, -0.3710],
               [ 0.8392, -0.1051, -0.2099,  ...,  0.5784,  0.6314, -0.4225]],
              grad_fn=&lt;AliasBackward0&gt;)</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-39-contents" aria-controls="callout-39" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
What if we used a pretrained model?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-39" class="callout-39-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>If we used a pretrained model here, it is possible to utilize the old pretrained weights. We can do so by averaging each channel’s weights and having the single channel’s weights be the result:</p>
<p>model.conv1.weight.mean(dim=1).unsqueeze(1)</p>
<p>We would find this would give a weight equal to shape [64, 1, 7, 7], the size of our new Conv2D layer</p>
</div>
</div>
</div>
<p>All that’s left is to build a Learner (the base class of what we used last lesson) and train!</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> Learner(dls, model, metrics<span class="op">=</span>[accuracy])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.111420</td>
      <td>0.107162</td>
      <td>0.965700</td>
      <td>03:40</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>Great! We successfully built a model that can classify handwritten digits! We can predict on one of them using fastai’s predict method:</p>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>items[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>Path('/home/stephen137/.fastai/data/mnist_png/training/4/47823.png')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> learn.predict(items[<span class="dv">0</span>])<span class="op">;</span> preds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>('4',
 tensor(4),
 tensor([2.3806e-09, 5.8144e-08, 9.9924e-07, 1.8630e-08, 9.9987e-01, 3.7552e-08,
         1.6265e-06, 1.0739e-04, 7.9393e-06, 1.0025e-05]))</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>'4'</code></pre>
<p>This four is the string representation of the class, found in dls.vocab.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>tensor(4)</code></pre>
<p>This is the argmax (or what index had the highest value) of the predictions, and it is then used as the index into dls.vocab.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>tensor([2.3806e-09, 5.8144e-08, 9.9924e-07, 1.8630e-08, 9.9987e-01, 3.7552e-08,1.6265e-06, 1.0739e-04, 7.9393e-06, 1.0025e-05]))</code></pre>
<p>These are the softmax (or taking all the outputs and making them sum to one) probabilities for each class. The argmax is the highest value from here.</p>
</div>
</div>
<p>To recreate what we just did without learn.predict it would look something like so:</p>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>dl <span class="op">=</span> learn.dls.test_dl(items[:<span class="dv">1</span>])</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>inps, preds, _, decoded_preds <span class="op">=</span> learn.get_preds(dl<span class="op">=</span>dl, with_decoded<span class="op">=</span><span class="va">True</span>, with_input<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>image, class_prediction <span class="op">=</span> learn.dls.decode_batch((inps,) <span class="op">+</span> tuplify(decoded_preds))[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>class_prediction, decoded_preds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>('4', tensor([4]))</code></pre>
</div>
</div>
<p>And finally to do it with just fastai transforms:</p>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>learn.dls.after_item, learn.dls.after_batch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>(Pipeline: CropPad -- {'size': (34, 34), 'pad_mode': 'zeros'} -&gt; RandomCrop -- {'size': (28, 28), 'p': 1.0} -&gt; ToTensor,
 Pipeline: IntToFloatTensor -- {'div': 255.0, 'div_mask': 1} -&gt; Normalize -- {'mean': None, 'std': None, 'axes': (0, 2, 3)})</code></pre>
</div>
</div>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>learn.dls.after_batch[<span class="dv">1</span>].mean, learn.dls.after_batch[<span class="dv">1</span>].std</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>(TensorImageBW([[[[0.1337]]]]), TensorImageBW([[[[0.3112]]]]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>type_tfms <span class="op">=</span> Pipeline([PILImageBW.create])</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>item_tfms <span class="op">=</span> Pipeline([CropPad((<span class="dv">34</span>,<span class="dv">34</span>)), CropPad((<span class="dv">28</span>,<span class="dv">28</span>)), ToTensor()])</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>batch_tfms <span class="op">=</span> Pipeline([</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>    IntToFloatTensor(), </span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>    Normalize.from_stats([[[[<span class="fl">0.1302</span>]]]], [[[[<span class="fl">0.3081</span>]]]])</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>items[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>Path('/home/stephen137/.fastai/data/mnist_png/training/4/47823.png')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> type_tfms(items[<span class="dv">0</span>])<span class="op">;</span> im.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>(28, 28)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>item_tfms(im).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>torch.Size([1, 28, 28])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>batch_tfms(item_tfms(im).shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>torch.Size([1, 28, 28])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>net <span class="op">=</span> learn.model</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>net.<span class="bu">eval</span>()</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>t_im <span class="op">=</span> batch_tfms(item_tfms(im))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> net(t_im)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>out.argmax(dim<span class="op">=-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>TensorImageBW([4])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>out.softmax(<span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>TensorImageBW([[2.1207e-09, 4.9505e-08, 9.1256e-07, 1.6589e-08, 9.9988e-01,
                3.3392e-08, 1.5165e-06, 1.0025e-04, 7.5753e-06, 9.5151e-06]])</code></pre>
</div>
</div>
<p>Now what if we wanted to do everything in PyTorch but the training?</p>
</section>
</section>
<section id="using-raw-pytorch" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="using-raw-pytorch">2.2 Using Raw PyTorch</h2>
<section id="introduction-1" class="level3">
<h3 class="anchored" data-anchor-id="introduction-1">Introduction</h3>
<p>In this chapter we’re going to go back to the previous lesson and train on the PETs dataset again, however there is a specific set of rules we will be following:</p>
<ol type="1">
<li>we cannot use the fastai data API, it must be done in raw PyTorch</li>
<li>we cannot use cnn_learner, we must create our own model</li>
<li>we cannot use fastai’s Optimizer, it must be a PyTorch optimizer.</li>
</ol>
<p>If you don’t know what that last part is, that is okay. We’ll cover it briefly in this lecture.</p>
</section>
<section id="removing-the-data-api" class="level3">
<h3 class="anchored" data-anchor-id="removing-the-data-api">Removing the Data API</h3>
<section id="downloading-the-dataset" class="level4">
<h4 class="anchored" data-anchor-id="downloading-the-dataset">Downloading the dataset</h4>
<p>The only part of fastai we will be allowed to use is untar_data to get the dataset and imagenet_stats, so let’s import it and grab it now:</p>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.data.external <span class="im">import</span> untar_data, URLs</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.data <span class="im">import</span> imagenet_stats</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.xtras <span class="im">import</span> Path <span class="co"># to bring in some patched functionalities we will use later</span></span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>dataset_path <span class="op">=</span> untar_data(URLs.PETS)</span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>dataset_path.ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>(#2) [Path('/home/stephen137/.fastai/data/oxford-iiit-pet/annotations'),Path('/home/stephen137/.fastai/data/oxford-iiit-pet/images')]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>imagenet_stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])</code></pre>
</div>
</div>
</section>
</section>
<section id="defining-our-transforms" class="level3">
<h3 class="anchored" data-anchor-id="defining-our-transforms">Defining our Transforms</h3>
<p>The next step is to define our Transform’s so they mimic fastai close enough to get by. Our transforms can be boiled down to:</p>
<ol type="1">
<li>resize randomly to (224, 224)</li>
<li>convert to a Tensor</li>
<li>perform some more data augmentation such as lighting and rotation</li>
<li>convert to a float tensor</li>
<li>normalize based on ImageNet</li>
</ol>
<p>We’ll do all but 3 here for simplicity.</p>
<p>In PyTorch this sequence of transforms is actually defined as a model nn.Sequential layer:</p>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.transforms <span class="im">import</span> CenterCrop, RandomResizedCrop, ToTensor, Normalize</span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>train_transforms <span class="op">=</span> nn.Sequential(</span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>    RandomResizedCrop((<span class="dv">224</span>,<span class="dv">224</span>)),</span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>    Normalize(<span class="op">*</span>imagenet_stats)</span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a>valid_transforms <span class="op">=</span> nn.Sequential(</span>
<span id="cb165-10"><a href="#cb165-10" aria-hidden="true" tabindex="-1"></a>    CenterCrop((<span class="dv">224</span>,<span class="dv">224</span>)),</span>
<span id="cb165-11"><a href="#cb165-11" aria-hidden="true" tabindex="-1"></a>    Normalize(<span class="op">*</span>imagenet_stats)</span>
<span id="cb165-12"><a href="#cb165-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="make-a-pytorch-dataset" class="level3">
<h3 class="anchored" data-anchor-id="make-a-pytorch-dataset">Make a PyTorch Dataset</h3>
<p>Next we need to create a Dataset class for us to use. Basically this is a simple class that will have three main functions:</p>
<pre><code>__init__</code></pre>
<p>In Python this is a class constructor or what is called when you do MyClass(). For our class this will include taking in and storing the list of filenames, transforms, and a way to turn the label strings into a number</p>
<pre><code>__len__</code></pre>
<p>In Python this function is how you get the length of some collection of data or items when doing len(MyThing()). For our class this will return the length of all the items used in the dataset.</p>
<pre><code>__getitem__</code></pre>
<p>In Python this function is what gets called when you <em>index</em> into an object, such as <strong>myList[x]</strong> and will return whatever you are trying to grab when doing so. For our class this will grab and open a file, apply the transforms, and return a tuple of the image and the label</p>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset</span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a><span class="co"># This example is highly based on the work of Sylvain Gugger</span></span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a><span class="co"># for the Accelerate notebook example which can be found here: </span></span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/huggingface/notebooks/blob/main/examples/accelerate_examples/simple_cv_example.ipynb</span></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PetsDataset(Dataset):</span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"A basic dataset that will return a tuple of (image, label)"</span></span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, filenames:<span class="bu">list</span>, transforms:nn.Sequential, label_to_int:<span class="bu">dict</span>):</span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.filenames <span class="op">=</span> filenames</span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.transforms <span class="op">=</span> transforms</span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.label_to_int <span class="op">=</span> label_to_int</span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.to_tensor <span class="op">=</span> ToTensor()</span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb169-17"><a href="#cb169-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.filenames)</span>
<span id="cb169-18"><a href="#cb169-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb169-19"><a href="#cb169-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> apply_x_transforms(<span class="va">self</span>, filename):</span>
<span id="cb169-20"><a href="#cb169-20" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> Image.<span class="bu">open</span>(filename).convert(<span class="st">"RGB"</span>)</span>
<span id="cb169-21"><a href="#cb169-21" aria-hidden="true" tabindex="-1"></a>        tensor_image <span class="op">=</span> <span class="va">self</span>.to_tensor(image)</span>
<span id="cb169-22"><a href="#cb169-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.transforms(tensor_image)</span>
<span id="cb169-23"><a href="#cb169-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb169-24"><a href="#cb169-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> apply_y_transforms(<span class="va">self</span>, filename):</span>
<span id="cb169-25"><a href="#cb169-25" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> re.findall(<span class="vs">r"^(.*)_\d+\.jpg$"</span>, filename.name)[<span class="dv">0</span>].lower()</span>
<span id="cb169-26"><a href="#cb169-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.label_to_int[label]</span>
<span id="cb169-27"><a href="#cb169-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb169-28"><a href="#cb169-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, index):</span>
<span id="cb169-29"><a href="#cb169-29" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> <span class="va">self</span>.filenames[index]</span>
<span id="cb169-30"><a href="#cb169-30" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.apply_x_transforms(filename)</span>
<span id="cb169-31"><a href="#cb169-31" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> <span class="va">self</span>.apply_y_transforms(filename)</span>
<span id="cb169-32"><a href="#cb169-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (x,y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>def apply_y_transforms(self, filename):
    label = re.findall(r"^(.*)_\d+\.jpg$", filename.name)[0].lower()
    return self.label_to_int[label]       </code></pre>
<p>This function uses regex to extract the filename based on the expectation it will show up as label_{some_number}.jpg and then converts this string label into an integer based on the label to integer dictionary</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>def __getitem__(self, index):
    filename = self.filenames[index]
    x = self.apply_x_transforms(filename)
    y = self.apply_y_transforms(filename)
    return (x,y)        </code></pre>
<p>This function first grabs the filename we want to use based on the index passed, then calls our defined apply_{type}_transform function before finally returning a tuple of the input and output.</p>
</div>
</div>
</section>
<section id="prepare-for-the-dataset" class="level3">
<h3 class="anchored" data-anchor-id="prepare-for-the-dataset">Prepare for the Dataset</h3>
<p>Next we need to prepare for the dataset by:</p>
<ul>
<li>getting a dictionary of labels to encoded classes</li>
<li>split the dataset randomly 80/20</li>
</ul>
</section>
<section id="labels-as-encoded-classes" class="level3">
<h3 class="anchored" data-anchor-id="labels-as-encoded-classes">Labels as encoded classes</h3>
<p>To get the labels as encoded classes, we can create a list of just labels then find the unique ones from them:</p>
<div class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>label_pat <span class="op">=</span> <span class="vs">r"^(.*)_\d+\.jpg$"</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>filenames <span class="op">=</span> (dataset_path<span class="op">/</span><span class="st">'images'</span>).ls(file_exts<span class="op">=</span><span class="st">".jpg"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>label_pat = r"^(.*)_\d+\.jpg$"</code></pre>
<p>This is the same regex pattern as before.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>.ls(file_exts='.jpg')</code></pre>
<p>This performs a monkey-patched functionality to pathlib.Path in fastcore to perform an ls operation on the path, returning only files that end with .jpg</p>
</div>
</div>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> filenames.<span class="bu">map</span>(</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: re.findall(label_pat, x.name)[<span class="dv">0</span>].lower()</span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>).unique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>labels.map</code></pre>
<p>A map will apply some function to every single item in a collection. Generally it’s seen as map(func, items). Since this list is a fastcore.foundations.L, we can just use map() directly and have it apply to labels</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>lambda x: </code></pre>
<p>A lambda function is what is called an anonymous function. These don’t need def name():… and instead assume the input is whatever goes before the :</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>re.findall(label_pat, x.name)[0].lower()</code></pre>
<p>This will apply our label_pat to the filename, return the first found item, and lowercase it.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>unique()</code></pre>
<p>This will look inside our resulting labels and return a list of every single unique value inside it.</p>
</div>
</div>
<div class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>labels</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<pre><code>(#37) ['birman','leonberger','bombay','japanese_chin','saint_bernard','ragdoll','persian','scottish_terrier','english_setter','havanese'...]</code></pre>
</div>
</div>
<p>And now we have a list of our 37 labels! All that’s left is to quickly turn this into a dictionary of indexes:</p>
<div class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>label_to_int <span class="op">=</span> {index:key <span class="cf">for</span> key, index <span class="kw">in</span> <span class="bu">enumerate</span>(labels)}</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>label_to_int.keys(), label_to_int[<span class="st">"siamese"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>(dict_keys(['birman', 'leonberger', 'bombay', 'japanese_chin', 'saint_bernard', 'ragdoll', 'persian', 'scottish_terrier', 'english_setter', 'havanese', 'bengal', 'great_pyrenees', 'basset_hound', 'egyptian_mau', 'american_bulldog', 'english_cocker_spaniel', 'newfoundland', 'american_pit_bull_terrier', 'samoyed', 'staffordshire_bull_terrier', 'shiba_inu', 'german_shorthaired', 'miniature_pinscher', 'yorkshire_terrier', 'chihuahua', 'sphynx', 'beagle', 'keeshond', 'boxer', 'british_shorthair', 'pomeranian', 'russian_blue', 'abyssinian', 'maine_coon', 'pug', 'wheaten_terrier', 'siamese']),
 36)</code></pre>
</div>
</div>
</section>
<section id="splitting-the-dataset" class="level3">
<h3 class="anchored" data-anchor-id="splitting-the-dataset">Splitting the dataset</h3>
<p>Finally to split the dataset we can use numpy to shuffle our filenames before then splitting them 80/20:</p>
<div class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>shuffled_indexes <span class="op">=</span> np.random.permutation(<span class="bu">len</span>(filenames))</span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>split <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.8</span> <span class="op">*</span> <span class="bu">len</span>(filenames))</span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a>train_indexes, valid_indexes <span class="op">=</span> (</span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a>    shuffled_indexes[:split], shuffled_indexes[split:]</span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>split = int(0.8 * len(filenames))
train_indexes, valid_indexes = (shuffled_indexes[:split], shuffled_indexes[split:]
)</code></pre>
<p>This will find the closest integer that is 80% through the length of our filenames and then split the list of shuffled_indexes by this</p>
</div>
</div>
<p>We can then grab our train and validation filenames:</p>
<div class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>train_fnames <span class="op">=</span> filenames[train_indexes]</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>valid_fnames <span class="op">=</span> filenames[valid_indexes]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="creating-our-datasets" class="level3">
<h3 class="anchored" data-anchor-id="creating-our-datasets">Creating our Datasets</h3>
<p>Finally we need to create the actual dataset objects. To do so we just call our PetsDataset class with the items required:</p>
<div class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>train_dataset <span class="op">=</span> PetsDataset(</span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>    train_fnames,</span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>    train_transforms,</span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a>    label_to_int</span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-7"><a href="#cb187-7" aria-hidden="true" tabindex="-1"></a>valid_dataset <span class="op">=</span> PetsDataset(</span>
<span id="cb187-8"><a href="#cb187-8" aria-hidden="true" tabindex="-1"></a>    valid_fnames,</span>
<span id="cb187-9"><a href="#cb187-9" aria-hidden="true" tabindex="-1"></a>    valid_transforms,</span>
<span id="cb187-10"><a href="#cb187-10" aria-hidden="true" tabindex="-1"></a>    label_to_int</span>
<span id="cb187-11"><a href="#cb187-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can look at one of the items in the dataset:</p>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>x,y <span class="op">=</span> train_dataset[<span class="dv">0</span>]</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>x.shape, y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>(torch.Size([3, 224, 224]), 14)</code></pre>
</div>
</div>
<p>Which has been transformed into a 224x224 tensor, and a class label of 14</p>
</section>
<section id="creating-pytorch-dataloaders" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="creating-pytorch-dataloaders">Creating PyTorch Dataloaders</h3>
<p>Next we need to create a set of DataLoader’s to use. These will get wrapped by fastai’s DataLoaders class, which let’s us use them directly in the framework:</p>
<div class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>train_dataloader <span class="op">=</span> DataLoader(</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>    train_dataset,</span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>    shuffle<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>    drop_last<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">64</span></span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>valid_dataloader <span class="op">=</span> DataLoader(</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>    valid_dataset,</span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">128</span></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>We can increase the batch size to 128 because gradients won’t be calculated during the validation set and we have more memory free.</p>
</div></div><div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.data.core <span class="im">import</span> DataLoaders</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> DataLoaders(train_dataloader, valid_dataloader)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>The DataLoaders class accepts any number of DataLoader’s (from fastai or PyTorch), and each are accessible through dls[index]; however only the first two will be available as dls.train and dls.valid respectively.</p>
</div></div></section>
<section id="creating-a-pytorch-model" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-pytorch-model">Creating a PyTorch Model</h3>
<p>We’ll be doing a similar method to what was shown earlier this lesson to create a pretrained model through PyTorch:</p>
<div class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.models <span class="im">import</span> resnet34</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> resnet34(pretrained<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/stephen137/mambaforge/lib/python3.10/site-packages/torchvision/models/_utils.py:208: UserWarning: The parameter 'pretrained' is deprecated since 0.13 and will be removed in 0.15, please use 'weights' instead.
  warnings.warn(
/home/stephen137/mambaforge/lib/python3.10/site-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for 'weights' are deprecated since 0.13 and will be removed in 0.15. The current behavior is equivalent to passing `weights=ResNet34_Weights.IMAGENET1K_V1`. You can also use `weights=ResNet34_Weights.DEFAULT` to get the most up-to-date weights.
  warnings.warn(msg)</code></pre>
</div>
</div>
<p>And change the last layer’s outputs to be our number of classes:</p>
<div class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>model.fc <span class="op">=</span> nn.Linear(<span class="dv">512</span>, <span class="dv">37</span>, bias<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>model.fc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>Linear(in_features=512, out_features=37, bias=True)</code></pre>
</div>
</div>
<p>The last thing we need to do is perform <strong><em>gradual unfreezing</em></strong> of our layers. What is this?</p>
</section>
<section id="gradual-unfreezing" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="gradual-unfreezing">Gradual Unfreezing</h3>
<section id="in-concept" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="in-concept">In Concept</h4>
<p>When we loaded the model in through vision_learner, it did a number of changes to our model:</p>
<ol type="1">
<li>it “cut off” that fc layer as well as the pooling layer (avgpool) to create a <strong>body</strong></li>
<li>it used create_head to make a <strong>new</strong> head that fastai uses for their vision models</li>
<li>it then <em>froze</em> the backbone of the model, or the body</li>
</ol>

<div class="no-row-height column-margin column-container"><div class="">
<p>Freezing means that the parameters inside that section of the model are considered untrainable, meaning their parameters won’t get updated as we train. This will be applied to both Model Body’s shown</p>
</div></div><p>Essentially, it looks like so:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Walkwithfastai_files/figure-html/cf8f2eeb-bbcb-47aa-a771-4c726a56a7d0.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">flowchart LR.JPG</figcaption><p></p>
</figure>
</div>
<p>While we won’t create a custom head, we will still be performing the freezing:</p>
<div class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(model.children())[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>Linear(in_features=512, out_features=37, bias=True)</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>model.children()</code></pre>
<p>All of a PyTorch model’s layers live in the children() generator. We can find the last layer by turning that into a list and indexing into it properly</p>
</div>
</div>
<div class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> layer <span class="kw">in</span> <span class="bu">list</span>(model.children())[:<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(layer, <span class="st">"requires_grad_"</span>):</span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a>        layer.requires_grad_(<span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-53-contents" aria-controls="callout-53" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Why iterate over all the layers including the pooling layer?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-53" class="callout-53-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Pooling layers have no parameters, so there is no requires_grad_ to be set.</p>
</div>
</div>
</div>
<p>And now the backbone of the model is frozen. We’re almost there!</p>
</section>
</section>
<section id="creating-an-optimizer" class="level3">
<h3 class="anchored" data-anchor-id="creating-an-optimizer">Creating an Optimizer</h3>
<p>The last step we will go over here is creating the Optimizer.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-54-contents" aria-controls="callout-54" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
What is an optimizer?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-54" class="callout-54-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>It is the backbone of our training. It is what goes through and calculates how to update our weights relative to our loss for a particular batch.</p>
</div>
</div>
</div>
<p>By default fastai uses the AdamW optimizer (shown as Adam in fastai). As a result we’ll use it here:</p>
<div class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.optim <span class="im">import</span> AdamW</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To use a PyTorch optimizer in the fastai framework, we make use of an OptimWrapper class fastai has to convert the PyTorch optimizer into something compatible:</p>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.optimizer <span class="im">import</span> OptimWrapper</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>opt_func <span class="op">=</span> partial(OptimWrapper, opt<span class="op">=</span>AdamW)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>partial</code></pre>
<p>A partial function is a function that has overloaded constructors, so when we call opt_func() now it will automatically have the opt parameter be set to the AdamW class.</p>
</div>
</div>
</section>
<section id="bringing-in-fastai-and-training" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="bringing-in-fastai-and-training">Bringing in fastai and Training!</h3>
<p>We have all the steps in place now to finally begin training. As mentioned previously fastai’s training magic is all within the Learner class. As a result, we will import it and any patched methods we want to use:</p>
<div class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.losses <span class="im">import</span> CrossEntropyLossFlat</span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.metrics <span class="im">import</span> accuracy</span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.learner <span class="im">import</span> Learner</span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.callback.schedule <span class="im">import</span> Learner <span class="co"># To get `fit_one_cycle`, `lr_find`, and more</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>To bring in MSELossFlat <span class="citation" data-cites="patched">@patched</span> functions defined in a fastai module, we can import the entire module or import the class. Both do not immediatly pollute the namespace, however the one shown here is better for code clarity</p>
</div></div><p>We then pass all the items we’ve written so far to the Learner:</p>
<div class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> Learner(</span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a>    dls, </span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a>    model, </span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a>    opt_func<span class="op">=</span>opt_func, </span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a>    loss_func<span class="op">=</span>CrossEntropyLossFlat(), </span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a>    metrics<span class="op">=</span>accuracy</span>
<span id="cb209-7"><a href="#cb209-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now we can train like normal!</p>
<div class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="79">
<pre><code>SuggestedLRs(valley=0.0014454397605732083)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Walkwithfastai_files/figure-html/cell-119-output-4.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>, <span class="fl">1e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2.890399</td>
      <td>1.713731</td>
      <td>0.712449</td>
      <td>03:22</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1.406183</td>
      <td>0.670381</td>
      <td>0.860622</td>
      <td>03:23</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.895859</td>
      <td>0.491480</td>
      <td>0.893775</td>
      <td>03:22</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.749822</td>
      <td>0.447594</td>
      <td>0.903924</td>
      <td>03:22</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.694308</td>
      <td>0.435798</td>
      <td>0.902571</td>
      <td>03:22</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</section>
<section id="getting-predictions" class="level3">
<h3 class="anchored" data-anchor-id="getting-predictions">Getting Predictions</h3>
<p>Now that we have a trained model, how do we get predictions? First we’ll open one of our images:</p>
<div class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> Image.<span class="bu">open</span>(filenames[<span class="dv">0</span>])</span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>im</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="81">
<p><img src="Walkwithfastai_files/figure-html/cell-121-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Then we’ll extract the trained model from the Learner</p>
<div class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>net <span class="op">=</span> learn.model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Apply the validation transforms onto the image:</p>
<div class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a>tfm_x <span class="op">=</span> valid_transforms(ToTensor()(im))</span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a>tfm_x <span class="op">=</span> tfm_x.unsqueeze(<span class="dv">0</span>)<span class="op">;</span> tfm_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="91">
<pre><code>torch.Size([1, 3, 224, 224])</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>tfm_x = valid_transforms(ToTensor()(im)) </code></pre>
<p>We apply the valid_transforms to our image after converting it to a tensor</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>tfm_x = tfm_x.unsqueeze(0); tfm_x.shape</code></pre>
<p>Then we need to turn it into a “batch” of one item by adding a single dimension to the front (turning it from (3, 224, 224) to (1, 3, 224, 224))</p>
</div>
</div>
<p>Before finally getting our prediction through raw PyTorch:</p>
<div class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a>net.<span class="bu">eval</span>()</span>
<span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb219-4"><a href="#cb219-4" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> net(tfm_x)</span>
<span id="cb219-5"><a href="#cb219-5" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> preds.argmax(dim<span class="op">=-</span><span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb219-6"><a href="#cb219-6" aria-hidden="true" tabindex="-1"></a>label <span class="op">=</span> <span class="bu">list</span>(label_to_int.keys())[pred]</span>
<span id="cb219-7"><a href="#cb219-7" aria-hidden="true" tabindex="-1"></a>pred, label</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre><code>(tensor(0), 'birman')</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>net.eval()</code></pre>
<p>When performing inference, we set the model to evaluation mode. This modifies any layers that keep track of things during training and are deterministic such as BatchNorm</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>with torch.no_grad():\ preds = net(tfm_x)    </code></pre>
<p>We wrap the prediction around torch.no_grad to skip calculating the gradients. This make inference time a bit faster and saves a bit of memory. Also the input needs to be on the right device (cuda)</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>pred = preds.argmax(dim=-1)[0]
label = list(label_to_int.keys())[pred]</code></pre>
<p>To get the class result, we find what index had the highest value. Since we only predicted on one value we can take the first item. And finally we can take our label_to_int dictionary from earlier and index into it to grab the true label.</p>
</div>
</div>
</section>
</section>
</section>
<section id="lesson-3" class="level1 page-columns page-full">
<h1>Lesson 3</h1>
<section id="multi-label-classification" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="multi-label-classification">3.1 Multi-Label Classification</h2>
<section id="introduction-2" class="level3">
<h3 class="anchored" data-anchor-id="introduction-2">Introduction</h3>
<p>In this lesson we will focus on dealing with multi-labelled images. In the prior edition of Walk with fastai this was done using the high level API, however in the spirit of revisited we will be doing so with the mid-level API and will continue to use it throughout the rest of this course.</p>
<p>This will be a <em>vision</em> problem so again we will import the <em>vision</em> library:</p>
<div class="cell" data-execution_count="94">
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="exploring-the-data" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="exploring-the-data">Exploring the data</h3>
<p>For this problem we will use the Planet dataset, a collection of satellite images with multiple labels describing the scene. First let’s download the data:</p>
<div class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb225"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a>src <span class="op">=</span> untar_data(URLs.PLANET_SAMPLE)</span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(src<span class="op">/</span><span class="st">'labels.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="15532032" class="" max="15523994" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.05% [15532032/15523994 00:01&lt;00:00]
    </div>
    
</div>
</div>
<p>And then take a peek:</p>
<div class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="97">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>image_name</th>
      <th>tags</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>train_21983</td>
      <td>partly_cloudy primary</td>
    </tr>
    <tr>
      <th>1</th>
      <td>train_9516</td>
      <td>clear cultivation primary water</td>
    </tr>
    <tr>
      <th>2</th>
      <td>train_12664</td>
      <td>haze primary</td>
    </tr>
    <tr>
      <th>3</th>
      <td>train_36960</td>
      <td>clear primary</td>
    </tr>
    <tr>
      <th>4</th>
      <td>train_5302</td>
      <td>haze primary road</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>For this problem we have an <strong>image_name</strong> column and a <strong>tags</strong> column. The labels are also seperated by a space.</p>
<p>Similar to what we did for the Kaggle dataset, let’s look at how the labels are distributed:</p>
<div class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb227"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a>all_tags <span class="op">=</span> df[<span class="st">"tags"</span>].values</span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a>all_labels <span class="op">=</span> []</span>
<span id="cb227-3"><a href="#cb227-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-4"><a href="#cb227-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> all_tags:</span>
<span id="cb227-5"><a href="#cb227-5" aria-hidden="true" tabindex="-1"></a>    all_labels <span class="op">+=</span> row.split(<span class="st">" "</span>)</span>
<span id="cb227-6"><a href="#cb227-6" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(all_labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="98">
<pre><code>2899</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>all_tags = df["tags"].values</code></pre>
<p>The labels are located in the “all_tags” column, and we can extract the raw values as a regular array using the .values attribute</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>all_labels = []
for row in all_tags:
    all_labels += row.split(" ")</code></pre>
<p>Since each row’s tags are split by a space, we can turn this string into an array and add these values directly into our all_labels array. This will be a giant list that has many repeated values on purpose.</p>
</div>
</div>
<p>In total there are 2,899 labels, but this doesn’t tell us how many <em>different</em> labels there are. Let’s find out:</p>
<div class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb231"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a>different_labels <span class="op">=</span> <span class="bu">set</span>(all_labels)</span>
<span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(different_labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="99">
<pre><code>17</code></pre>
</div>
</div>
<p>Only 17! Let’s see the distribution of these labels:</p>
<div class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb233"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> {</span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a>    label: all_labels.count(label) </span>
<span id="cb233-3"><a href="#cb233-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> label <span class="kw">in</span> different_labels</span>
<span id="cb233-4"><a href="#cb233-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb233-5"><a href="#cb233-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-6"><a href="#cb233-6" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> {</span>
<span id="cb233-7"><a href="#cb233-7" aria-hidden="true" tabindex="-1"></a>    key: value </span>
<span id="cb233-8"><a href="#cb233-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key, value <span class="kw">in</span> </span>
<span id="cb233-9"><a href="#cb233-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">sorted</span>(</span>
<span id="cb233-10"><a href="#cb233-10" aria-hidden="true" tabindex="-1"></a>        counts.items(), </span>
<span id="cb233-11"><a href="#cb233-11" aria-hidden="true" tabindex="-1"></a>        key <span class="op">=</span> <span class="kw">lambda</span> item: <span class="op">-</span>item[<span class="dv">1</span>]</span>
<span id="cb233-12"><a href="#cb233-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb233-13"><a href="#cb233-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>label: all_labels.count(label)</code></pre>
<p>Python lists contain a method called count which can take in an item and count how many times it occurs in the list.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>counts = {
key: value 
for key, value in 
sorted(
    counts.items(), 
    key = lambda item: -item[1]
) }</code></pre>
<p>To make our lives easier, we can sort the list by the number of instances found.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>key = lambda item: -item[1]</code></pre>
<p>To make the dictionary be sorted from highest to lowest occurences, we sort by the negative of the actual value</p>
</div>
</div>
<div class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb237"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a>counts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="102">
<pre><code>{'primary': 934,
 'clear': 701,
 'agriculture': 318,
 'road': 209,
 'partly_cloudy': 194,
 'water': 169,
 'cultivation': 124,
 'habitation': 93,
 'haze': 55,
 'cloudy': 50,
 'bare_ground': 19,
 'blooming': 9,
 'selective_logging': 8,
 'artisinal_mine': 7,
 'slash_burn': 6,
 'conventional_mine': 2,
 'blow_down': 1}</code></pre>
</div>
</div>
<p>What we find is that selective_logging, artisinal_mine, slash_burn, conventional_mine, and blow_down had the least number of occurances. For the sake of todays lesson we will get rid of rows with these values.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>Typically a Data Scientist has two choices when it comes to dealing with rare values, either leaving them in as they are or performing <strong>oversampling</strong>. We’re dropping them for convenience but normally we would want to oversample the training dataset for rare values and ensure the validation dataset has a few instances of them to test on.</p>
</div></div><p>Next we’ll use some pandas magic to filter our dataframe by these values:</p>
<div class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="103">
<pre><code>1000</code></pre>
</div>
</div>
<div class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key, count <span class="kw">in</span> counts.items():</span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> count <span class="op">&lt;</span> <span class="dv">10</span>:</span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df[df[<span class="st">"tags"</span>].<span class="bu">str</span>.contains(key) <span class="op">==</span> <span class="va">False</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>if count &lt; 10: </code></pre>
<p>Since we’re limiting it based on rare values, we’ll arbitrarily get rid of classes that occur less than 10 times</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>df['tags'].str</code></pre>
<p>This converts each rows item into a string and we can utilize methods inside the str class to be applied on every single row</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>.contains(key) == False</code></pre>
<p>From here we then look for if any of these rows have our rare class, and only keep the ones that do not.</p>
</div>
</div>
<div class="cell" data-execution_count="105">
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="105">
<pre><code>968</code></pre>
</div>
</div>
<p>Despite what seemed like getting rid of quite a lot of classes, they only showed up in &lt; 40 rows. In the real world one would want to try and get more data from these underrepresented classes if possible, or perform oversampling on them.</p>
<p>Next let’s take a look at one of the images:</p>
<div class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb247"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"image_name"</span>].head(), src.ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="106">
<pre><code>(0    train_21983
 1     train_9516
 2    train_12664
 3    train_36960
 4     train_5302
 Name: image_name, dtype: object,
 (#2) [Path('/home/stephen137/.fastai/data/planet_sample/labels.csv'),Path('/home/stephen137/.fastai/data/planet_sample/train')])</code></pre>
</div>
</div>
<p>We get a partial string of the filename, and based on looking at how the data source is setup they live in the train folder. Let’s look in there:</p>
<div class="cell" data-execution_count="107">
<div class="sourceCode cell-code" id="cb249"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a>(src<span class="op">/</span><span class="st">'train'</span>).ls()[:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="107">
<pre><code>(#3) [Path('/home/stephen137/.fastai/data/planet_sample/train/train_34232.jpg'),Path('/home/stephen137/.fastai/data/planet_sample/train/train_37605.jpg'),Path('/home/stephen137/.fastai/data/planet_sample/train/train_18029.jpg')]</code></pre>
</div>
</div>
<p>Each image has the extension .jpg:</p>
<div class="cell" data-execution_count="108">
<div class="sourceCode cell-code" id="cb251"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a>PILImage.create((src<span class="op">/</span><span class="st">'train'</span><span class="op">/</span><span class="st">'train_34232.jpg'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="108">
<p><img src="Walkwithfastai_files/figure-html/cell-137-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We now have enough to build ourselves a Datasets object!</p>
</section>
<section id="working-with-fastai-datasets" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="working-with-fastai-datasets">Working with fastai Datasets</h3>
<p>Next let’s build a Datasets object. Here’s what we know:</p>
<p><strong>x and y</strong></p>
<ul>
<li>x: Our x’s are colored images, meaning we should use PILImage</li>
<li>y: Our y’s are multilabeled images, meaning we should use MultiCategorize</li>
</ul>
<p><strong>Getting the items</strong></p>
<p>We need to write a set of getters to get each one based on looking at a single row of data</p>
<ul>
<li>x: Our x’s are located at src/‘train’/{fname}.jpg, so this can be written as a function that looks at the image_name column</li>
<li>y: Our y’s are a split string based on the tags column, and this too can be written as a function</li>
</ul>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-69-contents" aria-controls="callout-69" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Why as functions?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-69" class="callout-69-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Technically these can be written as lambda functions, such as lambda x: print(x) however lambda’s are not pickleable, meaning if you export the Learner it will give you an error of something along the lines of “Cannot pickle lambda …”. The solution is to define them as seperate functions that you pull in somewhere before importing the Learner</p>
</div>
</div>
</div>
<p><strong>Splitting the data</strong></p>
<p>There is no set value for what is “train” or “validation”, so we can randomly split the dataset again</p>
<p>Let’s build everything that was just described:</p>
<div class="cell" data-execution_count="109">
<div class="sourceCode cell-code" id="cb252"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_x(row:pd.Series) <span class="op">-&gt;</span> Path:</span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (src<span class="op">/</span><span class="st">'train'</span><span class="op">/</span>row.image_name).with_suffix(<span class="st">".jpg"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>Using with_suffix on a pathlib.Path object will either replace or add the defined suffix to the last item in the path.</p>
</div></div><div class="cell" data-execution_count="110">
<div class="sourceCode cell-code" id="cb253"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_y(row:pd.Series) <span class="op">-&gt;</span> List[<span class="bu">str</span>]:</span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> row.tags.split(<span class="st">" "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="111">
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>row <span class="op">=</span> df.iloc[<span class="dv">0</span>]</span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>get_x(row), get_y(row)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="111">
<pre><code>(Path('/home/stephen137/.fastai/data/planet_sample/train/train_21983.jpg'),
 ['partly_cloudy', 'primary'])</code></pre>
</div>
</div>
<p>Now that we’ve seen how these are written, in fastai there exists a labeller we can use instead called the <strong>ColReader</strong> which takes in the index of the column and any adjustments we want to make:</p>
<div class="cell" data-execution_count="112">
<div class="sourceCode cell-code" id="cb256"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a>get_x <span class="op">=</span> ColReader(<span class="dv">0</span>, pref<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>src<span class="sc">}</span><span class="ss">/train/'</span>, suff<span class="op">=</span><span class="st">".jpg"</span>)</span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a>get_y <span class="op">=</span> ColReader(<span class="dv">1</span>, label_delim<span class="op">=</span><span class="st">" "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="113">
<div class="sourceCode cell-code" id="cb257"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a>tfms <span class="op">=</span> [</span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a>    [get_x, PILImage.create], </span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a>        get_y,</span>
<span id="cb257-5"><a href="#cb257-5" aria-hidden="true" tabindex="-1"></a>        MultiCategorize(vocab<span class="op">=</span>different_labels), </span>
<span id="cb257-6"><a href="#cb257-6" aria-hidden="true" tabindex="-1"></a>        OneHotEncode(<span class="bu">len</span>(different_labels))</span>
<span id="cb257-7"><a href="#cb257-7" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb257-8"><a href="#cb257-8" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>MultiCategorize(vocab=different_labels)</code></pre>
<p>We need to explicitly pass in the list of different class labels to use here.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>OneHotEncode(len(different_labels))</code></pre>
<p>For our particular problem, just doing MultiCategorize isn’t quite enough, we also need to do OneHotEncode. This is because MultiCategorize will just turn our labels into something like 17, 22 (the index’s into the vocab), we need to turn it into [0, 0, …1, …1, …0] where each 1 represents a label present in the image. But to do so we must pass in the number of different labels present.</p>
</div>
</div>
<div class="cell" data-execution_count="114">
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a>train_idxs, valid_idxs <span class="op">=</span> (</span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a>    RandomSplitter(valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>)(df)</span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>The <strong>RandomSplitter</strong> can accept a validation percentage as well as a random seed to be set during the splitting. After instantiating the class we can then pass in any items we want to have split, such as our dataframe here.</p>
</div></div><div class="cell" data-execution_count="115">
<div class="sourceCode cell-code" id="cb261"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a>train_idxs, valid_idxs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="115">
<pre><code>((#775) [888,918,313,104,751,504,661,774,492,634...],
 (#193) [622,943,48,152,686,547,418,768,558,863...])</code></pre>
</div>
</div>
<p>Now we can build the datasets object!</p>
<div class="cell" data-execution_count="116">
<div class="sourceCode cell-code" id="cb263"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a>dsets <span class="op">=</span> Datasets(df, tfms<span class="op">=</span>tfms, splits<span class="op">=</span>[train_idxs, valid_idxs])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="117">
<div class="sourceCode cell-code" id="cb264"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a>dsets.train[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="117">
<pre><code>(PILImage mode=RGB size=256x256,
 TensorMultiCategory([0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0.,
                      0., 1.]))</code></pre>
</div>
</div>
<p>We now return the <strong>PILImage</strong> expected as well as our one-hot encoded labels!</p>
<div class="cell" data-execution_count="120">
<div class="sourceCode cell-code" id="cb266"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a>show_at(dsets.train, <span class="dv">0</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Walkwithfastai_files/figure-html/cell-147-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="building-some-dataloaders-1" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="building-some-dataloaders-1">Building some DataLoaders</h3>
<p>Lastly we need to build some DataLoaders. The fastai Datasets class has a .dataloaders() function for us to do so easily, we just need to pass in some transforms to use:</p>
<div class="cell" data-execution_count="121">
<div class="sourceCode cell-code" id="cb267"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a>batch_tfms <span class="op">=</span> [</span>
<span id="cb267-2"><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a>    IntToFloatTensor(), </span>
<span id="cb267-3"><a href="#cb267-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>aug_transforms(</span>
<span id="cb267-4"><a href="#cb267-4" aria-hidden="true" tabindex="-1"></a>        flip_vert<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb267-5"><a href="#cb267-5" aria-hidden="true" tabindex="-1"></a>        max_lighting<span class="op">=</span><span class="fl">0.1</span>, </span>
<span id="cb267-6"><a href="#cb267-6" aria-hidden="true" tabindex="-1"></a>        max_zoom<span class="op">=</span><span class="fl">1.05</span>, </span>
<span id="cb267-7"><a href="#cb267-7" aria-hidden="true" tabindex="-1"></a>        max_warp<span class="op">=</span><span class="fl">0.</span></span>
<span id="cb267-8"><a href="#cb267-8" aria-hidden="true" tabindex="-1"></a>    ), </span>
<span id="cb267-9"><a href="#cb267-9" aria-hidden="true" tabindex="-1"></a>    Normalize.from_stats(<span class="op">*</span>imagenet_stats)</span>
<span id="cb267-10"><a href="#cb267-10" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="122">
<div class="sourceCode cell-code" id="cb268"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dsets.dataloaders(</span>
<span id="cb268-2"><a href="#cb268-2" aria-hidden="true" tabindex="-1"></a>    after_item<span class="op">=</span>[ToTensor], </span>
<span id="cb268-3"><a href="#cb268-3" aria-hidden="true" tabindex="-1"></a>    after_batch<span class="op">=</span>batch_tfms</span>
<span id="cb268-4"><a href="#cb268-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>You may notice that we don’t pass any Resize or other augmentation to the item transforms, just <strong>ToTensor</strong>. This is because all of the images are already 256x256, so there isn’t a need to and we can just jump to augmenting the data on the GPU.</p>
</div></div><p>Let’s look at a batch of data to make sure everything looks correct:</p>
<div class="cell" data-execution_count="123">
<div class="sourceCode cell-code" id="cb269"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Walkwithfastai_files/figure-html/cell-150-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Great! Now to train a model</p>
</section>
<section id="training-a-model" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="training-a-model">Training a Model</h3>
<p>Similar to our previous problem, we will use the baseline resnet34 for this task, and since we are looking at multiple labels we will want to use the <strong>accuracy_multi</strong> metric:</p>
<div class="cell" data-execution_count="124">
<div class="sourceCode cell-code" id="cb270"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet34, metrics<span class="op">=</span>[accuracy_multi])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/stephen137/mambaforge/lib/python3.10/site-packages/torchvision/models/_utils.py:208: UserWarning: The parameter 'pretrained' is deprecated since 0.13 and will be removed in 0.15, please use 'weights' instead.
  warnings.warn(
/home/stephen137/mambaforge/lib/python3.10/site-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for 'weights' are deprecated since 0.13 and will be removed in 0.15. The current behavior is equivalent to passing `weights=ResNet34_Weights.IMAGENET1K_V1`. You can also use `weights=ResNet34_Weights.DEFAULT` to get the most up-to-date weights.
  warnings.warn(msg)</code></pre>
</div>
</div>
<p>Let’s take a look at a few of the defaults fastai set for us:</p>
<div class="cell" data-execution_count="125">
<div class="sourceCode cell-code" id="cb272"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a>learn.model[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="125">
<pre><code>Sequential(
  (0): AdaptiveConcatPool2d(
    (ap): AdaptiveAvgPool2d(output_size=1)
    (mp): AdaptiveMaxPool2d(output_size=1)
  )
  (1): fastai.layers.Flatten(full=False)
  (2): BatchNorm1d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (3): Dropout(p=0.25, inplace=False)
  (4): Linear(in_features=1024, out_features=512, bias=False)
  (5): ReLU(inplace=True)
  (6): BatchNorm1d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (7): Dropout(p=0.5, inplace=False)
  (8): Linear(in_features=512, out_features=17, bias=False)
)</code></pre>
</div>
</div>
<p>We can see that the head of our model is still exactly the same, since we have a total of 17 classes that can show up. So what needs to change for our multi-label problem?</p>
<div class="cell" data-execution_count="126">
<div class="sourceCode cell-code" id="cb274"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a>learn.loss_func</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="126">
<pre><code>FlattenedLoss of BCEWithLogitsLoss()</code></pre>
</div>
</div>
<p>The <strong>loss function</strong>.</p>
<p>The difference between normal Cross Entropy and Binary Cross Entropy with Logits is rather than performing a <em>softmax</em>, we instead perform what is called a <strong>sigmoid</strong> operation and use <strong>nn.BCEWithLogitsLoss</strong> instead of <em>nn.CrossEntropyLoss</em>:</p>
<div class="cell" data-execution_count="127">
<div class="sourceCode cell-code" id="cb276"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> tensor([[<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.3</span>, <span class="fl">0.7</span>, <span class="fl">0.2</span>]])</span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a>torch.sigmoid(t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="127">
<pre><code>tensor([[0.5250, 0.6225, 0.5744, 0.6682, 0.5498]])</code></pre>
</div>
</div>
<p>After <em>scaling</em> we can then also limit what is perceved as “seen” vs “not seen” through a threshold:</p>
<div class="cell" data-execution_count="129">
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a>learn.loss_func.thresh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="129">
<pre><code>0.5</code></pre>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>This essentially means that if there are any results that are less than 0.5 from the output of our sigmoid then we ignore them and assume they are not there.</p>
</div></div><div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Keeping the thresholds aligned!
</div>
</div>
<div class="callout-body-container callout-body">
<p>It’s <strong>extremely important</strong> to remember the metric and loss function’s thresholds should be the exact same otherwise you’re looking at two different versions of the same result. E.g. while you can just change the metric’s threshold to be 0.6, the loss function will still be 0.5 so you’re not actually training with the assumption that the right answer should be &gt; 0.6</p>
</div>
</div>
<p>Now that we have everything setup, let’s find a learning rate and train!</p>
<div class="cell" data-execution_count="130">
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="130">
<pre><code>SuggestedLRs(valley=0.0020892962347716093)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Walkwithfastai_files/figure-html/cell-156-output-4.png" class="img-fluid"></p>
</div>
</div>
<p>We find that 2e-3 is a pretty good learning rate, so let’s do some fine tuning!</p>
<div class="cell" data-execution_count="131">
<div class="sourceCode cell-code" id="cb282"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">1</span>, <span class="bu">slice</span>(<span class="fl">2e-3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy_multi</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.958438</td>
      <td>0.820993</td>
      <td>0.560805</td>
      <td>00:54</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>Then we’ll unfreeze and train a bit more:</p>
<div class="cell" data-execution_count="132">
<div class="sourceCode cell-code" id="cb283"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a>learn.unfreeze()</span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>, <span class="bu">slice</span>(<span class="fl">2e-3</span><span class="op">/</span><span class="fl">2.6</span><span class="op">**</span><span class="dv">4</span>, <span class="fl">2e-3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy_multi</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.848786</td>
      <td>0.768949</td>
      <td>0.575130</td>
      <td>01:17</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.786721</td>
      <td>0.662387</td>
      <td>0.704358</td>
      <td>01:17</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.712081</td>
      <td>0.484378</td>
      <td>0.804023</td>
      <td>01:18</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.643590</td>
      <td>0.420974</td>
      <td>0.874429</td>
      <td>01:18</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.593340</td>
      <td>0.394490</td>
      <td>0.900335</td>
      <td>01:16</td>
    </tr>
  </tbody>
</table>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>This lr/2.6**4 is a general rule of thumb that Jeremy Howard found works quite well when doing gradual unfreezing, see the <a href="https://github.com/fastai/fastai/blob/master/nbs/examples/ulmfit.ipynb">ULMFiT notebook</a> to see it in practice!</p>
</div></div><p>And now let’s look at our results:</p>
<div class="cell" data-execution_count="133">
<div class="sourceCode cell-code" id="cb284"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a>learn.show_results(figsize<span class="op">=</span>(<span class="dv">15</span>,<span class="dv">15</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="Walkwithfastai_files/figure-html/cell-159-output-3.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="predictions-in-the-wild" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="predictions-in-the-wild">Predictions in the wild</h3>
<p>While we’ve looked at how to train, let’s look at how to predict and get back our answers without using the fastai API.</p>
<div class="cell" data-execution_count="134">
<div class="sourceCode cell-code" id="cb285"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> learn.model</span>
<span id="cb285-2"><a href="#cb285-2" aria-hidden="true" tabindex="-1"></a>fname <span class="op">=</span> get_x(df.iloc[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First, the item transforms:</p>
<div class="cell" data-execution_count="135">
<div class="sourceCode cell-code" id="cb286"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> Image.<span class="bu">open</span>(fname)</span>
<span id="cb286-2"><a href="#cb286-2" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> im.convert(<span class="st">"RGB"</span>)</span>
<span id="cb286-3"><a href="#cb286-3" aria-hidden="true" tabindex="-1"></a>t_im <span class="op">=</span> tensor(im)</span>
<span id="cb286-4"><a href="#cb286-4" aria-hidden="true" tabindex="-1"></a>t_im <span class="op">=</span> t_im.permute(<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">1</span>).<span class="bu">type</span>(torch.uint8)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>im = Image.open(fname)
im = im.convert("RGB")</code></pre>
<p>First we will open the file using Pillow and convert it to an RGB image</p>
</div>
</div>
<div class="cell" data-execution_count="136">
<div class="sourceCode cell-code" id="cb288"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> Image.<span class="bu">open</span>(fname)</span>
<span id="cb288-2"><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> im.convert(<span class="st">"RGB"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>t_im = tensor(im)
t_im = t_im.permute(2,0,1)</code></pre>
<p>Then we need to convert it to a tensor and turn the image into something PyTorch would expect, so the channel order needs to be one of <strong>CxWxH</strong> while it is currently <strong>WxHxC</strong>.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>.type(torch.uint8)</code></pre>
<p>Finally we convert it into an int tensor</p>
</div>
</div>
<p>Then the batch transforms:</p>
<div class="cell" data-execution_count="137">
<div class="sourceCode cell-code" id="cb291"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a>t_im <span class="op">=</span> t_im.unsqueeze(<span class="dv">0</span>)</span>
<span id="cb291-2"><a href="#cb291-2" aria-hidden="true" tabindex="-1"></a>t_im <span class="op">=</span> t_im.<span class="bu">float</span>().div_(<span class="fl">255.</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>t_im = t_im.unsqueeze(0)</code></pre>
<p>First we turn the single image into a batch of 1</p>
</div>
</div>
<div class="cell" data-execution_count="138">
<div class="sourceCode cell-code" id="cb293"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a>t_im <span class="op">=</span> t_im.<span class="bu">float</span>().div_(<span class="fl">255.</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>t_im = t_im.float().div_(255.)</code></pre>
<p>Then we turn the tensor into a float and divide it by 255 as pixel values range from 0-256.</p>
</div>
</div>
<div class="cell" data-execution_count="140">
<div class="sourceCode cell-code" id="cb295"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a>mean, std <span class="op">=</span> (</span>
<span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>], </span>
<span id="cb295-3"><a href="#cb295-3" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>]</span>
<span id="cb295-4"><a href="#cb295-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb295-5"><a href="#cb295-5" aria-hidden="true" tabindex="-1"></a>vector <span class="op">=</span> [<span class="dv">1</span>]<span class="op">*</span><span class="dv">4</span></span>
<span id="cb295-6"><a href="#cb295-6" aria-hidden="true" tabindex="-1"></a>vector[<span class="dv">1</span>] <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb295-7"><a href="#cb295-7" aria-hidden="true" tabindex="-1"></a>mean <span class="op">=</span> tensor(mean).view(<span class="op">*</span>vector)</span>
<span id="cb295-8"><a href="#cb295-8" aria-hidden="true" tabindex="-1"></a>std <span class="op">=</span> tensor(std).view(<span class="op">*</span>vector)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>mean, std = (
[0.485, 0.456, 0.406], 
[0.229, 0.224, 0.225]
)</code></pre>
<p>First we need the mean and standard deviation of ImageNet</p>
</div>
</div>
<div class="cell" data-execution_count="141">
<div class="sourceCode cell-code" id="cb297"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a>vector <span class="op">=</span> [<span class="dv">1</span>]<span class="op">*</span><span class="dv">4</span></span>
<span id="cb297-2"><a href="#cb297-2" aria-hidden="true" tabindex="-1"></a>vector[<span class="dv">1</span>] <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>vector = [1]*4
vector[1] = -1</code></pre>
<p>Then we create a vector of how these two sets of three numbers should be formatted so that a matrix multiplication between the image and the setting can be performed</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>mean = tensor(mean).view(*vector)
std = tensor(std).view(*vector)</code></pre>
<p>Finally we apply these two formats to the tensors and return them</p>
</div>
</div>
<div class="cell" data-execution_count="143">
<div class="sourceCode cell-code" id="cb300"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a>mean.shape, std.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="143">
<pre><code>(torch.Size([1, 3, 1, 1]), torch.Size([1, 3, 1, 1]))</code></pre>
</div>
</div>
<p>And now we can normalize the data!</p>
<div class="cell" data-execution_count="144">
<div class="sourceCode cell-code" id="cb302"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a>t_im <span class="op">=</span> (t_im <span class="op">-</span> mean) <span class="op">/</span> std</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="145">
<div class="sourceCode cell-code" id="cb303"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb303-1"><a href="#cb303-1" aria-hidden="true" tabindex="-1"></a>t_im.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="145">
<pre><code>torch.Size([1, 3, 256, 256])</code></pre>
</div>
</div>
<p>Now all that’s left is to get our predictions:</p>
<div class="cell" data-execution_count="147">
<div class="sourceCode cell-code" id="cb305"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.inference_mode():</span>
<span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb305-3"><a href="#cb305-3" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> model(t_im)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>We use <strong><em>inference_mode</em></strong> here instead of <em>no_grad</em> as *<strong>inference_mode</strong> is a more powerful version of no_grad. Find out more in the <a href="https://pytorch.org/docs/stable/generated/torch.inference_mode.html">docs</a></p>
</div></div><div class="cell" data-execution_count="148">
<div class="sourceCode cell-code" id="cb306"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a>preds.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="148">
<pre><code>torch.Size([1, 17])</code></pre>
</div>
</div>
<p>Now that we have our predictions, we need to perform the sigmoid operation, find the limit, and grab the ones present:</p>
<div class="cell" data-execution_count="149">
<div class="sourceCode cell-code" id="cb308"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a>decoded_preds <span class="op">=</span> torch.sigmoid(preds) <span class="op">&gt;</span> <span class="fl">0.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="150">
<div class="sourceCode cell-code" id="cb309"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a>decoded_preds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="150">
<pre><code>TensorBase([[False, False,  True, False, False, False, False, False, False,
             False, False, False, False, False, False, False, False]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="151">
<div class="sourceCode cell-code" id="cb311"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb311-1"><a href="#cb311-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> compress</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="152">
<div class="sourceCode cell-code" id="cb312"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a>present_labels <span class="op">=</span> <span class="bu">list</span>(compress(</span>
<span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span><span class="bu">list</span>(different_labels), selectors<span class="op">=</span>decoded_preds[<span class="dv">0</span>]</span>
<span id="cb312-3"><a href="#cb312-3" aria-hidden="true" tabindex="-1"></a>    ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>compress(
    data=list(different_labels), selectors=decoded_preds[0]
)</code></pre>
<p>The compress function creates an iterator that filters elements based on some boolean array, which is what our decoded_preds are originally. We can use this to find what labels are actually present!</p>
</div>
</div>
<div class="cell" data-execution_count="153">
<div class="sourceCode cell-code" id="cb314"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a>present_labels</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="153">
<pre><code>['cloudy']</code></pre>
</div>
</div>
<p>And now we’ve successfully done what fastai does during predictions end-to-end:</p>
<div class="cell" data-execution_count="154">
<div class="sourceCode cell-code" id="cb316"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb316-1"><a href="#cb316-1" aria-hidden="true" tabindex="-1"></a>learn.predict(fname)[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="154">
<pre><code>(#2) ['partly_cloudy','cloudy']</code></pre>
</div>
</div>
<p>Here’s the code again for a quick copy-paste:</p>
<div class="cell" data-execution_count="160">
<div class="sourceCode cell-code" id="cb318"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb318-1"><a href="#cb318-1" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> Image.<span class="bu">open</span>(fname)</span>
<span id="cb318-2"><a href="#cb318-2" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> im.convert(<span class="st">"RGB"</span>)</span>
<span id="cb318-3"><a href="#cb318-3" aria-hidden="true" tabindex="-1"></a>t_im <span class="op">=</span> tensor(im)</span>
<span id="cb318-4"><a href="#cb318-4" aria-hidden="true" tabindex="-1"></a>t_im <span class="op">=</span> t_im.permute(<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">1</span>).<span class="bu">type</span>(torch.uint8)</span>
<span id="cb318-5"><a href="#cb318-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb318-6"><a href="#cb318-6" aria-hidden="true" tabindex="-1"></a>mean, std <span class="op">=</span> (</span>
<span id="cb318-7"><a href="#cb318-7" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>], </span>
<span id="cb318-8"><a href="#cb318-8" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>]</span>
<span id="cb318-9"><a href="#cb318-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb318-10"><a href="#cb318-10" aria-hidden="true" tabindex="-1"></a>vector <span class="op">=</span> [<span class="dv">1</span>]<span class="op">*</span><span class="dv">4</span></span>
<span id="cb318-11"><a href="#cb318-11" aria-hidden="true" tabindex="-1"></a>vector[<span class="dv">1</span>] <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb318-12"><a href="#cb318-12" aria-hidden="true" tabindex="-1"></a>mean <span class="op">=</span> tensor(mean).view(<span class="op">*</span>vector)</span>
<span id="cb318-13"><a href="#cb318-13" aria-hidden="true" tabindex="-1"></a>std <span class="op">=</span> tensor(std).view(<span class="op">*</span>vector)</span>
<span id="cb318-14"><a href="#cb318-14" aria-hidden="true" tabindex="-1"></a>t_im <span class="op">=</span> (t_im <span class="op">-</span> mean) <span class="op">/</span> std</span>
<span id="cb318-15"><a href="#cb318-15" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.inference_mode():</span>
<span id="cb318-16"><a href="#cb318-16" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb318-17"><a href="#cb318-17" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> model(t_im)</span>
<span id="cb318-18"><a href="#cb318-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb318-19"><a href="#cb318-19" aria-hidden="true" tabindex="-1"></a>decoded_preds <span class="op">=</span> torch.sigmoid(preds) <span class="op">&gt;</span> <span class="fl">0.5</span></span>
<span id="cb318-20"><a href="#cb318-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb318-21"><a href="#cb318-21" aria-hidden="true" tabindex="-1"></a>present_labels <span class="op">=</span> <span class="bu">list</span>(compress(</span>
<span id="cb318-22"><a href="#cb318-22" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span><span class="bu">list</span>(different_labels), selectors<span class="op">=</span>decoded_preds[<span class="dv">0</span>]</span>
<span id="cb318-23"><a href="#cb318-23" aria-hidden="true" tabindex="-1"></a>    ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="161">
<div class="sourceCode cell-code" id="cb319"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a>present_labels </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="161">
<pre><code>['partly_cloudy',
 'habitation',
 'cloudy',
 'selective_logging',
 'blooming',
 'road',
 'cultivation',
 'bare_ground',
 'water',
 'agriculture']</code></pre>
</div>
</div>
</section>
</section>
<section id="recognizing-unknown-images-or-the-unknown-label-problem" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="recognizing-unknown-images-or-the-unknown-label-problem">3.2 Recognizing Unknown Images, or the Unknown Label Problem</h2>
<section id="introduction-3" class="level3">
<h3 class="anchored" data-anchor-id="introduction-3">Introduction</h3>
<p>So far we’ve seen applications where you have a single image on a label and multiple images on a label. This lesson will be a mixture of the two as we try to address a real-world problem:</p>
<ul>
<li>if a machine learning model has n outputs and is designed to tell that there will always be one correct answer, what do you do if an image has no right answer?</li>
</ul>
<p>Let’s imagine a scenario where we trained a dog and cat classifier. What would happen if we gave it a picture of a bird? The raw probabilities out of the model would still sum to 1 for dog or cat, and if we took the <strong>argmax</strong> it would return either dog or cat, even though it’s neither! So, what can we do?</p>
</section>
<section id="fake-it-till-you-make-it-turn-single-label-to-multilabel" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="fake-it-till-you-make-it-turn-single-label-to-multilabel">Fake it till you make it, turn single label to multilabel</h3>
<p>The answer is through using <strong>multi-label classification</strong>. The way it worked in our previous lesson is <em>Binary Cross Entropy (BCE)</em> would find and return the probability that any of the n labels were present and we converted this to a boolean tensor from 0-n.&nbsp;This also means that we could have a tensor of size <strong><em>n</em></strong> where every answer is False, meaning no recognizable classes are there!</p>
<p>This is exactly what we will perform today. First let’s import fastai and download the PETs dataset again:</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb321"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb322"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb322-1"><a href="#cb322-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.PETS)<span class="op">/</span><span class="st">'images'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we’ll bring back our code we used originally to create our DataBlock:</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb323"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb323-1"><a href="#cb323-1" aria-hidden="true" tabindex="-1"></a>fnames <span class="op">=</span> get_image_files(path<span class="op">/</span><span class="st">'images'</span>)</span>
<span id="cb323-2"><a href="#cb323-2" aria-hidden="true" tabindex="-1"></a>pat <span class="op">=</span> <span class="vs">r'(.+)_\d+.jpg$'</span></span>
<span id="cb323-3"><a href="#cb323-3" aria-hidden="true" tabindex="-1"></a>item_tfms <span class="op">=</span> RandomResizedCrop(<span class="dv">460</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>, ratio<span class="op">=</span>(<span class="fl">1.</span>,<span class="fl">1.</span>))</span>
<span id="cb323-4"><a href="#cb323-4" aria-hidden="true" tabindex="-1"></a>batch_tfms <span class="op">=</span> [<span class="op">*</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, max_warp<span class="op">=</span><span class="dv">0</span>), Normalize.from_stats(<span class="op">*</span>imagenet_stats)]</span>
<span id="cb323-5"><a href="#cb323-5" aria-hidden="true" tabindex="-1"></a>bs<span class="op">=</span><span class="dv">64</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb324"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb324-1"><a href="#cb324-1" aria-hidden="true" tabindex="-1"></a>pets <span class="op">=</span> DataBlock(blocks<span class="op">=</span>(ImageBlock, CategoryBlock),</span>
<span id="cb324-2"><a href="#cb324-2" aria-hidden="true" tabindex="-1"></a>                 get_items<span class="op">=</span>get_image_files,</span>
<span id="cb324-3"><a href="#cb324-3" aria-hidden="true" tabindex="-1"></a>                 splitter<span class="op">=</span>RandomSplitter(),</span>
<span id="cb324-4"><a href="#cb324-4" aria-hidden="true" tabindex="-1"></a>                 get_y<span class="op">=</span>RegexLabeller(pat <span class="op">=</span> <span class="vs">r'/([^/]+)_\d+.*'</span>),</span>
<span id="cb324-5"><a href="#cb324-5" aria-hidden="true" tabindex="-1"></a>                 item_tfms<span class="op">=</span>item_tfms,</span>
<span id="cb324-6"><a href="#cb324-6" aria-hidden="true" tabindex="-1"></a>                 batch_tfms<span class="op">=</span>batch_tfms)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now currently it’s setup for our <em>single-label</em> classification again. So how do we turn this into multilable? We instead use the <strong>MultiCategoryBlock</strong> and add in a simple function that converts our label into a list of labels (or a list of a single label) for us to use:</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb325"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb325-1"><a href="#cb325-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> label_to_list(o): <span class="cf">return</span> [o]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we’ll pass this along into our new DataBlock:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb326"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a>multi_pets <span class="op">=</span> DataBlock(</span>
<span id="cb326-2"><a href="#cb326-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, MultiCategoryBlock),</span>
<span id="cb326-3"><a href="#cb326-3" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb326-4"><a href="#cb326-4" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(),</span>
<span id="cb326-5"><a href="#cb326-5" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>Pipeline(</span>
<span id="cb326-6"><a href="#cb326-6" aria-hidden="true" tabindex="-1"></a>        [RegexLabeller(pat <span class="op">=</span> <span class="vs">r'/([^/]+)_\d+.*'</span>), label_to_list]</span>
<span id="cb326-7"><a href="#cb326-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb326-8"><a href="#cb326-8" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>item_tfms,</span>
<span id="cb326-9"><a href="#cb326-9" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>batch_tfms</span>
<span id="cb326-10"><a href="#cb326-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>When using the DataBlock API and you have a sequence of items the get_y should follow, these must be wrapped in a Pipeline class to work.</p>
</div></div><p>And we can create some new DataLoaders:</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb327"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb327-1"><a href="#cb327-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> multi_pets.dataloaders(path, bs<span class="op">=</span><span class="dv">32</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb328"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb328-1"><a href="#cb328-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Walkwithfastai_files/figure-html/cell-187-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Now overall these don’t look that different right? This is because each label is still a <em>single label</em>. What we’ve really changed here is how <strong>vision_learner</strong> will read in our DataLoaders object and understand what to do with the outputs.</p>
<p>Let’s recreate what we’ve just done here as <strong>Datasets</strong> as well to understand what the API change would be:</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb329"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb329-1"><a href="#cb329-1" aria-hidden="true" tabindex="-1"></a>train_idxs, valid_idxs <span class="op">=</span> RandomSplitter()(get_image_files(path))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb330"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb330-1"><a href="#cb330-1" aria-hidden="true" tabindex="-1"></a>tfms <span class="op">=</span> [</span>
<span id="cb330-2"><a href="#cb330-2" aria-hidden="true" tabindex="-1"></a>    [PILImage.create],</span>
<span id="cb330-3"><a href="#cb330-3" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb330-4"><a href="#cb330-4" aria-hidden="true" tabindex="-1"></a>        RegexLabeller(pat <span class="op">=</span> <span class="vs">r'/([^/]+)_\d+.*'</span>),</span>
<span id="cb330-5"><a href="#cb330-5" aria-hidden="true" tabindex="-1"></a>        label_to_list,</span>
<span id="cb330-6"><a href="#cb330-6" aria-hidden="true" tabindex="-1"></a>        MultiCategorize(vocab<span class="op">=</span><span class="bu">list</span>(dls.vocab)),</span>
<span id="cb330-7"><a href="#cb330-7" aria-hidden="true" tabindex="-1"></a>        OneHotEncode(<span class="bu">len</span>(dls.vocab))</span>
<span id="cb330-8"><a href="#cb330-8" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb330-9"><a href="#cb330-9" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb331"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb331-1"><a href="#cb331-1" aria-hidden="true" tabindex="-1"></a>dsets <span class="op">=</span> Datasets(get_image_files(path), tfms<span class="op">=</span>tfms, splits<span class="op">=</span>[train_idxs, valid_idxs])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb332"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb332-1"><a href="#cb332-1" aria-hidden="true" tabindex="-1"></a>dsets[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>(PILImage mode=RGB size=500x358,
 TensorMultiCategory([0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
                      0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
                      0., 0., 0., 0., 0., 0., 0.]))</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Indexes
</div>
</div>
<div class="callout-body-container callout-body">
<p>Notice here that there is only <em>one</em> index that contains a 1 value in our label, which corresponds to our original label after its been encoded</p>
</div>
</div>
<p>Then we’ll create some DataLoaders:</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb334"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb334-1"><a href="#cb334-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dsets.dataloaders(</span>
<span id="cb334-2"><a href="#cb334-2" aria-hidden="true" tabindex="-1"></a>    after_item<span class="op">=</span>[ToTensor(), RandomResizedCrop(<span class="dv">460</span>, min_scale<span class="op">=</span><span class="fl">.75</span>)],</span>
<span id="cb334-3"><a href="#cb334-3" aria-hidden="true" tabindex="-1"></a>    after_batch<span class="op">=</span>[IntToFloatTensor(), <span class="op">*</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, max_warp<span class="op">=</span><span class="dv">0</span>), Normalize.from_stats(<span class="op">*</span>imagenet_stats)],</span>
<span id="cb334-4"><a href="#cb334-4" aria-hidden="true" tabindex="-1"></a>    bs<span class="op">=</span><span class="dv">32</span></span>
<span id="cb334-5"><a href="#cb334-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And we can verify it still looks the same:</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb335"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb335-1"><a href="#cb335-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Walkwithfastai_files/figure-html/cell-193-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Great! Now we can train our model</p>
</section>
<section id="train-the-model" class="level3">
<h3 class="anchored" data-anchor-id="train-the-model">Train the model!</h3>
<p>Next we’ll train the model deviating ever so slightly to the previous lesson’s advice, with an important reason:</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb336"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb336-1"><a href="#cb336-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet34, metrics<span class="op">=</span>[partial(accuracy_multi, thresh<span class="op">=</span><span class="fl">0.95</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/stephen137/mambaforge/lib/python3.10/site-packages/torchvision/models/_utils.py:208: UserWarning: The parameter 'pretrained' is deprecated since 0.13 and will be removed in 0.15, please use 'weights' instead.
  warnings.warn(
/home/stephen137/mambaforge/lib/python3.10/site-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for 'weights' are deprecated since 0.13 and will be removed in 0.15. The current behavior is equivalent to passing `weights=ResNet34_Weights.IMAGENET1K_V1`. You can also use `weights=ResNet34_Weights.DEFAULT` to get the most up-to-date weights.
  warnings.warn(msg)</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Why do we suddenly use a metric thresh that is different to our loss function threshold?
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is because when we deploy the model we will make sure that it’s set to 0.95, but during training we don’t want to bias the model towards extreme predictions.</p>
</div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb338"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb338-1"><a href="#cb338-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">4</span>, <span class="fl">2e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy_multi</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.419639</td>
      <td>0.068303</td>
      <td>0.974015</td>
      <td>05:15</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy_multi</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.052954</td>
      <td>0.021808</td>
      <td>0.981805</td>
      <td>07:44</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.027599</td>
      <td>0.013009</td>
      <td>0.989668</td>
      <td>07:39</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.016222</td>
      <td>0.010937</td>
      <td>0.992357</td>
      <td>07:43</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.010513</td>
      <td>0.009358</td>
      <td>0.993417</td>
      <td>07:39</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</section>
<section id="model-evaluation" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="model-evaluation">Model Evaluation</h3>
<p>All that’s left is to make sure our model doesn’t know the difference between a donkey and some dogs or cats! To do so (and so our exported Learner knows what we’re doing), let’s manually change the loss function’s threshold to be what we want:</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb339"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb339-1"><a href="#cb339-1" aria-hidden="true" tabindex="-1"></a>learn.loss_func.thresh <span class="op">=</span> <span class="fl">0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we can try predicting on an image from one of our classes:</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb340"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb340-1"><a href="#cb340-1" aria-hidden="true" tabindex="-1"></a>PERSIAN_CAT_URL <span class="op">=</span> <span class="st">"https://azure.wgp-cdn.co.uk/app-yourcat/posts/iStock-174776419-1.jpg"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb341"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb341-1"><a href="#cb341-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> requests.get(PERSIAN_CAT_URL)</span>
<span id="cb341-2"><a href="#cb341-2" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> PILImage.create(response.content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb342"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb342-1"><a href="#cb342-1" aria-hidden="true" tabindex="-1"></a>im.show()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Walkwithfastai_files/figure-html/cell-199-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb343"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb343-1"><a href="#cb343-1" aria-hidden="true" tabindex="-1"></a>learn.predict(im)[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>(#1) ['Persian']</code></pre>
</div>
</div>
<p>We can see it only returned one label. What happens if we try a donkey?</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>I chose a donkey here because it’s an animal very unlike a cat or a dog, but try your own image! To learn more about this sort of idea, look up the “Hotdog, not hotdog” problem</p>
</div></div><div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb345"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb345-1"><a href="#cb345-1" aria-hidden="true" tabindex="-1"></a>KOMODO_URL <span class="op">=</span> <span class="st">"https://i.natgeofe.com/k/c02b35d2-bfd7-4ed9-aad4-8e25627cd481/komodo-dragon-head-on_3x2.jpg"</span></span>
<span id="cb345-2"><a href="#cb345-2" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> requests.get(KOMODO_URL)</span>
<span id="cb345-3"><a href="#cb345-3" aria-hidden="true" tabindex="-1"></a>learn.predict(response.content)[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>(#0) []</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>response = requests.get(KOMODO_URL)
learn.predict(response.content)[0] </code></pre>
<p><strong><em>predict</em></strong> knows how to work with a large variety of data, including the raw bytes that get returned from requests.</p>
</div>
</div>
<p>We successfully didn’t find a cat or dog! You can follow the same steps as shown in the previous notebook from this lesson to get these predictions without the use of fastai, it still has the exact same pipeline!</p>
</section>
</section>
<section id="cross-validation-and-ensembling" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="cross-validation-and-ensembling">3.3 Cross Validation and Ensembling</h2>
<section id="what-is-cross-validation" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="what-is-cross-validation">What is Cross Validation?</h3>
<p>Typically we have one model that sees the <em>entire</em> training dataset and is evaluated on some test set at the end. Model ensembling works a bit differently. Instead each model of n <em>folds</em> is trained on a subset of the data. After the training is completed all of the models outputs are averaged and we take this as the overall prediction.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>This technique is known as a Voting Ensemble where each model gets an equal “vote” towards the correct answer.</p>
</div></div><p>Generally this results in a set of models that can <em>generalize</em> better as a whole and has been seen to perform much better on unseen data in Kaggle competitions.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>That being said, the computational requirements as a result are significantly higher as well as how long it takes for you to actually iterate over the results.</p>
</div></div></section>
<section id="lets-begin" class="level3">
<h3 class="anchored" data-anchor-id="lets-begin">Let’s begin</h3>
<p>For this problem yet again we’ll utilize the PETs dataset since we’re intimitely familiar with various levels of the API and how it’s written. First we’ll import the library:</p>
<p>::: {.column-margin} This will be especially important as we will need to use the Datasets level of the API to do this efficiently. ::</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb348"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb348-1"><a href="#cb348-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb348-2"><a href="#cb348-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb348-3"><a href="#cb348-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> StratifiedKFold</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
from sklearn.model_selection import StratifiedKFold
</div>
</div>
<div class="callout-body-container callout-body">
<p>The particular type of K-Fold validation we’ll be performing is called <strong>Stratified K-Fold</strong>, which ensures that the distributions between all of the classes remains the same across all <em>k</em> folds.</p>
</div>
</div>
<p>Next we’ll bring in our dataset and setup our transforms like before:</p>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb349"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.PETS)</span>
<span id="cb349-2"><a href="#cb349-2" aria-hidden="true" tabindex="-1"></a>fnames <span class="op">=</span> get_image_files(path<span class="op">/</span><span class="st">'images'</span>)</span>
<span id="cb349-3"><a href="#cb349-3" aria-hidden="true" tabindex="-1"></a>pat <span class="op">=</span> <span class="vs">r'(.+)_\d+.jpg$'</span></span>
<span id="cb349-4"><a href="#cb349-4" aria-hidden="true" tabindex="-1"></a>item_tfms <span class="op">=</span> [RandomResizedCrop(<span class="dv">460</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>, ratio<span class="op">=</span>(<span class="fl">1.</span>,<span class="fl">1.</span>)), ToTensor()]</span>
<span id="cb349-5"><a href="#cb349-5" aria-hidden="true" tabindex="-1"></a>batch_tfms <span class="op">=</span> [IntToFloatTensor(), <span class="op">*</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, max_warp<span class="op">=</span><span class="dv">0</span>), Normalize.from_stats(<span class="op">*</span>imagenet_stats)]</span>
<span id="cb349-6"><a href="#cb349-6" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">64</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This time we will utilize the <strong>IndexSplitter</strong> that fastai provides as our K-Fold will result in a list of indices representing our validation set.</p>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
K-Fold Validation and Data Subsets
</div>
</div>
<div class="callout-body-container callout-body">
<p>When performing K-Fold validation we turn 2 subsets of data (train and validation) into three: train, validation, and test.</p>
<p>The test set should never be graded (validated) upon until the <strong><em>very end</em></strong> of the entire training and should have no impact on how we grade if intermediate models are training well.</p>
<p>The validation sets are then smaller subsets of the training dataset, such that if we had a k of 10 each validation set would be a unique 10% of the data.</p>
</div>
</div>
</section>
<section id="creating-the-splits" class="level3">
<h3 class="anchored" data-anchor-id="creating-the-splits">Creating the splits</h3>
<p>Let’s set aside our train/validation and test sets:</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb350"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb350-1"><a href="#cb350-1" aria-hidden="true" tabindex="-1"></a>random.shuffle(fnames)</span>
<span id="cb350-2"><a href="#cb350-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb350-3"><a href="#cb350-3" aria-hidden="true" tabindex="-1"></a>train_fnames <span class="op">=</span> [filename <span class="cf">for</span> filename <span class="kw">in</span> fnames[:<span class="bu">int</span>(<span class="bu">len</span>(fnames) <span class="op">*</span> <span class="fl">.9</span>)]]</span>
<span id="cb350-4"><a href="#cb350-4" aria-hidden="true" tabindex="-1"></a>test_fnames <span class="op">=</span> [filename <span class="cf">for</span> filename <span class="kw">in</span> fnames[<span class="bu">int</span>(<span class="bu">len</span>(fnames) <span class="op">*</span> <span class="fl">.9</span>):]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>random.shuffle(fnames)</code></pre>
<p>In order to efficiently randomly select from the data we can just shuffle our list of filenames inplace and then choose from that.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb352"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb352-1"><a href="#cb352-1" aria-hidden="true" tabindex="-1"></a>::: {.callout<span class="op">-</span>note}</span>
<span id="cb352-2"><a href="#cb352-2" aria-hidden="true" tabindex="-1"></a><span class="co">## Code explanation</span></span>
<span id="cb352-3"><a href="#cb352-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">int</span>(<span class="bu">len</span>(fnames) <span class="op">*</span> <span class="fl">.9</span>)</span>
<span id="cb352-4"><a href="#cb352-4" aria-hidden="true" tabindex="-1"></a>For this example we’ll make our test <span class="bu">set</span> be <span class="dv">10</span><span class="op">%</span> of the data, randomly.</span>
<span id="cb352-5"><a href="#cb352-5" aria-hidden="true" tabindex="-1"></a>:::</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then need to actually create our K-Fold splits. To do so first let’s extract all of the labels from our dataset:</p>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb353"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a>vocab <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(RegexLabeller(pat<span class="op">=</span><span class="vs">r'/([^/]+)_\d+.*'</span>), train_fnames))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb354"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb354-1"><a href="#cb354-1" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> Pipeline([</span>
<span id="cb354-2"><a href="#cb354-2" aria-hidden="true" tabindex="-1"></a>    RegexLabeller(pat<span class="op">=</span><span class="vs">r'/([^/]+)_\d+.*'</span>), Categorize(vocab<span class="op">=</span>vocab)</span>
<span id="cb354-3"><a href="#cb354-3" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>Pipeline([ExampleClassA(), ExampleClassB()])</code></pre>
<p>This is the basic <strong>Pipeline</strong> class which controls how transforms are applied (read more about this below)</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>RegexLabeller(pat=r'/([^/]+)_\d+.*'), Categorize</code></pre>
<p>Similar to what we saw earlier, we can create a <strong>Pipeline</strong> of only the transforms that will extract and encode the label from a filename.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>pipe.setup(train_fnames)</code></pre>
<p>Some transforms require certain setups to be performed, such as how <strong>Categorize</strong> knows the class list. This is done by calling <strong>pipe.setup</strong> and passing in a list of items for it to utilize</p>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
What is a Pipeline?
</div>
</div>
<div class="callout-body-container callout-body">
<p>A <strong>Pipeline</strong> class is what fastai uses under the hood to call each set of transforms. It’s similar to PyTorch’s <strong>Compose</strong> we saw earlier except we can also control the transform behavior. For example, this is how fastai will either do <em>random cropping or center cropping</em> based on if we should apply the transforms to the training dataset or the validation dataset.</p>
<p>When going through a <strong>Pipeline</strong> it will call the <strong><strong>call</strong></strong> function of a class or just call the normal function, hence why the previous code example used <strong>ExampleClassA()</strong> as it’s assumed if we have <strong>tfm = ExampleClassA()</strong> we can then do: <strong>tfm(some_input)</strong></p>
</div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb358"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb358-1"><a href="#cb358-1" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(pipe, train_fnames))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This let’s us apply the pipeline we just created onto every single fname in train_fnames and return that as a <strong>list</strong> rather than having to write a for loop.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>list(map(function, items))</code></pre>
<p>The map function will return a generator where upon iterating it will apply a single function to an item from items. We can use list to instantly run that generator to its end and return all their results.</p>
</div>
</div>
<p>Now that we have the labels we can create the folds. For this example we will split the dataset into 10 subsets:</p>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb360"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb360-1"><a href="#cb360-1" aria-hidden="true" tabindex="-1"></a>splits <span class="op">=</span> []</span>
<span id="cb360-2"><a href="#cb360-2" aria-hidden="true" tabindex="-1"></a>skf <span class="op">=</span> StratifiedKFold(n_splits<span class="op">=</span><span class="dv">10</span>, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb360-3"><a href="#cb360-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, valid_indexes <span class="kw">in</span> skf.split(</span>
<span id="cb360-4"><a href="#cb360-4" aria-hidden="true" tabindex="-1"></a>    np.zeros(<span class="bu">len</span>(labels)), labels</span>
<span id="cb360-5"><a href="#cb360-5" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb360-6"><a href="#cb360-6" aria-hidden="true" tabindex="-1"></a>    split <span class="op">=</span> IndexSplitter(valid_indexes)</span>
<span id="cb360-7"><a href="#cb360-7" aria-hidden="true" tabindex="-1"></a>    splits.append(split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>splits = []</code></pre>
<p>All of our splits across the five validation folds will be stored into an array</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>skf = StratifiedKFold(n_splits=10, shuffle=True)</code></pre>
<p>This will instantiate our KFold class and specify the number of splits to use and that each classes indicies should be shuffled before they’re distributed between each of the splits</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>np.zeros(len(labels)), labels</code></pre>
<p>The skf.split function needs to take in a list of X and a list of y. It’s possible to just make the X’s a list of numbers instead, which is what we’re doing here</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>skf.split(np.zeros(len(labels)), labels) </code></pre>
<p>The split function is what will actually take our labels find their distributions and return an iterator for each of our specified subsets</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>for _, valid_indexes in </code></pre>
<p>The split’s iterator returns two sets of X and label indicies. Since we only care about the labels we just keep them</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>split = IndexSplitter(valid_indexes)
splits.append(split)</code></pre>
<p>We then use the IndexSplitter class from fastai which will split between train and validation based on a set of indicies passed in (these will be the validation indicies). From there we store them in an array of splitters</p>
</div>
</div>
<p>Now that we have our splits we can create a training loop!</p>
</section>
<section id="the-training-loop" class="level3">
<h3 class="anchored" data-anchor-id="the-training-loop">The Training Loop</h3>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb367"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a>valid_pcts <span class="op">=</span> []</span>
<span id="cb367-2"><a href="#cb367-2" aria-hidden="true" tabindex="-1"></a>test_preds <span class="op">=</span> []</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now create a train function which will take in a splitter, create a learner, and train:</p>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb368"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb368-1"><a href="#cb368-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train(splitter:IndexSplitter):</span>
<span id="cb368-2"><a href="#cb368-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Trains a single model over a set of splits based on `splitter`"</span></span>
<span id="cb368-3"><a href="#cb368-3" aria-hidden="true" tabindex="-1"></a>    dset <span class="op">=</span> Datasets(</span>
<span id="cb368-4"><a href="#cb368-4" aria-hidden="true" tabindex="-1"></a>        train_fnames,</span>
<span id="cb368-5"><a href="#cb368-5" aria-hidden="true" tabindex="-1"></a>        tfms <span class="op">=</span> [</span>
<span id="cb368-6"><a href="#cb368-6" aria-hidden="true" tabindex="-1"></a>            [PILImage.create], </span>
<span id="cb368-7"><a href="#cb368-7" aria-hidden="true" tabindex="-1"></a>            [RegexLabeller(pat<span class="op">=</span><span class="vs">r'/([^/]+)_\d+.*'</span>), Categorize]</span>
<span id="cb368-8"><a href="#cb368-8" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb368-9"><a href="#cb368-9" aria-hidden="true" tabindex="-1"></a>        splits <span class="op">=</span> splitter(train_fnames)</span>
<span id="cb368-10"><a href="#cb368-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb368-11"><a href="#cb368-11" aria-hidden="true" tabindex="-1"></a>    dls <span class="op">=</span> dset.dataloaders(</span>
<span id="cb368-12"><a href="#cb368-12" aria-hidden="true" tabindex="-1"></a>        bs<span class="op">=</span>batch_size,</span>
<span id="cb368-13"><a href="#cb368-13" aria-hidden="true" tabindex="-1"></a>        after_item<span class="op">=</span>item_tfms,</span>
<span id="cb368-14"><a href="#cb368-14" aria-hidden="true" tabindex="-1"></a>        after_batch<span class="op">=</span>batch_tfms</span>
<span id="cb368-15"><a href="#cb368-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb368-16"><a href="#cb368-16" aria-hidden="true" tabindex="-1"></a>    learn <span class="op">=</span> vision_learner(dls, resnet34, metrics<span class="op">=</span>accuracy)</span>
<span id="cb368-17"><a href="#cb368-17" aria-hidden="true" tabindex="-1"></a>    learn.fit_one_cycle(<span class="dv">1</span>)</span>
<span id="cb368-18"><a href="#cb368-18" aria-hidden="true" tabindex="-1"></a>    valid_pcts.append(learn.validate()[<span class="dv">1</span>])</span>
<span id="cb368-19"><a href="#cb368-19" aria-hidden="true" tabindex="-1"></a>    dl <span class="op">=</span> learn.dls.test_dl(test_fnames)</span>
<span id="cb368-20"><a href="#cb368-20" aria-hidden="true" tabindex="-1"></a>    preds, _ <span class="op">=</span> learn.get_preds(dl<span class="op">=</span>dl)</span>
<span id="cb368-21"><a href="#cb368-21" aria-hidden="true" tabindex="-1"></a>    test_preds.append(preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>dset = Datasets(
    train_fnames,
    tfms = [
        [PILImage.create], 
        [RegexLabeller(pat=r'/([^/]+)_\d+.*'), Categorize]
    ],
    splits = splitter(train_fnames)
)</code></pre>
<p>This will create a dataset based on all of our training filenames and apply the passed in splitter from earlier to define our splits</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>learn = vision_learner(dls, resnet34, metrics=accuracy) </code></pre>
<p>We create a model here and initialize it (and a Learner in this case), and attach accuracy to the Learner’s metrics.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>learn.fit_one_cycle(1)</code></pre>
<p>Then we perform whatever training we want to perform over each split. In this case since it’s just an example the model is trained for a single epoch using the One Cycle policy</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>valid_pcts.append(learn.validate()[1])</code></pre>
<p>Then we take the validation metric for that model and store it away in the valid_pcts array. learn.get_preds will return in the following order: loss, metrics, and then other more-specific items if desired</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>dl = learn.dls.test_dl(test_fnames)
preds, _ = learn.get_preds(dl=dl)</code></pre>
<p>Afterwards we perform inference by creating a test dataloader on the final hold-out dataset. This new dl is designed to apply the validation augmentation when a new batch is called.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>test_preds.append(preds)</code></pre>
<p>Finally we store those new predictions in the array defined earlier.</p>
</div>
</div>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb375"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb375-1"><a href="#cb375-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> splitter <span class="kw">in</span> splits:</span>
<span id="cb375-2"><a href="#cb375-2" aria-hidden="true" tabindex="-1"></a>    train(splitter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.151564</td>
      <td>0.392927</td>
      <td>0.878378</td>
      <td>05:05</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.160626</td>
      <td>0.322556</td>
      <td>0.896241</td>
      <td>05:05</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.177824</td>
      <td>0.346940</td>
      <td>0.890226</td>
      <td>05:10</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.127279</td>
      <td>0.407724</td>
      <td>0.879699</td>
      <td>05:23</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.181068</td>
      <td>0.367682</td>
      <td>0.867669</td>
      <td>05:34</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.168471</td>
      <td>0.350968</td>
      <td>0.900752</td>
      <td>05:06</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.186819</td>
      <td>0.367836</td>
      <td>0.884211</td>
      <td>05:04</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.205666</td>
      <td>0.327377</td>
      <td>0.906767</td>
      <td>05:07</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.149422</td>
      <td>0.387929</td>
      <td>0.887218</td>
      <td>05:06</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.206261</td>
      <td>0.324390</td>
      <td>0.906767</td>
      <td>05:07</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
</section>
<section id="performing-the-ensemble" class="level3">
<h3 class="anchored" data-anchor-id="performing-the-ensemble">Performing the Ensemble</h3>
<p>Currently we just have a set of predictions and some amount of models trained, we need a way to actually perform the ensembling (through equal voting) as mentioned earlier. Since the term equal is in there, it can be inferred that we take the average across all of the different models and use that prediction as the result.</p>
<p>First let’s check the accuracy of one fold:</p>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb376"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb376-1"><a href="#cb376-1" aria-hidden="true" tabindex="-1"></a>test_labels <span class="op">=</span> torch.stack([pipe(fname) <span class="cf">for</span> fname <span class="kw">in</span> test_fnames])</span>
<span id="cb376-2"><a href="#cb376-2" aria-hidden="true" tabindex="-1"></a>accuracy(test_preds[<span class="dv">0</span>], test_labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>TensorBase(0.8809)</code></pre>
</div>
</div>
<p>Then we can get the results for all of them to see their distribution:</p>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb378"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb378-1"><a href="#cb378-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> preds <span class="kw">in</span> test_preds:</span>
<span id="cb378-2"><a href="#cb378-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(accuracy(preds, test_labels))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TensorBase(0.8809)
TensorBase(0.8917)
TensorBase(0.8714)
TensorBase(0.8674)
TensorBase(0.8823)
TensorBase(0.8999)
TensorBase(0.8823)
TensorBase(0.8945)
TensorBase(0.8836)
TensorBase(0.8687)</code></pre>
</div>
</div>
<p>The highest is 89.99%, and the lowest was 87.14% How will the ensemble do?</p>
<p>Finally we can perform our vote:</p>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb380"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb380-1"><a href="#cb380-1" aria-hidden="true" tabindex="-1"></a>votes <span class="op">=</span> torch.stack(test_preds, dim<span class="op">=-</span><span class="dv">1</span>).<span class="bu">sum</span>(<span class="op">-</span><span class="dv">1</span>) <span class="op">/</span> <span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And see our new accuracy:</p>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb381"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb381-1"><a href="#cb381-1" aria-hidden="true" tabindex="-1"></a>accuracy(votes, test_labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>TensorBase(0.9066)</code></pre>
</div>
</div>
<p>We can see that ensembling worked well here and our results improved!</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
So, should we just shove even more folds into the mix to get a better model?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Ensembling in this way has diminishing returns, so finding the right number of folds is a trial and error hyperparameter. Also people will typically combine <em>multiple different models</em> when doing these folds so that there is an even starker variation to the data and some models that perform better on certain data can shine and improve the rest.</p>
</div>
</div>
</section>
</section>
</section>
<section id="lesson-4" class="level1 page-columns page-full">
<h1>Lesson 4</h1>
<section id="semantic-segmentation-and-the-unet" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="semantic-segmentation-and-the-unet">4.1 Semantic Segmentation and the Unet</h2>
<section id="what-is-semantic-segmentation" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="what-is-semantic-segmentation">What is Semantic Segmentation?</h3>
<p>Given a particular image, we can assume that each pixel inside that image represents a class.</p>
<p>This can come in the form (most commonly) of:</p>
<ul>
<li><strong>Binary</strong>: either it is or is not (such as background v.s. an object)</li>
<li><strong>Multiclass</strong>: one of n number of classes (such as parts of the body)</li>
</ul>
<p>In the Practical Deep Learning for Coders course it was the latter shown through the CAMVID problem. In this course we will focus on the <strong><em>binary segmentation</em></strong> aspect as sometimes it takes a bit of preprocessing to get it going well.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>The other option would be when individual pixels represent multiple classes, though I haven’t seen too many of these cases personally.</p>
</div></div><div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb383"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb383-1"><a href="#cb383-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="the-dataset" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="the-dataset">The Dataset</h3>
<p>The dataset for today will be portraits of people. Let’s download it first:</p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
<strong>gdown</strong>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Make sure to run <em>pip install gdown</em> first, as the dataset is hosted on Google Drive!</p>
</div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb384"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb384-1"><a href="#cb384-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> pip install gdown</span>
<span id="cb384-2"><a href="#cb384-2" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"https://drive.google.com/uc?id=18xM3jU2dSp1DiDqEM6PVXattNMZvsX4z"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Requirement already satisfied: gdown in /home/stephen137/mambaforge/lib/python3.10/site-packages (4.6.0)
Requirement already satisfied: beautifulsoup4 in /home/stephen137/mambaforge/lib/python3.10/site-packages (from gdown) (4.11.1)
Requirement already satisfied: tqdm in /home/stephen137/mambaforge/lib/python3.10/site-packages (from gdown) (4.64.1)
Requirement already satisfied: six in /home/stephen137/mambaforge/lib/python3.10/site-packages (from gdown) (1.16.0)
Requirement already satisfied: filelock in /home/stephen137/mambaforge/lib/python3.10/site-packages (from gdown) (3.8.0)
Requirement already satisfied: requests[socks] in /home/stephen137/mambaforge/lib/python3.10/site-packages (from gdown) (2.28.1)
Requirement already satisfied: soupsieve&gt;1.2 in /home/stephen137/mambaforge/lib/python3.10/site-packages (from beautifulsoup4-&gt;gdown) (2.3.2.post1)
Requirement already satisfied: urllib3&lt;1.27,&gt;=1.21.1 in /home/stephen137/mambaforge/lib/python3.10/site-packages (from requests[socks]-&gt;gdown) (1.26.11)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /home/stephen137/mambaforge/lib/python3.10/site-packages (from requests[socks]-&gt;gdown) (3.3)
Requirement already satisfied: certifi&gt;=2017.4.17 in /home/stephen137/mambaforge/lib/python3.10/site-packages (from requests[socks]-&gt;gdown) (2022.12.7)
Requirement already satisfied: charset-normalizer&lt;3,&gt;=2 in /home/stephen137/mambaforge/lib/python3.10/site-packages (from requests[socks]-&gt;gdown) (2.1.1)
Requirement already satisfied: PySocks!=1.5.7,&gt;=1.5.6 in /home/stephen137/mambaforge/lib/python3.10/site-packages (from requests[socks]-&gt;gdown) (1.7.1)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb386"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb386-1"><a href="#cb386-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>gdown {url}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading...
From: https://drive.google.com/uc?id=18xM3jU2dSp1DiDqEM6PVXattNMZvsX4z
To: /home/stephen137/Blog/posts/Walk_with_fastai/Portrait.zip
100%|████████████████████████████████████████| 107M/107M [00:04&lt;00:00, 25.8MB/s]</code></pre>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>When working in Jupyter Notebooks you can utilize variables named earlier when calling bash commands by surrounding them with {}</p>
</div></div><p>The data has now been stored in a <strong>Portrait.zip</strong> file. Let’s use the <strong>zipfile</strong> library to unzip it to a data folder:</p>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb388"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb388-1"><a href="#cb388-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> zipfile <span class="im">import</span> ZipFile</span>
<span id="cb388-2"><a href="#cb388-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb388-3"><a href="#cb388-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> ZipFile(<span class="st">"data/Portrait.zip"</span>, <span class="st">"r"</span>) <span class="im">as</span> zip_ref:</span>
<span id="cb388-4"><a href="#cb388-4" aria-hidden="true" tabindex="-1"></a>    zip_ref.extractall(<span class="st">"../data"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>What’s inside?</p>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb389"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb389-1"><a href="#cb389-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> Path(<span class="st">"../data"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb390"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb390-1"><a href="#cb390-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> walk <span class="kw">in</span> path.ls():</span>
<span id="cb390-2"><a href="#cb390-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="bu">repr</span>(walk), walk.is_file())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Path('../data/EG1800_val.txt') True
Path('../data/GT_png') False
Path('../data/images_data_crop') False
Path('../data/val.txt') True
Path('../data/EG1800_train.txt') True
Path('../data/train.txt') True</code></pre>
</div>
</div>
<p>You can see that we have some files relating to image labels, filenames that relate to whether an image is in the train or validation set, and two other text files we won’t worry about.</p>
</section>
<section id="checking-the-labels" class="level3">
<h3 class="anchored" data-anchor-id="checking-the-labels">Checking the Labels</h3>
<p>Why check the labels next? Let’s grab one and take a look:</p>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb392"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb392-1"><a href="#cb392-1" aria-hidden="true" tabindex="-1"></a>(path<span class="op">/</span><span class="st">"GT_png"</span>).ls()[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>Path('../data/GT_png/02227_mask.png')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb394"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb394-1"><a href="#cb394-1" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> Image.<span class="bu">open</span>((path<span class="op">/</span><span class="st">"GT_png"</span>).ls()[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb395"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb395-1"><a href="#cb395-1" aria-hidden="true" tabindex="-1"></a>mask</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<p><img src="Walkwithfastai_files/figure-html/cell-225-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>In <strong>semantic segmentation</strong>, the “labels” are a 1:1 <strong><em>mask</em></strong> of the original picture with each pixel representing a label and are single channel:</p>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb396"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb396-1"><a href="#cb396-1" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> np.asarray(mask)<span class="op">;</span> mask</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>array([[  0,   0,   0, ...,   0,   0,   0],
       [  0,   0,   0, ...,   0,   0,   0],
       [  0,   0,   0, ...,   0,   0,   0],
       ...,
       [255, 255, 255, ..., 255, 255, 255],
       [255, 255, 255, ..., 255, 255, 255],
       [255, 255, 255, ..., 255, 255, 255]], dtype=uint8)</code></pre>
</div>
</div>
<p>Very quickly we see the issue!</p>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Segmentation Masks and Their Values
</div>
</div>
<div class="callout-body-container callout-body">
<p>Because of how the loss gets calculated (and how fastai does things in general), the values of the pixel mask must be from <em>0 -&gt; n</em>, with <em>n</em> being the number of classes possible. If we take things as they are here during training you’ll hit an error that says “CUDA Segmentation Fault, Index Out of Bounds” (or something similar).</p>
<p>This is because our labels should be from 0 -&gt; 1, to align with the fact predicted probabilities from our model are 0 -&gt; 1. Instead they are between 0 and 255(the brightness intensity of each pixel), leading to this issue.</p>
</div>
</div>
<p>So how do we fix the issue? In NumPy we can just override the numbers for a particular value in the array and set it. To generalize this however a <strong>dictionary</strong> of the original value to the new one should also be made; this mapping ensures a trail is retained.</p>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb398"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb398-1"><a href="#cb398-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_codes(fnames) <span class="op">-&gt;</span> Dict[<span class="bu">int</span>,<span class="bu">int</span>]: </span>
<span id="cb398-2"><a href="#cb398-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Returns a dictionary of `original_code:new_code` for pixel values in segmentation masks"</span></span>
<span id="cb398-3"><a href="#cb398-3" aria-hidden="true" tabindex="-1"></a>    unique_codes <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb398-4"><a href="#cb398-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> fname <span class="kw">in</span> fnames:</span>
<span id="cb398-5"><a href="#cb398-5" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> Image.<span class="bu">open</span>(fname)</span>
<span id="cb398-6"><a href="#cb398-6" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> np.asarray(mask)</span>
<span id="cb398-7"><a href="#cb398-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> color <span class="kw">in</span> np.unique(mask):</span>
<span id="cb398-8"><a href="#cb398-8" aria-hidden="true" tabindex="-1"></a>            unique_codes.add(color)</span>
<span id="cb398-9"><a href="#cb398-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb398-10"><a href="#cb398-10" aria-hidden="true" tabindex="-1"></a>        i : color</span>
<span id="cb398-11"><a href="#cb398-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, color <span class="kw">in</span> </span>
<span id="cb398-12"><a href="#cb398-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">enumerate</span>(unique_codes)</span>
<span id="cb398-13"><a href="#cb398-13" aria-hidden="true" tabindex="-1"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>def get_codes(fnames) -&gt; Dict[int,int]: </code></pre>
<p>The function will take in a list of filenames and return a dictionary of int:int</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>unique_codes = set()</code></pre>
<p>The unique pixel values found in each mask will be stored in a set called unique_codes. This is because a <strong>set</strong> let’s us add items to the object but will only be included if they do not already exist inside it.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>mask = Image.open(fname)
mask = np.asarray(mask)</code></pre>
<p>We need to open each mask and convert it to a NumPy array</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>for color in np.unique(mask):
    unique_codes.add(color)           </code></pre>
<p>np.unique will find all the different pixel values present in our mask and return them as an array. We need to then add each of them to our set to see what ones exist.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>return {
    i : color
    for i, color in 
    enumerate(unique_codes)
}  </code></pre>
<p>Finally, we can construct a dictionary from 0 to n that says what the pixel to color translation will be.</p>
</div>
</div>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb404"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb404-1"><a href="#cb404-1" aria-hidden="true" tabindex="-1"></a>unique_codes <span class="op">=</span> get_codes((path<span class="op">/</span><span class="st">"GT_png"</span>).ls()[:<span class="dv">20</span>])</span>
<span id="cb404-2"><a href="#cb404-2" aria-hidden="true" tabindex="-1"></a>unique_codes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>{0: 0, 1: 255}</code></pre>
</div>
</div>
<p>Changing the values inside our masks afterwards looks something like so:</p>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb406"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb406-1"><a href="#cb406-1" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> mask.copy()</span>
<span id="cb406-2"><a href="#cb406-2" aria-hidden="true" tabindex="-1"></a>np.place(mask, mask<span class="op">==</span><span class="dv">255</span>, <span class="dv">1</span>)</span>
<span id="cb406-3"><a href="#cb406-3" aria-hidden="true" tabindex="-1"></a>np.unique(mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>array([0, 1], dtype=uint8)</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>mask = mask.copy()          </code></pre>
<p>NumPy will raise a WRITEBACKIFCOPY issue if we try to modify the original array in-place, so we make another one instead.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>np.place(mask, mask==255, 1)      </code></pre>
<p><strong>np.place</strong> takes in an array, a mask, and values to replace them with. In this case the “mask” here means what values need changing.</p>
</div>
</div>
<p>We’ll need to perform this when we do our <strong>get_y</strong></p>
</section>
<section id="building-the-dataloaders" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="building-the-dataloaders">Building the Dataloaders</h3>
<p>First step is to build a <strong>DataBlock</strong> (the Datasets will be shown afterwards). Our input is an <em>Image</em> and our output is a <em>Mask</em>, so thus:</p>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb410"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb410-1"><a href="#cb410-1" aria-hidden="true" tabindex="-1"></a>codes <span class="op">=</span> [<span class="st">"Background"</span>, <span class="st">"Face"</span>]</span>
<span id="cb410-2"><a href="#cb410-2" aria-hidden="true" tabindex="-1"></a>blocks <span class="op">=</span> (ImageBlock, MaskBlock(codes<span class="op">=</span>codes))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>Codes are how <strong>fastai</strong> knows the human label for each image, so that when decoding the final output it isn’t an array of <em>[0,1,0,…]</em> but instead <em>[Background, Face, Background,…]</em></p>
</div></div><p>Next we need to create a <strong>get_y function</strong>. In this case it should take in a <em>filename</em> and our dictionary, open the filename, and return the mask:</p>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb411"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb411-1"><a href="#cb411-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_y(filename:Path, unique_codes:<span class="bu">dict</span>):</span>
<span id="cb411-2"><a href="#cb411-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Grabs a mask from `filename` and adjusts the pixel values based on `unique_codes`"</span></span>
<span id="cb411-3"><a href="#cb411-3" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> path<span class="op">/</span><span class="st">"GT_png"</span><span class="op">/</span><span class="ss">f'</span><span class="sc">{</span>filename<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">_mask.png'</span></span>
<span id="cb411-4"><a href="#cb411-4" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> np.asarray(Image.<span class="bu">open</span>(filename)).copy()</span>
<span id="cb411-5"><a href="#cb411-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> new_value, old_value <span class="kw">in</span> unique_codes.items():</span>
<span id="cb411-6"><a href="#cb411-6" aria-hidden="true" tabindex="-1"></a>        np.place(mask, mask<span class="op">==</span>old_value, new_value)</span>
<span id="cb411-7"><a href="#cb411-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> PILMask.create(mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>filename = path/"GT_png"/f'{filename.stem}_mask.png'</code></pre>
<p>We need to grab the label relative to our x filename. It’s located under GT_png/{filename}_mask.png. <strong>.stem</strong> is used to extract everything prior to the extension.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>mask = np.asarray(Image.open(filename)).copy()</code></pre>
<p>Next similar to earlier we open the mask and convert it to a NumPy array.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>for new_value, old_value in unique_codes.items():
    np.place(mask, mask==old_value, new_value)</code></pre>
<p>Then we replace all of the old values with the new ones.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Code explanation
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>return PILMask.create(mask)</code></pre>
<p>Finally returning a fully created PILMask ready for fastai.</p>
</div>
</div>
<p>Now let’s test out if it works by calling the <strong>PILMask.show()</strong> function and passing in a color map to use:</p>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb416"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb416-1"><a href="#cb416-1" aria-hidden="true" tabindex="-1"></a>new_mask <span class="op">=</span> get_y((path<span class="op">/</span><span class="st">"images_data_crop"</span>).ls()[<span class="dv">0</span>], unique_codes)</span>
<span id="cb416-2"><a href="#cb416-2" aria-hidden="true" tabindex="-1"></a>new_mask.show(cmap<span class="op">=</span><span class="st">"Blues"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Walkwithfastai_files/figure-html/cell-232-output-1.png" class="img-fluid"></p>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p><strong>cmap</strong> relates to <strong>matplotlib</strong> and how they render colors for numerical values. Find out more <a href="https://matplotlib.org/stable/tutorials/colors/colormaps.html">here</a></p>
</div></div></section>
<section id="datablock" class="level3">
<h3 class="anchored" data-anchor-id="datablock">DataBlock</h3>
<p>We have a mask! Now everything is in place to build our DataBlock:</p>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb417"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb417-1"><a href="#cb417-1" aria-hidden="true" tabindex="-1"></a>block <span class="op">=</span> DataBlock(</span>
<span id="cb417-2"><a href="#cb417-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>blocks,</span>
<span id="cb417-3"><a href="#cb417-3" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(),</span>
<span id="cb417-4"><a href="#cb417-4" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>partial(get_y, unique_codes<span class="op">=</span>unique_codes),</span>
<span id="cb417-5"><a href="#cb417-5" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">224</span>),</span>
<span id="cb417-6"><a href="#cb417-6" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>[<span class="op">*</span>aug_transforms(), Normalize.from_stats(<span class="op">*</span>imagenet_stats)]</span>
<span id="cb417-7"><a href="#cb417-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb418"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb418-1"><a href="#cb418-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> block.dataloaders(</span>
<span id="cb418-2"><a href="#cb418-2" aria-hidden="true" tabindex="-1"></a>    get_image_files(path<span class="op">/</span><span class="st">'images_data_crop'</span>), </span>
<span id="cb418-3"><a href="#cb418-3" aria-hidden="true" tabindex="-1"></a>    bs<span class="op">=</span><span class="dv">8</span></span>
<span id="cb418-4"><a href="#cb418-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Use a small batch size
</div>
</div>
<div class="callout-body-container callout-body">
<p>The architecture we will use for training (and UNet’s in general) are resource hungry, and we’re expecting a very large output so the batch sizes will need to be quite small.</p>
</div>
</div>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb419"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb419-1"><a href="#cb419-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch(cmap<span class="op">=</span><span class="st">"Blues"</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Walkwithfastai_files/figure-html/cell-235-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="with-datasets" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="with-datasets">With Datasets</h3>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb420"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb420-1"><a href="#cb420-1" aria-hidden="true" tabindex="-1"></a>splitter <span class="op">=</span> RandomSplitter()</span>
<span id="cb420-2"><a href="#cb420-2" aria-hidden="true" tabindex="-1"></a>dsets <span class="op">=</span> Datasets(</span>
<span id="cb420-3"><a href="#cb420-3" aria-hidden="true" tabindex="-1"></a>    get_image_files(path<span class="op">/</span><span class="st">'images_data_crop'</span>),</span>
<span id="cb420-4"><a href="#cb420-4" aria-hidden="true" tabindex="-1"></a>    tfms<span class="op">=</span>[</span>
<span id="cb420-5"><a href="#cb420-5" aria-hidden="true" tabindex="-1"></a>        [PILImage.create], </span>
<span id="cb420-6"><a href="#cb420-6" aria-hidden="true" tabindex="-1"></a>        [partial(get_y, unique_codes<span class="op">=</span>unique_codes)]</span>
<span id="cb420-7"><a href="#cb420-7" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb420-8"><a href="#cb420-8" aria-hidden="true" tabindex="-1"></a>    splits <span class="op">=</span> splitter(get_image_files(path<span class="op">/</span><span class="st">'images_data_crop'</span>))</span>
<span id="cb420-9"><a href="#cb420-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb421"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb421-1"><a href="#cb421-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dsets.dataloaders(</span>
<span id="cb421-2"><a href="#cb421-2" aria-hidden="true" tabindex="-1"></a>    after_item <span class="op">=</span> [</span>
<span id="cb421-3"><a href="#cb421-3" aria-hidden="true" tabindex="-1"></a>        Resize(<span class="dv">224</span>), </span>
<span id="cb421-4"><a href="#cb421-4" aria-hidden="true" tabindex="-1"></a>        ToTensor(), </span>
<span id="cb421-5"><a href="#cb421-5" aria-hidden="true" tabindex="-1"></a>        AddMaskCodes(codes<span class="op">=</span>codes)</span>
<span id="cb421-6"><a href="#cb421-6" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb421-7"><a href="#cb421-7" aria-hidden="true" tabindex="-1"></a>    after_batch <span class="op">=</span> [</span>
<span id="cb421-8"><a href="#cb421-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>aug_transforms(), </span>
<span id="cb421-9"><a href="#cb421-9" aria-hidden="true" tabindex="-1"></a>        IntToFloatTensor(), </span>
<span id="cb421-10"><a href="#cb421-10" aria-hidden="true" tabindex="-1"></a>        Normalize.from_stats(<span class="op">*</span>imagenet_stats)</span>
<span id="cb421-11"><a href="#cb421-11" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb421-12"><a href="#cb421-12" aria-hidden="true" tabindex="-1"></a>    bs<span class="op">=</span><span class="dv">8</span></span>
<span id="cb421-13"><a href="#cb421-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p><strong>AddMaskCodes</strong> will <em>inject</em> that list of classes into the <em>metadata</em> of the ending TensorMask that is created. <strong>fastai</strong> will then use this data later when decoding all their values.</p>
</div></div><div class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb422"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb422-1"><a href="#cb422-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch(cmap<span class="op">=</span><span class="st">"Blues"</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Walkwithfastai_files/figure-html/cell-238-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>With that we’re ready for training!</p>
</section>
<section id="the-u-net" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="the-u-net">The U-Net</h3>
<p>When it comes to image segmentation, the model of choice with fastai is the Dynamic Unet.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Walkwithfastai_files/figure-html/2c2d4cad-dbb1-4e6d-93da-54f35bbd15e4.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">u-net-architecture.png</figcaption><p></p>
</figure>
</div>
<p>Within the above U-Net architecture you can see how the data gets compressed then uncompressed as it goes back out. You may have seen places where the Unet is already being used, such as in <em>Stable Diffusion</em>. (We’re not going to talk about that here, feel free to go watch Jeremy’s course to learn more about that once it’s out!)</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>I highly recommend <a href="https://lmb.informatik.uni-freiburg.de/people/ronneber/u-net/u-net-teaser.mp4">this video</a> explaining how the UNet works!</p>
</div></div><p>Here’s the basic premise though. We take in these pixeled images of some size and shrink it down in half each time <strong>(encoding)</strong>. Eventually it becomes a representation of some shape, in this case a matrix of <strong>1024x30x30 (CxWxH)</strong>. Afterwards we blow the image back up to it’s original size again <strong>(decoding)</strong> and create a segmentation map of size <strong>NxWxH</strong> where <em>N</em> is the number of classes, and <em>W</em> ,<em>H</em> are the original <em>width</em> and <em>height</em> of the image when it was passed in.</p>
<p>Each channel in this final segmentation map represents all the values for a particular class as a result.</p>
<p>In fastai there is a special Learner function to create this model, <strong>unet_learner</strong>. There’s a variety of configurations we can pass to the unet, which you can read more about <a href="https://walkwithfastai.com/Segmentation#The-Dynamic-Unet">here</a> however in my opinion the default configurations will get us by just fine.</p>
<p>The only two options we will be enabling are <strong>self attention layers</strong> (think <a href="https://paperswithcode.com/method/efficientnet">EfficientNet</a> or <a href="https://huggingface.co/transformers/v4.5.1/model_doc/vit.html">ViT</a>) and changing the activation function to <strong><a href="https://paperswithcode.com/method/mish">Mish</a></strong>, a popular alternative to Rectified Linear Unit <strong>(ReLU)</strong></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Walkwithfastai_files/figure-html/1b231f7d-7297-45c7-89c4-69809812b99b.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">mish.JPG</figcaption><p></p>
</figure>
</div>
<div class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb423"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb423-1"><a href="#cb423-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> unet_learner(</span>
<span id="cb423-2"><a href="#cb423-2" aria-hidden="true" tabindex="-1"></a>    dls, </span>
<span id="cb423-3"><a href="#cb423-3" aria-hidden="true" tabindex="-1"></a>    resnet34, </span>
<span id="cb423-4"><a href="#cb423-4" aria-hidden="true" tabindex="-1"></a>    metrics<span class="op">=</span>accuracy, </span>
<span id="cb423-5"><a href="#cb423-5" aria-hidden="true" tabindex="-1"></a>    self_attention<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb423-6"><a href="#cb423-6" aria-hidden="true" tabindex="-1"></a>    act_cls<span class="op">=</span>Mish,</span>
<span id="cb423-7"><a href="#cb423-7" aria-hidden="true" tabindex="-1"></a>    loss_func <span class="op">=</span> CrossEntropyLossFlat(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb423-8"><a href="#cb423-8" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb424"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb424-1"><a href="#cb424-1" aria-hidden="true" tabindex="-1"></a>learn.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>DynamicUnet (Input shape: 8 x 3 x 224 x 224)
============================================================================
Layer (type)         Output Shape         Param #    Trainable 
============================================================================
                     8 x 64 x 112 x 112  
Conv2d                                    9408       False     
BatchNorm2d                               128        True      
ReLU                                                           
____________________________________________________________________________
                     8 x 64 x 56 x 56    
MaxPool2d                                                      
Conv2d                                    36864      False     
BatchNorm2d                               128        True      
ReLU                                                           
Conv2d                                    36864      False     
BatchNorm2d                               128        True      
Conv2d                                    36864      False     
BatchNorm2d                               128        True      
ReLU                                                           
Conv2d                                    36864      False     
BatchNorm2d                               128        True      
Conv2d                                    36864      False     
BatchNorm2d                               128        True      
ReLU                                                           
Conv2d                                    36864      False     
BatchNorm2d                               128        True      
____________________________________________________________________________
                     8 x 128 x 28 x 28   
Conv2d                                    73728      False     
BatchNorm2d                               256        True      
ReLU                                                           
Conv2d                                    147456     False     
BatchNorm2d                               256        True      
Conv2d                                    8192       False     
BatchNorm2d                               256        True      
Conv2d                                    147456     False     
BatchNorm2d                               256        True      
ReLU                                                           
Conv2d                                    147456     False     
BatchNorm2d                               256        True      
Conv2d                                    147456     False     
BatchNorm2d                               256        True      
ReLU                                                           
Conv2d                                    147456     False     
BatchNorm2d                               256        True      
Conv2d                                    147456     False     
BatchNorm2d                               256        True      
ReLU                                                           
Conv2d                                    147456     False     
BatchNorm2d                               256        True      
____________________________________________________________________________
                     8 x 256 x 14 x 14   
Conv2d                                    294912     False     
BatchNorm2d                               512        True      
ReLU                                                           
Conv2d                                    589824     False     
BatchNorm2d                               512        True      
Conv2d                                    32768      False     
BatchNorm2d                               512        True      
Conv2d                                    589824     False     
BatchNorm2d                               512        True      
ReLU                                                           
Conv2d                                    589824     False     
BatchNorm2d                               512        True      
Conv2d                                    589824     False     
BatchNorm2d                               512        True      
ReLU                                                           
Conv2d                                    589824     False     
BatchNorm2d                               512        True      
Conv2d                                    589824     False     
BatchNorm2d                               512        True      
ReLU                                                           
Conv2d                                    589824     False     
BatchNorm2d                               512        True      
Conv2d                                    589824     False     
BatchNorm2d                               512        True      
ReLU                                                           
Conv2d                                    589824     False     
BatchNorm2d                               512        True      
Conv2d                                    589824     False     
BatchNorm2d                               512        True      
ReLU                                                           
Conv2d                                    589824     False     
BatchNorm2d                               512        True      
____________________________________________________________________________
                     8 x 512 x 7 x 7     
Conv2d                                    1179648    False     
BatchNorm2d                               1024       True      
ReLU                                                           
Conv2d                                    2359296    False     
BatchNorm2d                               1024       True      
Conv2d                                    131072     False     
BatchNorm2d                               1024       True      
Conv2d                                    2359296    False     
BatchNorm2d                               1024       True      
ReLU                                                           
Conv2d                                    2359296    False     
BatchNorm2d                               1024       True      
Conv2d                                    2359296    False     
BatchNorm2d                               1024       True      
ReLU                                                           
Conv2d                                    2359296    False     
BatchNorm2d                               1024       True      
BatchNorm2d                               1024       True      
ReLU                                                           
____________________________________________________________________________
                     8 x 1024 x 7 x 7    
Conv2d                                    4719616    True      
Mish                                                           
____________________________________________________________________________
                     8 x 512 x 7 x 7     
Conv2d                                    4719104    True      
Mish                                                           
____________________________________________________________________________
                     8 x 1024 x 7 x 7    
Conv2d                                    525312     True      
Mish                                                           
____________________________________________________________________________
                     8 x 256 x 14 x 14   
PixelShuffle                                                   
BatchNorm2d                               512        True      
Conv2d                                    2359808    True      
Mish                                                           
Conv2d                                    2359808    True      
Mish                                                           
Mish                                                           
____________________________________________________________________________
                     8 x 1024 x 14 x 14  
Conv2d                                    525312     True      
Mish                                                           
____________________________________________________________________________
                     8 x 256 x 28 x 28   
PixelShuffle                                                   
BatchNorm2d                               256        True      
Conv2d                                    1327488    True      
Mish                                                           
Conv2d                                    1327488    True      
Mish                                                           
____________________________________________________________________________
                     8 x 48 x 784        
Conv1d                                    18432      True      
Conv1d                                    18432      True      
Conv1d                                    147456     True      
Mish                                                           
____________________________________________________________________________
                     8 x 768 x 28 x 28   
Conv2d                                    295680     True      
Mish                                                           
____________________________________________________________________________
                     8 x 192 x 56 x 56   
PixelShuffle                                                   
BatchNorm2d                               128        True      
Conv2d                                    590080     True      
Mish                                                           
Conv2d                                    590080     True      
Mish                                                           
Mish                                                           
____________________________________________________________________________
                     8 x 512 x 56 x 56   
Conv2d                                    131584     True      
Mish                                                           
____________________________________________________________________________
                     8 x 128 x 112 x 112 
PixelShuffle                                                   
BatchNorm2d                               128        True      
____________________________________________________________________________
                     8 x 96 x 112 x 112  
Conv2d                                    165984     True      
Mish                                                           
Conv2d                                    83040      True      
Mish                                                           
Mish                                                           
____________________________________________________________________________
                     8 x 384 x 112 x 112 
Conv2d                                    37248      True      
Mish                                                           
____________________________________________________________________________
                     8 x 96 x 224 x 224  
PixelShuffle                                                   
ResizeToOrig                                                   
____________________________________________________________________________
                     8 x 99 x 224 x 224  
MergeLayer                                                     
Conv2d                                    88308      True      
Mish                                                           
Conv2d                                    88308      True      
Sequential                                                     
Mish                                                           
____________________________________________________________________________
                     8 x 2 x 224 x 224   
Conv2d                                    200        True      
ToTensorBase                                                   
____________________________________________________________________________

Total params: 41,405,488
Total trainable params: 20,137,840
Total non-trainable params: 21,267,648

Optimizer used: &lt;function Adam at 0x7f2741cf6680&gt;
Loss function: FlattenedLoss of CrossEntropyLoss()

Model frozen up to parameter group #2

Callbacks:
  - TrainEvalCallback
  - CastToTensor
  - Recorder
  - ProgressCallback</code></pre>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>You can see this change in shape visually in the architecture summary.</p>
</div></div><p>Otherwise training looks just as straightforward as before. Train our frozen backbone for a while:</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>
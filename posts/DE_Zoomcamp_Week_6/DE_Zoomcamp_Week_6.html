<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Stephen Barrie">
<meta name="dcterms.date" content="2023-04-03">

<title>Into the Unknown - Data Engineering Zoomcamp - Week 6</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Into the Unknown</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">Stephen Barrie</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"><i class="bi bi-rss" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Stephen137"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://linkedin.com/in/sjbarrie"><i class="bi bi-linkedin" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Data Engineering Zoomcamp - Week 6</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Kafka</div>
                <div class="quarto-category">Confluent</div>
                <div class="quarto-category">ksqlDataTalksClub</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Stephen Barrie </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 3, 2023</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#confluent-cloud" id="toc-confluent-cloud" class="nav-link active" data-scroll-target="#confluent-cloud">6.4 Confluent Cloud</a></li>
  <li><a href="#kafka-producer-consumer-using-java" id="toc-kafka-producer-consumer-using-java" class="nav-link" data-scroll-target="#kafka-producer-consumer-using-java">6.5 Kafka Producer Consumer (using Java)</a></li>
  <li><a href="#copying-files-from-windows-to-ubuntu" id="toc-copying-files-from-windows-to-ubuntu" class="nav-link" data-scroll-target="#copying-files-from-windows-to-ubuntu">Copying files from Windows to Ubuntu</a></li>
  <li><a href="#kafka-configuration" id="toc-kafka-configuration" class="nav-link" data-scroll-target="#kafka-configuration">6.6 Kafka Configuration</a></li>
  <li><a href="#kafka-streaming-using-python" id="toc-kafka-streaming-using-python" class="nav-link" data-scroll-target="#kafka-streaming-using-python">13.1 Kafka Streaming using Python</a></li>
  <li><a href="#streaming-data-held-in-a-pyspark-dataframe" id="toc-streaming-data-held-in-a-pyspark-dataframe" class="nav-link" data-scroll-target="#streaming-data-held-in-a-pyspark-dataframe">13.2 Streaming data held in a PySpark DataFrame</a></li>
  <li><a href="#spark-setup" id="toc-spark-setup" class="nav-link" data-scroll-target="#spark-setup">0 Spark Setup</a></li>
  <li><a href="#reading-from-kafka-stream" id="toc-reading-from-kafka-stream" class="nav-link" data-scroll-target="#reading-from-kafka-stream">1 Reading from Kafka Stream</a></li>
  <li><a href="#sink-operation-streaming-query" id="toc-sink-operation-streaming-query" class="nav-link" data-scroll-target="#sink-operation-streaming-query">2 Sink Operation &amp; Streaming Query</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>In week 5 we looked at <strong><em>Batch Processing</em></strong> where the processing and analysis happens on a set of data that have already been stored over a period of time. An example is payroll and billing systems that have to be processed weekly or monthly.</p>
<p>This week we will be looking at <strong><em>Streaming data processing</em></strong> which happens as the data flows through a system. This results in analysis and reporting of events as it happens. An example would be fraud detection or intrusion detection. Streaming data processing means that the data will be analyzed and that actions will be taken on the data within a short period of time or near real-time, as best as it can. Real-time data processing guarantees that the real-time data will be acted on within a period of time, like milliseconds. An example would be for-real time application that purchases a stock within 20ms of receiving a desired price.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/fe8c0892-0f85-4365-95db-af5062e571a6.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">week_6.JPG</figcaption><p></p>
</figure>
</div>
<section id="confluent-cloud" class="level3">
<h3 class="anchored" data-anchor-id="confluent-cloud">6.4 Confluent Cloud</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/62348281-8957-4348-ac57-f3ec01414eb9.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">confluent_logo.png</figcaption><p></p>
</figure>
</div>
<p>Confluent Cloud is the industry’s only fully managed, cloud-native event streaming platform powered by Apache Kafka. Apache Kafka is an open source, distributed streaming platform that enables 100,000+ organizations globally to build event-driven applications at scale. Confluent Cloud provides a simple, scalable, resilient, and secure event streaming platform for the cloud-first enterprise, the DevOps-starved organization, or the agile developer on a mission.</p>
<p>Developers use Confluent Cloud to:</p>
<ul>
<li>analyze data at massive scale and in real-time. Stream data to Google Cloud’s big data solutions, including BigQuery, Cloud Machine Learning Engine and TensorFlow</li>
<li>build event-driven applications. Combine Confluent Cloud pub/sub messaging services with Google Cloud Functions, App Engine and Kubernetes</li>
<li>provide a persistent bridge to cloud. Build a real-time data pipeline between datacenters and Google Cloud, and accelerate multi-cloud adoption</li>
</ul>
<p>See the <a href="https://docs.confluent.io/cloud/current/get-started/index.html#quick-start-for-ccloud">Quick Start guide</a> to get up and running.</p>
<p>You can sign up for a 30 days free trial <a href="https://www.confluent.io/get-started/">here</a> and receive $400 of credit.</p>
<p><code>Create Cluster</code></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/60bab788-52bf-450e-904f-882ea915d7d2.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">basic.PNG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/3c764117-1f6d-4f86-84dc-fbba9d8faee4.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">region.PNG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/19e45fdd-fe80-4443-b183-93e3149eaa52.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">skip_payment.PNG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/c01dce60-ed86-4e06-a20b-7994c1f2c325.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">create_cluster.PNG</figcaption><p></p>
</figure>
</div>
<p><code>Dashboard</code></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/a4c77f18-77d4-46d0-b687-f95b3c1ae727.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">confluent_dashboard.PNG</figcaption><p></p>
</figure>
</div>
<p><code>API Keys</code></p>
<p>The first thing we need to do is create an API key. An API key consists of a key and a secret. Kafka API keys are required to interact with Kafka clusters in Confluent Cloud. Each Kafka API key is valid for a specific Kafka cluster. To grant API access for this Cloud organization, go <a href="https://confluent.cloud/settings/api-keys">here</a>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/dcebbc21-3705-415d-b189-df81e73c30f6.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">global_access.PNG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/fc4c35eb-67b2-49d3-81e5-fcba65223f01.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">api_key.PNG</figcaption><p></p>
</figure>
</div>
<p><code>Cluster Settings</code></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/92bc9178-522d-4062-9a27-de3db49651ae.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">cluster_settings_general.PNG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/2c508f39-c832-4c38-bca1-69ea978909b1.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">cluster_settings_capacity.PNG</figcaption><p></p>
</figure>
</div>
<p><code>Topics</code></p>
<p>A Topic is a category/feed name to which records are stored and published. All Kafka records are organized into topics. Producer applications write data to topics and consumer applications read from topics. Records published to the cluster stay in the cluster until a configurable retention period has passed by.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/a61712af-29f5-4bf0-88b8-2a0967a3323e.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">topic.PNG</figcaption><p></p>
</figure>
</div>
<p><code>Messages</code></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/06cc4157-bde5-4cd1-be3e-3ecb0ceaf4c7.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">messages.PNG</figcaption><p></p>
</figure>
</div>
<p>Let’s create a dummy message :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/4285d088-fbd7-4c16-aac5-525aa8c43b08.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">example_message.PNG</figcaption><p></p>
</figure>
</div>
<p><code>Schema</code></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/9cd439ee-4bca-4c8a-b193-b4c8d9b52b31.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">schema.PNG</figcaption><p></p>
</figure>
</div>
<p>You can use Confluent Cloud Schema Registry to manage schemas in Confluent Cloud. You enable a single Schema Registry per Confluent Cloud environment. Schema Registry is accessed over port 443.</p>
<p>You can create and edit schemas in a schema editor and associate them with Kafka topics. This <a href="https://docs.confluent.io/cloud/current/get-started/schema-registry.html?ajs_aid=fb07bb5b-45de-4fef-8f3c-582720283f1e&amp;ajs_uid=1254227#quick-start-for-schema-management-on-ccloud">quick start</a> does not cover all the capabilities of Schema Registry, but rather is an introduction. For a complete guide, see <a href="https://docs.confluent.io/cloud/current/sr/schemas-manage.html#sr-prv">Manage Schemas in Confluent Cloud</a>.</p>
<p><code>Connectors</code></p>
<p>Confluent Cloud offers pre-built, fully managed Kafka connectors that make it easy to instantly connect your clusters to popular data sources and sinks. Connect to external data systems effortlessly with simple configuration and no ongoing operational burden.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/931f986f-7fb3-4f22-ad45-f67b390aed47.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">connectors.PNG</figcaption><p></p>
</figure>
</div>
<p>Let’s create a <code>Datagen Source</code> connector which is used to generate mock data for development and testing :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/9d9698b9-d5de-4287-abac-8d896d5d09ec.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">datagen_1.PNG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/9e103866-9ded-457a-9d7c-56212f4255d5.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">datagen_2.PNG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/827d4a02-cf3c-45f7-9a34-31e0cb9a71c1.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">datagen_3.PNG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/487d0840-9a2c-4035-afc0-b49c83724d21.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">datagen_4.PNG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/dd32a76a-599b-4c56-bb3a-ea94bb5454b3.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">datagen_5.PNG</figcaption><p></p>
</figure>
</div>
<p>Our connector setup is complete and our connector is now running :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/a6b1a55a-3ee5-448e-9524-b4c820b50d36.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">connector_running.PNG</figcaption><p></p>
</figure>
</div>
<p><code>Metrics</code></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/ac6fbc27-6779-439e-9223-93d7d32783e8.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">metrics.PNG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/b9587317-0d64-4c97-acef-25c8e0990838.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">received_bytes.PNG</figcaption><p></p>
</figure>
</div>
<p>We can see an overview of our example topic here which shows we have produced meesages and there has been some consumption :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/b552cac3-1309-4267-a6e1-3fd280d817a2.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">example_overview.PNG</figcaption><p></p>
</figure>
</div>
<p>Let’s shut down our dummy connector to protect our credits :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/adaafa58-3f73-4187-b8cb-93d637dbe586.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">shutdown.PNG</figcaption><p></p>
</figure>
</div>
<p>Now that we have an overview, in the next section we will progress to producing and consuming some messages using code.</p>
</section>
<section id="kafka-producer-consumer-using-java" class="level3">
<h3 class="anchored" data-anchor-id="kafka-producer-consumer-using-java">6.5 Kafka Producer Consumer (using Java)</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/951ad054-f655-4f34-9eff-8035cae56f3d.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<section id="what-is-a-producer" class="level4">
<h4 class="anchored" data-anchor-id="what-is-a-producer">What is a producer ?</h4>
<p>A Kafka producer writes messages to a topic. A producer partitioner maps each message to a topic partition, and the producer sends a produce request to the leader of that partition. The partitioners shipped with Kafka guarantee that all messages with the same non-empty key will be sent to the same partition.</p>
<p>All Kafka producer libraries have a small API surface area. First configure how to connect to the Kafka cluster. Then can send records, expressed as key-value pairs, to the cluster.</p>
</section>
<section id="what-is-a-consumer" class="level4">
<h4 class="anchored" data-anchor-id="what-is-a-consumer">What is a consumer ?</h4>
<p>A Kafka consumer reads messages from a topic. Kafka consumers are typically part of a consumer group. A consumer group is a set of consumers which cooperate to consume data from some topics. The partitions of all the topics are divided among the consumers in the group to allow for parallelism in reading the data.”</p>
<p>The Kafka consumer library is similar in principle to the producer. First configure how to connect to the Kafka cluster. Then use that connection to subscribe to one or more topics. When messages are available on those topics, they come back in a collection of records which represent key/value pairs from single messages.</p>
<p>Let’s now create a new topic for our taxi rides data :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/2ac89712-ffd3-4637-8e0c-5df9a5006443.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">taxi_rides_topic.PNG</figcaption><p></p>
</figure>
</div>
<p><code>Clients</code></p>
<p>Clients are applications that you write in your programming language of choice. Clients allow you to send and receive data to/from Confluent by producing and consuming from Kafka topics :</p>
<p><code>Choose your language</code></p>
<p>We are now going to introduce our NY taxi rides data that we have been working with throughout this course into Kafka using the <a href="https://en.wikipedia.org/wiki/Java_(programming_language)">Java programming language</a>. Kafka libraries are well maintained for Java. Python libraries are less so however we will look at some Python examples later.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/2d1f30fe-331d-4809-816c-225cd8647749.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">new_client.PNG</figcaption><p></p>
</figure>
</div>
</section>
<section id="installing-a-java-ide" class="level4">
<h4 class="anchored" data-anchor-id="installing-a-java-ide">Installing a Java IDE</h4>
<p>In the course video Ankush mentioned he was using <a href="https://www.jetbrains.com/idea/">IntelliJ</a>. I have <strong>xero</strong> Java experience but have some Python knowledge, so hopefuly it won’t be too intimidating. Let’s have a go at instlling the IDE.</p>
<p>Follow the <a href="https://www.jetbrains.com/help/idea/installation-guide.html#toolbox">installation instructions</a>.</p>
<ol type="1">
<li><p>Install the Toolbox App</p></li>
<li><p>Extract the tarball to a directory that supports file execution.</p></li>
</ol>
<p>Unpack the <code>tar.gz</code> file using the following command:</p>
<pre><code>sudo tar -xzf jetbrains-toolbox-1.27.3.14493.tar.gz -C /opt</code></pre>
<ol start="3" type="1">
<li>Execute the jetbrains-toolbox binary from the extracted directory to run the Toolbox App.</li>
</ol>
<p>After you run the Toolbox App for the first time, it will automatically add the Toolbox App icon Toolbox App icon to the main menu.</p>
<ol start="4" type="1">
<li>Select the product that you want to install.</li>
</ol>
<p><strong>Configuration using files produced by Confluent</strong></p>
<p><code>Copy the configuration snippet for your clients</code></p>
<p>Paste the following configuration data into a file called <code>client.properties</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Required connection configs for Kafka producer, consumer, and admin</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>bootstrap.servers<span class="op">=</span>pkc<span class="op">-</span>xmzwx.europe<span class="op">-</span>central2.gcp.confluent.cloud:<span class="dv">9092</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>security.protocol<span class="op">=</span>SASL_SSL</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>sasl.jaas.config<span class="op">=</span>org.apache.kafka.common.security.plain.PlainLoginModule required username<span class="op">=</span><span class="st">'MT2AG6GKQMMR2ZOQ'</span> password<span class="op">=</span><span class="st">'Kuj0vwcPzWuu08zojjtQGtWo+EH4grftzQ++PXKL9yAf3VagJdWrjUd4udW5754C'</span><span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>sasl.mechanism<span class="op">=</span>PLAIN</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Required for correctness in Apache Kafka clients prior to 2.6</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>client.dns.lookup<span class="op">=</span>use_all_dns_ips</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Best practice for higher availability in Apache Kafka clients prior to 3.0</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>session.timeout.ms<span class="op">=</span><span class="dv">45000</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Best practice for Kafka producer to prevent data loss</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>acks<span class="op">=</span><span class="bu">all</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Required connection configs for Confluent Cloud Schema Registry</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>schema.registry.url<span class="op">=</span>https:<span class="op">//</span>{{ SR_ENDPOINT }}</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>basic.auth.credentials.source<span class="op">=</span>USER_INFO</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>basic.auth.user.info<span class="op">=</span>{{ SR_API_KEY }}:{{ SR_API_SECRET }}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>Install the required libraries</code></p>
<p>Install <a href="https://gradle.org/install/">gradle</a> (if not already installed). Create a file called <code>build.gradle</code> with the following contents :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>buildscript {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    repositories {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        mavenCentral()</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    dependencies {</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        classpath <span class="st">"gradle.plugin.com.github.jengelman.gradle.plugins:shadow:7.0.0"</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>plugins {</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span> <span class="st">"java"</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span> <span class="st">"idea"</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span> <span class="st">"eclipse"</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>sourceCompatibility <span class="op">=</span> <span class="st">"1.11"</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>targetCompatibility <span class="op">=</span> <span class="st">"1.11"</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>version <span class="op">=</span> <span class="st">"0.0.1"</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>repositories {</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    mavenCentral()</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    maven {</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        url <span class="st">"https://packages.confluent.io/maven"</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="bu">apply</span> plugin: <span class="st">"com.github.johnrengelman.shadow"</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>dependencies {</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    implementation group: <span class="st">'org.slf4j'</span>, name: <span class="st">'slf4j-nop'</span>, version: <span class="st">'1.7.36'</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    implementation group: <span class="st">'org.apache.kafka'</span>, name: <span class="st">'kafka-clients'</span>, version: <span class="st">'3.3.1'</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>jar {</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    manifest {</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>        attributes(</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Class-Path"</span>: configurations.compileClasspath.collect { it.getName() }.join(<span class="st">" "</span>),</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Main-Class"</span>: <span class="st">"examples.ProducerExample"</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>shadowJar {</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    archiveBaseName <span class="op">=</span> <span class="st">"kafka-java-getting-started"</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    archiveClassifier <span class="op">=</span> <span class="st">''</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>Produce data</code></p>
<p>First, load producer configuration settings from a local file (based on the client properties above).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> org.apache.kafka.clients.producer.<span class="op">*;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> java.io.<span class="op">*;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> java.nio.<span class="bu">file</span>.<span class="op">*;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> java.util.<span class="op">*;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>public static Properties loadConfig(final String configFile) throws IOException {</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="op">!</span>Files.exists(Paths.get(configFile))) {</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>            throw new IOException(configFile <span class="op">+</span> <span class="st">" not found."</span>)<span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        final Properties cfg <span class="op">=</span> new Properties()<span class="op">;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> (InputStream inputStream <span class="op">=</span> new FileInputStream(configFile)) {</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>            cfg.load(inputStream)<span class="op">;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cfg<span class="op">;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>final Properties props <span class="op">=</span> loadConfig(<span class="st">"client.properties"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, create a producer based on the code snippet below :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>Producer<span class="op">&lt;</span>String, String<span class="op">&gt;</span> producer <span class="op">=</span> new KafkaProducer<span class="op">&lt;&gt;</span>(props)<span class="op">;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>producer.send(new ProducerRecord<span class="op">&lt;&gt;</span>(<span class="st">"my-topic"</span>, <span class="st">"key"</span>, <span class="st">"value"</span>))<span class="op">;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>producer.close()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>Learn more</code></p>
<ul>
<li>Check out the full <a href="https://developer.confluent.io/get-started/java/?ajs_aid=37e21b6a-45df-43a6-9a21-e9b1d40ab6cb&amp;ajs_uid=1254219#introduction">getting started tutorial</a></li>
<li>For the Java client API, check out the <a href="https://docs.confluent.io/platform/current/clients/javadocs/javadoc/index.html?_ga=2.194093037.1737893820.1667837038-1469322267.1663606026&amp;ajs_aid=37e21b6a-45df-43a6-9a21-e9b1d40ab6cb&amp;ajs_uid=1254219">Java documentation</a></li>
<li>Try out <a href="https://kafka-tutorials.confluent.io/creating-first-apache-kafka-streams-application/confluent.html?_ga=2.168998881.1737893820.1667837038-1469322267.1663606026&amp;ajs_aid=37e21b6a-45df-43a6-9a21-e9b1d40ab6cb&amp;ajs_uid=1254219">Kafka Streams</a> to unlock powerful features such as real-time joins, aggregations, filters, and exactly-once processing</li>
</ul>
<p><strong>Configuration using files included by Ankush Khanna</strong></p>
<p><code>Ride.java</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>package org.example.data<span class="op">;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> java.nio.DoubleBuffer<span class="op">;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> java.time.LocalDate<span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> java.time.LocalDateTime<span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> java.time.<span class="bu">format</span>.DateTimeFormatter<span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>public <span class="kw">class</span> Ride {</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    public Ride(String[] arr) {</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        VendorID <span class="op">=</span> arr[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        tpep_pickup_datetime <span class="op">=</span> LocalDateTime.parse(arr[<span class="dv">1</span>], DateTimeFormatter.ofPattern(<span class="st">"yyyy-MM-dd HH:mm:ss"</span>))<span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        tpep_dropoff_datetime <span class="op">=</span> LocalDateTime.parse(arr[<span class="dv">2</span>], DateTimeFormatter.ofPattern(<span class="st">"yyyy-MM-dd HH:mm:ss"</span>))<span class="op">;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        passenger_count <span class="op">=</span> Integer.parseInt(arr[<span class="dv">3</span>])<span class="op">;</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        trip_distance <span class="op">=</span> Double.parseDouble(arr[<span class="dv">4</span>])<span class="op">;</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        RatecodeID <span class="op">=</span> Long.parseLong(arr[<span class="dv">5</span>])<span class="op">;</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        store_and_fwd_flag <span class="op">=</span> arr[<span class="dv">6</span>]<span class="op">;</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        PULocationID <span class="op">=</span> Long.parseLong(arr[<span class="dv">7</span>])<span class="op">;</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        DOLocationID <span class="op">=</span> Long.parseLong(arr[<span class="dv">8</span>])<span class="op">;</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        payment_type <span class="op">=</span> arr[<span class="dv">9</span>]<span class="op">;</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        fare_amount <span class="op">=</span> Double.parseDouble(arr[<span class="dv">10</span>])<span class="op">;</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        extra <span class="op">=</span> Double.parseDouble(arr[<span class="dv">11</span>])<span class="op">;</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        mta_tax <span class="op">=</span> Double.parseDouble(arr[<span class="dv">12</span>])<span class="op">;</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        tip_amount <span class="op">=</span> Double.parseDouble(arr[<span class="dv">13</span>])<span class="op">;</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        tolls_amount <span class="op">=</span> Double.parseDouble(arr[<span class="dv">14</span>])<span class="op">;</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        improvement_surcharge <span class="op">=</span> Double.parseDouble(arr[<span class="dv">15</span>])<span class="op">;</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        total_amount <span class="op">=</span> Double.parseDouble(arr[<span class="dv">16</span>])<span class="op">;</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        congestion_surcharge <span class="op">=</span> Double.parseDouble(arr[<span class="dv">17</span>])<span class="op">;</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    public Ride(){}</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    public String VendorID<span class="op">;</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    public LocalDateTime tpep_pickup_datetime<span class="op">;</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    public LocalDateTime tpep_dropoff_datetime<span class="op">;</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    public <span class="bu">int</span> passenger_count<span class="op">;</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    public double trip_distance<span class="op">;</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    public <span class="bu">long</span> RatecodeID<span class="op">;</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    public String store_and_fwd_flag<span class="op">;</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    public <span class="bu">long</span> PULocationID<span class="op">;</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    public <span class="bu">long</span> DOLocationID<span class="op">;</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    public String payment_type<span class="op">;</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    public double fare_amount<span class="op">;</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    public double extra<span class="op">;</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    public double mta_tax<span class="op">;</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    public double tip_amount<span class="op">;</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    public double tolls_amount<span class="op">;</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    public double improvement_surcharge<span class="op">;</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    public double total_amount<span class="op">;</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>    public double congestion_surcharge<span class="op">;</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>JsonProducer.java</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>package org.example<span class="op">;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> com.opencsv.CSVReader<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> com.opencsv.exceptions.CsvException<span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> org.apache.kafka.clients.producer.<span class="op">*;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> org.apache.kafka.streams.StreamsConfig<span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> org.example.data.Ride<span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> java.io.FileReader<span class="op">;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> java.io.IOException<span class="op">;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> java.time.LocalDateTime<span class="op">;</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> java.util.List<span class="op">;</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> java.util.Properties<span class="op">;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> java.util.concurrent.ExecutionException<span class="op">;</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> java.util.stream.Collectors<span class="op">;</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>public <span class="kw">class</span> JsonProducer {</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    private Properties props <span class="op">=</span> new Properties()<span class="op">;</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    public JsonProducer() {</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="st">"pkc-xmzwx.europe-central2.gcp.confluent.cloud:9092"</span>)<span class="op">;</span> <span class="co">#use CONFLUENT config</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        props.put(<span class="st">"security.protocol"</span>, <span class="st">"SASL_SSL"</span>)<span class="op">;</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        props.put(<span class="st">"sasl.jaas.config"</span>, <span class="st">"org.apache.kafka.common.security.plain.PlainLoginModule required username='"</span><span class="op">+</span>Secrets.KAFKA_CLUSTER_KEY<span class="op">+</span><span class="st">"' password='"</span><span class="op">+</span>Secrets.KAFKA_CLUSTER_SECRET<span class="op">+</span><span class="st">"';"</span>)<span class="op">;</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        props.put(<span class="st">"sasl.mechanism"</span>, <span class="st">"PLAIN"</span>)<span class="op">;</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>        props.put(<span class="st">"client.dns.lookup"</span>, <span class="st">"use_all_dns_ips"</span>)<span class="op">;</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        props.put(<span class="st">"session.timeout.ms"</span>, <span class="st">"45000"</span>)<span class="op">;</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        props.put(ProducerConfig.ACKS_CONFIG, <span class="st">"all"</span>)<span class="op">;</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, <span class="st">"org.apache.kafka.common.serialization.StringSerializer"</span>)<span class="op">;</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, <span class="st">"io.confluent.kafka.serializers.KafkaJsonSerializer"</span>)<span class="op">;</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    public List<span class="op">&lt;</span>Ride<span class="op">&gt;</span> getRides() throws IOException, CsvException {</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>        var ridesStream <span class="op">=</span> this.getClass().getResource(<span class="st">"Dats/rides.csv"</span>)<span class="op">;</span> <span class="co">#Modify file path</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>        var reader <span class="op">=</span> new CSVReader(new FileReader(ridesStream.getFile()))<span class="op">;</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>        reader.skip(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> reader.readAll().stream().<span class="bu">map</span>(arr <span class="op">-&gt;</span> new Ride(arr))</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>                .collect(Collectors.toList())<span class="op">;</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    public void publishRides(List<span class="op">&lt;</span>Ride<span class="op">&gt;</span> rides) throws ExecutionException, InterruptedException {</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>        KafkaProducer<span class="op">&lt;</span>String, Ride<span class="op">&gt;</span> kafkaProducer <span class="op">=</span> new KafkaProducer<span class="op">&lt;</span>String, Ride<span class="op">&gt;</span>(props)<span class="op">;</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(Ride ride: rides) {</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>            ride.tpep_pickup_datetime <span class="op">=</span> LocalDateTime.now().minusMinutes(<span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>            ride.tpep_dropoff_datetime <span class="op">=</span> LocalDateTime.now()<span class="op">;</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>            var record <span class="op">=</span> kafkaProducer.send(new ProducerRecord<span class="op">&lt;&gt;</span>(<span class="st">"taxi-rides-ny-137"</span>, String.valueOf(ride.DOLocationID), ride), (metadata, exception) <span class="op">-&gt;</span> {</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(exception <span class="op">!=</span> null) {</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>                    System.out.println(exception.getMessage())<span class="op">;</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>            System.out.println(record.get().offset())<span class="op">;</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>            System.out.println(ride.DOLocationID)<span class="op">;</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>            Thread.sleep(<span class="dv">500</span>)<span class="op">;</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>    public static void main(String[] args) throws IOException, CsvException, ExecutionException, InterruptedException {</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>        var producer <span class="op">=</span> new JsonProducer()<span class="op">;</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>        var rides <span class="op">=</span> producer.getRides()<span class="op">;</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>        producer.publishRides(rides)<span class="op">;</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>Secrets.java</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>package org.example<span class="op">;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>public <span class="kw">class</span> Secrets {</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    public static final String KAFKA_CLUSTER_KEY <span class="op">=</span> <span class="st">"REPLACE_WITH_YOUR_KAFKA_CLUSTER_KEY"</span><span class="op">;</span> <span class="co">##use CONFLUENT config</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    public static final String KAFKA_CLUSTER_SECRET <span class="op">=</span> <span class="st">"REPLACE_WITH_YOUR_KAFKA_CLUSTER_SECRET"</span><span class="op">;</span> <span class="co">#use CONFLUENT config</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    public static final String SCHEMA_REGISTRY_KEY <span class="op">=</span> <span class="st">"REPLACE_WITH_SCHEMA_REGISTRY_KEY"</span><span class="op">;</span> <span class="co">#use CONFLUENT config</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    public static final String SCHEMA_REGISTRY_SECRET <span class="op">=</span> <span class="st">"REPLACE_WITH_SCHEMA_REGISTRY_SECRET"</span><span class="op">;</span> <span class="co">#use CONFLUENT config</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>build.gradle</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>plugins {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span> <span class="st">'java'</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span> <span class="st">"com.github.davidmc24.gradle.plugin.avro"</span> version <span class="st">"1.5.0"</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>group <span class="st">'org.example'</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>version <span class="st">'1.0-SNAPSHOT'</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>repositories {</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    mavenCentral()</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    maven {</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        url <span class="st">"https://packages.confluent.io/maven"</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>dependencies {</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    implementation <span class="st">'org.apache.kafka:kafka-clients:3.3.1'</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    implementation <span class="st">'com.opencsv:opencsv:5.7.1'</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    implementation <span class="st">'io.confluent:kafka-json-serializer:7.3.1'</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    implementation <span class="st">'org.apache.kafka:kafka-streams:3.3.1'</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    implementation <span class="st">'io.confluent:kafka-avro-serializer:7.3.1'</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    implementation <span class="st">'io.confluent:kafka-schema-registry-client:7.3.1'</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    implementation <span class="st">'io.confluent:kafka-streams-avro-serde:7.3.1'</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    implementation <span class="st">"org.apache.avro:avro:1.11.0"</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    testImplementation <span class="st">'org.junit.jupiter:junit-jupiter-api:5.8.1'</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    testRuntimeOnly <span class="st">'org.junit.jupiter:junit-jupiter-engine:5.8.1'</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    testImplementation <span class="st">'org.apache.kafka:kafka-streams-test-utils:3.3.1'</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>sourceSets.main.java.srcDirs <span class="op">=</span> [<span class="st">'build/generated-main-avro-java'</span>,<span class="st">'src/main/java'</span>]</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>test {</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    useJUnitPlatform()</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="copying-files-from-windows-to-ubuntu" class="level3">
<h3 class="anchored" data-anchor-id="copying-files-from-windows-to-ubuntu">Copying files from Windows to Ubuntu</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>https:<span class="op">//</span>linuxhint.com<span class="op">/</span>copy<span class="op">-</span>files<span class="op">-</span><span class="im">from</span><span class="op">-</span>windows<span class="op">-</span>ubuntu<span class="op">-</span>wsl<span class="op">-</span>same<span class="op">-</span>host<span class="op">/</span><span class="co">#:~:text=Using%20the%20File%20System,files%20from%20Windows%20to%20Ubuntu.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>sudo cp /mnt/c/Users/User/Downloads/'jetbrains-toolbox-1.27.3.14493 (1).gz' .</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">"C:\Users\User\Downloads\eclipse-java-2023-03-R-linux-gtk-x86_64.tar.gz"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>https:<span class="op">//</span>www.youtube.com<span class="op">/</span>watch?v<span class="op">=</span>WUrDUZw6G70</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>https:<span class="op">//</span>www.testingdocs.com<span class="op">/</span>questions<span class="op">/</span>how<span class="op">-</span>to<span class="op">-</span>launch<span class="op">-</span>eclipse<span class="op">-</span><span class="im">from</span><span class="op">-</span>terminal<span class="op">-</span><span class="kw">in</span><span class="op">-</span>linux<span class="op">/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="kafka-configuration" class="level3">
<h3 class="anchored" data-anchor-id="kafka-configuration">6.6 Kafka Configuration</h3>
<p>https://kafka.apache.org/documentation/#configuration</p>
</section>
<section id="kafka-streaming-using-python" class="level3">
<h3 class="anchored" data-anchor-id="kafka-streaming-using-python">13.1 Kafka Streaming using Python</h3>
<p><code>Create Docker Network &amp; Volume</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Network</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>docker network  create kafka<span class="op">-</span>spark<span class="op">-</span>network</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Volume</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>docker volume create <span class="op">--</span>name<span class="op">=</span>hadoop<span class="op">-</span>distributed<span class="op">-</span><span class="bu">file</span><span class="op">-</span>system</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/1444fdb8-7e6f-4817-b8f3-ee0c2ce6203a.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">kafka_spark_network.PNG</figcaption><p></p>
</figure>
</div>
<p><code>Run Services on Docker</code></p>
<p><code>docker-compose.yml</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>version: <span class="st">"3.6"</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>volumes:</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  shared<span class="op">-</span>workspace:</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    name: <span class="st">"hadoop-distributed-file-system"</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    driver: local</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>services:</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  jupyterlab:</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    image: jupyterlab</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    container_name: jupyterlab</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    ports:</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> <span class="dv">8888</span>:<span class="dv">8888</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    volumes:</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> shared<span class="op">-</span>workspace:<span class="op">/</span>opt<span class="op">/</span>workspace</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  spark<span class="op">-</span>master:</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    image: spark<span class="op">-</span>master</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    container_name: spark<span class="op">-</span>master</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    environment:</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>      SPARK_LOCAL_IP: <span class="st">'spark-master'</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    ports:</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> <span class="dv">8080</span>:<span class="dv">8080</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> <span class="dv">7077</span>:<span class="dv">7077</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    volumes:</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> shared<span class="op">-</span>workspace:<span class="op">/</span>opt<span class="op">/</span>workspace</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>  spark<span class="op">-</span>worker<span class="op">-</span><span class="dv">1</span>:</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    image: spark<span class="op">-</span>worker</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    container_name: spark<span class="op">-</span>worker<span class="op">-</span><span class="dv">1</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    environment:</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> SPARK_WORKER_CORES<span class="op">=</span><span class="dv">1</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> SPARK_WORKER_MEMORY<span class="op">=</span><span class="dv">4</span><span class="er">g</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    ports:</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> <span class="dv">8083</span>:<span class="dv">8081</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    volumes:</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> shared<span class="op">-</span>workspace:<span class="op">/</span>opt<span class="op">/</span>workspace</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    depends_on:</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> spark<span class="op">-</span>master</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>  spark<span class="op">-</span>worker<span class="op">-</span><span class="dv">2</span>:</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>    image: spark<span class="op">-</span>worker</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>    container_name: spark<span class="op">-</span>worker<span class="op">-</span><span class="dv">2</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    environment:</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> SPARK_WORKER_CORES<span class="op">=</span><span class="dv">1</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> SPARK_WORKER_MEMORY<span class="op">=</span><span class="dv">4</span><span class="er">g</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>    ports:</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> <span class="dv">8082</span>:<span class="dv">8081</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    volumes:</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> shared<span class="op">-</span>workspace:<span class="op">/</span>opt<span class="op">/</span>workspace</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    depends_on:</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> spark<span class="op">-</span>master</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>  broker:</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>    image: confluentinc<span class="op">/</span>cp<span class="op">-</span>kafka:<span class="fl">7.2.0</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>    hostname: broker</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>    container_name: broker</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>    depends_on:</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> zookeeper</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>    ports:</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> <span class="st">'9092:9092'</span></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    environment:</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>      KAFKA_BROKER_ID: <span class="dv">1</span></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>      KAFKA_ZOOKEEPER_CONNECT: <span class="st">'zookeeper:2181'</span></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>      <span class="co"># KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT</span></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>      <span class="co"># KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://broker:9092,PLAINTEXT_HOST://localhost:9092</span></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: LISTENER_BOB:PLAINTEXT,LISTENER_FRED:PLAINTEXT</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>      KAFKA_LISTENERS: LISTENER_BOB:<span class="op">//</span>broker:<span class="dv">29092</span>,LISTENER_FRED:<span class="op">//</span>broker:<span class="dv">9092</span></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>      KAFKA_ADVERTISED_LISTENERS: LISTENER_BOB:<span class="op">//</span>broker:<span class="dv">29092</span>,LISTENER_FRED:<span class="op">//</span>localhost:<span class="dv">9092</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>      KAFKA_INTER_BROKER_LISTENER_NAME: LISTENER_BOB</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: <span class="dv">1</span></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: <span class="dv">0</span></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: <span class="dv">1</span></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: <span class="dv">1</span></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>  schema<span class="op">-</span>registry:</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>    image: confluentinc<span class="op">/</span>cp<span class="op">-</span>schema<span class="op">-</span>registry:<span class="fl">7.2.0</span></span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>    hostname: schema<span class="op">-</span>registry</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>    container_name: schema<span class="op">-</span>registry</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>    depends_on:</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> zookeeper</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> broker</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>    ports:</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> <span class="st">"8081:8081"</span></span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>    environment:</span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>      <span class="co"># SCHEMA_REGISTRY_HOST_NAME: schema-registry # used for intercommunication</span></span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>      <span class="co"># SCHEMA_REGISTRY_KAFKASTORE_CONNECTION_URL: "zookeeper:2181" #(depreciated)</span></span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: <span class="st">"broker:29092"</span></span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>      SCHEMA_REGISTRY_HOST_NAME: <span class="st">"localhost"</span></span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>      SCHEMA_REGISTRY_LISTENERS: <span class="st">"http://0.0.0.0:8081"</span> <span class="co">#(default: http://0.0.0.0:8081)</span></span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>  zookeeper:</span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>    image: confluentinc<span class="op">/</span>cp<span class="op">-</span>zookeeper:<span class="fl">7.2.0</span></span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a>    hostname: zookeeper</span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>    container_name: zookeeper</span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>    ports:</span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> <span class="st">'2181:2181'</span></span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>    environment:</span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>      ZOOKEEPER_CLIENT_PORT: <span class="dv">2181</span></span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a>      ZOOKEEPER_TICK_TIME: <span class="dv">2000</span></span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>  control<span class="op">-</span>center:</span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>    image: confluentinc<span class="op">/</span>cp<span class="op">-</span>enterprise<span class="op">-</span>control<span class="op">-</span>center:<span class="fl">7.2.0</span></span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>    hostname: control<span class="op">-</span>center</span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a>    container_name: control<span class="op">-</span>center</span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a>    depends_on:</span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> zookeeper</span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> broker</span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> schema<span class="op">-</span>registry</span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a>    ports:</span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> <span class="st">"9021:9021"</span></span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a>    environment:</span>
<span id="cb16-105"><a href="#cb16-105" aria-hidden="true" tabindex="-1"></a>      CONTROL_CENTER_BOOTSTRAP_SERVERS: <span class="st">'broker:29092'</span></span>
<span id="cb16-106"><a href="#cb16-106" aria-hidden="true" tabindex="-1"></a>      CONTROL_CENTER_ZOOKEEPER_CONNECT: <span class="st">'zookeeper:2181'</span></span>
<span id="cb16-107"><a href="#cb16-107" aria-hidden="true" tabindex="-1"></a>      CONTROL_CENTER_SCHEMA_REGISTRY_URL: <span class="st">"http://localhost:8081"</span></span>
<span id="cb16-108"><a href="#cb16-108" aria-hidden="true" tabindex="-1"></a>      CONTROL_CENTER_REPLICATION_FACTOR: <span class="dv">1</span></span>
<span id="cb16-109"><a href="#cb16-109" aria-hidden="true" tabindex="-1"></a>      CONTROL_CENTER_INTERNAL_TOPICS_PARTITIONS: <span class="dv">1</span></span>
<span id="cb16-110"><a href="#cb16-110" aria-hidden="true" tabindex="-1"></a>      CONTROL_CENTER_MONITORING_INTERCEPTOR_TOPIC_PARTITIONS: <span class="dv">1</span></span>
<span id="cb16-111"><a href="#cb16-111" aria-hidden="true" tabindex="-1"></a>      CONFLUENT_METRICS_TOPIC_REPLICATION: <span class="dv">1</span></span>
<span id="cb16-112"><a href="#cb16-112" aria-hidden="true" tabindex="-1"></a>      PORT: <span class="dv">9021</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Start Docker-Compose (within for kafka and spark folders)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>docker compose up <span class="op">-</span>d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/853d94e5-0753-4ca6-ba65-af4effa38614.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">docker_compose_up.PNG</figcaption><p></p>
</figure>
</div>
<p>We can see the containers have been created :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/f1e297fe-9169-4282-9041-ab61fec766a0.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">docker_containers.PNG</figcaption><p></p>
</figure>
</div>
<p>We also need to install the necessary dependencies from the command line using :</p>
<pre><code>pip install -r requirements.txt</code></pre>
<p><code>requirements.txt</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>kafka<span class="op">-</span>python<span class="op">==</span><span class="fl">1.4.6</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>confluent_kafka</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>requests</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>avro</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>faust</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>fastavro</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/17ce64d1-b769-414c-96e7-e1fcb32d3bfa.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">requirements.PNG</figcaption><p></p>
</figure>
</div>
<section id="kafka-listeners-explained" class="level4">
<h4 class="anchored" data-anchor-id="kafka-listeners-explained">Kafka Listeners – Explained</h4>
<p>https://www.confluent.io/blog/kafka-listeners-explained/</p>
</section>
<section id="json-producer-consumer-example-using-the-kafka-python-library" class="level4">
<h4 class="anchored" data-anchor-id="json-producer-consumer-example-using-the-kafka-python-library">Json Producer-Consumer Example using the <code>kafka-python</code> library</h4>
<p>Our overall set up includes four python files :</p>
<p><code>settings.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>INPUT_DATA_PATH <span class="op">=</span> <span class="st">'../resources/rides.csv'</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>BOOTSTRAP_SERVERS <span class="op">=</span> [<span class="st">'localhost:9092'</span>]</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>KAFKA_TOPIC <span class="op">=</span> <span class="st">'rides_json'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>ride.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Dict</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> decimal <span class="im">import</span> Decimal</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Ride:</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, arr: List[<span class="bu">str</span>]):</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vendor_id <span class="op">=</span> arr[<span class="dv">0</span>]</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.tpep_pickup_datetime <span class="op">=</span> datetime.strptime(arr[<span class="dv">1</span>], <span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S"</span>),</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.tpep_dropoff_datetime <span class="op">=</span> datetime.strptime(arr[<span class="dv">2</span>], <span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S"</span>),</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.passenger_count <span class="op">=</span> <span class="bu">int</span>(arr[<span class="dv">3</span>])</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.trip_distance <span class="op">=</span> Decimal(arr[<span class="dv">4</span>])</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rate_code_id <span class="op">=</span> <span class="bu">int</span>(arr[<span class="dv">5</span>])</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.store_and_fwd_flag <span class="op">=</span> arr[<span class="dv">6</span>]</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pu_location_id <span class="op">=</span> <span class="bu">int</span>(arr[<span class="dv">7</span>])</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.do_location_id <span class="op">=</span> <span class="bu">int</span>(arr[<span class="dv">8</span>])</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.payment_type <span class="op">=</span> arr[<span class="dv">9</span>]</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fare_amount <span class="op">=</span> Decimal(arr[<span class="dv">10</span>])</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.extra <span class="op">=</span> Decimal(arr[<span class="dv">11</span>])</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mta_tax <span class="op">=</span> Decimal(arr[<span class="dv">12</span>])</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.tip_amount <span class="op">=</span> Decimal(arr[<span class="dv">13</span>])</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.tolls_amount <span class="op">=</span> Decimal(arr[<span class="dv">14</span>])</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.improvement_surcharge <span class="op">=</span> Decimal(arr[<span class="dv">15</span>])</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.total_amount <span class="op">=</span> Decimal(arr[<span class="dv">16</span>])</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.congestion_surcharge <span class="op">=</span> Decimal(arr[<span class="dv">17</span>])</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span> <span class="co"># creates an array from the dictionary</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> from_dict(cls, d: Dict):</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cls(arr<span class="op">=</span>[</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'vendor_id'</span>],</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'tpep_pickup_datetime'</span>][<span class="dv">0</span>],</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'tpep_dropoff_datetime'</span>][<span class="dv">0</span>],</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'passenger_count'</span>],</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'trip_distance'</span>],</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'rate_code_id'</span>],</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'store_and_fwd_flag'</span>],</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'pu_location_id'</span>],</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'do_location_id'</span>],</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'payment_type'</span>],</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'fare_amount'</span>],</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'extra'</span>],</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'mta_tax'</span>],</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'tip_amount'</span>],</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'tolls_amount'</span>],</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'improvement_surcharge'</span>],</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'total_amount'</span>],</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'congestion_surcharge'</span>],</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>):</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>__class__<span class="sc">.</span><span class="va">__name__</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>__dict__<span class="sc">}</span><span class="ss">'</span> <span class="co"># on printing our Ride class, it will first print class name and then object as a dictionary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>producer.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Dict</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> kafka <span class="im">import</span> KafkaProducer</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> kafka.errors <span class="im">import</span> KafkaTimeoutError</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ride <span class="im">import</span> Ride</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> settings <span class="im">import</span> BOOTSTRAP_SERVERS, INPUT_DATA_PATH, KAFKA_TOPIC</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> JsonProducer(KafkaProducer):</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, props: Dict):</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.producer <span class="op">=</span> KafkaProducer(<span class="op">**</span>props) <span class="co"># expects a set of parameters defined in settings.py</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read_records(resource_path: <span class="bu">str</span>):</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        records <span class="op">=</span> []</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(resource_path, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>            reader <span class="op">=</span> csv.reader(f)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>            header <span class="op">=</span> <span class="bu">next</span>(reader)  <span class="co"># skip the header row</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> row <span class="kw">in</span> reader:</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>                records.append(Ride(arr<span class="op">=</span>row)) <span class="co"># array</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> records</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> publish_rides(<span class="va">self</span>, topic: <span class="bu">str</span>, messages: List[Ride]):</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ride <span class="kw">in</span> messages:</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>                record <span class="op">=</span> <span class="va">self</span>.producer.send(topic<span class="op">=</span>topic, key<span class="op">=</span>ride.pu_location_id, value<span class="op">=</span>ride)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">'Record </span><span class="sc">{}</span><span class="st"> successfully produced at offset </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(ride.pu_location_id, record.get().offset)) <span class="co"># debugging</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> KafkaTimeoutError <span class="im">as</span> e:</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(e.<span class="fu">__str__</span>())</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Config Should match with the KafkaProducer expectation</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> {</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">'bootstrap_servers'</span>: BOOTSTRAP_SERVERS,</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">'key_serializer'</span>: <span class="kw">lambda</span> key: <span class="bu">str</span>(key).encode(), <span class="co"># Kafka is expecting messages in binary format so need to convert before sending to Kafka</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">'value_serializer'</span>: <span class="kw">lambda</span> x: json.dumps(x.__dict__, default<span class="op">=</span><span class="bu">str</span>).encode(<span class="st">'utf-8'</span>)  <span class="co"># Kafka is expecting messages in binary format so need to convert before sending to Kafka</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    producer <span class="op">=</span> JsonProducer(props<span class="op">=</span>config)</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    rides <span class="op">=</span> producer.read_records(resource_path<span class="op">=</span>INPUT_DATA_PATH)</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>    producer.publish_rides(topic<span class="op">=</span>KAFKA_TOPIC, messages<span class="op">=</span>rides)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>consumer.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> json <span class="im">import</span> loads</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> kafka <span class="im">import</span> KafkaConsumer</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ride <span class="im">import</span> Ride</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> settings <span class="im">import</span> BOOTSTRAP_SERVERS, KAFKA_TOPIC</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> JsonConsumer:</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, props: Dict):</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.consumer <span class="op">=</span> KafkaConsumer(<span class="op">**</span>props)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> consume_from_kafka(<span class="va">self</span>, topics: List[<span class="bu">str</span>]):</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.consumer.subscribe(topics)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Consuming from Kafka started'</span>)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Available topics to consume: '</span>, <span class="va">self</span>.consumer.subscription())</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>                <span class="co"># SIGINT can't be handled when polling, limit timeout to 1 second.</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>                message <span class="op">=</span> <span class="va">self</span>.consumer.poll(<span class="fl">1.0</span>)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> message <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> message <span class="op">==</span> {}:</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> message_key, message_value <span class="kw">in</span> message.items():</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> msg_val <span class="kw">in</span> message_value:</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(msg_val.key, msg_val.value)</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.consumer.close()</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> {</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">'bootstrap_servers'</span>: BOOTSTRAP_SERVERS,</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">'auto_offset_reset'</span>: <span class="st">'earliest'</span>,</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">'enable_auto_commit'</span>: <span class="va">True</span>,</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">'key_deserializer'</span>: <span class="kw">lambda</span> key: <span class="bu">int</span>(key.decode(<span class="st">'utf-8'</span>)), <span class="co"># reverse of producer.py encoding</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">'value_deserializer'</span>: <span class="kw">lambda</span> x: loads(x.decode(<span class="st">'utf-8'</span>), object_hook<span class="op">=</span><span class="kw">lambda</span> d: Ride.from_dict(d)), <span class="co"># reverse of producer.py encoding</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">'group_id'</span>: <span class="st">'consumer.group.id.json-example.1'</span>,</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>    json_consumer <span class="op">=</span> JsonConsumer(props<span class="op">=</span>config)</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>    json_consumer.consume_from_kafka(topics<span class="op">=</span>[KAFKA_TOPIC])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First let’s run the <code>producer.py</code> script which references both the <code>settings.py</code> and `<code>ride.py</code> scripts :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/4416b2d5-6611-4466-81ee-0d8c5663870a.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">producer.PNG</figcaption><p></p>
</figure>
</div>
<p>And let’s now run the <code>consumer.py</code> script which also references both the <code>settings.py</code> and <code>ride.py</code> scripts :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/5e511bb5-d32e-4b80-a35b-89b57705f155.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">consumer.PNG</figcaption><p></p>
</figure>
</div>
<p>In the above examples we did not specify any <code>schema</code>.</p>
</section>
<section id="avro-producer-consumer-example-using-the-confluent-kafka-library" class="level4">
<h4 class="anchored" data-anchor-id="avro-producer-consumer-example-using-the-confluent-kafka-library">Avro Producer-Consumer Example using the <code>confluent-kafka</code> library</h4>
<p>The configuration for this example is slightly different from the previous example where we used the <code>kafka-python</code> library and did not specify any schema. In this example we will be using the <code>confluent-kafka</code> library and will be adding stability by specifying a schema. The overall set up is very similar, and includes five python files :</p>
<p><code>settings.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>INPUT_DATA_PATH <span class="op">=</span> <span class="st">'../resources/rides.csv'</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>RIDE_KEY_SCHEMA_PATH <span class="op">=</span> <span class="st">'../resources/schemas/taxi_ride_key.avsc'</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>RIDE_VALUE_SCHEMA_PATH <span class="op">=</span> <span class="st">'../resources/schemas/taxi_ride_value.avsc'</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>SCHEMA_REGISTRY_URL <span class="op">=</span> <span class="st">'http://localhost:8081'</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>BOOTSTRAP_SERVERS <span class="op">=</span> <span class="st">'localhost:9092'</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>KAFKA_TOPIC <span class="op">=</span> <span class="st">'rides_avro'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>ride_record.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Dict</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RideRecord:</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, arr: List[<span class="bu">str</span>]):</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vendor_id <span class="op">=</span> <span class="bu">int</span>(arr[<span class="dv">0</span>])</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.passenger_count <span class="op">=</span> <span class="bu">int</span>(arr[<span class="dv">1</span>])</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.trip_distance <span class="op">=</span> <span class="bu">float</span>(arr[<span class="dv">2</span>])</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.payment_type <span class="op">=</span> <span class="bu">int</span>(arr[<span class="dv">3</span>])</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.total_amount <span class="op">=</span> <span class="bu">float</span>(arr[<span class="dv">4</span>])</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> from_dict(cls, d: Dict):</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cls(arr<span class="op">=</span>[</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'vendor_id'</span>],</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'passenger_count'</span>],</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'trip_distance'</span>],</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'payment_type'</span>],</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>            d[<span class="st">'total_amount'</span>]</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>):</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>__class__<span class="sc">.</span><span class="va">__name__</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>__dict__<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dict_to_ride_record(obj, ctx):</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> obj <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> RideRecord.from_dict(obj)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ride_record_to_dict(ride_record: RideRecord, ctx):</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ride_record.__dict__</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>ride_record_key.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RideRecordKey:</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, vendor_id):</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vendor_id <span class="op">=</span> vendor_id</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> from_dict(cls, d: Dict):</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cls(vendor_id<span class="op">=</span>d[<span class="st">'vendor_id'</span>])</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>):</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>__class__<span class="sc">.</span><span class="va">__name__</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>__dict__<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dict_to_ride_record_key(obj, ctx):</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> obj <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> RideRecordKey.from_dict(obj)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ride_record_key_to_dict(ride_record_key: RideRecordKey, ctx):</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ride_record_key.__dict__</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>producer.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> sleep</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> confluent_kafka <span class="im">import</span> Producer</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> confluent_kafka.schema_registry <span class="im">import</span> SchemaRegistryClient <span class="co"># more stability by using Schema</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> confluent_kafka.schema_registry.avro <span class="im">import</span> AvroSerializer</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> confluent_kafka.serialization <span class="im">import</span> SerializationContext, MessageField</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ride_record_key <span class="im">import</span> RideRecordKey, ride_record_key_to_dict</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ride_record <span class="im">import</span> RideRecord, ride_record_to_dict</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> settings <span class="im">import</span> RIDE_KEY_SCHEMA_PATH, RIDE_VALUE_SCHEMA_PATH, <span class="op">\</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    SCHEMA_REGISTRY_URL, BOOTSTRAP_SERVERS, INPUT_DATA_PATH, KAFKA_TOPIC</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> delivery_report(err, msg):</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> err <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Delivery failed for record </span><span class="sc">{}</span><span class="st">: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(msg.key(), err))</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Record </span><span class="sc">{}</span><span class="st"> successfully produced to </span><span class="sc">{}</span><span class="st"> [</span><span class="sc">{}</span><span class="st">] at offset </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>        msg.key(), msg.topic(), msg.partition(), msg.offset()))</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RideAvroProducer:</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, props: Dict):</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Schema Registry and Serializer-Deserializer Configurations</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>        key_schema_str <span class="op">=</span> <span class="va">self</span>.load_schema(props[<span class="st">'schema.key'</span>])</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>        value_schema_str <span class="op">=</span> <span class="va">self</span>.load_schema(props[<span class="st">'schema.value'</span>])</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>        schema_registry_props <span class="op">=</span> {<span class="st">'url'</span>: props[<span class="st">'schema_registry.url'</span>]}</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>        schema_registry_client <span class="op">=</span> SchemaRegistryClient(schema_registry_props)</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.key_serializer <span class="op">=</span> AvroSerializer(schema_registry_client, key_schema_str, ride_record_key_to_dict)</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.value_serializer <span class="op">=</span> AvroSerializer(schema_registry_client, value_schema_str, ride_record_to_dict)</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Producer Configuration</span></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>        producer_props <span class="op">=</span> {<span class="st">'bootstrap.servers'</span>: props[<span class="st">'bootstrap.servers'</span>]}</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.producer <span class="op">=</span> Producer(producer_props)</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> load_schema(schema_path: <span class="bu">str</span>):</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>        path <span class="op">=</span> os.path.realpath(os.path.dirname(<span class="va">__file__</span>))</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>schema_path<span class="sc">}</span><span class="ss">"</span>) <span class="im">as</span> f:</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>            schema_str <span class="op">=</span> f.read()</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> schema_str</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> delivery_report(err, msg):</span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> err <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Delivery failed for record </span><span class="sc">{}</span><span class="st">: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(msg.key(), err))</span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span></span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Record </span><span class="sc">{}</span><span class="st"> successfully produced to </span><span class="sc">{}</span><span class="st"> [</span><span class="sc">{}</span><span class="st">] at offset </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(</span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>            msg.key(), msg.topic(), msg.partition(), msg.offset()))</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read_records(resource_path: <span class="bu">str</span>):</span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>        ride_records, ride_keys <span class="op">=</span> [], []</span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(resource_path, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>            reader <span class="op">=</span> csv.reader(f)</span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a>            header <span class="op">=</span> <span class="bu">next</span>(reader)  <span class="co"># skip the header</span></span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> row <span class="kw">in</span> reader:</span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a>                ride_records.append(RideRecord(arr<span class="op">=</span>[row[<span class="dv">0</span>], row[<span class="dv">3</span>], row[<span class="dv">4</span>], row[<span class="dv">9</span>], row[<span class="dv">16</span>]]))</span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a>                ride_keys.append(RideRecordKey(vendor_id<span class="op">=</span><span class="bu">int</span>(row[<span class="dv">0</span>])))</span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">zip</span>(ride_keys, ride_records)</span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> publish(<span class="va">self</span>, topic: <span class="bu">str</span>, records: [RideRecordKey, RideRecord]):</span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key_value <span class="kw">in</span> records:</span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a>            key, value <span class="op">=</span> key_value</span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.producer.produce(topic<span class="op">=</span>topic,</span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true" tabindex="-1"></a>                                      key<span class="op">=</span><span class="va">self</span>.key_serializer(key, SerializationContext(topic<span class="op">=</span>topic,</span>
<span id="cb27-71"><a href="#cb27-71" aria-hidden="true" tabindex="-1"></a>                                                                                        field<span class="op">=</span>MessageField.KEY)),</span>
<span id="cb27-72"><a href="#cb27-72" aria-hidden="true" tabindex="-1"></a>                                      value<span class="op">=</span><span class="va">self</span>.value_serializer(value, SerializationContext(topic<span class="op">=</span>topic,</span>
<span id="cb27-73"><a href="#cb27-73" aria-hidden="true" tabindex="-1"></a>                                                                                              field<span class="op">=</span>MessageField.VALUE)),</span>
<span id="cb27-74"><a href="#cb27-74" aria-hidden="true" tabindex="-1"></a>                                      on_delivery<span class="op">=</span>delivery_report)</span>
<span id="cb27-75"><a href="#cb27-75" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb27-76"><a href="#cb27-76" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb27-77"><a href="#cb27-77" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb27-78"><a href="#cb27-78" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Exception while producing record - </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb27-79"><a href="#cb27-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-80"><a href="#cb27-80" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.producer.flush()</span>
<span id="cb27-81"><a href="#cb27-81" aria-hidden="true" tabindex="-1"></a>        sleep(<span class="dv">1</span>)</span>
<span id="cb27-82"><a href="#cb27-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-83"><a href="#cb27-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-84"><a href="#cb27-84" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb27-85"><a href="#cb27-85" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> {</span>
<span id="cb27-86"><a href="#cb27-86" aria-hidden="true" tabindex="-1"></a>        <span class="st">'bootstrap.servers'</span>: BOOTSTRAP_SERVERS,</span>
<span id="cb27-87"><a href="#cb27-87" aria-hidden="true" tabindex="-1"></a>        <span class="st">'schema_registry.url'</span>: SCHEMA_REGISTRY_URL,</span>
<span id="cb27-88"><a href="#cb27-88" aria-hidden="true" tabindex="-1"></a>        <span class="st">'schema.key'</span>: RIDE_KEY_SCHEMA_PATH,</span>
<span id="cb27-89"><a href="#cb27-89" aria-hidden="true" tabindex="-1"></a>        <span class="st">'schema.value'</span>: RIDE_VALUE_SCHEMA_PATH</span>
<span id="cb27-90"><a href="#cb27-90" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb27-91"><a href="#cb27-91" aria-hidden="true" tabindex="-1"></a>    producer <span class="op">=</span> RideAvroProducer(props<span class="op">=</span>config)</span>
<span id="cb27-92"><a href="#cb27-92" aria-hidden="true" tabindex="-1"></a>    ride_records <span class="op">=</span> producer.read_records(resource_path<span class="op">=</span>INPUT_DATA_PATH)</span>
<span id="cb27-93"><a href="#cb27-93" aria-hidden="true" tabindex="-1"></a>    producer.publish(topic<span class="op">=</span>KAFKA_TOPIC, records<span class="op">=</span>ride_records)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>consumer.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> confluent_kafka <span class="im">import</span> Consumer</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> confluent_kafka.schema_registry <span class="im">import</span> SchemaRegistryClient <span class="co"># more stability by using Schema</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> confluent_kafka.schema_registry.avro <span class="im">import</span> AvroDeserializer</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> confluent_kafka.serialization <span class="im">import</span> SerializationContext, MessageField</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ride_record_key <span class="im">import</span> dict_to_ride_record_key</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ride_record <span class="im">import</span> dict_to_ride_record</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> settings <span class="im">import</span> BOOTSTRAP_SERVERS, SCHEMA_REGISTRY_URL, <span class="op">\</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    RIDE_KEY_SCHEMA_PATH, RIDE_VALUE_SCHEMA_PATH, KAFKA_TOPIC</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RideAvroConsumer:</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, props: Dict):</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Schema Registry and Serializer-Deserializer Configurations</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        key_schema_str <span class="op">=</span> <span class="va">self</span>.load_schema(props[<span class="st">'schema.key'</span>])</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>        value_schema_str <span class="op">=</span> <span class="va">self</span>.load_schema(props[<span class="st">'schema.value'</span>])</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>        schema_registry_props <span class="op">=</span> {<span class="st">'url'</span>: props[<span class="st">'schema_registry.url'</span>]}</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>        schema_registry_client <span class="op">=</span> SchemaRegistryClient(schema_registry_props)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.avro_key_deserializer <span class="op">=</span> AvroDeserializer(schema_registry_client<span class="op">=</span>schema_registry_client,</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>                                                      schema_str<span class="op">=</span>key_schema_str,</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>                                                      from_dict<span class="op">=</span>dict_to_ride_record_key)</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.avro_value_deserializer <span class="op">=</span> AvroDeserializer(schema_registry_client<span class="op">=</span>schema_registry_client,</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>                                                        schema_str<span class="op">=</span>value_schema_str,</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>                                                        from_dict<span class="op">=</span>dict_to_ride_record)</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>        consumer_props <span class="op">=</span> {<span class="st">'bootstrap.servers'</span>: props[<span class="st">'bootstrap.servers'</span>],</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>                          <span class="st">'group.id'</span>: <span class="st">'datatalkclubs.taxirides.avro.consumer.2'</span>,</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>                          <span class="st">'auto.offset.reset'</span>: <span class="st">"earliest"</span>}</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.consumer <span class="op">=</span> Consumer(consumer_props)</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> load_schema(schema_path: <span class="bu">str</span>):</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>        path <span class="op">=</span> os.path.realpath(os.path.dirname(<span class="va">__file__</span>))</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>schema_path<span class="sc">}</span><span class="ss">"</span>) <span class="im">as</span> f:</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>            schema_str <span class="op">=</span> f.read()</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> schema_str</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> consume_from_kafka(<span class="va">self</span>, topics: List[<span class="bu">str</span>]):</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.consumer.subscribe(topics<span class="op">=</span>topics)</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>                <span class="co"># SIGINT can't be handled when polling, limit timeout to 1 second.</span></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>                msg <span class="op">=</span> <span class="va">self</span>.consumer.poll(<span class="fl">1.0</span>)</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> msg <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>                key <span class="op">=</span> <span class="va">self</span>.avro_key_deserializer(msg.key(), SerializationContext(msg.topic(), MessageField.KEY))</span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>                record <span class="op">=</span> <span class="va">self</span>.avro_value_deserializer(msg.value(),</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>                                                      SerializationContext(msg.topic(), MessageField.VALUE))</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> record <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="st">"</span><span class="sc">{}</span><span class="st">, </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(key, record))</span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.consumer.close()</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> {</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">'bootstrap.servers'</span>: BOOTSTRAP_SERVERS,</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">'schema_registry.url'</span>: SCHEMA_REGISTRY_URL,</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">'schema.key'</span>: RIDE_KEY_SCHEMA_PATH,</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>        <span class="st">'schema.value'</span>: RIDE_VALUE_SCHEMA_PATH,</span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>    avro_consumer <span class="op">=</span> RideAvroConsumer(props<span class="op">=</span>config)</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>    avro_consumer.consume_from_kafka(topics<span class="op">=</span>[KAFKA_TOPIC])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First let’s run the <code>producer.py</code> script which references both the <code>settings.py</code> ,<code>ride.py</code>, and <code>ride_record_key.py</code> scripts :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/5aaf1a24-1dc6-4a00-86a7-c651fa2f397f.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">avro_producer.PNG</figcaption><p></p>
</figure>
</div>
<p>And let’s now run the <code>consumer.py</code> script which also references the <code>settings.py</code> ,<code>ride.py</code>, and <code>ride_record_key.py</code> scripts :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/c7a72027-99a1-4ba3-8ecd-54dbbe4f28d7.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">avro_consumer.PNG</figcaption><p></p>
</figure>
</div>
<p>Let’s now look at how we can stream data that is held in a PySpark DataFrame.</p>
</section>
</section>
<section id="streaming-data-held-in-a-pyspark-dataframe" class="level3">
<h3 class="anchored" data-anchor-id="streaming-data-held-in-a-pyspark-dataframe">13.2 Streaming data held in a PySpark DataFrame</h3>
<section id="build-required-images-for-running-spark" class="level4">
<h4 class="anchored" data-anchor-id="build-required-images-for-running-spark">Build Required Images for running Spark</h4>
<p>We already have :</p>
<ul>
<li>Docker containers running which hold the required Kafka services</li>
<li>bridge network to enable the connection between Kafka and Spark</li>
<li><a href="https://hadoop.apache.org/">Hadoop distributed file system</a></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/1ba09f56-4851-4c56-8780-317165be8030.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">kafka_spark_network.PNG</figcaption><p></p>
</figure>
</div>
<p>We also need to have the followng images set up :</p>
<ul>
<li>jupyterlab</li>
<li>spark-worker</li>
<li>spark-master</li>
<li>spark-base</li>
<li>cluster-base</li>
</ul>
<p>We can check our running images using :</p>
<pre><code>docker image ls</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/3bba0463-8c4a-434a-9193-0019cef4d3c5.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">docker_images.PNG</figcaption><p></p>
</figure>
</div>
<p>We are missing the aforementioned images. We can create them by running the following bash script from the command line :</p>
<p><code>build.sh</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -- Software Stack Version</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>SPARK_VERSION<span class="op">=</span><span class="st">"3.3.1"</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>HADOOP_VERSION<span class="op">=</span><span class="st">"3"</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>JUPYTERLAB_VERSION<span class="op">=</span><span class="st">"3.6.1"</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co"># -- Building the Images</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>docker build <span class="op">\</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span>f cluster<span class="op">-</span>base.Dockerfile <span class="op">\</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span>t cluster<span class="op">-</span>base .</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>docker build <span class="op">\</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>build<span class="op">-</span>arg spark_version<span class="op">=</span><span class="st">"$</span><span class="sc">{SPARK_VERSION}</span><span class="st">"</span> \</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>build<span class="op">-</span>arg hadoop_version<span class="op">=</span><span class="st">"$</span><span class="sc">{HADOOP_VERSION}</span><span class="st">"</span> \</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span>f spark<span class="op">-</span>base.Dockerfile <span class="op">\</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span>t spark<span class="op">-</span>base .</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>docker build <span class="op">\</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span>f spark<span class="op">-</span>master.Dockerfile <span class="op">\</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span>t spark<span class="op">-</span>master .</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>docker build <span class="op">\</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span>f spark<span class="op">-</span>worker.Dockerfile <span class="op">\</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span>t spark<span class="op">-</span>worker .</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>docker build <span class="op">\</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>build<span class="op">-</span>arg spark_version<span class="op">=</span><span class="st">"$</span><span class="sc">{SPARK_VERSION}</span><span class="st">"</span> \</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>build<span class="op">-</span>arg jupyterlab_version<span class="op">=</span><span class="st">"$</span><span class="sc">{JUPYTERLAB_VERSION}</span><span class="st">"</span> \</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span>f jupyterlab.Dockerfile <span class="op">\</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span>t jupyterlab .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/786b8026-4c83-4119-80ac-fc1e7d966acc.PNG" class="img-fluid" alt="build_1.PNG"> <img src="DE_Zoomcamp_Week_6_files/figure-html/d9219f8d-4360-499b-b055-8123a86f798c.PNG" class="img-fluid" alt="build_2.PNG"></p>
<p>That took a few minutes but appears to have completed successfully. Let’s check our images once more :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/06605cd2-2874-4bec-8096-92bc4b24446b.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">images.PNG</figcaption><p></p>
</figure>
</div>
<p>The details of how the spark-images are built in different layers can be found in <a href="https://towardsdatascience.com/apache-spark-cluster-on-docker-ft-a-juyterlab-interface-418383c95445">this blog post</a> written by André Perez. OK, now we can progress!</p>
</section>
<section id="streams-example-using-pyspark" class="level4">
<h4 class="anchored" data-anchor-id="streams-example-using-pyspark">Streams example using PySpark</h4>
<p>First we need to run the following file from the command line using :</p>
<pre><code>docker compose up -d</code></pre>
<p>and check once again that we have all the necessary containers.</p>
<p><code>docker-compose.yml</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>version: <span class="st">"3.6"</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>volumes:</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  shared<span class="op">-</span>workspace:</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    name: <span class="st">"hadoop-distributed-file-system"</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    driver: local</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>networks:</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  default:</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    name: kafka<span class="op">-</span>spark<span class="op">-</span>network</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    external: true</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>services:</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  jupyterlab:</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    image: jupyterlab</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    container_name: jupyterlab</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    ports:</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> <span class="dv">8888</span>:<span class="dv">8888</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    volumes:</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> shared<span class="op">-</span>workspace:<span class="op">/</span>opt<span class="op">/</span>workspace</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>  spark<span class="op">-</span>master:</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    image: spark<span class="op">-</span>master</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    container_name: spark<span class="op">-</span>master</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    environment:</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>      SPARK_LOCAL_IP: <span class="st">'spark-master'</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>    ports:</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> <span class="dv">8080</span>:<span class="dv">8080</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> <span class="dv">7077</span>:<span class="dv">7077</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    volumes:</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> shared<span class="op">-</span>workspace:<span class="op">/</span>opt<span class="op">/</span>workspace</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>  spark<span class="op">-</span>worker<span class="op">-</span><span class="dv">1</span>:</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    image: spark<span class="op">-</span>worker</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>    container_name: spark<span class="op">-</span>worker<span class="op">-</span><span class="dv">1</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>    environment:</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> SPARK_WORKER_CORES<span class="op">=</span><span class="dv">1</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> SPARK_WORKER_MEMORY<span class="op">=</span><span class="dv">4</span><span class="er">g</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>    ports:</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> <span class="dv">8083</span>:<span class="dv">8081</span></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>    volumes:</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> shared<span class="op">-</span>workspace:<span class="op">/</span>opt<span class="op">/</span>workspace</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>    depends_on:</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> spark<span class="op">-</span>master</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>  spark<span class="op">-</span>worker<span class="op">-</span><span class="dv">2</span>:</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>    image: spark<span class="op">-</span>worker</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>    container_name: spark<span class="op">-</span>worker<span class="op">-</span><span class="dv">2</span></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>    environment:</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> SPARK_WORKER_CORES<span class="op">=</span><span class="dv">1</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> SPARK_WORKER_MEMORY<span class="op">=</span><span class="dv">4</span><span class="er">g</span></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>    ports:</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> <span class="dv">8084</span>:<span class="dv">8081</span></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>    volumes:</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> shared<span class="op">-</span>workspace:<span class="op">/</span>opt<span class="op">/</span>workspace</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>    depends_on:</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> spark<span class="op">-</span>master</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/331dbc3e-3ec7-4025-9a4b-9f43b9ac271d.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">pyspark_docker.PNG</figcaption><p></p>
</figure>
</div>
<p>The overall set up includes four Python scripts :</p>
<p><code>settings.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyspark.sql.types <span class="im">as</span> T</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>INPUT_DATA_PATH <span class="op">=</span> <span class="st">'../../resources/rides.csv'</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>BOOTSTRAP_SERVERS <span class="op">=</span> <span class="st">'localhost:9092'</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>TOPIC_WINDOWED_VENDOR_ID_COUNT <span class="op">=</span> <span class="st">'vendor_counts_windowed'</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>PRODUCE_TOPIC_RIDES_CSV <span class="op">=</span> CONSUME_TOPIC_RIDES_CSV <span class="op">=</span> <span class="st">'rides_csv'</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>RIDE_SCHEMA <span class="op">=</span> T.StructType(</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    [T.StructField(<span class="st">"vendor_id"</span>, T.IntegerType()),</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>     T.StructField(<span class="st">'tpep_pickup_datetime'</span>, T.TimestampType()),</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>     T.StructField(<span class="st">'tpep_dropoff_datetime'</span>, T.TimestampType()),</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>     T.StructField(<span class="st">"passenger_count"</span>, T.IntegerType()),</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>     T.StructField(<span class="st">"trip_distance"</span>, T.FloatType()),</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>     T.StructField(<span class="st">"payment_type"</span>, T.IntegerType()),</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>     T.StructField(<span class="st">"total_amount"</span>, T.FloatType()),</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>     ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>producer.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> sleep</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> kafka <span class="im">import</span> KafkaProducer</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> settings <span class="im">import</span> BOOTSTRAP_SERVERS, INPUT_DATA_PATH, PRODUCE_TOPIC_RIDES_CSV</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> delivery_report(err, msg):</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> err <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Delivery failed for record </span><span class="sc">{}</span><span class="st">: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(msg.key(), err))</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Record </span><span class="sc">{}</span><span class="st"> successfully produced to </span><span class="sc">{}</span><span class="st"> [</span><span class="sc">{}</span><span class="st">] at offset </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>        msg.key(), msg.topic(), msg.partition(), msg.offset()))</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RideCSVProducer:</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, props: Dict):</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.producer <span class="op">=</span> KafkaProducer(<span class="op">**</span>props)</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.producer = Producer(producer_props)</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read_records(resource_path: <span class="bu">str</span>):</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>        records, ride_keys <span class="op">=</span> [], []</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>        i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(resource_path, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>            reader <span class="op">=</span> csv.reader(f)</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>            header <span class="op">=</span> <span class="bu">next</span>(reader)  <span class="co"># skip the header</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> row <span class="kw">in</span> reader:</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>                <span class="co"># vendor_id, passenger_count, trip_distance, payment_type, total_amount</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>                records.append(<span class="ss">f'</span><span class="sc">{</span>row[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>row[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>row[<span class="dv">2</span>]<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>row[<span class="dv">3</span>]<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>row[<span class="dv">4</span>]<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>row[<span class="dv">9</span>]<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>row[<span class="dv">16</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>                ride_keys.append(<span class="bu">str</span>(row[<span class="dv">0</span>]))</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>                i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> i <span class="op">==</span> <span class="dv">5</span>:</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">zip</span>(ride_keys, records)</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> publish(<span class="va">self</span>, topic: <span class="bu">str</span>, records: [<span class="bu">str</span>, <span class="bu">str</span>]):</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key_value <span class="kw">in</span> records:</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>            key, value <span class="op">=</span> key_value</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.producer.send(topic<span class="op">=</span>topic, key<span class="op">=</span>key, value<span class="op">=</span>value)</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Producing record for &lt;key: </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">, value:</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">&gt;"</span>)</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Exception while producing record - </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.producer.flush()</span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>        sleep(<span class="dv">1</span>)</span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> {</span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">'bootstrap_servers'</span>: [BOOTSTRAP_SERVERS],</span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">'key_serializer'</span>: <span class="kw">lambda</span> x: x.encode(<span class="st">'utf-8'</span>),</span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">'value_serializer'</span>: <span class="kw">lambda</span> x: x.encode(<span class="st">'utf-8'</span>)</span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a>    producer <span class="op">=</span> RideCSVProducer(props<span class="op">=</span>config)</span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a>    ride_records <span class="op">=</span> producer.read_records(resource_path<span class="op">=</span>INPUT_DATA_PATH)</span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(ride_records)</span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a>    producer.publish(topic<span class="op">=</span>PRODUCE_TOPIC_RIDES_CSV, records<span class="op">=</span>ride_records)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>consumer.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> kafka <span class="im">import</span> KafkaConsumer</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> settings <span class="im">import</span> BOOTSTRAP_SERVERS, CONSUME_TOPIC_RIDES_CSV</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RideCSVConsumer:</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, props: Dict):</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.consumer <span class="op">=</span> KafkaConsumer(<span class="op">**</span>props)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> consume_from_kafka(<span class="va">self</span>, topics: List[<span class="bu">str</span>]):</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.consumer.subscribe(topics<span class="op">=</span>topics)</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Consuming from Kafka started'</span>)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Available topics to consume: '</span>, <span class="va">self</span>.consumer.subscription())</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>                <span class="co"># SIGINT can't be handled when polling, limit timeout to 1 second.</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>                msg <span class="op">=</span> <span class="va">self</span>.consumer.poll(<span class="fl">1.0</span>)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> msg <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> msg <span class="op">==</span> {}:</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> msg_key, msg_values <span class="kw">in</span> msg.items():</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> msg_val <span class="kw">in</span> msg_values:</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f'Key:</span><span class="sc">{</span>msg_val<span class="sc">.</span>key<span class="sc">}</span><span class="ss">-type(</span><span class="sc">{</span><span class="bu">type</span>(msg_val.key)<span class="sc">}</span><span class="ss">), '</span></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>                              <span class="ss">f'Value:</span><span class="sc">{</span>msg_val<span class="sc">.</span>value<span class="sc">}</span><span class="ss">-type(</span><span class="sc">{</span><span class="bu">type</span>(msg_val.value)<span class="sc">}</span><span class="ss">)'</span>)</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.consumer.close()</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span><span class="st">'Kafka Consumer'</span>)</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">'--topic'</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, default<span class="op">=</span>CONSUME_TOPIC_RIDES_CSV)</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>    topic <span class="op">=</span> args.topic</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> {</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">'bootstrap_servers'</span>: [BOOTSTRAP_SERVERS],</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">'auto_offset_reset'</span>: <span class="st">'earliest'</span>,</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">'enable_auto_commit'</span>: <span class="va">True</span>,</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">'key_deserializer'</span>: <span class="kw">lambda</span> key: <span class="bu">int</span>(key.decode(<span class="st">'utf-8'</span>)),</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">'value_deserializer'</span>: <span class="kw">lambda</span> value: value.decode(<span class="st">'utf-8'</span>),</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">'group_id'</span>: <span class="st">'consumer.group.id.csv-example.1'</span>,</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>    csv_consumer <span class="op">=</span> RideCSVConsumer(props<span class="op">=</span>config)</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>    csv_consumer.consume_from_kafka(topics<span class="op">=</span>[topic])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First let’s run the <code>producer.py</code> script :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run producer</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>python3 producer.py</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Run consumer with default settings</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>python3 consumer.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/f12582e0-ab89-4c98-ba1a-88af16f9e40a.PNG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">producer_consumer.PNG</figcaption><p></p>
</figure>
</div>
</section>
</section>
<section id="spark-setup" class="level3">
<h3 class="anchored" data-anchor-id="spark-setup">0 Spark Setup</h3>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">'PYSPARK_SUBMIT_ARGS'</span>] <span class="op">=</span> <span class="st">'--packages org.apache.spark:spark-sql-kafka-0-10_2.12:3.3.1,org.apache.spark:spark-avro_2.12:3.3.1 pyspark-shell'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> SparkSession</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyspark.sql.types <span class="im">as</span> T</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyspark.sql.functions <span class="im">as</span> F</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>spark <span class="op">=</span> SparkSession <span class="op">\</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    .builder <span class="op">\</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    .appName(<span class="st">"Spark-Notebook"</span>) <span class="op">\</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    .getOrCreate()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="reading-from-kafka-stream" class="level3">
<h3 class="anchored" data-anchor-id="reading-from-kafka-stream">1 Reading from Kafka Stream</h3>
<section id="raw-kafka-stream" class="level4">
<h4 class="anchored" data-anchor-id="raw-kafka-stream">1.1 Raw Kafka Stream</h4>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># default for startingOffsets is "latest"</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>df_kafka_raw <span class="op">=</span> spark <span class="op">\</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    .readStream <span class="op">\</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">format</span>(<span class="st">"kafka"</span>) <span class="op">\</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    .option(<span class="st">"kafka.bootstrap.servers"</span>, <span class="st">"localhost:9092,broker:29092"</span>) <span class="op">\</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    .option(<span class="st">"subscribe"</span>, <span class="st">"rides_csv"</span>) <span class="op">\</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    .option(<span class="st">"startingOffsets"</span>, <span class="st">"earliest"</span>) <span class="op">\</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    .option(<span class="st">"checkpointLocation"</span>, <span class="st">"checkpoint"</span>) <span class="op">\</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    .load()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>df_kafka_raw.printSchema()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>root
 |-- key: binary (nullable = true)
 |-- value: binary (nullable = true)
 |-- topic: string (nullable = true)
 |-- partition: integer (nullable = true)
 |-- offset: long (nullable = true)
 |-- timestamp: timestamp (nullable = true)
 |-- timestampType: integer (nullable = true)
</code></pre>
</div>
</div>
</section>
<section id="encoded-kafka-stream" class="level4">
<h4 class="anchored" data-anchor-id="encoded-kafka-stream">1.2 Encoded Kafka Stream</h4>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>df_kafka_encoded <span class="op">=</span> df_kafka_raw.selectExpr(<span class="st">"CAST(key AS STRING)"</span>,<span class="st">"CAST(value AS STRING)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>df_kafka_encoded.printSchema()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>root
 |-- key: string (nullable = true)
 |-- value: string (nullable = true)
</code></pre>
</div>
</div>
</section>
<section id="structure-streaming-dataframe" class="level4">
<h4 class="anchored" data-anchor-id="structure-streaming-dataframe">1.3 Structure Streaming DataFrame</h4>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_ride_from_kafka_message(df_raw, schema):</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" take a Spark Streaming df and parse value col based on &lt;schema&gt;, return streaming df cols in schema """</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> df_raw.isStreaming <span class="kw">is</span> <span class="va">True</span>, <span class="st">"DataFrame doesn't receive streaming data"</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df_raw.selectExpr(<span class="st">"CAST(key AS STRING)"</span>, <span class="st">"CAST(value AS STRING)"</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># split attributes to nested array in one Column</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> F.split(df[<span class="st">'value'</span>], <span class="st">', '</span>)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># expand col to multiple top-level columns</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, field <span class="kw">in</span> <span class="bu">enumerate</span>(schema):</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.withColumn(field.name, col.getItem(idx).cast(field.dataType))</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.select([field.name <span class="cf">for</span> field <span class="kw">in</span> schema])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>ride_schema <span class="op">=</span> T.StructType(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    [T.StructField(<span class="st">"vendor_id"</span>, T.IntegerType()),</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>     T.StructField(<span class="st">'tpep_pickup_datetime'</span>, T.TimestampType()),</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>     T.StructField(<span class="st">'tpep_dropoff_datetime'</span>, T.TimestampType()),</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>     T.StructField(<span class="st">"passenger_count"</span>, T.IntegerType()),</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>     T.StructField(<span class="st">"trip_distance"</span>, T.FloatType()),</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>     T.StructField(<span class="st">"payment_type"</span>, T.IntegerType()),</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>     T.StructField(<span class="st">"total_amount"</span>, T.FloatType()),</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>     ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>df_rides <span class="op">=</span> parse_ride_from_kafka_message(df_raw<span class="op">=</span>df_kafka_raw, schema<span class="op">=</span>ride_schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>df_rides.printSchema()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>root
 |-- vendor_id: integer (nullable = true)
 |-- tpep_pickup_datetime: timestamp (nullable = true)
 |-- tpep_dropoff_datetime: timestamp (nullable = true)
 |-- passenger_count: integer (nullable = true)
 |-- trip_distance: float (nullable = true)
 |-- payment_type: integer (nullable = true)
 |-- total_amount: float (nullable = true)
</code></pre>
</div>
</div>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>df_rides.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>AnalysisException: Queries with streaming sources must be executed with writeStream.start();
kafka</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>23/04/05 22:01:10 WARN ClientUtils: Couldn't resolve server broker:29092 from bootstrap.servers as DNS resolution failed for broker</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>-------------------------------------------
Batch: 1
-------------------------------------------
+---------+--------------------+---------------------+---------------+-------------+------------+------------+
|vendor_id|tpep_pickup_datetime|tpep_dropoff_datetime|passenger_count|trip_distance|payment_type|total_amount|
+---------+--------------------+---------------------+---------------+-------------+------------+------------+
|1        |2020-07-01 00:25:32 |2020-07-01 00:33:39  |1              |1.5          |2           |9.3         |
|1        |2020-07-01 00:03:19 |2020-07-01 00:25:43  |1              |9.5          |1           |27.8        |
|2        |2020-07-01 00:15:11 |2020-07-01 00:29:24  |1              |5.85         |2           |22.3        |
|2        |2020-07-01 00:30:49 |2020-07-01 00:38:26  |1              |1.9          |1           |14.16       |
|2        |2020-07-01 00:31:26 |2020-07-01 00:38:02  |1              |1.25         |2           |7.8         |
+---------+--------------------+---------------------+---------------+-------------+------------+------------+
</code></pre>
</div>
</div>
<p>writeStream is a way that we can decide how our streaming data should be outputted.</p>
</section>
</section>
<section id="sink-operation-streaming-query" class="level3">
<h3 class="anchored" data-anchor-id="sink-operation-streaming-query">2 Sink Operation &amp; Streaming Query</h3>
<p>through <code>writeStream</code></p>
<p><code>Output Sinks</code></p>
<ul>
<li>File Sink: stores the output to the directory</li>
<li>Kafka Sink: stores the output to one or more topics in Kafka</li>
<li>Foreach Sink:</li>
<li>(for debugging) Console Sink, Memory Sink</li>
</ul>
<p>Further details can be found in <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#output-sinks">Output Sinks</a></p>
<p><code>Output Modes</code></p>
<ul>
<li>Complete: The whole Result Table will be outputted to the sink after every trigger. This is supported for aggregation queries.</li>
<li>Append (default): Only new rows are added to the Result Table</li>
<li>Update: Only updated rows are outputted</li>
</ul>
<p><a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#output-modes">Output Modes</a> differ based on the set of transformations applied to the streaming data.</p>
<p><code>Triggers</code></p>
<p>The <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#triggers">trigger settings</a> of a streaming query define the timing of streaming data processing. Spark streaming support micro-batch streamings schema and you can select following options based on requirements :</p>
<ul>
<li>default-micro-batch-mode</li>
<li>fixed-interval-micro-batch-mode</li>
<li>one-time-micro-batch-mode</li>
<li>available-now-micro-batch-mode</li>
</ul>
<section id="console-and-memory-sink" class="level4">
<h4 class="anchored" data-anchor-id="console-and-memory-sink">2.1 Console and Memory Sink</h4>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sink_console(df, output_mode: <span class="bu">str</span> <span class="op">=</span> <span class="st">'complete'</span>, processing_time: <span class="bu">str</span> <span class="op">=</span> <span class="st">'5 seconds'</span>):</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    write_query <span class="op">=</span> df.writeStream <span class="op">\</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>        .outputMode(output_mode) <span class="op">\</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>        .trigger(processingTime<span class="op">=</span>processing_time) <span class="op">\</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">format</span>(<span class="st">"console"</span>) <span class="op">\</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>        .option(<span class="st">"truncate"</span>, <span class="va">False</span>) <span class="op">\</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>        .start()</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> write_query <span class="co"># pyspark.sql.streaming.StreamingQuery</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>write_query <span class="op">=</span> sink_console(df_rides, output_mode<span class="op">=</span><span class="st">'append'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>23/04/05 22:01:59 WARN ResolveWriteToStream: Temporary checkpoint location created which is deleted normally when the query didn't fail: /tmp/temporary-eb051e1e-2db8-4728-b385-5f0f14334440. If it's required to delete it under any circumstances, please set spark.sql.streaming.forceDeleteTempCheckpointLocation to true. Important to know deleting temp checkpoint folder is best effort.
23/04/05 22:01:59 WARN ResolveWriteToStream: spark.sql.adaptive.enabled is not supported in streaming DataFrames/Datasets and will be disabled.
23/04/05 22:01:59 WARN ClientUtils: Couldn't resolve server broker:29092 from bootstrap.servers as DNS resolution failed for broker
23/04/05 22:01:59 WARN ClientUtils: Couldn't resolve server broker:29092 from bootstrap.servers as DNS resolution failed for broker
-------------------------------------------
Batch: 0
-------------------------------------------
+---------+--------------------+---------------------+---------------+-------------+------------+------------+
|vendor_id|tpep_pickup_datetime|tpep_dropoff_datetime|passenger_count|trip_distance|payment_type|total_amount|
+---------+--------------------+---------------------+---------------+-------------+------------+------------+
|1        |2020-07-01 00:25:32 |2020-07-01 00:33:39  |1              |1.5          |2           |9.3         |
|1        |2020-07-01 00:03:19 |2020-07-01 00:25:43  |1              |9.5          |1           |27.8        |
|2        |2020-07-01 00:15:11 |2020-07-01 00:29:24  |1              |5.85         |2           |22.3        |
|2        |2020-07-01 00:30:49 |2020-07-01 00:38:26  |1              |1.9          |1           |14.16       |
|2        |2020-07-01 00:31:26 |2020-07-01 00:38:02  |1              |1.25         |2           |7.8         |
|1        |2020-07-01 00:25:32 |2020-07-01 00:33:39  |1              |1.5          |2           |9.3         |
|1        |2020-07-01 00:03:19 |2020-07-01 00:25:43  |1              |9.5          |1           |27.8        |
|2        |2020-07-01 00:15:11 |2020-07-01 00:29:24  |1              |5.85         |2           |22.3        |
|2        |2020-07-01 00:30:49 |2020-07-01 00:38:26  |1              |1.9          |1           |14.16       |
|2        |2020-07-01 00:31:26 |2020-07-01 00:38:02  |1              |1.25         |2           |7.8         |
+---------+--------------------+---------------------+---------------+-------------+------------+------------+
</code></pre>
</div>
</div>
<p>If we go back and run <code>'producer.py</code> then we see we get another batch.</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sink_memory(df, query_name, query_template):</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    write_query <span class="op">=</span> df <span class="op">\</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>        .writeStream <span class="op">\</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>        .queryName(query_name) <span class="op">\</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">format</span>(<span class="st">'memory'</span>) <span class="op">\</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>        .start()</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    query_str <span class="op">=</span> query_template.<span class="bu">format</span>(table_name<span class="op">=</span>query_name)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    query_results <span class="op">=</span> spark.sql(query_str)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> write_query, query_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>query_name <span class="op">=</span> <span class="st">'vendor_id_counts'</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>query_template <span class="op">=</span> <span class="st">'select count(distinct(vendor_id)) from </span><span class="sc">{table_name}</span><span class="st">'</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>write_query, df_vendor_id_counts <span class="op">=</span> sink_memory(df<span class="op">=</span>df_rides, query_name<span class="op">=</span>query_name, query_template<span class="op">=</span>query_template)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>23/04/05 21:46:19 WARN ResolveWriteToStream: Temporary checkpoint location created which is deleted normally when the query didn't fail: /tmp/temporary-01522808-a7db-49f3-8533-fb8f9e1aea60. If it's required to delete it under any circumstances, please set spark.sql.streaming.forceDeleteTempCheckpointLocation to true. Important to know deleting temp checkpoint folder is best effort.
23/04/05 21:46:19 WARN ResolveWriteToStream: spark.sql.adaptive.enabled is not supported in streaming DataFrames/Datasets and will be disabled.
23/04/05 21:46:19 WARN ClientUtils: Couldn't resolve server broker:29092 from bootstrap.servers as DNS resolution failed for broker
23/04/05 21:46:19 WARN ClientUtils: Couldn't resolve server broker:29092 from bootstrap.servers as DNS resolution failed for broker</code></pre>
</div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">type</span>(write_query)) <span class="co"># pyspark.sql.streaming.StreamingQuery</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>write_query.status</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pyspark.sql.streaming.StreamingQuery'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>{'message': 'Waiting for data to arrive',
 'isDataAvailable': False,
 'isTriggerActive': False}</code></pre>
</div>
</div>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>df_vendor_id_counts.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+-------------------------+
|count(DISTINCT vendor_id)|
+-------------------------+
|                        2|
+-------------------------+
</code></pre>
</div>
</div>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>write_query.stop()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="kafka-sink" class="level4">
<h4 class="anchored" data-anchor-id="kafka-sink">2.2 Kafka Sink</h4>
<p>To write stream results to <code>kafka-topic</code>, the stream dataframe has at least a column with name <code>value</code>.</p>
<p>Therefore before starting <code>writeStream</code> in kafka format, dataframe needs to be updated accordingly.</p>
<p>More information regarding kafka sink expected data structure <a href="https://spark.apache.org/docs/latest/structured-streaming-kafka-integration.html#writing-data-to-kafka">here</a>.</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_dataframe_to_kafka_sink(df, value_columns, key_column<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    columns <span class="op">=</span> df.columns</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.withColumn(<span class="st">"value"</span>, F.concat_ws(<span class="st">', '</span>,<span class="op">*</span>value_columns))    </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> key_column:</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.withColumnRenamed(key_column,<span class="st">"key"</span>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.withColumn(<span class="st">"key"</span>,df.key.cast(<span class="st">'string'</span>))</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.select([<span class="st">'key'</span>, <span class="st">'value'</span>])</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sink_kafka(df, topic, output_mode<span class="op">=</span><span class="st">'append'</span>):</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>    write_query <span class="op">=</span> df.writeStream <span class="op">\</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">format</span>(<span class="st">"kafka"</span>) <span class="op">\</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>        .option(<span class="st">"kafka.bootstrap.servers"</span>, <span class="st">"localhost:9092,broker:29092"</span>) <span class="op">\</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>        .outputMode(output_mode) <span class="op">\</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>        .option(<span class="st">"topic"</span>, topic) <span class="op">\</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>        .option(<span class="st">"checkpointLocation"</span>, <span class="st">"checkpoint"</span>) <span class="op">\</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>        .start()</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> write_query</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now go to the following file :</p>
<p><code>streaming.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> SparkSession</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyspark.sql.functions <span class="im">as</span> F</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> settings <span class="im">import</span> RIDE_SCHEMA, CONSUME_TOPIC_RIDES_CSV, TOPIC_WINDOWED_VENDOR_ID_COUNT</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_from_kafka(consume_topic: <span class="bu">str</span>):</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Spark Streaming DataFrame, connect to Kafka topic served at host in bootrap.servers option</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    df_stream <span class="op">=</span> spark <span class="op">\</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>        .readStream <span class="op">\</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">format</span>(<span class="st">"kafka"</span>) <span class="op">\</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>        .option(<span class="st">"kafka.bootstrap.servers"</span>, <span class="st">"localhost:9092,broker:29092"</span>) <span class="op">\</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>        .option(<span class="st">"subscribe"</span>, consume_topic) <span class="op">\</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>        .option(<span class="st">"startingOffsets"</span>, <span class="st">"earliest"</span>) <span class="op">\</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>        .option(<span class="st">"checkpointLocation"</span>, <span class="st">"checkpoint"</span>) <span class="op">\</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>        .load()</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_stream</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_ride_from_kafka_message(df, schema):</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" take a Spark Streaming df and parse value col based on &lt;schema&gt;, return streaming df cols in schema """</span></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> df.isStreaming <span class="kw">is</span> <span class="va">True</span>, <span class="st">"DataFrame doesn't receive streaming data"</span></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.selectExpr(<span class="st">"CAST(key AS STRING)"</span>, <span class="st">"CAST(value AS STRING)"</span>)</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># split attributes to nested array in one Column</span></span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> F.split(df[<span class="st">'value'</span>], <span class="st">', '</span>)</span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># expand col to multiple top-level columns</span></span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, field <span class="kw">in</span> <span class="bu">enumerate</span>(schema):</span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.withColumn(field.name, col.getItem(idx).cast(field.dataType))</span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.select([field.name <span class="cf">for</span> field <span class="kw">in</span> schema])</span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sink_console(df, output_mode: <span class="bu">str</span> <span class="op">=</span> <span class="st">'complete'</span>, processing_time: <span class="bu">str</span> <span class="op">=</span> <span class="st">'5 seconds'</span>):</span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a>    write_query <span class="op">=</span> df.writeStream <span class="op">\</span></span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a>        .outputMode(output_mode) <span class="op">\</span></span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a>        .trigger(processingTime<span class="op">=</span>processing_time) <span class="op">\</span></span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">format</span>(<span class="st">"console"</span>) <span class="op">\</span></span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a>        .option(<span class="st">"truncate"</span>, <span class="va">False</span>) <span class="op">\</span></span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a>        .start()</span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> write_query  <span class="co"># pyspark.sql.streaming.StreamingQuery</span></span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sink_memory(df, query_name, query_template):</span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a>    query_df <span class="op">=</span> df <span class="op">\</span></span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true" tabindex="-1"></a>        .writeStream <span class="op">\</span></span>
<span id="cb68-48"><a href="#cb68-48" aria-hidden="true" tabindex="-1"></a>        .queryName(query_name) <span class="op">\</span></span>
<span id="cb68-49"><a href="#cb68-49" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">format</span>(<span class="st">"memory"</span>) <span class="op">\</span></span>
<span id="cb68-50"><a href="#cb68-50" aria-hidden="true" tabindex="-1"></a>        .start()</span>
<span id="cb68-51"><a href="#cb68-51" aria-hidden="true" tabindex="-1"></a>    query_str <span class="op">=</span> query_template.<span class="bu">format</span>(table_name<span class="op">=</span>query_name)</span>
<span id="cb68-52"><a href="#cb68-52" aria-hidden="true" tabindex="-1"></a>    query_results <span class="op">=</span> spark.sql(query_str)</span>
<span id="cb68-53"><a href="#cb68-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> query_results, query_df</span>
<span id="cb68-54"><a href="#cb68-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-55"><a href="#cb68-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-56"><a href="#cb68-56" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sink_kafka(df, topic):</span>
<span id="cb68-57"><a href="#cb68-57" aria-hidden="true" tabindex="-1"></a>    write_query <span class="op">=</span> df.writeStream <span class="op">\</span></span>
<span id="cb68-58"><a href="#cb68-58" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">format</span>(<span class="st">"kafka"</span>) <span class="op">\</span></span>
<span id="cb68-59"><a href="#cb68-59" aria-hidden="true" tabindex="-1"></a>        .option(<span class="st">"kafka.bootstrap.servers"</span>, <span class="st">"localhost:9092,broker:29092"</span>) <span class="op">\</span></span>
<span id="cb68-60"><a href="#cb68-60" aria-hidden="true" tabindex="-1"></a>        .outputMode(<span class="st">'complete'</span>) <span class="op">\</span></span>
<span id="cb68-61"><a href="#cb68-61" aria-hidden="true" tabindex="-1"></a>        .option(<span class="st">"topic"</span>, topic) <span class="op">\</span></span>
<span id="cb68-62"><a href="#cb68-62" aria-hidden="true" tabindex="-1"></a>        .option(<span class="st">"checkpointLocation"</span>, <span class="st">"checkpoint"</span>) <span class="op">\</span></span>
<span id="cb68-63"><a href="#cb68-63" aria-hidden="true" tabindex="-1"></a>        .start()</span>
<span id="cb68-64"><a href="#cb68-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> write_query</span>
<span id="cb68-65"><a href="#cb68-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-66"><a href="#cb68-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-67"><a href="#cb68-67" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_df_to_kafka_sink(df, value_columns, key_column<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb68-68"><a href="#cb68-68" aria-hidden="true" tabindex="-1"></a>    columns <span class="op">=</span> df.columns</span>
<span id="cb68-69"><a href="#cb68-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-70"><a href="#cb68-70" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.withColumn(<span class="st">"value"</span>, F.concat_ws(<span class="st">', '</span>, <span class="op">*</span>value_columns))</span>
<span id="cb68-71"><a href="#cb68-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> key_column:</span>
<span id="cb68-72"><a href="#cb68-72" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.withColumnRenamed(key_column, <span class="st">"key"</span>)</span>
<span id="cb68-73"><a href="#cb68-73" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.withColumn(<span class="st">"key"</span>, df.key.cast(<span class="st">'string'</span>))</span>
<span id="cb68-74"><a href="#cb68-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.select([<span class="st">'key'</span>, <span class="st">'value'</span>])</span>
<span id="cb68-75"><a href="#cb68-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-76"><a href="#cb68-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-77"><a href="#cb68-77" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> op_groupby(df, column_names):</span>
<span id="cb68-78"><a href="#cb68-78" aria-hidden="true" tabindex="-1"></a>    df_aggregation <span class="op">=</span> df.groupBy(column_names).count()</span>
<span id="cb68-79"><a href="#cb68-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_aggregation</span>
<span id="cb68-80"><a href="#cb68-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-81"><a href="#cb68-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-82"><a href="#cb68-82" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> op_windowed_groupby(df, window_duration, slide_duration):</span>
<span id="cb68-83"><a href="#cb68-83" aria-hidden="true" tabindex="-1"></a>    df_windowed_aggregation <span class="op">=</span> df.groupBy(</span>
<span id="cb68-84"><a href="#cb68-84" aria-hidden="true" tabindex="-1"></a>        F.window(timeColumn<span class="op">=</span>df.tpep_pickup_datetime, windowDuration<span class="op">=</span>window_duration, slideDuration<span class="op">=</span>slide_duration),</span>
<span id="cb68-85"><a href="#cb68-85" aria-hidden="true" tabindex="-1"></a>        df.vendor_id</span>
<span id="cb68-86"><a href="#cb68-86" aria-hidden="true" tabindex="-1"></a>    ).count()</span>
<span id="cb68-87"><a href="#cb68-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_windowed_aggregation</span>
<span id="cb68-88"><a href="#cb68-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-89"><a href="#cb68-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-90"><a href="#cb68-90" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb68-91"><a href="#cb68-91" aria-hidden="true" tabindex="-1"></a>    spark <span class="op">=</span> SparkSession.builder.appName(<span class="st">'streaming-examples'</span>).getOrCreate()</span>
<span id="cb68-92"><a href="#cb68-92" aria-hidden="true" tabindex="-1"></a>    spark.sparkContext.setLogLevel(<span class="st">'WARN'</span>)</span>
<span id="cb68-93"><a href="#cb68-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-94"><a href="#cb68-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># read_streaming data</span></span>
<span id="cb68-95"><a href="#cb68-95" aria-hidden="true" tabindex="-1"></a>    df_consume_stream <span class="op">=</span> read_from_kafka(consume_topic<span class="op">=</span>CONSUME_TOPIC_RIDES_CSV)</span>
<span id="cb68-96"><a href="#cb68-96" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(df_consume_stream.printSchema())</span>
<span id="cb68-97"><a href="#cb68-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-98"><a href="#cb68-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># parse streaming data</span></span>
<span id="cb68-99"><a href="#cb68-99" aria-hidden="true" tabindex="-1"></a>    df_rides <span class="op">=</span> parse_ride_from_kafka_message(df_consume_stream, RIDE_SCHEMA)</span>
<span id="cb68-100"><a href="#cb68-100" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(df_rides.printSchema())</span>
<span id="cb68-101"><a href="#cb68-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-102"><a href="#cb68-102" aria-hidden="true" tabindex="-1"></a>    sink_console(df_rides, output_mode<span class="op">=</span><span class="st">'append'</span>)</span>
<span id="cb68-103"><a href="#cb68-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-104"><a href="#cb68-104" aria-hidden="true" tabindex="-1"></a>    df_trip_count_by_vendor_id <span class="op">=</span> op_groupby(df_rides, [<span class="st">'vendor_id'</span>])</span>
<span id="cb68-105"><a href="#cb68-105" aria-hidden="true" tabindex="-1"></a>    df_trip_count_by_pickup_date_vendor_id <span class="op">=</span> op_windowed_groupby(df_rides, window_duration<span class="op">=</span><span class="st">"10 minutes"</span>,</span>
<span id="cb68-106"><a href="#cb68-106" aria-hidden="true" tabindex="-1"></a>                                                                 slide_duration<span class="op">=</span><span class="st">'5 minutes'</span>)</span>
<span id="cb68-107"><a href="#cb68-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-108"><a href="#cb68-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># write the output out to the console for debugging / testing</span></span>
<span id="cb68-109"><a href="#cb68-109" aria-hidden="true" tabindex="-1"></a>    sink_console(df_trip_count_by_vendor_id)</span>
<span id="cb68-110"><a href="#cb68-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-111"><a href="#cb68-111" aria-hidden="true" tabindex="-1"></a>    <span class="co"># write the output to the kafka topic</span></span>
<span id="cb68-112"><a href="#cb68-112" aria-hidden="true" tabindex="-1"></a>    df_trip_count_messages <span class="op">=</span> prepare_df_to_kafka_sink(df<span class="op">=</span>df_trip_count_by_pickup_date_vendor_id,</span>
<span id="cb68-113"><a href="#cb68-113" aria-hidden="true" tabindex="-1"></a>                                                      value_columns<span class="op">=</span>[<span class="st">'count'</span>], key_column<span class="op">=</span><span class="st">'vendor_id'</span>)</span>
<span id="cb68-114"><a href="#cb68-114" aria-hidden="true" tabindex="-1"></a>    kafka_sink_query <span class="op">=</span> sink_kafka(df<span class="op">=</span>df_trip_count_messages, topic<span class="op">=</span>TOPIC_WINDOWED_VENDOR_ID_COUNT)</span>
<span id="cb68-115"><a href="#cb68-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-116"><a href="#cb68-116" aria-hidden="true" tabindex="-1"></a>    spark.streams.awaitAnyTermination()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now run the file. This time we don’t use the usual python3 command as <code>spark-submit</code> script ensures installation of necessary jars before running <code>streaming.py</code> :</p>
<pre><code>./spark-submit.sh streaming.py </code></pre>
<p><code>spark-submit.sh</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Submit Python code to SparkMaster</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> [ $<span class="co"># -lt 1 ]</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>then</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    echo <span class="st">"Usage: $0 &lt;pyspark-job.py&gt; [ executor-memory ]"</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    echo <span class="st">"(specify memory in string format such as </span><span class="ch">\"</span><span class="st">512M</span><span class="ch">\"</span><span class="st"> or </span><span class="ch">\"</span><span class="st">2G</span><span class="ch">\"</span><span class="st">)"</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    exit <span class="dv">1</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>fi</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>PYTHON_JOB<span class="op">=</span>$<span class="dv">1</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> [ <span class="op">-</span>z $<span class="dv">2</span> ]</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>then</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    EXEC_MEM<span class="op">=</span><span class="st">"1G"</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    EXEC_MEM<span class="op">=</span>$<span class="dv">2</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>fi</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>spark<span class="op">-</span>submit <span class="op">--</span>master spark:<span class="op">//</span>localhost:<span class="dv">7077</span> <span class="op">--</span>num<span class="op">-</span>executors <span class="dv">2</span> <span class="op">\</span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>               <span class="op">--</span>executor<span class="op">-</span>memory $EXEC_MEM <span class="op">--</span>executor<span class="op">-</span>cores <span class="dv">1</span> <span class="op">\</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>             <span class="op">--</span>packages org.apache.spark:spark<span class="op">-</span>sql<span class="op">-</span>kafka<span class="op">-</span><span class="dv">0</span><span class="op">-</span><span class="fl">10_2.12</span>:<span class="fl">3.3.1</span>,org.apache.spark:spark<span class="op">-</span>avro_2<span class="fl">.12</span>:<span class="fl">3.3.1</span>,org.apache.spark:spark<span class="op">-</span>streaming<span class="op">-</span>kafka<span class="op">-</span><span class="dv">0</span><span class="op">-</span><span class="fl">10_2.12</span>:<span class="fl">3.3.1</span> <span class="op">\</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>             $PYTHON_JOB</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="window-operations-on-event-time" class="level4">
<h4 class="anchored" data-anchor-id="window-operations-on-event-time">Window Operations on Event Time</h4>
<p>Aggregations over a sliding event-time window are straightforward with Structured Streaming and are very similar to grouped aggregations. In a grouped aggregation, aggregate values (e.g.&nbsp;counts) are maintained for each unique value in the user-specified grouping column. In case of window-based aggregations, aggregate values are maintained for each window the event-time of a row falls into</p>
<p>Imagine a stream now contains lines along with the time when the line was generated. Instead of running word counts, we want to count words within 10 minute windows, updating every 5 minutes. That is, word counts in words received between 10 minute windows 12:00 - 12:10, 12:05 - 12:15, 12:10 - 12:20, etc. Note that 12:00 - 12:10 means data that arrived after 12:00 but before 12:10. Now, consider a word that was received at 12:07. This word should increment the counts corresponding to two windows 12:00 - 12:10 and 12:05 - 12:15. So the counts will be indexed by both, the grouping key (i.e.&nbsp;the word) and the window (can be calculated from the event-time).</p>
<p>The result tables would look something like the following :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="DE_Zoomcamp_Week_6_files/figure-html/475f71d4-9521-4b5e-9897-c7bc6dc55447.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">structured-streaming-window.png</figcaption><p></p>
</figure>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>
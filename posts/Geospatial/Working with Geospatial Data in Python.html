<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Stephen Barrie">
<meta name="dcterms.date" content="2022-12-14">

<title>Into the Unknown - Introduction to Geospatial Raster and Vector data with Python</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Into the Unknown</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">Stephen Barrie</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Stephen137" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://linkedin.com/in/sjbarrie" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Introduction to Geospatial Raster and Vector data with Python</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">TIL</div>
                <div class="quarto-category">Geospatial</div>
                <div class="quarto-category">Data Carpentry</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Stephen Barrie </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 14, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#data-structures-raster-and-vector" id="toc-data-structures-raster-and-vector" class="nav-link active" data-scroll-target="#data-structures-raster-and-vector">Data Structures: Raster and Vector</a>
  <ul class="collapse">
  <li><a href="#raster-data" id="toc-raster-data" class="nav-link" data-scroll-target="#raster-data">1. Raster data</a>
  <ul class="collapse">
  <li><a href="#extent" id="toc-extent" class="nav-link" data-scroll-target="#extent">Extent</a></li>
  <li><a href="#resolution" id="toc-resolution" class="nav-link" data-scroll-target="#resolution">Resolution</a></li>
  <li><a href="#raster-data-format" id="toc-raster-data-format" class="nav-link" data-scroll-target="#raster-data-format">Raster data format</a></li>
  <li><a href="#multi-band-raster-data" id="toc-multi-band-raster-data" class="nav-link" data-scroll-target="#multi-band-raster-data">Multi-band Raster data</a></li>
  <li><a href="#other-types-of-multi-band-raster-data" id="toc-other-types-of-multi-band-raster-data" class="nav-link" data-scroll-target="#other-types-of-multi-band-raster-data">Other Types of Multi-band Raster Data</a></li>
  </ul></li>
  <li><a href="#vector-data" id="toc-vector-data" class="nav-link" data-scroll-target="#vector-data">2. Vector data</a>
  <ul class="collapse">
  <li><a href="#points" id="toc-points" class="nav-link" data-scroll-target="#points">Points</a></li>
  <li><a href="#lines" id="toc-lines" class="nav-link" data-scroll-target="#lines">Lines</a></li>
  <li><a href="#polygons" id="toc-polygons" class="nav-link" data-scroll-target="#polygons">Polygons</a></li>
  <li><a href="#advantages-of-vector-data" id="toc-advantages-of-vector-data" class="nav-link" data-scroll-target="#advantages-of-vector-data">Advantages of vector data</a></li>
  <li><a href="#disadvantages-of-vector-data" id="toc-disadvantages-of-vector-data" class="nav-link" data-scroll-target="#disadvantages-of-vector-data">Disadvantages of vector data</a></li>
  <li><a href="#vector-data-format" id="toc-vector-data-format" class="nav-link" data-scroll-target="#vector-data-format">Vector data format</a></li>
  </ul></li>
  <li><a href="#coordinate-reference-systems" id="toc-coordinate-reference-systems" class="nav-link" data-scroll-target="#coordinate-reference-systems">3. Coordinate Reference Systems</a>
  <ul class="collapse">
  <li><a href="#components-of-a-crs" id="toc-components-of-a-crs" class="nav-link" data-scroll-target="#components-of-a-crs">Components of a CRS</a></li>
  <li><a href="#which-projection-should-we-use" id="toc-which-projection-should-we-use" class="nav-link" data-scroll-target="#which-projection-should-we-use">Which projection should we use?</a></li>
  <li><a href="#describing-coordinate-reference-systems" id="toc-describing-coordinate-reference-systems" class="nav-link" data-scroll-target="#describing-coordinate-reference-systems">Describing Coordinate Reference Systems</a></li>
  <li><a href="#epsg" id="toc-epsg" class="nav-link" data-scroll-target="#epsg">EPSG</a></li>
  <li><a href="#well-known-text" id="toc-well-known-text" class="nav-link" data-scroll-target="#well-known-text">Well-Known Text</a></li>
  <li><a href="#proj" id="toc-proj" class="nav-link" data-scroll-target="#proj">PROJ</a></li>
  <li><a href="#format-interoperability" id="toc-format-interoperability" class="nav-link" data-scroll-target="#format-interoperability">Format interoperability</a></li>
  <li><a href="#metadata" id="toc-metadata" class="nav-link" data-scroll-target="#metadata">Metadata</a></li>
  </ul></li>
  <li><a href="#the-geospatial-landscape" id="toc-the-geospatial-landscape" class="nav-link" data-scroll-target="#the-geospatial-landscape">4. The Geospatial Landscape</a>
  <ul class="collapse">
  <li><a href="#open-source-software" id="toc-open-source-software" class="nav-link" data-scroll-target="#open-source-software">Open-source software</a></li>
  <li><a href="#online-cloud-computing" id="toc-online-cloud-computing" class="nav-link" data-scroll-target="#online-cloud-computing">Online + Cloud computing</a></li>
  <li><a href="#gui-vs-cli" id="toc-gui-vs-cli" class="nav-link" data-scroll-target="#gui-vs-cli">GUI vs CLI</a></li>
  <li><a href="#gis-in-programming-languages" id="toc-gis-in-programming-languages" class="nav-link" data-scroll-target="#gis-in-programming-languages">GIS in programming languages</a></li>
  <li><a href="#gis-file-types" id="toc-gis-file-types" class="nav-link" data-scroll-target="#gis-file-types">GIS File Types</a></li>
  </ul></li>
  <li><a href="#access-satellite-imagery-using-python" id="toc-access-satellite-imagery-using-python" class="nav-link" data-scroll-target="#access-satellite-imagery-using-python">5. Access satellite imagery using Python</a>
  <ul class="collapse">
  <li><a href="#search-for-satellite-imagery---sentinel" id="toc-search-for-satellite-imagery---sentinel" class="nav-link" data-scroll-target="#search-for-satellite-imagery---sentinel">Search for satellite imagery - Sentinel</a></li>
  <li><a href="#search-a-stac-catalog" id="toc-search-a-stac-catalog" class="nav-link" data-scroll-target="#search-a-stac-catalog">Search a STAC catalog</a></li>
  <li><a href="#cloud-optimized-geotiffs" id="toc-cloud-optimized-geotiffs" class="nav-link" data-scroll-target="#cloud-optimized-geotiffs">Cloud Optimized GeoTIFFs</a></li>
  <li><a href="#access-the-imagesassets" id="toc-access-the-imagesassets" class="nav-link" data-scroll-target="#access-the-imagesassets">Access the images(assets)</a></li>
  <li><a href="#search-for-satellite-imagery---landsat-8" id="toc-search-for-satellite-imagery---landsat-8" class="nav-link" data-scroll-target="#search-for-satellite-imagery---landsat-8">Search for satellite imagery - Landsat 8</a></li>
  </ul></li>
  <li><a href="#read-and-visualize-raster-data" id="toc-read-and-visualize-raster-data" class="nav-link" data-scroll-target="#read-and-visualize-raster-data">6. Read and visualize raster data</a>
  <ul class="collapse">
  <li><a href="#load-a-raster-and-view-attributes" id="toc-load-a-raster-and-view-attributes" class="nav-link" data-scroll-target="#load-a-raster-and-view-attributes">Load a Raster and View Attributes</a></li>
  <li><a href="#visualize-a-raster" id="toc-visualize-a-raster" class="nav-link" data-scroll-target="#visualize-a-raster">Visualize a Raster</a></li>
  <li><a href="#view-raster-coordinate-reference-system-crs-in-python" id="toc-view-raster-coordinate-reference-system-crs-in-python" class="nav-link" data-scroll-target="#view-raster-coordinate-reference-system-crs-in-python">View Raster Coordinate Reference System (CRS) in Python</a></li>
  <li><a href="#understanding-pyproj-crs-summary" id="toc-understanding-pyproj-crs-summary" class="nav-link" data-scroll-target="#understanding-pyproj-crs-summary">Understanding pyproj CRS Summary</a></li>
  <li><a href="#calculate-raster-statistics" id="toc-calculate-raster-statistics" class="nav-link" data-scroll-target="#calculate-raster-statistics">Calculate Raster Statistics</a></li>
  <li><a href="#dealing-with-missing-data" id="toc-dealing-with-missing-data" class="nav-link" data-scroll-target="#dealing-with-missing-data">Dealing with Missing Data</a></li>
  <li><a href="#raster-bands" id="toc-raster-bands" class="nav-link" data-scroll-target="#raster-bands">Raster Bands</a></li>
  </ul></li>
  <li><a href="#vector-data-in-python" id="toc-vector-data-in-python" class="nav-link" data-scroll-target="#vector-data-in-python">7. Vector data in Python</a>
  <ul class="collapse">
  <li><a href="#introducing-the-vector-data" id="toc-introducing-the-vector-data" class="nav-link" data-scroll-target="#introducing-the-vector-data">Introducing the vector data</a></li>
  <li><a href="#vector-metadata-attributes" id="toc-vector-metadata-attributes" class="nav-link" data-scroll-target="#vector-metadata-attributes">Vector Metadata &amp; Attributes</a></li>
  <li><a href="#spatial-metadata" id="toc-spatial-metadata" class="nav-link" data-scroll-target="#spatial-metadata">Spatial Metadata</a></li>
  <li><a href="#selecting-spatial-features" id="toc-selecting-spatial-features" class="nav-link" data-scroll-target="#selecting-spatial-features">Selecting spatial features</a></li>
  <li><a href="#plotting-a-vector-dataset" id="toc-plotting-a-vector-dataset" class="nav-link" data-scroll-target="#plotting-a-vector-dataset">Plotting a vector dataset</a></li>
  <li><a href="#spatial-data-attributes" id="toc-spatial-data-attributes" class="nav-link" data-scroll-target="#spatial-data-attributes">Spatial Data Attributes</a></li>
  <li><a href="#modify-the-geometry-of-a-geodataframe" id="toc-modify-the-geometry-of-a-geodataframe" class="nav-link" data-scroll-target="#modify-the-geometry-of-a-geodataframe">Modify the geometry of a GeoDataFrame</a></li>
  </ul></li>
  <li><a href="#crop-raster-data-with-rioxarray-and-geopandas" id="toc-crop-raster-data-with-rioxarray-and-geopandas" class="nav-link" data-scroll-target="#crop-raster-data-with-rioxarray-and-geopandas">8. Crop raster data with rioxarray and geopandas</a>
  <ul class="collapse">
  <li><a href="#introduce-the-data" id="toc-introduce-the-data" class="nav-link" data-scroll-target="#introduce-the-data">Introduce the Data</a></li>
  <li><a href="#crop-raster-data-with-a-bounding-box" id="toc-crop-raster-data-with-a-bounding-box" class="nav-link" data-scroll-target="#crop-raster-data-with-a-bounding-box">Crop raster data with a bounding box</a></li>
  <li><a href="#crop-raster-data-with-polygons" id="toc-crop-raster-data-with-polygons" class="nav-link" data-scroll-target="#crop-raster-data-with-polygons">Crop raster data with polygons</a></li>
  <li><a href="#crop-raster-data-with-a-geometry-buffer" id="toc-crop-raster-data-with-a-geometry-buffer" class="nav-link" data-scroll-target="#crop-raster-data-with-a-geometry-buffer">Crop raster data with a geometry buffer</a></li>
  <li><a href="#select-the-raster-data-around-the-wells" id="toc-select-the-raster-data-around-the-wells" class="nav-link" data-scroll-target="#select-the-raster-data-around-the-wells">Select the raster data around the wells</a></li>
  <li><a href="#select-the-raster-data-around-the-waterways" id="toc-select-the-raster-data-around-the-waterways" class="nav-link" data-scroll-target="#select-the-raster-data-around-the-waterways">Select the raster data around the waterways</a></li>
  <li><a href="#crop-raster-data-using-another-raster-dataset" id="toc-crop-raster-data-using-another-raster-dataset" class="nav-link" data-scroll-target="#crop-raster-data-using-another-raster-dataset">Crop raster data using another raster dataset</a></li>
  </ul></li>
  <li><a href="#raster-calculations-in-python" id="toc-raster-calculations-in-python" class="nav-link" data-scroll-target="#raster-calculations-in-python">9. Raster Calculations in Python</a>
  <ul class="collapse">
  <li><a href="#normalized-difference-vegetation-index-ndvi" id="toc-normalized-difference-vegetation-index-ndvi" class="nav-link" data-scroll-target="#normalized-difference-vegetation-index-ndvi">Normalized Difference Vegetation Index (NDVI)</a></li>
  <li><a href="#load-and-crop-the-data" id="toc-load-and-crop-the-data" class="nav-link" data-scroll-target="#load-and-crop-the-data">Load and crop the data</a></li>
  <li><a href="#raster-math" id="toc-raster-math" class="nav-link" data-scroll-target="#raster-math">Raster Math</a></li>
  <li><a href="#explore-ndvi-raster-values" id="toc-explore-ndvi-raster-values" class="nav-link" data-scroll-target="#explore-ndvi-raster-values">Explore NDVI Raster Values</a></li>
  <li><a href="#classifying-continuous-rasters-in-python" id="toc-classifying-continuous-rasters-in-python" class="nav-link" data-scroll-target="#classifying-continuous-rasters-in-python">Classifying Continuous Rasters in Python</a></li>
  <li><a href="#compute-the-ndvi-for-the-texel-island" id="toc-compute-the-ndvi-for-the-texel-island" class="nav-link" data-scroll-target="#compute-the-ndvi-for-the-texel-island">Compute the NDVI for the Texel island</a></li>
  </ul></li>
  <li><a href="#calculating-zonal-statistics-on-rasters" id="toc-calculating-zonal-statistics-on-rasters" class="nav-link" data-scroll-target="#calculating-zonal-statistics-on-rasters">10. Calculating Zonal Statistics on Rasters</a>
  <ul class="collapse">
  <li><a href="#making-vector-and-raster-data-compatible" id="toc-making-vector-and-raster-data-compatible" class="nav-link" data-scroll-target="#making-vector-and-raster-data-compatible">Making vector and raster data compatible</a></li>
  <li><a href="#rasterizing-our-vector-data" id="toc-rasterizing-our-vector-data" class="nav-link" data-scroll-target="#rasterizing-our-vector-data">Rasterizing our vector data</a></li>
  <li><a href="#calculate-zonal-statistics" id="toc-calculate-zonal-statistics" class="nav-link" data-scroll-target="#calculate-zonal-statistics">Calculate zonal statistics</a></li>
  <li><a href="#calculate-zonal-statistics-for-zones-defined-by-ndvi_classified" id="toc-calculate-zonal-statistics-for-zones-defined-by-ndvi_classified" class="nav-link" data-scroll-target="#calculate-zonal-statistics-for-zones-defined-by-ndvi_classified">Calculate zonal statistics for zones defined by ndvi_classified</a></li>
  </ul></li>
  <li><a href="#parallel-raster-computations-using-dask" id="toc-parallel-raster-computations-using-dask" class="nav-link" data-scroll-target="#parallel-raster-computations-using-dask">11. Parallel raster computations using Dask</a>
  <ul class="collapse">
  <li><a href="#time-profiling-in-jupyter" id="toc-time-profiling-in-jupyter" class="nav-link" data-scroll-target="#time-profiling-in-jupyter">Time profiling in Jupyter</a></li>
  <li><a href="#dask-powered-rasters" id="toc-dask-powered-rasters" class="nav-link" data-scroll-target="#dask-powered-rasters">Dask-powered rasters</a></li>
  <li><a href="#parallel-computations" id="toc-parallel-computations" class="nav-link" data-scroll-target="#parallel-computations">Parallel computations</a></li>
  <li><a href="#dask-graph" id="toc-dask-graph" class="nav-link" data-scroll-target="#dask-graph">Dask graph</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>This blog has been produced after working through the <strong><em><a href="https://carpentries-incubator.github.io/geospatial-python/">Introduction to Geospatial Raster and Vector data with Python</a></em></strong> lesson provided by <strong><a href="https://datacarpentry.org/">Data Carpentry</a></strong>.</p>
<section id="data-structures-raster-and-vector" class="level1">
<h1>Data Structures: Raster and Vector</h1>
<p>The two primary types of geospatial data are <strong>raster</strong> and <strong>vector data</strong>. Raster data is stored as a grid of values which are rendered on a map as pixels. Each pixel value represents an area on the Earth’s surface. Vector data structures represent specific features on the Earth’s surface, and assign attributes to those features. Vector data structures will be discussed in more detail in the next section.</p>
<p>This section will focus on how to work with both raster and vector data sets, therefore it is essential that we understand the basic structures of these types of data and the types of data that they can be used to represent.</p>
<section id="raster-data" class="level2">
<h2 class="anchored" data-anchor-id="raster-data">1. Raster data</h2>
<p>Raster data is any pixelated (or gridded) data where each pixel is associated with a specific geographic location. The value of a pixel can be continuous (e.g.&nbsp;elevation) or categorical (e.g.&nbsp;land use). If this sounds familiar, it is because this data structure is very common: it’s how we represent any digital image. A geospatial raster is only different from a digital photo in that it is accompanied by spatial information that connects the data to a particular location. This includes the raster’s extent and cell size, the number of rows and columns, and its coordinate reference system (or CRS).</p>
<p><img src="raster.png" width="600" height="600"></p>
<p>Some examples of continuous rasters include:</p>
<ul>
<li>Precipitation maps</li>
<li>Maps of tree height derived from LiDAR data</li>
<li>Elevation values for a region</li>
</ul>
<p>A map of elevation for Harvard Forest derived from the NEON AOP LiDAR sensor is below. Elevation is represented as a continuous numeric variable in this map. The legend shows the continuous range of values in the data from around 300 to 420 meters:</p>
<p><img src="continuous_elevation.png" width="600" height="600"></p>
<p>Some rasters contain categorical data where each pixel represents a discrete class such as a landcover type (e.g., “forest” or “grassland”) rather than a continuous value such as elevation or temperature. Some examples of classified maps include:</p>
<ol type="1">
<li>Landcover / land-use maps</li>
<li>Tree height maps classified as short, medium, and tall trees</li>
<li>Elevation maps classified as low, medium, and high elevation</li>
</ol>
<p><img src="USA_landcover_classification" width="600" height="600"></p>
<p>The map above shows the contiguous United States with landcover as categorical data. Each color is a different landcover category. (Source: Homer, C.G., et al., 2015, Completion of the 2011 National Land Cover Database for the conterminous United States-Representing a decade of land cover change information. Photogrammetric Engineering and Remote Sensing, v. 81, no. 5, p.&nbsp;345-354)</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Can you think of potential advantages and disadvantages of storing data in raster format?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Raster data has some important advantages:</p>
<ul>
<li>representation of continuous surfaces</li>
<li>potentially very high levels of detail</li>
<li>data is ‘unweighted’ across its extent - the geometry doesn’t implicitly highlight features</li>
<li>cell-by-cell calculations can be very fast and efficient</li>
</ul>
<p>The downsides of raster data are:</p>
<ul>
<li>very large file sizes as cell size gets smaller</li>
<li>currently popular formats don’t embed metadata well (more on this later!)</li>
<li>can be difficult to represent complex information</li>
</ul>
</div>
</div>
</div>
<section id="extent" class="level3">
<h3 class="anchored" data-anchor-id="extent">Extent</h3>
<p>The spatial extent is the geographic area that the raster data covers. The spatial extent of an object represents the geographic edge or location that is the furthest north, south, east and west. In other words, extent represents the overall geographic coverage of the spatial object.</p>
<p><img src="spatial_extent.png" width="600" height="600"></p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
In the image above, the dashed boxes around each set of objects seems to imply that the three objects have the same extent. Is this accurate? If not, which object(s) have a different extent?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The lines and polygon objects have the same extent. The extent for the points object is smaller in the vertical direction than the other two because there are no points on the line at y = 8.</p>
</div>
</div>
</div>
</section>
<section id="resolution" class="level3">
<h3 class="anchored" data-anchor-id="resolution">Resolution</h3>
<p>A resolution of a raster represents the area on the ground that each pixel of the raster covers. The image below illustrates the effect of changes in resolution:</p>
<p><img src="raster_resolution.png" width="600" height="600"></p>
</section>
<section id="raster-data-format" class="level3">
<h3 class="anchored" data-anchor-id="raster-data-format">Raster data format</h3>
<p>Raster data can come in many different formats. In this blog, we will use the GeoTIFF format which has the extension .tif. A .tif file stores metadata or attributes about the file as embedded tif tags. For instance, your camera might store a tag that describes the make and model of the camera or the date the photo was taken when it saves a .tif. A GeoTIFF is a standard .tif image format with additional spatial (georeferencing) information embedded in the file as tags. These tags should include the following raster metadata:</p>
<ul>
<li>extent</li>
<li>resolution</li>
<li>Coordinate Reference System (CRS) - this concept will be introduced later</li>
<li>values that represent missing data (NoDataValue) - this concept will be introduced later</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
More resources on the .tif format
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://en.wikipedia.org/wiki/GeoTIFF">GeoTIFF on Wikipedia</a></li>
</ul>
</div>
</div>
</section>
<section id="multi-band-raster-data" class="level3">
<h3 class="anchored" data-anchor-id="multi-band-raster-data">Multi-band Raster data</h3>
<p>A raster can contain one or more bands. One type of multi-band raster dataset that is familiar to many of us is a colour image. A basic colour image consists of three bands: red, green, and blue. Each band represents light reflected from the red, green or blue portions of the electromagnetic spectrum. The pixel brightness for each band, when composited creates the colours that we see in an image.</p>
<p><img src="RGB_Stack" width="600" height="600"></p>
<p>We can plot each band of a multi-band image individually. Or we can composite all three bands together to make a colour image. In a multi-band dataset, the rasters will always have the same extent, resolution, and CRS.</p>
</section>
<section id="other-types-of-multi-band-raster-data" class="level3">
<h3 class="anchored" data-anchor-id="other-types-of-multi-band-raster-data">Other Types of Multi-band Raster Data</h3>
<p>Multi-band raster data might also contain:</p>
<ol type="1">
<li>Time series: the same variable, over the same area, over time</li>
<li><a href="https://en.wikipedia.org/wiki/Multispectral_imaging">Multispectral</a> imagery: image rasters that have 4 or more bands</li>
<li><a href="https://en.wikipedia.org/wiki/Hyperspectral_imaging">hyperspectral</a> imagery: image rasters with more than 10-15 bands</li>
</ol>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Key Points:<br>
- raster data is pixelated data where each pixel is associated with a specific location<br>
- raster data always has an extent and a resolution<br>
- the extent is the geographical area covered by a raster<br>
- the resolution is the area covered by each pixel of a raster</p>
</div>
</div>
</section>
</section>
<section id="vector-data" class="level2">
<h2 class="anchored" data-anchor-id="vector-data">2. Vector data</h2>
<p>Vector data structures represent specific features on the Earth’s surface, and assign attributes to those features. Vectors are composed of discrete geometric locations (x, y values) known as vertices that define the shape of the spatial object. The organization of the vertices determines the type of vector that we are working with:</p>
<ul>
<li>point;</li>
<li>line; or</li>
<li>polygon</li>
</ul>
<p>Vector datasets are in use in many industries besides geospatial fields. For instance, computer graphics are largely vector-based, although the data structures in use tend to join points using arcs and complex curves rather than straight lines. Computer-aided design (CAD) is also vector- based. The difference is that geospatial datasets are accompanied by information tying their features to real-world locations.</p>
<p><img src="pt_line_poly.png" width="500" height="500"></p>
<section id="points" class="level3">
<h3 class="anchored" data-anchor-id="points">Points</h3>
<p>Each point is defined by a single x, y coordinate. There can be many points in a vector point file. Examples of point data include: sampling locations, the location of individual trees, or the location of survey plots.</p>
</section>
<section id="lines" class="level3">
<h3 class="anchored" data-anchor-id="lines">Lines</h3>
<p>Lines are composed of many (at least 2) points that are connected. For instance, a road or a stream may be represented by a line. This line is composed of a series of segments, each “bend” in the road or stream represents a vertex that has a defined x, y location.</p>
</section>
<section id="polygons" class="level3">
<h3 class="anchored" data-anchor-id="polygons">Polygons</h3>
<p>A polygon consists of 3 or more vertices that are connected and closed. The outlines of survey plot boundaries, lakes, oceans, and states or countries are often represented by polygons.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Data tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Sometimes, boundary layers such as states and countries, are stored as lines rather than polygons. However, these boundaries, when represented as a line, will not create a closed object with a defined area that can be filled.</p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The plot below includes examples of two of the three types of vector objects. Use the definitions above to identify which features are represented by which vector type.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>State boundaries are polygons. The Fisher Tower location is a point. There are no line features shown.</p>
</div>
</div>
</div>
<p><img src="vector_types_examples.png" width="800" height="800"></p>
</section>
<section id="advantages-of-vector-data" class="level3">
<h3 class="anchored" data-anchor-id="advantages-of-vector-data">Advantages of vector data</h3>
<ul>
<li>the geometry itself contains information about what the dataset creator thought was important</li>
<li>the geometry structures hold information in themselves - why choose point over polygon, for instance?</li>
<li>each geometry feature can carry multiple attributes instead of just one, e.g.&nbsp;a database of cities can have attributes for name, country, population, etc</li>
<li>data storage can be very efficient compared to rasters</li>
</ul>
</section>
<section id="disadvantages-of-vector-data" class="level3">
<h3 class="anchored" data-anchor-id="disadvantages-of-vector-data">Disadvantages of vector data</h3>
<ul>
<li>potential loss of detail compared to raster</li>
<li>potential bias in datasets - what didn’t get recorded?</li>
<li>calculations involving multiple vector layers need to do math on the geometry as well as the attributes, so can be slow compared to raster math</li>
</ul>
</section>
<section id="vector-data-format" class="level3">
<h3 class="anchored" data-anchor-id="vector-data-format">Vector data format</h3>
<p>Like raster data, vector data can also come in many different formats. For this blog, we will use the Shapefile format. A Shapefile format consists of multiple files in the same directory, of which .shp, .shx, and .dbf files are mandatory. Other non-mandatory but very important files are .prj and shp.xml files.</p>
<ul>
<li>the .shp file stores the feature geometry itself</li>
<li>.shx is a positional index of the feature geometry to allow quickly searching forwards and backwards the geographic coordinates of each vertex in the vector</li>
<li>.dbf contains the tabular attributes for each shape.</li>
<li>.prj file indicates the Coordinate reference system (CRS)</li>
<li>.shp.xml contains the Shapefile metadata.</li>
</ul>
<p>Together, the Shapefile includes the following information:</p>
<ul>
<li>extent - the spatial extent of the shapefile (i.e.&nbsp;geographic area that the shapefile covers). The spatial extent for a shapefile represents the combined extent for all spatial objects in the shapefile.</li>
<li>object type - whether the shapefile includes points, lines, or polygons.</li>
<li>Coordinate reference system (CRS)</li>
<li>other attributes - for example, a line shapefile that contains the locations of streams, might contain the name of each stream.</li>
</ul>
<p>Because the structure of points, lines, and polygons are different, each individual shapefile can only contain one vector type (all points, all lines or all polygons). You will not find a mixture of point, line and polygon objects in a single shapefile.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
More resources on Shapefiles
</div>
</div>
<div class="callout-body-container callout-body">
<p>More about shapefiles can be found on <a href="https://en.wikipedia.org/wiki/Shapefile">Wikipedia</a>. Shapefiles are often publicly available from government services, such as <a href="https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html">this page from the US Census Bureau</a> or <a href="https://data.gov.au/data/dataset?res_format=SHP">this one from Australia’s Data.gov.au website</a>.</p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Key Points:<br>
- vector data structures represent specific features on the Earth’s surface along with attributes of those features<br>
- vector objects are either points, lines, or polygons</p>
</div>
</div>
</section>
</section>
<section id="coordinate-reference-systems" class="level2">
<h2 class="anchored" data-anchor-id="coordinate-reference-systems">3. Coordinate Reference Systems</h2>
<p>A data structure cannot be considered geospatial unless it is accompanied by coordinate reference system (CRS) information, in a format that geospatial applications can use to display and manipulate the data correctly. CRS information connects data to the Earth’s surface using a mathematical model. The CRS associated with a dataset tells your mapping software (for example Python) where the raster is located in geographic space. It also tells the mapping software what method should be used to flatten or project the raster in geographic space.</p>
<p>CRS and SRS (spatial reference system) are synonyms and are commonly interchanged. We will use only the term CRS throughout this blog.</p>
<p><img src="US_maps_projections.jpg" width="500" height="500"></p>
<p>The above image shows maps of the United States in different projections. Notice the differences in shape associated with each projection. These differences are a direct result of the calculations used to flatten the data onto a 2-dimensional map. (Source: opennews.org)</p>
<p>There are lots of great resources that describe coordinate reference systems and projections in greater detail.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Data from the same location but saved in different projections will not line up in any Geographic Information System(GIS) or other program.
</div>
</div>
<div class="callout-body-container callout-body">
<p>It’s important when working with spatial data to identify the coordinate reference system applied to the data and retain it throughout data processing and analysis.</p>
</div>
</div>
<section id="components-of-a-crs" class="level3">
<h3 class="anchored" data-anchor-id="components-of-a-crs">Components of a CRS</h3>
<p>CRS information has three components:</p>
<ul>
<li><p><strong>Datum</strong>: A model of the shape of the earth. It has angular units (i.e.&nbsp;degrees) and defines the starting point (i.e.&nbsp;where is [0,0]?) so the angles reference a meaningful spot on the earth. Common global datums are WGS84 and NAD83. Datums can also be local - fit to a particular area of the globe, but ill-fitting outside the area of intended use. In this blog, we will use the <a href="https://www.linz.govt.nz/guidance/geodetic-system/coordinate-systems-used-new-zealand/geodetic-datums/world-geodetic-system-1984-wgs84">WGS84 datum</a>.</p></li>
<li><p><strong>Projection</strong>: A mathematical transformation of the angular measurements on a round earth to a flat surface (i.e.&nbsp;paper or a computer screen). The units associated with a given projection are usually linear (feet, meters, etc.). In this workshop, we will see data in two different projections.</p></li>
<li><p><strong>Additional Parameters</strong>: Additional parameters are often necessary to create the full coordinate reference system. One common additional parameter is a definition of the center of the map. The number of required additional parameters depends on what is needed by each specific projection.</p></li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Orange peel analogy
</div>
</div>
<div class="callout-body-container callout-body">
<p>A common analogy employed to teach projections is the orange peel analogy. If you imagine that the Earth is an orange, how you peel it and then flatten the peel is similar to how projections get made.</p>
<p><img src="orange-peel-earth.jpg" width="400" height="400"></p>
</div>
</div>
</section>
<section id="which-projection-should-we-use" class="level3">
<h3 class="anchored" data-anchor-id="which-projection-should-we-use">Which projection should we use?</h3>
<p>To decide if a projection is right for our data, answer these questions:</p>
<ul>
<li>What is the area of minimal distortion?</li>
<li>What aspect of the data does it preserve?</li>
</ul>
<p><a href="https://foote.geography.uconn.edu/gcraft/notes/mapproj/mapproj_f.html">Peter Dana from the University of Colorado at Boulder</a> and the <a href="https://kartoweb.itc.nl/geometrics/Map%20projections/mappro.html">Department of Geo-Information Processing</a> has a good discussion of these aspects of projections. Online tools like <a href="https://projectionwizard.org/">Projection Wizard</a> can also help discover projections that might be a good fit for our data.</p>
</section>
<section id="describing-coordinate-reference-systems" class="level3">
<h3 class="anchored" data-anchor-id="describing-coordinate-reference-systems">Describing Coordinate Reference Systems</h3>
<p>There are several common systems in use for storing and transmitting CRS information, as well as translating among different CRSs. These systems generally comply with ISO 19111. Common systems for describing CRSs include EPSG, OGC WKT, and PROJ strings.</p>
</section>
<section id="epsg" class="level3">
<h3 class="anchored" data-anchor-id="epsg">EPSG</h3>
<p>The <a href="https://epsg.org/home.html">EPSG system</a> is a database of CRS information maintained by the International Association of Oil and Gas Producers. The dataset contains both CRS definitions and information on how to safely convert data from one CRS to another. Using EPSG is easy as every CRS has an integer identifier, e.g.&nbsp;WGS84 is EPSG:4326. The downside is that you can only use the CRSs defined by EPSG and cannot customise them (some datasets do not have EPSG codes). epsg.io is an excellent website for finding suitable projections by location or for finding information about a particular EPSG code.</p>
</section>
<section id="well-known-text" class="level3">
<h3 class="anchored" data-anchor-id="well-known-text">Well-Known Text</h3>
<p>The <a href="https://www.ogc.org/standards/wkt-crs">Open Geospatial Consortium WKT</a> standard is used by a number of important geospatial apps and software libraries. WKT is a nested list of geodetic parameters. The structure of the information is defined on their website. WKT is valuable in that the CRS information is more transparent than in EPSG, but can be more difficult to read and compare than PROJ since it is meant to necessarily represent more complex CRS information. Additionally, the WKT standard is implemented inconsistently across various software platforms, and the spec itself has some <a href="https://gdal.org/tutorials/wktproblems.html">known issues</a>.</p>
</section>
<section id="proj" class="level3">
<h3 class="anchored" data-anchor-id="proj">PROJ</h3>
<p><a href="https://proj.org/">PROJ</a> is an open-source library for storing, representing and transforming CRS information.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
PROJ strings continue to be used, but the format is deprecated by the PROJ C maintainers due to inaccuracies when converting to the WKT format.
</div>
</div>
<div class="callout-body-container callout-body">
<p>CRS information can still be represented with EPSG, WKT, or PROJ strings without consequence, but it is best to only use PROJ strings as a format for viewing CRS information, not for reprojecting data.</p>
</div>
</div>
<p>The data and python libraries we will be working with in this blog use different underlying representations of CRSs under the hood for reprojecting. PROJ represents CRS information as a text string of key-value pairs, which makes it easy to read and interpret.</p>
<p>A PROJ4 string includes the following information:</p>
<ul>
<li><strong>proj</strong>: the projection of the data</li>
<li><strong>zone</strong>: the zone of the data (this is specific to the UTM projection)</li>
<li><strong>datum</strong>: the datum used</li>
<li><strong>units</strong>: the units for the coordinates of the data</li>
<li><strong>ellps</strong>: the ellipsoid (how the earth’s roundness is calculated) for the data</li>
</ul>
<p>Note that the zone is unique to the UTM projection. Not all CRSs will have a zone.</p>
<p><img src="Utm-zones-USA.svg" width="500" height="500"> Image source: Chrismurf at English Wikipedia, via <a href="https://en.wikipedia.org/wiki/Universal_Transverse_Mercator_coordinate_system#/media/File:Utm-zones-USA.svg">Wikimedia Commons (CC-BY)</a>.</p>
<p>Here is a PROJ4 string for one of the datasets we will use in this blog:</p>
<pre><code>+proj=utm +zone=18 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0</code></pre>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What projection, zone, datum, and ellipsoid are used for this data? What are the units of the data? Using the map above, what part of the United States was this data collected from?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>Projection is UTM, zone 18, datum is WGS84, ellipsoid is WGS84.</li>
<li>The data is in meters.</li>
<li>The data comes from the eastern US seaboard.</li>
</ul>
</div>
</div>
</div>
</section>
<section id="format-interoperability" class="level3">
<h3 class="anchored" data-anchor-id="format-interoperability">Format interoperability</h3>
<p>Many existing file formats were invented by GIS software developers, often in a closed-source environment. This led to the large number of formats on offer today, and considerable problems transferring data between software environments. The <a href="https://gdal.org/">Geospatial Data Abstraction Library (GDAL)</a> is an open-source answer to this issue.</p>
<p>GDAL is a set of software tools that translate between almost any geospatial format in common use today (and some not so common ones). GDAL also contains tools for editing and manipulating both raster and vector files, including reprojecting data to different CRSs. GDAL can be used as a standalone command-line tool, or built in to other GIS software. Several open-source GIS programs use GDAL for all file import/export operations.</p>
</section>
<section id="metadata" class="level3">
<h3 class="anchored" data-anchor-id="metadata">Metadata</h3>
<p>Spatial data is useless without metadata. Essential metadata includes the CRS information, but proper spatial metadata encompasses more than that. History and provenance of a dataset (how it was made), who is in charge of maintaining it, and appropriate (and inappropriate!) use cases should also be documented in metadata. This information should accompany a spatial dataset wherever it goes. In practice this can be difficult, as many spatial data formats don’t have a built-in place to hold this kind of information. Metadata often has to be stored in a companion file, and generated and maintained manually.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
More Resources on CRS
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://spatialreference.org/ref/epsg/">spatialreference.org</a> - A comprehensive online library of CRS information.</li>
<li><a href="https://docs.qgis.org/3.22/en/docs/">QGIS Documentation</a> - CRS Overview.</li>
<li><a href="https://source.opennews.org/articles/choosing-right-map-projection/">Choosing the Right Map Projection</a>.</li>
<li><a href="https://www.youtube.com/embed/KUF_Ckv8HbE">Video</a> highlighting how map projections can make continents seems proportionally larger or smaller than they actually are.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Key Points:<br>
- All geospatial datasets (raster and vector) are associated with a specific coordinate reference system<br>
- A coordinate reference system includes datum, projection, and additional parameters specific to the dataset</p>
</div>
</div>
</section>
</section>
<section id="the-geospatial-landscape" class="level2">
<h2 class="anchored" data-anchor-id="the-geospatial-landscape">4. The Geospatial Landscape</h2>
<p>Most traditional GIS work is carried out in standalone applications that aim to provide end-to-end geospatial solutions. These applications are available under a wide range of licenses and price points. Some of the most common are listed below.</p>
<section id="open-source-software" class="level3">
<h3 class="anchored" data-anchor-id="open-source-software">Open-source software</h3>
<p>The <a href="https://www.osgeo.org/">Open Source Geospatial Foundation (OSGEO)</a> supports several actively managed GIS platforms:</p>
<ul>
<li><p><a href="https://www.qgis.org/en/site/">QGIS</a> is a professional GIS application that is built on top of and proud to be itself Free and Open Source Software (FOSS). QGIS is written in Python, has a python console interface, and has several interfaces written in R including RQGIS.</p></li>
<li><p><a href="https://grass.osgeo.org/">GRASS GIS</a>, commonly referred to as GRASS (Geographic Resources Analysis Support System), is a FOSS-GIS software suite used for geospatial data management and analysis, image processing, graphics and maps production, spatial modeling, and visualization. GRASS GIS is currently used in academic and commercial settings around the world, as well as by many governmental agencies and environmental consulting companies. It is a founding member of the Open Source Geospatial Foundation (OSGeo). GRASS GIS can be installed along with and made accessible within QGIS 3.</p></li>
<li><p><a href="https://gdal.org/">GDAL</a> is a multiplatform set of tools for translating between geospatial data formats. It can also handle reprojection and a variety of geoprocessing tasks. GDAL is built in to many applications both FOSS and commercial, including GRASS and QGIS.</p></li>
<li><p><a href="https://saga-gis.sourceforge.io/en/index.html">SAGA-GIS</a>, or System for Automated Geoscientific Analyses, is a FOSS-GIS application developed by a small team of researchers from the Dept. of Physical Geography, Göttingen, and the Dept. of Physical Geography, Hamburg. SAGA has been designed for an easy and effective implementation of spatial algorithms, offers a comprehensive, growing set of geoscientific methods, provides an easily approachable user interface with many visualisation options, and runs under Windows and Linux operating systems. Like GRASS GIS, it can also be installed and made accessible in QGIS3.</p></li>
<li><p><a href="https://postgis.net/">PostGIS</a> is a geospatial extension to the PostGreSQL relational database.</p></li>
</ul>
</section>
<section id="online-cloud-computing" class="level3">
<h3 class="anchored" data-anchor-id="online-cloud-computing">Online + Cloud computing</h3>
<ul>
<li><p><a href="https://pangeo.io/">PANGEO</a> is a community organization dedicated to open and reproducible data science with python. They focus on the Pangeo software ecosystem for working with big data in the geosciences. This community organization also supports python libraries like xarray, iris, dask, jupyter, and many other packages.</p></li>
<li><p>Google has created <a href="https://earthengine.google.com/">Google Earth Engine</a> which combines a multi-petabyte catalog of satellite imagery and geospatial datasets with planetary-scale analysis capabilities and makes it available for scientists, researchers, and developers to detect changes, map trends, and quantify differences on the Earth’s surface. Earth Engine API runs in both Python and JavaScript.</p></li>
<li><p><a href="https://www.esri.com/en-us/arcgis/products/arcgis-online/overview">ArcGIS Online</a> provides access to thousands of maps and base layers.</p></li>
<li><p><a href="https://kepler.gl/#/">Kepler.gl</a> is Uber’s toolkit for handling large datasets (i.e.&nbsp;Uber’s data archive).</p></li>
<li><p><a href="https://sepal.io/">Sepal.io</a> by <a href="https://openforis.org/">FAO Open Foris</a> utilizing EOS satellite imagery and cloud resources for global forest monitoring.</p></li>
</ul>
</section>
<section id="gui-vs-cli" class="level3">
<h3 class="anchored" data-anchor-id="gui-vs-cli">GUI vs CLI</h3>
<p>The earliest computer systems operated without a <strong>graphical user interface (GUI)</strong>, relying only on the <strong>command-line interface (CLI)</strong>. Since mapping and spatial analysis are strongly visual tasks, GIS applications benefited greatly from the emergence of GUIs and quickly came to rely heavily on them. Most modern GIS applications have very complex GUIs, with all common tools and procedures accessed via buttons and menus.</p>
<p>Benefits of using a GUI include:</p>
<ul>
<li>Tools are all laid out in front of you</li>
<li>Complex commands are easy to build</li>
<li>Don’t need to learn a coding language</li>
<li>Cartography and visualisation is more intuitive and flexible</li>
</ul>
<p>Downsides of using a GUI include:</p>
<ul>
<li>Low reproducibility - you can’t record your actions and replay</li>
<li>Most are not designed for batch-processing files</li>
<li>Limited ability to customise functions or write your own</li>
<li>Intimidating interface for new users - so many buttons!</li>
</ul>
<p>In scientific computing, the lack of reproducibility in point-and-click software has come to be viewed as a critical weakness. As such, scripted CLI-style workflows are again becoming popular, which leads us to another approach to doing GIS — via a programming language. This is the approach we will be using throughout this blog.</p>
</section>
<section id="gis-in-programming-languages" class="level3">
<h3 class="anchored" data-anchor-id="gis-in-programming-languages">GIS in programming languages</h3>
<p>A number of powerful geospatial processing libraries exist for general-purpose programming languages like Java and C++. However, the learning curve for these languages is steep and the effort required is excessive for users who only need a subset of their functionality.</p>
<p>Higher-level scripting languages like Python and R are easier to learn and use. Both now have their own packages that wrap up those geospatial processing libraries and make them easy to access and use safely. A key example is the Java Topology Suite (JTS), which is implemented in C++ as GEOS. GEOS is accessible in Python via the shapely package (and geopandas, which makes use of shapely) and in R via sf. R and Python also have interface packages for GDAL, and for specific GIS apps.</p>
<p>This last point is a huge advantage for GIS-by-programming; these interface packages give you the ability to access functions unique to particular programs, but have your entire workflow recorded in a central document - a document that can be re-run at will. Below are lists of some of the key spatial packages for Python, which we will be using in the remainder of this workshop.</p>
<ul>
<li>geopandas and geocube for working with vector data</li>
<li>rasterio and rioxarray for working with raster data</li>
</ul>
<p>These packages along with the <strong>matplotlib</strong> package are all we need for spatial data visualisation. Python also has many fundamental scientific packages that are relevant in the geospatial domain. Below is a list of particularly fundamental packages:</p>
<ul>
<li>NumPy</li>
<li>scipy</li>
<li>scikit-image</li>
</ul>
<p>These are all excellent options for working with rasters, as arrays. An overview of these and other Python spatial packages can be <a href="https://chrieke.medium.com/essential-geospatial-python-libraries-5d82fcc38731">accessed here</a>.</p>
<p>As a programming language, Python can be a CLI tool. However, using Python together with an <a href="https://www.codecademy.com/article/what-is-an-ide">Integrated Development Environment (IDE)</a> application allows some GUI features to become part of your workflow. IDEs allow the best of both worlds. They provide a place to visually examine data and other software objects, interact with your file system, and draw plots and maps, but your activities are still command-driven: recordable and reproducible. There are several IDEs available for Python. <a href="https://jupyter.org/">JupyterLab</a> is well-developed and the most widely used option for data science in Python. <a href="https://code.visualstudio.com/docs/python/python-tutorial">VSCode</a> and <a href="https://www.spyder-ide.org/">Spyder</a> are other popular options for data science.</p>
<p>Traditional GIS apps are also moving back towards providing a scripting environment for users, further blurring the CLI/GUI divide. <a href="https://www.esri.com/en-us/home">ESRI</a> have adopted Python into their software, and QGIS is both Python and R-friendly.</p>
</section>
<section id="gis-file-types" class="level3">
<h3 class="anchored" data-anchor-id="gis-file-types">GIS File Types</h3>
<p>There are a variety of file types that are used in GIS analysis. Depending on the program you choose to use some file types can be used while others are not readable. Below is a brief table describing some of the most common vector and raster file types.</p>
<p><img src="vector_raster_file_types.png" width="700" height="700"></p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Key Points:<br>
- Many software packages exist for working with geospatial data<br>
- Command-line programs allow you to automate and reproduce your work<br>
- JupyterLab provides a user-friendly interface for working with Python</p>
</div>
</div>
</section>
</section>
<section id="access-satellite-imagery-using-python" class="level2">
<h2 class="anchored" data-anchor-id="access-satellite-imagery-using-python">5. Access satellite imagery using Python</h2>
<p>A number of satellites take snapshots of the Earth’s surface from space. The images recorded by these remote sensors represent a very precious data source for any activity that involves monitoring changes on Earth. Satellite imagery is typically provided in the form of geospatial raster data, with the measurements in each grid cell (“pixel”) being associated to accurate geographic coordinate information.</p>
<p>In this section we will explore how to access open satellite data using Python. In particular, we will consider <a href="https://registry.opendata.aws/sentinel-2-l2a-cogs/">the Sentinel-2 data collection that is hosted on AWS</a>. This dataset consists of multi-band optical images acquired by the two satellites of the <a href="https://sentinel.esa.int/web/sentinel/missions/sentinel-2">Sentinel-2 mission</a> and it is continuously updated with new images.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Satellite data sources
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://landsat.gsfc.nasa.gov/">Landsat</a></li>
<li><a href="https://sentinels.copernicus.eu/web/sentinel/sentinel-data-access">Sentinel</a></li>
</ul>
</div>
</div>
<section id="search-for-satellite-imagery---sentinel" class="level3">
<h3 class="anchored" data-anchor-id="search-for-satellite-imagery---sentinel">Search for satellite imagery - Sentinel</h3>
<p>Current sensor resolutions and satellite revisit periods are such that terabytes of data products are added daily to the corresponding collections. Such datasets cannot be made accessible to users via full-catalog download. Space agencies and other data providers often offer access to their data catalogs through interactive Graphical User Interfaces (GUIs), see for instance the <a href="https://scihub.copernicus.eu/dhus/#/home">Copernicus Open Access Hub portal</a> for the Sentinel missions. Accessing data via a GUI is a nice way to explore a catalog and get familiar with its content, but it represents a heavy and error-prone task that should be avoided if carried out systematically to retrieve data.</p>
<p>A service that offers programmatic access to the data enables users to reach the desired data in a more reliable, scalable and reproducible manner. An important element in the software interface exposed to the users, which is generally called the Application Programming Interface (API), is the use of standards. Standards, in fact, can significantly facilitate the reusability of tools and scripts across datasets and applications.</p>
<p>The <a href="https://stacspec.org/en">SpatioTemporal Asset Catalog (STAC)</a> specification is an emerging standard for describing geospatial data. By organizing metadata in a form that adheres to the STAC specifications, data providers make it possible for users to access data from different missions, instruments and collections using the same set of tools.</p>
</section>
<section id="search-a-stac-catalog" class="level3">
<h3 class="anchored" data-anchor-id="search-a-stac-catalog">Search a STAC catalog</h3>
<p>The <a href="https://radiantearth.github.io/stac-browser/#/">STAC browser</a> is a good starting point to discover available datasets, as it provides an up-to-date list of existing STAC catalogs. From the list, let’s click on the “Earth Search” catalog, i.e.&nbsp;the access point to search the archive of Sentinel-2 images hosted on AWS.</p>
<p>Let’s take a moment to explore the Earth Search STAC catalog, which is the catalog indexing the Sentinel-2 collection that is hosted on AWS. We can interactively browse this catalog using the STAC browser at <a href="https://radiantearth.github.io/stac-browser/#/external/earth-search.aws.element84.com/v0">this link</a> :</p>
<ol type="1">
<li>Open the link in your web browser. Which (sub-) catalogs are available?</li>
</ol>
<p>Four subcatalogs are available, including both Sentinel 2 and Landsat 8 images</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Working with Geospatial Data in Python_files/figure-html/c7f894a5-89cd-4093-96e0-053e2a366c82-1-33b0c500-b2b7-45ca-9373-6daba339e163.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">catalogs.PNG</figcaption>
</figure>
</div>
<ol start="2" type="1">
<li>Open the Sentinel-2 L2A COGs collection, and select one item from the list. Each item corresponds to a satellite “scene”, i.e.&nbsp;a portion of the footage recorded by the satellite at a given time. Have a look at the metadata fields and the list of assets. What kind of data do the assets represent?</li>
</ol>
<p><img src="Sentinel_2_L2A.png" width="1000" height="1000"></p>
<p>When you select the Sentinel-2 L2A COGs collection, and randomly choose one of the items from the list, you should find yourself on a page similar to the screenshot above. On the left side you will find a list of the available assets: overview images (thumbnail and true color images), metadata files and the “real” satellite images, one for each band captured by the Multispectral Instrument on board Sentinel-2.</p>
<p>When opening a catalog with the STAC browser, you can access the API URL by clicking on the “Source” button on the top right of the page. By using this URL, we have access to the catalog content and, if supported by the catalog, to the functionality of searching its items. For the Earth Search STAC catalog the API URL is:</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>api_url <span class="op">=</span> <span class="st">"https://earth-search.aws.element84.com/v0"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can query a STAC API endpoint from Python using the <a href="https://pystac-client.readthedocs.io/en/stable/">pystac_client</a> library:</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pystac_client <span class="im">import</span> Client</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> Client.<span class="bu">open</span>(api_url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the following, we ask for scenes belonging to the sentinel-s2-l2a-cogs collection. This dataset includes Sentinel-2 data products pre-processed at level 2A (bottom-of-atmosphere reflectance) and saved in Cloud Optimized GeoTIFF (COG) format:</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sentinel-2, Level 2A, COGs</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>collection <span class="op">=</span> <span class="st">"sentinel-s2-l2a-cogs"</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>https://earth-search.aws.element84.com/v0/collections/sentinel-s2-l2a-cogs</code></pre>
</section>
<section id="cloud-optimized-geotiffs" class="level3">
<h3 class="anchored" data-anchor-id="cloud-optimized-geotiffs">Cloud Optimized GeoTIFFs</h3>
<p>Cloud Optimized GeoTIFFs (COGs) are regular GeoTIFF files with some additional features that make them ideal to be employed in the context of cloud computing and other web-based services. This format builds on the widely-employed GeoTIFF format, introduced in section 1: Raster Data.</p>
<p>In essence, COGs are regular GeoTIFF files with a special internal structure. One of the features of COGs is that data is organized in “blocks” that can be accessed remotely via independent HTTP requests. Data users can thus access the only blocks of a GeoTIFF that are relevant for their analysis, without having to download the full file. In addition, COGs typically include multiple lower-resolution versions of the original image, called “overviews”, which can also be accessed independently. By providing this “pyramidal” structure, users that are not interested in the details provided by a high-resolution raster can directly access the lower-resolution versions of the same image, significantly saving on the downloading time. More information on the COG format can be found <a href="https://www.cogeo.org/">here</a>.</p>
<p>We also ask for scenes intersecting a geometry defined using the <a href="https://shapely.readthedocs.io/en/stable/">shapely library</a> (in this case, a point):</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># AMS coordinates</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Point</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>point <span class="op">=</span> Point(<span class="fl">4.89</span>, <span class="fl">52.37</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note: at this stage, we are only dealing with metadata, so no image is going to be downloaded yet. But even metadata can be quite bulky if a large number of scenes match our search! For this reason, we limit the search result to 10 items:</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Search for scenes which include the point(4.89, 52.37)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>search <span class="op">=</span> client.search(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    collections<span class="op">=</span>[collection],</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    intersects<span class="op">=</span>point,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    max_items<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We submit the query and find out how many scenes match our search criteria (please note that this output can be different as more data is added to the catalog):</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(search.matched())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>736</code></pre>
</div>
</div>
<p>Finally, we retrieve the metadata of the search results:</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>items <span class="op">=</span> search.get_all_items()</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(items))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>10</code></pre>
</div>
</div>
<p>This is consistent with the maximum number of items that we set in the search criteria. We can iterate over the returned items and print these to show their IDs:</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate over our 10 items to show unique IDs</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> item <span class="kw">in</span> items:</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(item)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;Item id=S2B_31UFU_20221211_0_L2A&gt;
&lt;Item id=S2B_31UFU_20221208_0_L2A&gt;
&lt;Item id=S2A_31UFU_20221206_0_L2A&gt;
&lt;Item id=S2A_31UFU_20221203_0_L2A&gt;
&lt;Item id=S2B_31UFU_20221201_0_L2A&gt;
&lt;Item id=S2B_31UFU_20221128_0_L2A&gt;
&lt;Item id=S2A_31UFU_20221126_0_L2A&gt;
&lt;Item id=S2A_31UFU_20221123_0_L2A&gt;
&lt;Item id=S2B_31UFU_20221121_0_L2A&gt;
&lt;Item id=S2B_31UFU_20221118_0_L2A&gt;</code></pre>
</div>
</div>
<p>Each of the items contains information about the scene geometry, its acquisition time, and other metadata that can be accessed as a dictionary from the properties attribute. Let’s inspect the metadata associated with the first item of the search results:</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extract some metadata from our first search item</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>item <span class="op">=</span> items[<span class="dv">0</span>]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(item.datetime)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(item.geometry)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(item.properties)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2022-12-11 10:56:20+00:00
{'type': 'Polygon', 'coordinates': [[[6.071664488869862, 52.22257539160586], [4.464995307918359, 52.25346561204129], [4.498475093400055, 53.24019917467795], [6.1417542968794585, 53.20819279121764], [6.071664488869862, 52.22257539160586]]]}
{'datetime': '2022-12-11T10:56:20Z', 'platform': 'sentinel-2b', 'constellation': 'sentinel-2', 'instruments': ['msi'], 'gsd': 10, 'view:off_nadir': 0, 'proj:epsg': 32631, 'sentinel:utm_zone': 31, 'sentinel:latitude_band': 'U', 'sentinel:grid_square': 'FU', 'sentinel:sequence': '0', 'sentinel:product_id': 'S2B_MSIL2A_20221211T105339_N0509_R051_T31UFU_20221211T122517', 'sentinel:data_coverage': 100, 'eo:cloud_cover': 53.32, 'sentinel:valid_cloud_cover': True, 'sentinel:processing_baseline': '05.09', 'sentinel:boa_offset_applied': True, 'created': '2022-12-11T19:02:22.484Z', 'updated': '2022-12-11T19:02:22.484Z'}</code></pre>
</div>
</div>
<p>The above metadata e.g.&nbsp;<strong>datetime</strong>, <strong>eo:cloud_cover</strong> are the arguments which can be fed into our search to acess specific information.</p>
<p>Let’s try another scene search from the <strong>sentinel-s2-l2a-cogs</strong> collection using different criteria:</p>
<pre><code>-intersect a provided bounding box (use ±0.01 deg in lat/lon from the previously defined point);
-have been recorded between 20 March 2020 and 30 March 2020;
-have a cloud coverage smaller than 10% (hint: use the query input argument of client.search).</code></pre>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>bound_box <span class="op">=</span> point.<span class="bu">buffer</span>(<span class="fl">0.01</span>).bounds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Search for scenes which intersect bounding box +- 0.01 deg in lat/lon from (4.89, 52.37) as prev defined</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># between 20/3/20 and 30/3/20 where cloud cover &lt; 10%</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>search <span class="op">=</span> client.search(</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    collections<span class="op">=</span>[collection],</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    bbox<span class="op">=</span>bound_box,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    datetime<span class="op">=</span><span class="st">"2020-03-20/2020-03-30"</span>,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    query<span class="op">=</span>[<span class="st">"eo:cloud_cover&lt;10"</span>]</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(search.matched())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>4</code></pre>
</div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Grab search items and save as a JSON file</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>items <span class="op">=</span> search.get_all_items()</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>items.save_object(<span class="st">"search.json"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>An extract of the JSON file is included below. As we can see the file contains a lot of information for each of our 4 search items, which are indexed 0 to 3, such as <strong>properties</strong>, <strong>geometry</strong>, <strong>links</strong> etc:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Working with Geospatial Data in Python_files/figure-html/14b52ed8-c41e-4048-b7cd-ef9c2b508530-1-6e7c63c3-bea9-4965-b411-97dbf51c644f.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">json.PNG</figcaption>
</figure>
</div>
</section>
<section id="access-the-imagesassets" class="level3">
<h3 class="anchored" data-anchor-id="access-the-imagesassets">Access the images(assets)</h3>
<p>So far we have only discussed metadata - but how can one get to the actual images of a satellite scene (the “assets” in the STAC nomenclature)? These can be reached via links that are made available through the item’s attribute <strong>assets</strong>. The JSON file extract is included below, followed by how to access this info using Python.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Working with Geospatial Data in Python_files/figure-html/b901ebe2-bf05-4e78-831a-6cc63ee7cb04-1-3d3cbabb-5ade-4cf6-9b2b-8b6b6a4a76d9.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">json_image_thumbnail.PNG</figcaption>
</figure>
</div>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first item's asset dictionary</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>assets <span class="op">=</span> items[<span class="dv">0</span>].assets  </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(assets.keys())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>dict_keys(['thumbnail', 'overview', 'info', 'metadata', 'visual', 'B01', 'B02', 'B03', 'B04', 'B05', 'B06', 'B07', 'B08', 'B8A', 'B09', 'B11', 'B12', 'AOT', 'WVP', 'SCL'])</code></pre>
</div>
</div>
<p>As we can see these dictionary keys match the headings included in the JSON image above.</p>
<p>We can print a minimal description of the available assets:</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key, asset <span class="kw">in</span> assets.items():</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>asset<span class="sc">.</span>title<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>thumbnail: Thumbnail
overview: True color image
info: Original JSON metadata
metadata: Original XML metadata
visual: True color image
B01: Band 1 (coastal)
B02: Band 2 (blue)
B03: Band 3 (green)
B04: Band 4 (red)
B05: Band 5
B06: Band 6
B07: Band 7
B08: Band 8 (nir)
B8A: Band 8A
B09: Band 9
B11: Band 11 (swir16)
B12: Band 12 (swir22)
AOT: Aerosol Optical Thickness (AOT)
WVP: Water Vapour (WVP)
SCL: Scene Classification Map (SCL)</code></pre>
</div>
</div>
<p>Among the others, assets include multiple <strong>raster data</strong> files <strong>B01 through B12</strong> (one per optical band, as acquired by the multi-spectral instrument), a thumbnail, a true-color image (“visual”), instrument metadata and scene-classification information (“SCL”).</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let’s get the URL links to the actual image:</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(assets[<span class="st">"thumbnail"</span>].href)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>https://roda.sentinel-hub.com/sentinel-s2-l1c/tiles/31/U/FU/2020/3/28/0/preview.jpg</code></pre>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Working with Geospatial Data in Python_files/figure-html/34a1b2a0-96e1-4218-a192-0106f74f4361-1-3c04d3d2-4eb3-4cf3-91af-be32f6e52138.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">sentinel_image_download.jpg</figcaption>
</figure>
</div>
<p>Remote raster data can be directly opened via the <a href="https://pypi.org/project/rioxarray/">rioxarray library</a>. We will learn more about this library in the next sections.</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Open raster B01 Band 1 (coastal)</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rioxarray</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>b01_href <span class="op">=</span> assets[<span class="st">"B01"</span>].href</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>b01 <span class="op">=</span> rioxarray.open_rasterio(b01_href)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(b01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;xarray.DataArray (band: 1, y: 1830, x: 1830)&gt;
[3348900 values with dtype=uint16]
Coordinates:
  * band         (band) int64 1
  * x            (x) float64 6e+05 6.001e+05 6.002e+05 ... 7.097e+05 7.098e+05
  * y            (y) float64 5.9e+06 5.9e+06 5.9e+06 ... 5.79e+06 5.79e+06
    spatial_ref  int64 0
Attributes:
    AREA_OR_POINT:       Area
    OVR_RESAMPLING_ALG:  AVERAGE
    _FillValue:          0
    scale_factor:        1.0
    add_offset:          0.0</code></pre>
</div>
</div>
<p>We can then save the data to disk:</p>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save image to disk</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>b01.rio.to_raster(<span class="st">"B01.tif"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="search-for-satellite-imagery---landsat-8" class="level3">
<h3 class="anchored" data-anchor-id="search-for-satellite-imagery---landsat-8">Search for satellite imagery - Landsat 8</h3>
<p>Let’s now put into practice all the skills we have learned in this section to retrieve images from a different mission: Landsat 8. In particular, we browse images from the Harmonized Landsat Sentinel-2 (HLS) project, which provides images from NASA’s Landsat 8 and ESA’s Sentinel-2 that have been made consistent with each other. The HLS catalog is indexed in the NASA Common Metadata Repository (CMR) and it can be accessed from the STAC API endpoint at the following URL: https://cmr.earthdata.nasa.gov/stac/LPCLOUD.</p>
<ul>
<li>using pystac_client, search for all assets of the Landsat 8 collection (HLSL30.v2.0) from February to March 2021</li>
<li>intersecting the point with longitude/latitute coordinates (-73.97, 40.78) deg.</li>
<li>sort by cloud cover</li>
</ul>
<p>Visualize an item’s thumbnail (asset key “browse”).</p>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect to the STAC endpoint</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>api_url <span class="op">=</span> <span class="st">"https://cmr.earthdata.nasa.gov/stac/LPCLOUD"</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> Client.<span class="bu">open</span>(api_url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Search for scenes which include point (-73.97, 40.78) between Feb and March 2021</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Note we can enter collections and co_ors directly into search argument</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>search <span class="op">=</span> client.search(</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    collections<span class="op">=</span>[<span class="st">"HLSL30.v2.0"</span>],</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    intersects<span class="op">=</span>Point(<span class="op">-</span><span class="fl">73.97</span>, <span class="fl">40.78</span>),  </span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    datetime<span class="op">=</span><span class="st">"2021-02-01/2021-03-31"</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co"># retrieve search results</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>items <span class="op">=</span> search.get_all_items()</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co"># save as JSON file</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>items.save_object(<span class="st">"landsat.search.json"</span>)</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(items))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>5</code></pre>
</div>
</div>
<div class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sort by cloud cover and select first item</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>items_sorted <span class="op">=</span> <span class="bu">sorted</span>(items, key<span class="op">=</span><span class="kw">lambda</span> x: x.properties[<span class="st">"eo:cloud_cover"</span>]) </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>item <span class="op">=</span> items_sorted[<span class="dv">0</span>]</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(item)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;Item id=HLS.L30.T18TWL.2021039T153324.v2.0&gt;</code></pre>
</div>
</div>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let’s get the URL links to the actual image:</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(item.assets[<span class="st">"browse"</span>].href)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>https://data.lpdaac.earthdatacloud.nasa.gov/lp-prod-public/HLSL30.020/HLS.L30.T18TWL.2021039T153324.v2.0/HLS.L30.T18TWL.2021039T153324.v2.0.jpg</code></pre>
</div>
</div>
<p><img src="Landsat_download.jpg" width="400" height="400"></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Public catalogs, protected data
</div>
</div>
<div class="callout-body-container callout-body">
<p>Publicly accessible catalogs and STAC endpoints do not necessarily imply publicly accessible data. Data providers, in fact, may limit data access to specific infrastructures and/or require authentication. For instance, the NASA CMR STAC endpoint considered in the last exercise offers publicly accessible metadata for the HLS collection, but most of the linked assets are available only for registered users (the thumbnail is publicly accessible).</p>
<p>The authentication procedure for dataset with restricted access might differ depending on the data provider. For the NASA CMR, follow these steps in order to access data using Python:</p>
<ul>
<li>create a NASA Earthdata login account <a href="https://urs.earthdata.nasa.gov/">here</a>;</li>
<li>set up a netrc file with your credentials, e.g.&nbsp;by using <a href="https://git.earthdata.nasa.gov/projects/LPDUR/repos/daac_data_download_python/browse/EarthdataLoginSetup.py">this script</a>;</li>
<li>define the following environment variables:</li>
</ul>
</div>
</div>
<pre><code>import os
os.environ["GDAL_HTTP_COOKIEFILE"] = "./cookies.txt"
os.environ["GDAL_HTTP_COOKIEJAR"] = "./cookies.txt"</code></pre>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Key Points
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>accessing satellite images via the providers’ API enables a more reliable and scalable data retrieval</p></li>
<li><p>STAC catalogs can be browsed and searched using the same tools and scripts</p></li>
<li><p>rioxarray allows you to open and download remote raster files</p></li>
</ul>
</div>
</div>
</section>
</section>
<section id="read-and-visualize-raster-data" class="level2">
<h2 class="anchored" data-anchor-id="read-and-visualize-raster-data">6. Read and visualize raster data</h2>
<p>Raster datasets were introduced in section 1. Here, we introduce the fundamental principles, packages and metadata/raster attributes for working with raster data in Python. We will also explore how Python handles missing and bad data values.</p>
<p><strong>rioxarray</strong> is the Python package we will use throughout this blog to work with raster data. It is based on the popular <strong>rasterio</strong> package for working with rasters and <strong>xarray</strong> for working with multi-dimensional arrays. rioxarray extends xarray by providing top-level functions (e.g.&nbsp;the open_rasterio function to open raster datasets) and by adding a set of methods to the main objects of the xarray package (the Dataset and the DataArray). These additional methods are made available via the rio accessor and become available from xarray objects after importing rioxarray.</p>
<p>We will also use the <strong>pystac</strong> package to load rasters from the search results we created in the previous section.</p>
<p>We’ll continue from the results of the satellite image search that we have carried out in the previous section. We will load data starting from the search.json file, using one scene from the search results as an example to demonstrate data loading and visualization. You can download the raster data using <a href="https://figshare.com/ndownloader/files/36028100">this link</a>. Save the <em>geospatial-python-raster-dataset.tar.gz</em> file in your current working directory, and extract the archive file by double-clicking on it or by running the following command in your terminal tar <em>-zxvf geospatial-python-raster-dataset.tar.gz</em>. Use the file <em>geospatial-python-raster-dataset/search.json</em> (instead of search.json) to get started with this lesson.</p>
<section id="load-a-raster-and-view-attributes" class="level3">
<h3 class="anchored" data-anchor-id="load-a-raster-and-view-attributes">Load a Raster and View Attributes</h3>
<p>In the previous section, we searched for Sentinel-2 images, and then saved the search results to a file named <em>search.json</em>. This contains the information on where and how to access the target images from a remote repository. We can use the function pystac.ItemCollection.from_file() to load the search results as an Item list.</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pystac</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>items <span class="op">=</span> pystac.ItemCollection.from_file(<span class="st">"search.json"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the search results, we have 2 Item type objects, corresponding to 4 Sentinel-2 scenes from March 26th and 28th in 2020. We will focus on the first scene <em>S2A_31UFU_20200328_0_L2A</em>, and load band B09 (central wavelength 945 nm). We can load this band using the function <strong>rioxarray.open_rasterio()</strong>, via the Hypertext Reference href (commonly referred to as a URL):</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rioxarray</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># load band B09 (central wavelength 945 nanometres(nm) - 1 nm = 10^-9m</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>raster_ams_b9 <span class="op">=</span> rioxarray.open_rasterio(items[<span class="dv">0</span>].assets[<span class="st">"B09"</span>].href)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Call the variable name to get a quick look at the shape and attributes</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>raster_ams_b9</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">

<div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewbox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewbox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class="xr-text-repr-fallback">&lt;xarray.DataArray (band: 1, y: 1830, x: 1830)&gt;
[3348900 values with dtype=uint16]
Coordinates:
  * band         (band) int64 1
  * x            (x) float64 6e+05 6.001e+05 6.002e+05 ... 7.097e+05 7.098e+05
  * y            (y) float64 5.9e+06 5.9e+06 5.9e+06 ... 5.79e+06 5.79e+06
    spatial_ref  int64 0
Attributes:
    AREA_OR_POINT:       Area
    OVR_RESAMPLING_ALG:  AVERAGE
    _FillValue:          0
    scale_factor:        1.0
    add_offset:          0.0</pre><div class="xr-wrap" style="display:none"><div class="xr-header"><div class="xr-obj-type">xarray.DataArray</div><div class="xr-array-name"></div><ul class="xr-dim-list"><li><span class="xr-has-index">band</span>: 1</li><li><span class="xr-has-index">y</span>: 1830</li><li><span class="xr-has-index">x</span>: 1830</li></ul></div><ul class="xr-sections"><li class="xr-section-item"><div class="xr-array-wrap"><input id="section-1d013ea5-0286-47d4-ad28-d07a5eedb29a" class="xr-array-in" type="checkbox" checked=""><label for="section-1d013ea5-0286-47d4-ad28-d07a5eedb29a" title="Show/hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-array-preview xr-preview"><span>...</span></div><div class="xr-array-data"><pre>[3348900 values with dtype=uint16]</pre></div></div></li><li class="xr-section-item"><input id="section-ac11e08d-7191-4045-8ed9-ae82c844da69" class="xr-section-summary-in" type="checkbox" checked=""><label for="section-ac11e08d-7191-4045-8ed9-ae82c844da69" class="xr-section-summary">Coordinates: <span>(4)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><ul class="xr-var-list"><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">band</span></div><div class="xr-var-dims">(band)</div><div class="xr-var-dtype">int64</div><div class="xr-var-preview xr-preview">1</div><input id="attrs-329f25ed-d56c-4278-b60a-95ddbbfd93b5" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-329f25ed-d56c-4278-b60a-95ddbbfd93b5" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-37fdff23-e472-455d-950f-e83a422eca5f" class="xr-var-data-in" type="checkbox"><label for="data-37fdff23-e472-455d-950f-e83a422eca5f" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([1])</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">x</span></div><div class="xr-var-dims">(x)</div><div class="xr-var-dtype">float64</div><div class="xr-var-preview xr-preview">6e+05 6.001e+05 ... 7.098e+05</div><input id="attrs-be594007-4431-4092-93c2-a080f927adf5" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-be594007-4431-4092-93c2-a080f927adf5" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-d8494e49-79dc-4778-89fc-fa80839433e2" class="xr-var-data-in" type="checkbox"><label for="data-d8494e49-79dc-4778-89fc-fa80839433e2" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([600030., 600090., 600150., ..., 709650., 709710., 709770.])</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">y</span></div><div class="xr-var-dims">(y)</div><div class="xr-var-dtype">float64</div><div class="xr-var-preview xr-preview">5.9e+06 5.9e+06 ... 5.79e+06</div><input id="attrs-f8c24ee3-9217-447e-8b5a-4472d6b6782d" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-f8c24ee3-9217-447e-8b5a-4472d6b6782d" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-0b47824a-2d1c-4439-9e3b-eb37b03e5889" class="xr-var-data-in" type="checkbox"><label for="data-0b47824a-2d1c-4439-9e3b-eb37b03e5889" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([5900010., 5899950., 5899890., ..., 5790390., 5790330., 5790270.])</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span>spatial_ref</span></div><div class="xr-var-dims">()</div><div class="xr-var-dtype">int64</div><div class="xr-var-preview xr-preview">0</div><input id="attrs-006826fa-80a1-4e52-8cc7-23c69a70b38f" class="xr-var-attrs-in" type="checkbox"><label for="attrs-006826fa-80a1-4e52-8cc7-23c69a70b38f" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-fc641906-bf83-4ccb-9c63-17bf63e5c7b7" class="xr-var-data-in" type="checkbox"><label for="data-fc641906-bf83-4ccb-9c63-17bf63e5c7b7" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"><dt><span>crs_wkt :</span></dt><dd>PROJCS["WGS 84 / UTM zone 31N",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",3],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","32631"]]</dd><dt><span>semi_major_axis :</span></dt><dd>6378137.0</dd><dt><span>semi_minor_axis :</span></dt><dd>6356752.314245179</dd><dt><span>inverse_flattening :</span></dt><dd>298.257223563</dd><dt><span>reference_ellipsoid_name :</span></dt><dd>WGS 84</dd><dt><span>longitude_of_prime_meridian :</span></dt><dd>0.0</dd><dt><span>prime_meridian_name :</span></dt><dd>Greenwich</dd><dt><span>geographic_crs_name :</span></dt><dd>WGS 84</dd><dt><span>horizontal_datum_name :</span></dt><dd>World Geodetic System 1984</dd><dt><span>projected_crs_name :</span></dt><dd>WGS 84 / UTM zone 31N</dd><dt><span>grid_mapping_name :</span></dt><dd>transverse_mercator</dd><dt><span>latitude_of_projection_origin :</span></dt><dd>0.0</dd><dt><span>longitude_of_central_meridian :</span></dt><dd>3.0</dd><dt><span>false_easting :</span></dt><dd>500000.0</dd><dt><span>false_northing :</span></dt><dd>0.0</dd><dt><span>scale_factor_at_central_meridian :</span></dt><dd>0.9996</dd><dt><span>spatial_ref :</span></dt><dd>PROJCS["WGS 84 / UTM zone 31N",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",3],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","32631"]]</dd><dt><span>GeoTransform :</span></dt><dd>600000.0 60.0 0.0 5900040.0 0.0 -60.0</dd></dl></div><div class="xr-var-data"><pre>array(0)</pre></div></li></ul></div></li><li class="xr-section-item"><input id="section-77bf8034-2748-427d-97fc-3b0f74fbba4f" class="xr-section-summary-in" type="checkbox"><label for="section-77bf8034-2748-427d-97fc-3b0f74fbba4f" class="xr-section-summary">Indexes: <span>(3)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><ul class="xr-var-list"><li class="xr-var-item"><div class="xr-index-name"><div>band</div></div><div class="xr-index-preview">PandasIndex</div><div></div><input id="index-fabaad48-74e8-44c4-a760-4611968747d4" class="xr-index-data-in" type="checkbox"><label for="index-fabaad48-74e8-44c4-a760-4611968747d4" title="Show/Hide index repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-index-data"><pre>PandasIndex(Int64Index([1], dtype='int64', name='band'))</pre></div></li><li class="xr-var-item"><div class="xr-index-name"><div>x</div></div><div class="xr-index-preview">PandasIndex</div><div></div><input id="index-021b2fea-5e46-442f-a04e-3b1275d9942a" class="xr-index-data-in" type="checkbox"><label for="index-021b2fea-5e46-442f-a04e-3b1275d9942a" title="Show/Hide index repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-index-data"><pre>PandasIndex(Float64Index([600030.0, 600090.0, 600150.0, 600210.0, 600270.0, 600330.0,
              600390.0, 600450.0, 600510.0, 600570.0,
              ...
              709230.0, 709290.0, 709350.0, 709410.0, 709470.0, 709530.0,
              709590.0, 709650.0, 709710.0, 709770.0],
             dtype='float64', name='x', length=1830))</pre></div></li><li class="xr-var-item"><div class="xr-index-name"><div>y</div></div><div class="xr-index-preview">PandasIndex</div><div></div><input id="index-4ee943ec-6ee1-4c77-9438-9d0481296d50" class="xr-index-data-in" type="checkbox"><label for="index-4ee943ec-6ee1-4c77-9438-9d0481296d50" title="Show/Hide index repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-index-data"><pre>PandasIndex(Float64Index([5900010.0, 5899950.0, 5899890.0, 5899830.0, 5899770.0, 5899710.0,
              5899650.0, 5899590.0, 5899530.0, 5899470.0,
              ...
              5790810.0, 5790750.0, 5790690.0, 5790630.0, 5790570.0, 5790510.0,
              5790450.0, 5790390.0, 5790330.0, 5790270.0],
             dtype='float64', name='y', length=1830))</pre></div></li></ul></div></li><li class="xr-section-item"><input id="section-618cecc6-5c43-4faf-b205-4e0ff4054987" class="xr-section-summary-in" type="checkbox" checked=""><label for="section-618cecc6-5c43-4faf-b205-4e0ff4054987" class="xr-section-summary">Attributes: <span>(5)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><dl class="xr-attrs"><dt><span>AREA_OR_POINT :</span></dt><dd>Area</dd><dt><span>OVR_RESAMPLING_ALG :</span></dt><dd>AVERAGE</dd><dt><span>_FillValue :</span></dt><dd>0</dd><dt><span>scale_factor :</span></dt><dd>1.0</dd><dt><span>add_offset :</span></dt><dd>0.0</dd></dl></div></li></ul></div></div>
</div>
</div>
<p>The first call to rioxarray.open_rasterio() opens the file from remote or local storage, and then returns a <strong>xarray.DataArray</strong> object. The object is stored in a variable, i.e.&nbsp;<em>raster_ams_b9</em>. Reading in the data with xarray instead of rioxarray also returns a xarray.DataArray, but the output will not contain the geospatial metadata (such as projection information). We can use numpy functions or built-in Python math operators on a xarray.DataArray just like a numpy array. Calling the variable name of the DataArray also prints out all of its metadata information.</p>
<p>The output tells us that we are looking at an xarray.DataArray, with:</p>
<ul>
<li>1 band;</li>
<li>1830 rows(y); and</li>
<li>1830 columns(x)</li>
</ul>
<p>We can also see the number of pixel values in the DataArray (1,830 x 1,830 = 3,348,900) and the type of those pixel values, which is unsigned integer (or uint16). The DataArray also stores different values for the coordinates of the DataArray. When using rioxarray, the term coordinates refers to spatial coordinates like x and y but also the band coordinate. Each of these sequences of values has its own data type, like float64 for the spatial coordinates and int64 for the band coordinate.</p>
<p>This DataArray object also has a couple of attributes that are accessed like <strong>.rio.crs</strong>, <strong>.rio.nodata</strong>, and <strong>.rio.bounds()</strong>, which contain the metadata for the file we opened.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that many of the metadata are accessed as <strong>attributes</strong> using <em>.attribute_name</em>, but <em>bounds()</em> is a <strong>method</strong> (i.e.&nbsp;a function in an object) and needs parentheses.</p>
</div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Co_ordinate Reference System</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raster_ams_b9.rio.crs)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Nodata value encoded as...</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raster_ams_b9.rio.nodata)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Bounding box corners</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raster_ams_b9.rio.bounds())</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Width </span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raster_ams_b9.rio.width)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Height</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raster_ams_b9.rio.height)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>EPSG:32631
0
(600000.0, 5790240.0, 709800.0, 5900040.0)
1830
1830</code></pre>
</div>
</div>
<p>The Coordinate Reference System, or <em>raster_ams_b9.rio.crs</em>, is reported as the string EPSG:32631. The nodata value is encoded as 0 and the bounding box corners of our raster are represented by the output of .bounds() as a <strong>tuple</strong> (like a list but we can’t edit it). The height and width match what we saw when we printed the DataArray, but by using .rio.width and .rio.height we can access these values if we need them in calculations.</p>
<p>We will be exploring this data throughout this section. By the end of this section we will be able to understand and explain the metadata output.</p>
</section>
<section id="visualize-a-raster" class="level3">
<h3 class="anchored" data-anchor-id="visualize-a-raster">Visualize a Raster</h3>
<p>After viewing the attributes of our raster, we can examine the raw values of the array with <strong><em>.values</em></strong>:</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>raster_ams_b9.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>array([[[    0,     0,     0, ...,  8888,  9075,  8139],
        [    0,     0,     0, ..., 10444, 10358,  8669],
        [    0,     0,     0, ..., 10346, 10659,  9168],
        ...,
        [    0,     0,     0, ...,  4295,  4289,  4320],
        [    0,     0,     0, ...,  4291,  4269,  4179],
        [    0,     0,     0, ...,  3944,  3503,  3862]]], dtype=uint16)</code></pre>
</div>
</div>
<p>This can give us a quick view of the values of our array, but only at the corners. Since our raster is loaded in python as a <strong>DataArray</strong> type, we can plot this in one line similar to a pandas DataFrame with DataArray.plot() :</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>raster_ams_b9.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>&lt;matplotlib.collections.QuadMesh at 0x7fa254cc0d30&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-27-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Nice plot! Notice that rioxarray helpfully allows us to plot this raster with spatial coordinates on the x and y axis (<strong>this is not the default in many cases with other functions or libraries</strong>).</p>
<p>This plot shows the satellite measurement of the spectral band B09 for an area that covers part of the Netherlands. According to the Sentinel-2 documentaion, this is a band with the central wavelength of 945nm, which is sensitive to water vapour. It has a spatial resolution of 60m. Note that the band=1 in the image title refers to the ordering of all the bands in the DataArray, not the Sentinel-2 band number B09 that we saw in the pystac search results.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
With a quick view of the image, we notice that half of the image is blank, no data is captured. We also see that the cloudy pixels at the top have high reflectance values, while the contrast of everything else is quite low. This is expected because this band is sensitive to the water vapour.
</div>
</div>
<div class="callout-body-container callout-body">
<p>To obtain a better colour contrast, we can add the option <strong>robust=True</strong>, which displays values between the 2nd and 98th percentile.</p>
</div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># restrict display to values within the 2nd and 98th quartile</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>raster_ams_b9.plot(robust<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>&lt;matplotlib.collections.QuadMesh at 0x7fa255063370&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-28-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Now that the colour limit is set in a way fitting most of the values in the image, we have a much better view of the ground pixels.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The option robust=True defaults to displaying values between the 2nd and 98th percentile.
</div>
</div>
<div class="callout-body-container callout-body">
<p>For a customized displaying range, you can also manually specifying the keywords vmin and vmax.</p>
</div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>raster_ams_b9.plot(vmin<span class="op">=</span><span class="dv">100</span>, vmax<span class="op">=</span><span class="dv">7000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>&lt;matplotlib.collections.QuadMesh at 0x7fa254f4e680&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-29-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="view-raster-coordinate-reference-system-crs-in-python" class="level3">
<h3 class="anchored" data-anchor-id="view-raster-coordinate-reference-system-crs-in-python">View Raster Coordinate Reference System (CRS) in Python</h3>
<p>Another feature that we’re interested in is the CRS, and it can be accessed with <strong>.rio.crs</strong>. We introduced the concept of a CRS in an earlier section. Now we will see how features of the CRS appear in our data file and what meanings they have. We can view the CRS string associated with our DataArray’s rio object using the crs attribute.</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># view the co_ordinate reference system string</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raster_ams_b9.rio.crs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>EPSG:32631</code></pre>
</div>
</div>
<p>To print the EPSG code number as an int, we use the .to_epsg() method:</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print the ESPG code as an int</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>raster_ams_b9.rio.crs.to_epsg()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>32631</code></pre>
</div>
</div>
<p>EPSG codes are great for succinctly representing a particular coordinate reference system. But what if we want to see more details about the CRS, like the units? For that, we can use <strong>pyproj</strong>, a library for representing and working with coordinate reference systems.</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyproj <span class="im">import</span> CRS</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>epsg <span class="op">=</span> raster_ams_b9.rio.crs.to_epsg()</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>crs <span class="op">=</span> CRS(epsg)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>crs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>&lt;Derived Projected CRS: EPSG:32631&gt;
Name: WGS 84 / UTM zone 31N
Axis Info [cartesian]:
- E[east]: Easting (metre)
- N[north]: Northing (metre)
Area of Use:
- name: Between 0°E and 6°E, northern hemisphere between equator and 84°N, onshore and offshore. Algeria. Andorra. Belgium. Benin. Burkina Faso. Denmark - North Sea. France. Germany - North Sea. Ghana. Luxembourg. Mali. Netherlands. Niger. Nigeria. Norway. Spain. Togo. United Kingdom (UK) - North Sea.
- bounds: (0.0, 0.0, 6.0, 84.0)
Coordinate Operation:
- name: UTM zone 31N
- method: Transverse Mercator
Datum: World Geodetic System 1984 ensemble
- Ellipsoid: WGS 84
- Prime Meridian: Greenwich</code></pre>
</div>
</div>
</section>
<section id="understanding-pyproj-crs-summary" class="level3">
<h3 class="anchored" data-anchor-id="understanding-pyproj-crs-summary">Understanding pyproj CRS Summary</h3>
<p>Let’s break down the pieces of the pyproj CRS summary. The string contains all of the individual CRS elements that Python or another GIS might need, separated into distinct sections, and datum.</p>
<ul>
<li><strong>Name</strong>: of the projection is UTM zone 31N (UTM has 60 zones, each 6-degrees of longitude in width). The underlying datum is WGS84.</li>
<li><strong>Axis Info</strong>: the CRS shows a Cartesian system with two axes, easting and northing, in meter units.</li>
<li><strong>Area of Use</strong>: the projection is used for a particular range of longitudes 0°E to 6°E in the northern hemisphere (0.0°N to 84.0°N)</li>
<li><strong>Coordinate Operation</strong>: the operation to project the coordinates (if it is projected) onto a cartesian (x, y) plane. Transverse Mercator is accurate for areas with longitudinal widths of a few degrees, hence the distinct UTM zones.</li>
<li><strong>Datum</strong>: Details about the datum, or the reference point for coordinates. WGS 84 and NAD 1983 are common datums. NAD 1983 is set to be replaced in 2022.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that the zone is unique to the UTM projection. Not all CRSs will have a zone.</p>
</div>
</div>
<p>The CRS <strong>class</strong> from the pyproj library allows us to create a CRS object with <strong>methods</strong> and <strong>attributes</strong> for accessing specific information about a CRS, or the detailed summary shown above. A particularly useful attribute is <strong>area_of_use</strong>, which shows the geographic bounds that the CRS is intended to be used.</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>crs.area_of_use</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>AreaOfUse(west=0.0, south=0.0, east=6.0, north=84.0, name='Between 0°E and 6°E, northern hemisphere between equator and 84°N, onshore and offshore. Algeria. Andorra. Belgium. Benin. Burkina Faso. Denmark - North Sea. France. Germany - North Sea. Ghana. Luxembourg. Mali. Netherlands. Niger. Nigeria. Norway. Spain. Togo. United Kingdom (UK) - North Sea.')</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-23-contents" aria-controls="callout-23" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What units are our data in? See if you can find a method to examine this information using help(crs) or dir(crs)
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-23" class="callout-23-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><em>crs.axis_info</em> tells us that the CRS for our raster has two axis and both are in meters. We could also get this information from the <strong>attribute</strong> raster_ams_b9.rio.crs.linear_units.</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>crs.axis_info</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>[Axis(name=Easting, abbrev=E, direction=east, unit_auth_code=EPSG, unit_code=9001, unit_name=metre),
 Axis(name=Northing, abbrev=N, direction=north, unit_auth_code=EPSG, unit_code=9001, unit_name=metre)]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>raster_ams_b9.rio.crs.linear_units</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>'metre'</code></pre>
</div>
</div>
</section>
<section id="calculate-raster-statistics" class="level3">
<h3 class="anchored" data-anchor-id="calculate-raster-statistics">Calculate Raster Statistics</h3>
<p>It is useful to know the minimum or maximum values of a raster dataset. We can compute these and other descriptive statistics with <strong>min</strong>, <strong>max</strong>, <strong>mean</strong>, and <strong>std</strong>.</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raster_ams_b9.<span class="bu">min</span>())</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raster_ams_b9.<span class="bu">max</span>())</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raster_ams_b9.mean())</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raster_ams_b9.std())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;xarray.DataArray ()&gt;
array(0, dtype=uint16)
Coordinates:
    spatial_ref  int64 0
&lt;xarray.DataArray ()&gt;
array(15497, dtype=uint16)
Coordinates:
    spatial_ref  int64 0
&lt;xarray.DataArray ()&gt;
array(1652.44009944)
Coordinates:
    spatial_ref  int64 0
&lt;xarray.DataArray ()&gt;
array(2049.16447495)
Coordinates:
    spatial_ref  int64 0</code></pre>
</div>
</div>
<p>The information above includes a report of the min, max, mean, and standard deviation values, along with the data type. If we want to see specific quantiles, we can use xarray’s .quantile() method. For example for the 25% and 75% quantiles:</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raster_ams_b9.quantile([<span class="fl">0.25</span>, <span class="fl">0.75</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;xarray.DataArray (quantile: 2)&gt;
array([   0., 2911.])
Coordinates:
  * quantile  (quantile) float64 0.25 0.75</code></pre>
</div>
</div>
<p>We could also get each of these values one by one using NumPy:</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(numpy.percentile(raster_ams_b9, <span class="dv">25</span>))</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(numpy.percentile(raster_ams_b9, <span class="dv">75</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.0
2911.0</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
You may notice that <strong><em>raster_ams_b9.quantile</em></strong> and <strong><em>numpy.percentile</em></strong> didn’t require an argument specifying the axis or dimension along which to compute the quantile. This is because axis=None is the default for most numpy functions, and therefore dim=None is the default for most xarray methods.
</div>
</div>
<div class="callout-body-container callout-body">
<p>it’s always good to check out the docs on a function to see what the default arguments are, particularly when working with multi-dimensional image data. To do so, we can use <strong><em>help(raster_ams_b9.quantile)</em></strong> or <strong><em>?raster_ams_b9.quantile</em></strong> if you are using jupyter notebook or jupyter lab.</p>
</div>
</div>
</section>
<section id="dealing-with-missing-data" class="level3">
<h3 class="anchored" data-anchor-id="dealing-with-missing-data">Dealing with Missing Data</h3>
<p>So far, we have visualized a band of a Sentinel-2 scene and calculated its statistics. However, we need to take missing data into account. Raster data often has a “no data value” associated with it and for raster datasets read in by rioxarray. This value is referred to as nodata. This is a value assigned to pixels where data is missing or no data were collected. There can be different cases that cause missing data, and it’s common for other values in a raster to represent different cases. The most common example is missing data at the edges of rasters.</p>
<p>By default the shape of a raster is always rectangular. So if we have a dataset that has a shape that isn’t rectangular, some pixels at the edge of the raster will have no data values. This often happens when the data were collected by a sensor which only flew over some part of a defined region. As we have seen above, the nodata value of this dataset (raster_ams_b9.rio.nodata) is 0. When we have plotted the band data, or calculated statistics, the missing value was not distinguished from other values.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Missing data may cause some unexpected results. For example, the 25th percentile we just calculated was 0, probably reflecting the presence of a lot of missing data in the raster.
</div>
</div>
<div class="callout-body-container callout-body">
<p>To distinguish missing data from real data, one possible way is to use NaN to represent them. This can be done by specifying masked=True when loading the raster.</p>
</div>
</div>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># use NaN to represent missing data</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>raster_ams_b9 <span class="op">=</span> rioxarray.open_rasterio(items[<span class="dv">0</span>].assets[<span class="st">"B09"</span>].href, masked<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Or, we can also use the where function to select all the pixels which are different from the nodata value of the raster:</p>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>raster_ams_b9.where(raster_ams_b9<span class="op">!=</span>raster_ams_b9.rio.nodata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">

<div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewbox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewbox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class="xr-text-repr-fallback">&lt;xarray.DataArray (band: 1, y: 1830, x: 1830)&gt;
array([[[   nan,    nan,    nan, ...,  8888.,  9075.,  8139.],
        [   nan,    nan,    nan, ..., 10444., 10358.,  8669.],
        [   nan,    nan,    nan, ..., 10346., 10659.,  9168.],
        ...,
        [   nan,    nan,    nan, ...,  4295.,  4289.,  4320.],
        [   nan,    nan,    nan, ...,  4291.,  4269.,  4179.],
        [   nan,    nan,    nan, ...,  3944.,  3503.,  3862.]]],
      dtype=float32)
Coordinates:
  * band         (band) int64 1
  * x            (x) float64 6e+05 6.001e+05 6.002e+05 ... 7.097e+05 7.098e+05
  * y            (y) float64 5.9e+06 5.9e+06 5.9e+06 ... 5.79e+06 5.79e+06
    spatial_ref  int64 0
Attributes:
    AREA_OR_POINT:       Area
    OVR_RESAMPLING_ALG:  AVERAGE
    scale_factor:        1.0
    add_offset:          0.0</pre><div class="xr-wrap" style="display:none"><div class="xr-header"><div class="xr-obj-type">xarray.DataArray</div><div class="xr-array-name"></div><ul class="xr-dim-list"><li><span class="xr-has-index">band</span>: 1</li><li><span class="xr-has-index">y</span>: 1830</li><li><span class="xr-has-index">x</span>: 1830</li></ul></div><ul class="xr-sections"><li class="xr-section-item"><div class="xr-array-wrap"><input id="section-9f282a7a-11f8-462d-ab3b-8d82df229505" class="xr-array-in" type="checkbox" checked=""><label for="section-9f282a7a-11f8-462d-ab3b-8d82df229505" title="Show/hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-array-preview xr-preview"><span>nan nan nan nan nan ... 3.996e+03 3.944e+03 3.503e+03 3.862e+03</span></div><div class="xr-array-data"><pre>array([[[   nan,    nan,    nan, ...,  8888.,  9075.,  8139.],
        [   nan,    nan,    nan, ..., 10444., 10358.,  8669.],
        [   nan,    nan,    nan, ..., 10346., 10659.,  9168.],
        ...,
        [   nan,    nan,    nan, ...,  4295.,  4289.,  4320.],
        [   nan,    nan,    nan, ...,  4291.,  4269.,  4179.],
        [   nan,    nan,    nan, ...,  3944.,  3503.,  3862.]]],
      dtype=float32)</pre></div></div></li><li class="xr-section-item"><input id="section-66fd7128-34b9-41ba-a236-b2e27068a837" class="xr-section-summary-in" type="checkbox" checked=""><label for="section-66fd7128-34b9-41ba-a236-b2e27068a837" class="xr-section-summary">Coordinates: <span>(4)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><ul class="xr-var-list"><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">band</span></div><div class="xr-var-dims">(band)</div><div class="xr-var-dtype">int64</div><div class="xr-var-preview xr-preview">1</div><input id="attrs-1ea97fa0-74e5-4468-bbb1-aadc3d27b344" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-1ea97fa0-74e5-4468-bbb1-aadc3d27b344" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-568ee856-e3e8-4b7b-9959-b319bd545bbf" class="xr-var-data-in" type="checkbox"><label for="data-568ee856-e3e8-4b7b-9959-b319bd545bbf" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([1])</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">x</span></div><div class="xr-var-dims">(x)</div><div class="xr-var-dtype">float64</div><div class="xr-var-preview xr-preview">6e+05 6.001e+05 ... 7.098e+05</div><input id="attrs-c58b11c7-9a8f-4e76-94c7-58b16ac27555" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-c58b11c7-9a8f-4e76-94c7-58b16ac27555" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-7d535029-aaaa-4ae7-a0d0-52f0b2c741d1" class="xr-var-data-in" type="checkbox"><label for="data-7d535029-aaaa-4ae7-a0d0-52f0b2c741d1" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([600030., 600090., 600150., ..., 709650., 709710., 709770.])</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">y</span></div><div class="xr-var-dims">(y)</div><div class="xr-var-dtype">float64</div><div class="xr-var-preview xr-preview">5.9e+06 5.9e+06 ... 5.79e+06</div><input id="attrs-f5ab251c-86ca-4035-b029-fcc087f331f7" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-f5ab251c-86ca-4035-b029-fcc087f331f7" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-5a2b51bb-991a-472b-ac95-5de69b336d39" class="xr-var-data-in" type="checkbox"><label for="data-5a2b51bb-991a-472b-ac95-5de69b336d39" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([5900010., 5899950., 5899890., ..., 5790390., 5790330., 5790270.])</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span>spatial_ref</span></div><div class="xr-var-dims">()</div><div class="xr-var-dtype">int64</div><div class="xr-var-preview xr-preview">0</div><input id="attrs-9bd06956-d867-41d3-ab85-ed184b7a06dd" class="xr-var-attrs-in" type="checkbox"><label for="attrs-9bd06956-d867-41d3-ab85-ed184b7a06dd" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-823351dd-4414-4deb-9951-e7b9ae6cf6e0" class="xr-var-data-in" type="checkbox"><label for="data-823351dd-4414-4deb-9951-e7b9ae6cf6e0" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"><dt><span>crs_wkt :</span></dt><dd>PROJCS["WGS 84 / UTM zone 31N",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",3],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","32631"]]</dd><dt><span>semi_major_axis :</span></dt><dd>6378137.0</dd><dt><span>semi_minor_axis :</span></dt><dd>6356752.314245179</dd><dt><span>inverse_flattening :</span></dt><dd>298.257223563</dd><dt><span>reference_ellipsoid_name :</span></dt><dd>WGS 84</dd><dt><span>longitude_of_prime_meridian :</span></dt><dd>0.0</dd><dt><span>prime_meridian_name :</span></dt><dd>Greenwich</dd><dt><span>geographic_crs_name :</span></dt><dd>WGS 84</dd><dt><span>horizontal_datum_name :</span></dt><dd>World Geodetic System 1984</dd><dt><span>projected_crs_name :</span></dt><dd>WGS 84 / UTM zone 31N</dd><dt><span>grid_mapping_name :</span></dt><dd>transverse_mercator</dd><dt><span>latitude_of_projection_origin :</span></dt><dd>0.0</dd><dt><span>longitude_of_central_meridian :</span></dt><dd>3.0</dd><dt><span>false_easting :</span></dt><dd>500000.0</dd><dt><span>false_northing :</span></dt><dd>0.0</dd><dt><span>scale_factor_at_central_meridian :</span></dt><dd>0.9996</dd><dt><span>spatial_ref :</span></dt><dd>PROJCS["WGS 84 / UTM zone 31N",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",3],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","32631"]]</dd><dt><span>GeoTransform :</span></dt><dd>600000.0 60.0 0.0 5900040.0 0.0 -60.0</dd></dl></div><div class="xr-var-data"><pre>array(0)</pre></div></li></ul></div></li><li class="xr-section-item"><input id="section-6d17e2b4-995a-4e35-826e-d225ca8179c3" class="xr-section-summary-in" type="checkbox"><label for="section-6d17e2b4-995a-4e35-826e-d225ca8179c3" class="xr-section-summary">Indexes: <span>(3)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><ul class="xr-var-list"><li class="xr-var-item"><div class="xr-index-name"><div>band</div></div><div class="xr-index-preview">PandasIndex</div><div></div><input id="index-205c2927-c1ba-4d4b-b2a7-6173e874b341" class="xr-index-data-in" type="checkbox"><label for="index-205c2927-c1ba-4d4b-b2a7-6173e874b341" title="Show/Hide index repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-index-data"><pre>PandasIndex(Int64Index([1], dtype='int64', name='band'))</pre></div></li><li class="xr-var-item"><div class="xr-index-name"><div>x</div></div><div class="xr-index-preview">PandasIndex</div><div></div><input id="index-b6fdd14e-e32e-4dfa-ac9b-23ce1dad9304" class="xr-index-data-in" type="checkbox"><label for="index-b6fdd14e-e32e-4dfa-ac9b-23ce1dad9304" title="Show/Hide index repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-index-data"><pre>PandasIndex(Float64Index([600030.0, 600090.0, 600150.0, 600210.0, 600270.0, 600330.0,
              600390.0, 600450.0, 600510.0, 600570.0,
              ...
              709230.0, 709290.0, 709350.0, 709410.0, 709470.0, 709530.0,
              709590.0, 709650.0, 709710.0, 709770.0],
             dtype='float64', name='x', length=1830))</pre></div></li><li class="xr-var-item"><div class="xr-index-name"><div>y</div></div><div class="xr-index-preview">PandasIndex</div><div></div><input id="index-3be9855b-ec72-406f-9409-1cba3265129a" class="xr-index-data-in" type="checkbox"><label for="index-3be9855b-ec72-406f-9409-1cba3265129a" title="Show/Hide index repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-index-data"><pre>PandasIndex(Float64Index([5900010.0, 5899950.0, 5899890.0, 5899830.0, 5899770.0, 5899710.0,
              5899650.0, 5899590.0, 5899530.0, 5899470.0,
              ...
              5790810.0, 5790750.0, 5790690.0, 5790630.0, 5790570.0, 5790510.0,
              5790450.0, 5790390.0, 5790330.0, 5790270.0],
             dtype='float64', name='y', length=1830))</pre></div></li></ul></div></li><li class="xr-section-item"><input id="section-deff43dc-55db-4f26-8902-6b36a81090f1" class="xr-section-summary-in" type="checkbox" checked=""><label for="section-deff43dc-55db-4f26-8902-6b36a81090f1" class="xr-section-summary">Attributes: <span>(4)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><dl class="xr-attrs"><dt><span>AREA_OR_POINT :</span></dt><dd>Area</dd><dt><span>OVR_RESAMPLING_ALG :</span></dt><dd>AVERAGE</dd><dt><span>scale_factor :</span></dt><dd>1.0</dd><dt><span>add_offset :</span></dt><dd>0.0</dd></dl></div></li></ul></div></div>
</div>
</div>
<p>Either way will change the nodata value from 0 to nan. Now if we compute the statistics again, the missing data will not be considered:</p>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raster_ams_b9.<span class="bu">min</span>())</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raster_ams_b9.<span class="bu">max</span>())</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raster_ams_b9.mean())</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raster_ams_b9.std())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;xarray.DataArray ()&gt;
array(8., dtype=float32)
Coordinates:
    spatial_ref  int64 0
&lt;xarray.DataArray ()&gt;
array(15497., dtype=float32)
Coordinates:
    spatial_ref  int64 0
&lt;xarray.DataArray ()&gt;
array(2477.405, dtype=float32)
Coordinates:
    spatial_ref  int64 0
&lt;xarray.DataArray ()&gt;
array(2061.9539, dtype=float32)
Coordinates:
    spatial_ref  int64 0</code></pre>
</div>
</div>
<p>And if we plot the image, the nodata pixels are not shown because they are not 0 anymore:</p>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>raster_ams_b9.plot(robust<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>&lt;matplotlib.collections.QuadMesh at 0x7fa254eac670&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-42-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notice that there is a side effect of using NaN instead of 0 to represent missing data: the data type of the DataArray was changed from integers to float
</div>
</div>
<div class="callout-body-container callout-body">
<p>This need to be taken into consideration when the data type matters in our application.</p>
</div>
</div>
</section>
<section id="raster-bands" class="level3">
<h3 class="anchored" data-anchor-id="raster-bands">Raster Bands</h3>
<p>So far we looked into a single band raster, i.e.&nbsp;the B09 band of a Sentinel-2 scene. However, to get an overview of the scene, we may also want to visualize the true-colour thumbnail of the region. This is provided as a <strong>multi-band raster</strong> – a raster dataset that contains more than one band.</p>
<p><img src="single_multi_raster.png" width="600" height="600"></p>
<p>The <strong>overview</strong> asset in the Sentinel-2 scene is a multiband asset. Similar to B09, we can load it by:</p>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>raster_ams_overview <span class="op">=</span> rioxarray.open_rasterio(items[<span class="dv">0</span>].assets[<span class="st">'overview'</span>].href)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>raster_ams_overview</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">

<div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewbox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewbox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class="xr-text-repr-fallback">&lt;xarray.DataArray (band: 3, y: 343, x: 343)&gt;
[352947 values with dtype=uint8]
Coordinates:
  * band         (band) int64 1 2 3
  * x            (x) float64 6.002e+05 6.005e+05 ... 7.093e+05 7.096e+05
  * y            (y) float64 5.9e+06 5.9e+06 5.899e+06 ... 5.791e+06 5.79e+06
    spatial_ref  int64 0
Attributes:
    AREA_OR_POINT:       Area
    OVR_RESAMPLING_ALG:  AVERAGE
    _FillValue:          0
    scale_factor:        1.0
    add_offset:          0.0</pre><div class="xr-wrap" style="display:none"><div class="xr-header"><div class="xr-obj-type">xarray.DataArray</div><div class="xr-array-name"></div><ul class="xr-dim-list"><li><span class="xr-has-index">band</span>: 3</li><li><span class="xr-has-index">y</span>: 343</li><li><span class="xr-has-index">x</span>: 343</li></ul></div><ul class="xr-sections"><li class="xr-section-item"><div class="xr-array-wrap"><input id="section-40d25eff-900e-4bb2-860d-96c42a1abaea" class="xr-array-in" type="checkbox" checked=""><label for="section-40d25eff-900e-4bb2-860d-96c42a1abaea" title="Show/hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-array-preview xr-preview"><span>...</span></div><div class="xr-array-data"><pre>[352947 values with dtype=uint8]</pre></div></div></li><li class="xr-section-item"><input id="section-97d03a47-55ad-4aa5-a295-2c426491fdad" class="xr-section-summary-in" type="checkbox" checked=""><label for="section-97d03a47-55ad-4aa5-a295-2c426491fdad" class="xr-section-summary">Coordinates: <span>(4)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><ul class="xr-var-list"><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">band</span></div><div class="xr-var-dims">(band)</div><div class="xr-var-dtype">int64</div><div class="xr-var-preview xr-preview">1 2 3</div><input id="attrs-c4d0cd45-d821-4dec-97b7-713695015426" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-c4d0cd45-d821-4dec-97b7-713695015426" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-20d7a15f-1293-4e72-a5fd-c7854abb6dec" class="xr-var-data-in" type="checkbox"><label for="data-20d7a15f-1293-4e72-a5fd-c7854abb6dec" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([1, 2, 3])</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">x</span></div><div class="xr-var-dims">(x)</div><div class="xr-var-dtype">float64</div><div class="xr-var-preview xr-preview">6.002e+05 6.005e+05 ... 7.096e+05</div><input id="attrs-cbc104aa-b7e4-47d9-b248-e5487f855f0b" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-cbc104aa-b7e4-47d9-b248-e5487f855f0b" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-a6eb806b-e091-4c17-a97a-8294292c85ab" class="xr-var-data-in" type="checkbox"><label for="data-a6eb806b-e091-4c17-a97a-8294292c85ab" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([600160., 600480., 600800., ..., 708960., 709280., 709600.])</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">y</span></div><div class="xr-var-dims">(y)</div><div class="xr-var-dtype">float64</div><div class="xr-var-preview xr-preview">5.9e+06 5.9e+06 ... 5.79e+06</div><input id="attrs-c379f95a-496e-4733-a43d-2ebb8f24ce78" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-c379f95a-496e-4733-a43d-2ebb8f24ce78" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-bead63a0-48a3-49ff-8b56-35015589c30e" class="xr-var-data-in" type="checkbox"><label for="data-bead63a0-48a3-49ff-8b56-35015589c30e" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([5899880., 5899560., 5899240., ..., 5791080., 5790760., 5790440.])</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span>spatial_ref</span></div><div class="xr-var-dims">()</div><div class="xr-var-dtype">int64</div><div class="xr-var-preview xr-preview">0</div><input id="attrs-a27b8fb2-b823-4338-83f9-d4fecc13643d" class="xr-var-attrs-in" type="checkbox"><label for="attrs-a27b8fb2-b823-4338-83f9-d4fecc13643d" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-84b2ae92-c696-4d0d-9130-de7afb497f91" class="xr-var-data-in" type="checkbox"><label for="data-84b2ae92-c696-4d0d-9130-de7afb497f91" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"><dt><span>crs_wkt :</span></dt><dd>PROJCS["WGS 84 / UTM zone 31N",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",3],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","32631"]]</dd><dt><span>semi_major_axis :</span></dt><dd>6378137.0</dd><dt><span>semi_minor_axis :</span></dt><dd>6356752.314245179</dd><dt><span>inverse_flattening :</span></dt><dd>298.257223563</dd><dt><span>reference_ellipsoid_name :</span></dt><dd>WGS 84</dd><dt><span>longitude_of_prime_meridian :</span></dt><dd>0.0</dd><dt><span>prime_meridian_name :</span></dt><dd>Greenwich</dd><dt><span>geographic_crs_name :</span></dt><dd>WGS 84</dd><dt><span>horizontal_datum_name :</span></dt><dd>World Geodetic System 1984</dd><dt><span>projected_crs_name :</span></dt><dd>WGS 84 / UTM zone 31N</dd><dt><span>grid_mapping_name :</span></dt><dd>transverse_mercator</dd><dt><span>latitude_of_projection_origin :</span></dt><dd>0.0</dd><dt><span>longitude_of_central_meridian :</span></dt><dd>3.0</dd><dt><span>false_easting :</span></dt><dd>500000.0</dd><dt><span>false_northing :</span></dt><dd>0.0</dd><dt><span>scale_factor_at_central_meridian :</span></dt><dd>0.9996</dd><dt><span>spatial_ref :</span></dt><dd>PROJCS["WGS 84 / UTM zone 31N",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",3],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","32631"]]</dd><dt><span>GeoTransform :</span></dt><dd>600000.0 320.0 0.0 5900040.0 0.0 -320.0</dd></dl></div><div class="xr-var-data"><pre>array(0)</pre></div></li></ul></div></li><li class="xr-section-item"><input id="section-8cba55b8-90a7-4b85-b09b-03847a98ac1f" class="xr-section-summary-in" type="checkbox"><label for="section-8cba55b8-90a7-4b85-b09b-03847a98ac1f" class="xr-section-summary">Indexes: <span>(3)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><ul class="xr-var-list"><li class="xr-var-item"><div class="xr-index-name"><div>band</div></div><div class="xr-index-preview">PandasIndex</div><div></div><input id="index-369bccea-81ca-40f9-9af8-2fcff67580c5" class="xr-index-data-in" type="checkbox"><label for="index-369bccea-81ca-40f9-9af8-2fcff67580c5" title="Show/Hide index repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-index-data"><pre>PandasIndex(Int64Index([1, 2, 3], dtype='int64', name='band'))</pre></div></li><li class="xr-var-item"><div class="xr-index-name"><div>x</div></div><div class="xr-index-preview">PandasIndex</div><div></div><input id="index-e9fdbbfe-63e1-4641-91f0-42659048dad6" class="xr-index-data-in" type="checkbox"><label for="index-e9fdbbfe-63e1-4641-91f0-42659048dad6" title="Show/Hide index repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-index-data"><pre>PandasIndex(Float64Index([600160.0, 600480.0, 600800.0, 601120.0, 601440.0, 601760.0,
              602080.0, 602400.0, 602720.0, 603040.0,
              ...
              706720.0, 707040.0, 707360.0, 707680.0, 708000.0, 708320.0,
              708640.0, 708960.0, 709280.0, 709600.0],
             dtype='float64', name='x', length=343))</pre></div></li><li class="xr-var-item"><div class="xr-index-name"><div>y</div></div><div class="xr-index-preview">PandasIndex</div><div></div><input id="index-6de84611-cdfe-42be-af4a-8fb44ad77197" class="xr-index-data-in" type="checkbox"><label for="index-6de84611-cdfe-42be-af4a-8fb44ad77197" title="Show/Hide index repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-index-data"><pre>PandasIndex(Float64Index([5899880.0, 5899560.0, 5899240.0, 5898920.0, 5898600.0, 5898280.0,
              5897960.0, 5897640.0, 5897320.0, 5897000.0,
              ...
              5793320.0, 5793000.0, 5792680.0, 5792360.0, 5792040.0, 5791720.0,
              5791400.0, 5791080.0, 5790760.0, 5790440.0],
             dtype='float64', name='y', length=343))</pre></div></li></ul></div></li><li class="xr-section-item"><input id="section-e0aeac81-ddca-4517-8c60-1c460bb6d8a5" class="xr-section-summary-in" type="checkbox" checked=""><label for="section-e0aeac81-ddca-4517-8c60-1c460bb6d8a5" class="xr-section-summary">Attributes: <span>(5)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><dl class="xr-attrs"><dt><span>AREA_OR_POINT :</span></dt><dd>Area</dd><dt><span>OVR_RESAMPLING_ALG :</span></dt><dd>AVERAGE</dd><dt><span>_FillValue :</span></dt><dd>0</dd><dt><span>scale_factor :</span></dt><dd>1.0</dd><dt><span>add_offset :</span></dt><dd>0.0</dd></dl></div></li></ul></div></div>
</div>
</div>
<p>The band number comes first when GeoTiffs are read with the <strong>.open_rasterio()</strong> function. As we can see in the xarray.DataArray object, the shape is now (band: 3, y: 343, x: 343), with <strong>three</strong> bands in the band dimension. It’s always a good idea to examine the shape of the raster array you are working with and make sure it’s what you expect. Many functions, especially the ones that plot images, expect a raster array to have a particular shape. We can also check the shape using the <strong>.shape</strong> attribute:</p>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>raster_ams_overview.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>(3, 343, 343)</code></pre>
</div>
</div>
<p>We can visualize the multi-band data with the DataArray.plot.imshow() function:</p>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>raster_ams_overview.plot.imshow()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7fa254c55600&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-45-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Note that the DataArray.plot.imshow() function makes assumptions about the shape of the input DataArray, that since it has three channels, the correct colormap for these channels is RGB. It does not work directly on image arrays with more than 3 channels. We can replace one of the RGB channels with another band, to make a false-colour image.</p>
<p>As seen in the figure above, the true-colour image is stretched. Let’s visualize it with the right aspect ratio. Since we know the height/width ratio is 1:1 (check the rio.height and rio.width attributes), we can set the aspect ratio to be 1. For example, we can choose the size to be 5 inches, and set aspect=1. Note that according to the <a href="https://docs.xarray.dev/en/stable/generated/xarray.DataArray.plot.imshow.html">documentation</a> of DataArray.plot.imshow(), when specifying the aspect argument, size also needs to be provided.</p>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>raster_ams_overview.plot.imshow(size<span class="op">=</span><span class="dv">5</span>, aspect<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7fa2545752a0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-46-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Key Points:<br>
- rioxarray and xarray are for working with multidimensional arrays like pandas is for working with tabular data<br>
- rioxarray stores CRS information as a CRS object that can be converted to an EPSG code or PROJ4 string<br>
- missing raster data are filled with nodata values, which should be handled with care for statistics and visualization</p>
</div>
</div>
</section>
</section>
<section id="vector-data-in-python" class="level2">
<h2 class="anchored" data-anchor-id="vector-data-in-python">7. Vector data in Python</h2>
<p>As covered in section 2, vector data represents specific features on the Earth’s surface using points, lines and polygons. These geographic elements can then have one or more attributes assigned to them, such as ‘name’ and ‘population’ for a city, or crop type for a field. Vector data can be much smaller in (file) size than raster data, while being very rich in terms of the information captured.</p>
<p>In this section, we will be moving from working with <em>raster</em> data to working with <strong><em>vector</em></strong> data. We will use Python to open and plot point, line and polygon vector data. In particular, we will make use of the <strong><a href="https://geopandas.org/en/stable/docs.html">geopandas</a></strong> package to open, manipulate and write vector datasets. geopandas extends the popular pandas library for data analysis to geospatial applications. The main pandas objects (the Series and the DataFrame) are expanded by including geometric types, represented in Python using the **<a href="https://shapely.readthedocs.io/en/stable/manual.html">shapely library</a>, and by providing dedicated methods for spatial operations (union, intersection, etc.).</p>
<section id="introducing-the-vector-data" class="level3">
<h3 class="anchored" data-anchor-id="introducing-the-vector-data">Introducing the vector data</h3>
<p>The data we will work with comes from the Dutch government’s open geodata sets, obtained from the <a href="https://www.pdok.nl/">PDOK platform</a>. It provides open data for various applications, e.g.&nbsp;real estate, infrastructure, agriculture, etc. In this episode we will use three data sets:</p>
<ul>
<li><strong><a href="https://www.pdok.nl/introductie/-/article/basisregistratie-gewaspercelen-brp-">crop fields</a></strong> (polygons)</li>
<li><strong><a href="https://www.pdok.nl/introductie/-/article/nationaal-wegen-bestand-nwb-">water ways</a></strong> (lines)</li>
<li><strong><a href="https://www.pdok.nl/downloads/-/article/basisregistratie-ondergrond-bro-">ground water monitoring wells</a></strong> (points)</li>
</ul>
<p>In later sections, we will learn how to work with raster and vector data together and combine them into a single plot.</p>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will use the geopandas module to load the crop field vector data we downloaded at: data/brpgewaspercelen_definitief_2020_small.gpkg. This file contains data for the entirety of the European portion of the Netherlands, resulting in a very large number of crop field parcels. Directly loading the whole file to memory can be slow. Let’s consider as Area of Interest (AoI) northern Amsterdam, which is a small portion of the Netherlands. We only need to load this part.</p>
<p>We define a bounding box, and will only read the data within the extent of the bounding box:</p>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define bounding box</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>xmin, xmax <span class="op">=</span> (<span class="dv">110_000</span>, <span class="dv">140_000</span>)</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>ymin, ymax <span class="op">=</span> (<span class="dv">470_000</span>, <span class="dv">510_000</span>)</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>bbox <span class="op">=</span> (xmin, ymin, xmax, ymax)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
How should I define my bounding box?
</div>
</div>
<div class="callout-body-container callout-body">
<p>For simplicity, here we assume the Coordinate Reference System (CRS) and extent of the vector file are known (for instance they are provided in the dataset documentation). Some Python tools, e.g.&nbsp;<a href="https://fiona.readthedocs.io/en/latest/">fiona</a>(which is also the backend of geopandas), provides the file inspection functionality without actually the need to read the full data set into memory. An example can be found in the <a href="https://fiona.readthedocs.io/en/latest/manual.html#format-drivers-crs-bounds-and-schema">documentation of fiona</a>.</p>
</div>
</div>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Partially load data within the bounding box</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>cropfield <span class="op">=</span> gpd.read_file(<span class="st">"Data/brpgewaspercelen_definitief_2020_small.gpkg"</span>, bbox<span class="op">=</span>bbox)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="vector-metadata-attributes" class="level3">
<h3 class="anchored" data-anchor-id="vector-metadata-attributes">Vector Metadata &amp; Attributes</h3>
<p>When we import the vector dataset to Python (as our cropfield object) it comes in as a DataFrame, specifically a GeoDataFrame. The read_file() function also automatically stores geospatial information about the data. We are particularly interested in describing the format, CRS, extent, and other components of the vector data, and the attributes which describe properties associated with each individual vector object.</p>
</section>
<section id="spatial-metadata" class="level3">
<h3 class="anchored" data-anchor-id="spatial-metadata">Spatial Metadata</h3>
<p>Key metadata includes:</p>
<ul>
<li><strong>Object Type</strong>: the class of the imported object.</li>
<li><strong>Coordinate Reference System (CRS)</strong>: the projection of the data.</li>
<li><strong>Extent</strong>: the spatial extent (i.e.&nbsp;geographic area that the data covers). Note that the spatial extent for a vector dataset represents the combined extent for all spatial objects in the dataset.</li>
</ul>
<p>Each GeoDataFrame has a “geometry” column that contains geometries. In the case of our cropfield object, this geometry is represented by a shapely.geometry.Polygon object. geopandas uses the shapely library to represent polygons, lines, and points, so the types are inherited from shapely.</p>
<p>We can view the metadata using the <strong>.crs</strong>, <strong>.bounds</strong> and <strong>.type</strong> attributes. First, let’s view the geometry type for our crop field dataset:</p>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># view the geometry type using the pandas method .type on the GeoDataFrame object, cropfield</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>cropfield.<span class="bu">type</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>0        Polygon
1        Polygon
2        Polygon
3        Polygon
4        Polygon
          ...   
22026    Polygon
22027    Polygon
22028    Polygon
22029    Polygon
22030    Polygon
Length: 22031, dtype: object</code></pre>
</div>
</div>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># view the CRS metadata</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>cropfield.crs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>&lt;Derived Projected CRS: EPSG:28992&gt;
Name: Amersfoort / RD New
Axis Info [cartesian]:
- X[east]: Easting (metre)
- Y[north]: Northing (metre)
Area of Use:
- name: Netherlands - onshore, including Waddenzee, Dutch Wadden Islands and 12-mile offshore coastal zone.
- bounds: (3.2, 50.75, 7.22, 53.7)
Coordinate Operation:
- name: RD New
- method: Oblique Stereographic
Datum: Amersfoort
- Ellipsoid: Bessel 1841
- Prime Meridian: Greenwich</code></pre>
</div>
</div>
<p>Our data is in the CRS <strong>RD New</strong>.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>The CRS is critical to interpreting the object’s extent values as it specifies units. To find the extent of our dataset in the projected coordinates, we can use the .total_bounds attribute.</p>
</div>
</div>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># find the extent of our dataset in the projected coordinates</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>cropfield.total_bounds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>array([109222.03325 , 469461.512625, 140295.122125, 510939.997875])</code></pre>
</div>
</div>
<p>This array contains, in order, the values for the overall dataset:</p>
<ul>
<li>minx, miny, maxx, maxy</li>
</ul>
<p>The spatial extent of a GeoDataFrame represents the geographic “edge” or location that is the furthest north, south, east, and west. Thus, it is represents the overall geographic coverage of the spatial object. We can convert these coordinates to a bounding box or acquire the index of the dataframe to access the geometry. Either of these polygons can be used to clip rasters (more on that later).</p>
</section>
<section id="selecting-spatial-features" class="level3">
<h3 class="anchored" data-anchor-id="selecting-spatial-features">Selecting spatial features</h3>
<p>Sometimes, the loaded data can still be too large. We can cut it is to a even smaller extent using the <strong>.cx</strong> indexer (note the use of square brackets instead of round brackets, which are used instead with functions and methods):</p>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a Boundingbox in RD</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>xmin, xmax <span class="op">=</span> (<span class="dv">120_000</span>, <span class="dv">135_000</span>)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>ymin, ymax <span class="op">=</span> (<span class="dv">485_000</span>, <span class="dv">500_000</span>)</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>cropfield_crop <span class="op">=</span> cropfield.cx[xmin:xmax, ymin:ymax]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will cut out a smaller area, defined by a box in units of the projection, discarding the rest of the data. The resultant GeoDataframe, which includes all the features intersecting the box, is found in the cropfield_crop object. Note that the edge elements are not ‘cropped’ themselves. We can check the total bounds of this new data as before:</p>
<div class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>cropfield_crop.total_bounds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>array([119594.384   , 484949.292625, 135375.77025 , 500782.531   ])</code></pre>
</div>
</div>
<p>We can then save this cropped dataset for use in future, using the <strong>to_file()</strong> method of our GeoDataFrame object:</p>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>cropfield_crop.to_file(<span class="st">'cropped_field.shp'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will write it to disk (in this case, in ‘shapefile’ format), containing only the data from our cropped area. It can be read in again at a later time using the read_file() method we have been using above. Note that this actually writes multiple files to disk (cropped_field.cpg, cropped_field.dbf, cropped_field.prj, cropped_field.shp, cropped_field.shx). All these files should ideally be present in order to re-read the dataset later, although only the .shp, .shx, and .dbf files are mandatory. See section 2 for more information.</p>
</section>
<section id="plotting-a-vector-dataset" class="level3">
<h3 class="anchored" data-anchor-id="plotting-a-vector-dataset">Plotting a vector dataset</h3>
<p>We can now plot this data. Any GeoDataFrame can be plotted in CRS units to view the shape of the object with .plot().</p>
<div class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>cropfield_crop.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>&lt;AxesSubplot: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-56-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>We can customize our boundary plot by setting the figsize, edgecolor, and color. Making some polygons transparent will come in handy when we need to add multiple spatial datasets to a single plot.</p>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>cropfield_crop.plot(figsize<span class="op">=</span>(<span class="dv">5</span>,<span class="dv">5</span>), edgecolor<span class="op">=</span><span class="st">"purple"</span>, facecolor<span class="op">=</span><span class="st">"None"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>&lt;AxesSubplot: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-57-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Under the hood, geopandas is using matplotlib to generate this plot. In the next section we will see how we can add DataArrays and other vector datasets to this plot to start building an informative map of our area of interest.</p>
</section>
<section id="spatial-data-attributes" class="level3">
<h3 class="anchored" data-anchor-id="spatial-data-attributes">Spatial Data Attributes</h3>
<p>We introduced the idea of spatial data attributes in an earlier section. Now we will explore how to use spatial data attributes stored in our data to plot different features.</p>
<section id="waterways" class="level4">
<h4 class="anchored" data-anchor-id="waterways">Waterways</h4>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load data </span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>waterways_nl <span class="op">=</span> gpd.read_file(<span class="st">"Data/status_vaarweg.zip"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Type of features</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>waterways_nl.<span class="bu">type</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>0     LineString
1     LineString
2     LineString
3     LineString
4     LineString
         ...    
86    LineString
87    LineString
88    LineString
89    LineString
90    LineString
Length: 91, dtype: object</code></pre>
</div>
</div>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Co_ord reference system</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>waterways_nl.crs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>&lt;Geographic 2D CRS: EPSG:4326&gt;
Name: WGS 84
Axis Info [ellipsoidal]:
- Lat[north]: Geodetic latitude (degree)
- Lon[east]: Geodetic longitude (degree)
Area of Use:
- name: World.
- bounds: (-180.0, -90.0, 180.0, 90.0)
Datum: World Geodetic System 1984 ensemble
- Ellipsoid: WGS 84
- Prime Meridian: Greenwich</code></pre>
</div>
</div>
<div class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bounds</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>waterways_nl.total_bounds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>array([50.7916,  3.1626, 53.6161,  7.0121])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many spatial features</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(waterways_nl))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>91</code></pre>
</div>
</div>
<p>Our waterways dataset includes 91 lines.</p>
<p>Now let’s take a deeper look at the Dutch waterway lines: waterways_nl. Let’s visualize it with the plot function:</p>
<div class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>waterways_nl.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>&lt;AxesSubplot: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-63-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Axis ordering - we can tell that the latitude and longitude of the file are flipped.
</div>
</div>
<div class="callout-body-container callout-body">
<p>According to the standards, the axis ordering for a CRS should follow the definition provided by the competent authority. For the commonly used EPSG:4326 geographic coordinate system, the EPSG defines the ordering as first latitude then longitude. However, in the GIS world, it is custom to work with coordinate tuples where the first component is aligned with the east/west direction and the second component is aligned with the north/south direction. Multiple software packages thus implement this convention also when dealing with EPSG:4326. As a result, one can encounter vector files that implement either convention - keep this in mind and always check your datasets!</p>
</div>
</div>
</section>
<section id="ground-water-monitoring-wells" class="level4">
<h4 class="anchored" data-anchor-id="ground-water-monitoring-wells">Ground water monitoring wells</h4>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load data </span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>wells_nl <span class="op">=</span> gpd.read_file(<span class="st">"Data/brogmwvolledigeset.zip"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Type of features</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>wells_nl.<span class="bu">type</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="67">
<pre><code>0        Point
1        Point
2        Point
3        Point
4        Point
         ...  
54654    Point
54655    Point
54656    Point
54657    Point
54658    Point
Length: 54659, dtype: object</code></pre>
</div>
</div>
<div class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Co_ord reference system</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>wells_nl.crs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>&lt;Geographic 2D CRS: EPSG:4258&gt;
Name: ETRS89
Axis Info [ellipsoidal]:
- Lat[north]: Geodetic latitude (degree)
- Lon[east]: Geodetic longitude (degree)
Area of Use:
- name: Europe - onshore and offshore: Albania; Andorra; Austria; Belgium; Bosnia and Herzegovina; Bulgaria; Croatia; Cyprus; Czechia; Denmark; Estonia; Faroe Islands; Finland; France; Germany; Gibraltar; Greece; Hungary; Ireland; Italy; Kosovo; Latvia; Liechtenstein; Lithuania; Luxembourg; Malta; Moldova; Monaco; Montenegro; Netherlands; North Macedonia; Norway including Svalbard and Jan Mayen; Poland; Portugal; Romania; San Marino; Serbia; Slovakia; Slovenia; Spain; Sweden; Switzerland; United Kingdom (UK) including Channel Islands and Isle of Man; Vatican City State.
- bounds: (-16.1, 32.88, 40.18, 84.73)
Datum: European Terrestrial Reference System 1989 ensemble
- Ellipsoid: GRS 1980
- Prime Meridian: Greenwich</code></pre>
</div>
</div>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bounds</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>wells_nl.total_bounds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>array([ 3.37982412, 50.75590464,  7.21010667, 53.49457587])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many spatial features</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(wells_nl))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>54659</code></pre>
</div>
</div>
<p>Our wells dataset includes 54659 points.</p>
<div class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>wells_nl.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="74">
<pre><code>&lt;AxesSubplot: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-69-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="modify-the-geometry-of-a-geodataframe" class="level3">
<h3 class="anchored" data-anchor-id="modify-the-geometry-of-a-geodataframe">Modify the geometry of a GeoDataFrame</h3>
<p>Sometimes we need to modify the geometry of a GeoDataFrame. For example, as we saw previously, the latitude and longitude are flipped in the vector data waterways_nl. This error needs to be fixed before performing further analysis. Let’s first take a look at what makes up the geometry column of waterways_nl:</p>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>waterways_nl[<span class="st">'geometry'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="75">
<pre><code>0     LINESTRING (52.41810 4.84060, 52.42070 4.84090...
1     LINESTRING (52.11910 4.67450, 52.11930 4.67340...
2     LINESTRING (52.10090 4.25730, 52.10390 4.25530...
3     LINESTRING (53.47250 6.84550, 53.47740 6.83840...
4     LINESTRING (52.32270 5.14300, 52.32100 5.14640...
                            ...                        
86    LINESTRING (51.49270 5.39100, 51.48050 5.39160...
87    LINESTRING (52.15900 5.38510, 52.16010 5.38340...
88    LINESTRING (51.97340 4.12420, 51.97110 4.12220...
89    LINESTRING (52.11910 4.67450, 52.11850 4.67430...
90    LINESTRING (51.88940 4.61900, 51.89040 4.61350...
Name: geometry, Length: 91, dtype: geometry</code></pre>
</div>
</div>
<p>Each row is a LINESTRING object. We can further zoom into one of the rows, for example, the 13th row:</p>
<div class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(waterways_nl[<span class="st">'geometry'</span>][<span class="dv">12</span>])</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">type</span>(waterways_nl[<span class="st">'geometry'</span>][<span class="dv">12</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>LINESTRING (51.714200001 4.620299999, 51.7203 4.62279999999998, 51.7212 4.62319999900001, 51.73 4.62759999899998, 51.736000001 4.62959999999998, 51.7434 4.63139999999999, 51.7489 4.63139999999999, 51.753600001 4.63019999900001, 51.759799998 4.62700000000001, 51.764699999 4.62630000000001, 51.769200001 4.62680000099999, 51.771699999 4.62720000000002, 51.773699999 4.62740000000002, 51.775800001 4.62740000000002, 51.780099999 4.62740000000002, 51.782699998 4.62709999800001, 51.785700001 4.62640000099998, 51.791900001 4.62359999900002, 51.7962 4.62229999900001, 51.800000001 4.62130000100001)
&lt;class 'shapely.geometry.linestring.LineString'&gt;</code></pre>
</div>
</div>
<p>As we can see in the output, the LINESTRING object contains a list of coordinates of the vertices. In our situation, we would like to find a way to flip the x and y of every coordinates set. A good way to look for the solution is to use the <a href="https://shapely.readthedocs.io/en/stable/manual.html">documentation of the shapely package</a>, since we are seeking to modify the LINESTRING object. Here we are going to use the <strong>shapely.ops.transform</strong> function, which applies a self-defined function to all coordinates of a geometry.</p>
<div class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shapely</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function flipping the x and y coordinate values</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> flip(geometry):</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> shapely.ops.transform(<span class="kw">lambda</span> x, y: (y, x), geometry)</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply this function to all coordinates and all lines</span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>geom_corrected <span class="op">=</span> waterways_nl[<span class="st">'geometry'</span>].<span class="bu">apply</span>(flip)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we can update the geometry column with the corrected geometry geom_corrected, and visualize it to check:</p>
<div class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Update geometry</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>waterways_nl[<span class="st">'geometry'</span>] <span class="op">=</span> geom_corrected</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>waterways_nl.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="78">
<pre><code>&lt;AxesSubplot: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-73-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Now the waterways look good! We can save the vector data for later usage:</p>
<div class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save plot as .shp file</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>waterways_nl.to_file(<span class="st">'waterways_nl_corrected.shp'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Key Points:<br>
- vector dataset metadata include geometry type, CRS, and extent<br>
- load spatial objects into Python with geopandas.read_file() function<br>
- spatial objects can be plotted directly with GeoDataFrame’s .plot() method</p>
</div>
</div>
</section>
</section>
<section id="crop-raster-data-with-rioxarray-and-geopandas" class="level2">
<h2 class="anchored" data-anchor-id="crop-raster-data-with-rioxarray-and-geopandas">8. Crop raster data with rioxarray and geopandas</h2>
<p>It is quite common that the raster data we have in hand is too large to process, or not all the pixels are relevant to our area of interest (AoI). In both situations, we should consider cropping our raster data before performing data analysis. In this section, we will introduce how to crop raster data into the desired area. We will use one Sentinel-2 image over Amsterdam as the example raster data, and introduce how to crop our data to different types of AoIs.</p>
<section id="introduce-the-data" class="level3">
<h3 class="anchored" data-anchor-id="introduce-the-data">Introduce the Data</h3>
<p>We’ll continue from the results of the satellite image search that we carried out in a previous section. We will load data starting from the search.json file.</p>
<p>The rasta data can be downloaded using this <a href="https://figshare.com/ndownloader/files/36028100">link</a>. Save the <em>geospatial-python-raster-dataset.tar.gz</em> file in your current working directory, and extract the archive file by double-clicking on it or by running the following command in your terminal tar <em>-zxvf geospatial-python-raster-dataset.tar.gz</em>. Use the file <em>geospatial-python-raster-dataset/search.json</em> (instead of search.json) to get started. We also use the vector data that was introduced in the previous section.</p>
</section>
<section id="crop-raster-data-with-a-bounding-box" class="level3">
<h3 class="anchored" data-anchor-id="crop-raster-data-with-a-bounding-box">Crop raster data with a bounding box</h3>
<p>Let’s load a true colour image using pystac and rioxarray and check the shape of the raster:</p>
<div class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pystac</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rioxarray</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load image and inspect the shape</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>items <span class="op">=</span> pystac.ItemCollection.from_file(<span class="st">"search.json"</span>)</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Select a true colour image</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>true_color_image <span class="op">=</span> rioxarray.open_rasterio(items[<span class="dv">1</span>].assets[<span class="st">"visual"</span>].href) </span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(true_color_image.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(3, 10980, 10980)</code></pre>
</div>
</div>
<p>The large size of the raster data makes it time and memory consuming to visualise in its entirety. Instead, we can plot the <strong>“overview”</strong> asset, to investigate the coverage of the image:</p>
<div class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the overview asset</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>overview_image <span class="op">=</span> rioxarray.open_rasterio(items[<span class="dv">1</span>].assets[<span class="st">"overview"</span>].href)</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(overview_image.shape)</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize it</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>overview_image.plot.imshow(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(3, 343, 343)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="81">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7fa21341cc70&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-76-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>As we can see, the overview image is much smaller compared to the original true colour image. Therefore the visualization is much faster. If we are interested in the crop fields, then we would like to know where these are located in the image. To compare its coverage with the raster data, we first check the coordinate systems of both raster and vector data.</p>
<p>For raster data, we use <strong>pyproj.CRS</strong>:</p>
<div class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyproj <span class="im">import</span> CRS</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the coordinate system</span></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>CRS(true_color_image.rio.crs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>&lt;Derived Projected CRS: EPSG:32631&gt;
Name: WGS 84 / UTM zone 31N
Axis Info [cartesian]:
- [east]: Easting (metre)
- [north]: Northing (metre)
Area of Use:
- undefined
Coordinate Operation:
- name: UTM zone 31N
- method: Transverse Mercator
Datum: World Geodetic System 1984
- Ellipsoid: WGS 84
- Prime Meridian: Greenwich</code></pre>
</div>
</div>
<p>To open and check the coordinate system of vector data, we use <strong>geopandas</strong>:</p>
<div class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the polygons of the crop fields</span></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>cf_boundary_crop <span class="op">=</span> gpd.read_file(<span class="st">"cropped_field.shp"</span>)</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the coordinate system</span></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>cf_boundary_crop.crs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>&lt;Derived Projected CRS: EPSG:28992&gt;
Name: Amersfoort / RD New
Axis Info [cartesian]:
- X[east]: Easting (metre)
- Y[north]: Northing (metre)
Area of Use:
- name: Netherlands - onshore, including Waddenzee, Dutch Wadden Islands and 12-mile offshore coastal zone.
- bounds: (3.2, 50.75, 7.22, 53.7)
Coordinate Operation:
- name: RD New
- method: Oblique Stereographic
Datum: Amersfoort
- Ellipsoid: Bessel 1841
- Prime Meridian: Greenwich</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
As we can see, the coordinate systems differ.
</div>
</div>
<div class="callout-body-container callout-body">
<p>To crop the raster using the shapefile, we first convert the coordinate system of <em>cf_boundary_crop</em> to the coordinate system of <em>true_color_image</em>, using <strong>.to_crs</strong> and then check the coverage:</p>
</div>
</div>
<div class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the coordinate system</span></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>cf_boundary_crop <span class="op">=</span> cf_boundary_crop.to_crs(true_color_image.rio.crs)</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>fig.set_size_inches((<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot image</span></span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a>overview_image.plot.imshow(ax<span class="op">=</span>ax)</span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot crop fields</span></span>
<span id="cb137-14"><a href="#cb137-14" aria-hidden="true" tabindex="-1"></a>cf_boundary_crop.plot(</span>
<span id="cb137-15"><a href="#cb137-15" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb137-16"><a href="#cb137-16" aria-hidden="true" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">"red"</span>,</span>
<span id="cb137-17"><a href="#cb137-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>&lt;AxesSubplot: title={'center': 'spatial_ref = 0'}, xlabel='x', ylabel='y'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-79-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Seeing from the location of the polygons, the crop fields (red) only takes a small part of the raster. Therefore, before actual processing, we can first crop the raster to our area of interest. The <strong>clip_box</strong> function allows us to crop a raster by the min/max of the x and y coordinates. Note that we are cropping the original image true_color_image now, and not the overview image overview_image.</p>
<div class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Crop the raster with the bounding box</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>raster_clip_box <span class="op">=</span> true_color_image.rio.clip_box(<span class="op">*</span>cf_boundary_crop.total_bounds)</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raster_clip_box.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(3, 1574, 1584)</code></pre>
</div>
</div>
<p>We successfully cropped the raster to a much smaller piece. We can visualize it now:</p>
<div class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co"># view the image</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>raster_clip_box.plot.imshow(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="86">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7fa213d2ab90&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-81-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>This cropped image can be saved for later use:</p>
<div class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save cropped image as .tif file</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>raster_clip_box.rio.to_raster(<span class="st">"raster_clip.tif"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="crop-raster-data-with-polygons" class="level3">
<h3 class="anchored" data-anchor-id="crop-raster-data-with-polygons">Crop raster data with polygons</h3>
<p>We have a cropped image around the fields. To further analyze the fields, we might want to crop the image to the exact field boundaries. This can be done with the <strong>clip</strong> function:</p>
<div class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co"># crop image to exact field boundaries</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>raster_clip_fields <span class="op">=</span> raster_clip_box.rio.clip(cf_boundary_crop[<span class="st">'geometry'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And we can visualize the results:</p>
<div class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co"># view the image</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>raster_clip_fields.plot.imshow(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="89">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7fa2132929b0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-84-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>We can save this image for later use:</p>
<div class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save image as .tif file</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>raster_clip_fields.rio.to_raster(<span class="st">"crop_fields.tif"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="crop-raster-data-with-a-geometry-buffer" class="level3">
<h3 class="anchored" data-anchor-id="crop-raster-data-with-a-geometry-buffer">Crop raster data with a geometry buffer</h3>
<p>It is not always the case that the AoI comes in polygon format. Sometimes we would like to perform analysis around a (set of) point(s), or polyline(s). For example, in our AoI, there are also some groundwater monitoring wells available as point vector data. We may also want to perform analysis around these wells. The location of the wells is stored in data/groundwater_monitoring_well.</p>
<p>We can first load the wells vector data, and select wells within the coverage of the image:</p>
<div class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load wells</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>wells <span class="op">=</span> gpd.read_file(<span class="st">"Data/brogmwvolledigeset.zip"</span>)</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>wells <span class="op">=</span> wells.to_crs(raster_clip_box.rio.crs)</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Crop the wells to the image extent</span></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>xmin, ymin, xmax, ymax <span class="op">=</span> raster_clip_box.rio.bounds()</span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>wells <span class="op">=</span> wells.cx[xmin:xmax, ymin:ymax]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we can check the location of the wells:</p>
<div class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the wells over raster</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>fig.set_size_inches((<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>raster_clip_box.plot.imshow(ax<span class="op">=</span>ax)</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>wells.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">'red'</span>, markersize<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre><code>&lt;AxesSubplot: title={'center': 'spatial_ref = 0'}, xlabel='x coordinate of projection\n[metre]', ylabel='y coordinate of projection\n[metre]'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-87-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>To select pixels around the geometries, we need to first define a region including the geometries. This region is called a <strong>“buffer”</strong> and it is defined in the units of the projection. The size of the buffer depends on the analysis in our research. A buffer is also a polygon, which can be used to crop the raster data. geopandas’ objects have a buffer method to generate buffer polygons.</p>
<div class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create 200m buffer around the wells</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>wells_buffer <span class="op">=</span> wells.<span class="bu">buffer</span>(<span class="dv">200</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize buffer on raster</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>fig.set_size_inches((<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>raster_clip_box.plot.imshow(ax<span class="op">=</span>ax)</span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>wells_buffer.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">'red'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="95">
<pre><code>&lt;AxesSubplot: title={'center': 'spatial_ref = 0'}, xlabel='x coordinate of projection\n[metre]', ylabel='y coordinate of projection\n[metre]'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-89-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>The red dots have grown larger indicating the conversion from points to buffer polygons.</p>
</section>
<section id="select-the-raster-data-around-the-wells" class="level3">
<h3 class="anchored" data-anchor-id="select-the-raster-data-around-the-wells">Select the raster data around the wells</h3>
<p>Now we have the buffer polygons around the groudwater monitoring wells, i.e.&nbsp;wells_buffer. Let’s now crop the image <em>raster_clip_box</em> to the buffer polygons, and visualize the results of cropping:</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Crop the image raster_clip_box to the buffer polygons</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>raster_clip_wells <span class="op">=</span> raster_clip_box.rio.clip(wells_buffer)</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize cropped buffer</span></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>raster_clip_wells.plot.imshow()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>NameError: name 'raster_clip_box' is not defined</code></pre>
</div>
</div>
</section>
<section id="select-the-raster-data-around-the-waterways" class="level3">
<h3 class="anchored" data-anchor-id="select-the-raster-data-around-the-waterways">Select the raster data around the waterways</h3>
<p>Let’s now attempt to select all the raster data within 100m around the waterways, and visualize the results:</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load waterways</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>waterways_nl <span class="op">=</span> gpd.read_file(<span class="st">"Data/waterways_nl_corrected.shp"</span>)</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>waterways_nl <span class="op">=</span> waterways_nl.to_crs(raster_clip_box.rio.crs)</span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Crop the waterways to the image extent</span></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>waterways_nl <span class="op">=</span> waterways_nl.cx[xmin:xmax, ymin:ymax]</span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create 100m buffer around the waterways</span></span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>waterways_nl_buffer <span class="op">=</span> waterways_nl.<span class="bu">buffer</span>(<span class="dv">100</span>)</span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Crop</span></span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>raster_clip_waterways <span class="op">=</span> raster_clip_box.rio.clip(waterways_nl_buffer)</span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize</span></span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a>raster_clip_waterways.plot.imshow(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>NameError: name 'raster_clip_box' is not defined</code></pre>
</div>
</div>
</section>
<section id="crop-raster-data-using-another-raster-dataset" class="level3">
<h3 class="anchored" data-anchor-id="crop-raster-data-using-another-raster-dataset">Crop raster data using another raster dataset</h3>
<p>So far we have learned how to crop raster image with vector data. We can also crop a raster with <strong>another raster data</strong>. Let’s demonstrate how to crop the true_color_image image using the crop_fields.tif image. that was produced in the sub-section “Crop raster data with polygon”.</p>
<div class="cell" data-execution_count="107">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read crop_fields</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>crop_fields <span class="op">=</span> rioxarray.open_rasterio(<span class="st">"Data/crop_fields.tif"</span>)</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Reproject to RD to make the CRS different from the "true_color_image"</span></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>crop_fields <span class="op">=</span> crop_fields.rio.reproject(<span class="st">"EPSG:28992"</span>)</span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>CRS(crop_fields.rio.crs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="107">
<pre><code>&lt;Derived Projected CRS: EPSG:28992&gt;
Name: Amersfoort / RD New
Axis Info [cartesian]:
- [east]: Easting (metre)
- [north]: Northing (metre)
Area of Use:
- undefined
Coordinate Operation:
- name: unnamed
- method: Oblique Stereographic
Datum: Amersfoort
- Ellipsoid: Bessel 1841
- Prime Meridian: Greenwich</code></pre>
</div>
</div>
<p>And let’s check again the CRS of true_color_image:</p>
<div class="cell" data-execution_count="108">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get CRS of true_color_image</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>CRS(true_color_image.rio.crs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="108">
<pre><code>&lt;Derived Projected CRS: EPSG:32631&gt;
Name: WGS 84 / UTM zone 31N
Axis Info [cartesian]:
- [east]: Easting (metre)
- [north]: Northing (metre)
Area of Use:
- undefined
Coordinate Operation:
- name: UTM zone 31N
- method: Transverse Mercator
Datum: World Geodetic System 1984
- Ellipsoid: WGS 84
- Prime Meridian: Greenwich</code></pre>
</div>
</div>
<p>Now the two images are in different coordinate systems. We can use <strong>rioxarray.reproject_match()</strong> function to crop true_color_image image. It will perform <strong>both</strong> the <em>reprojection</em> and the <em>cropping</em> operation. This might take a few minutes, because the true_color_image image is large:</p>
<div class="cell" data-execution_count="109">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Crop and reproject</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>cropped_raster <span class="op">=</span> true_color_image.rio.reproject_match(crop_fields)</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize</span></span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>cropped_raster.plot.imshow(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="109">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7fa20b696b90&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-94-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
In one line reproject_match does a lot of helpful things:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>it reprojects</li>
<li>it matches the extent using nodata values or by clipping the data</li>
<li>it sets nodata values. This means we can run calculations on those two images</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you want more control over how rasters are resampled, clipped, and/or reprojected
</div>
</div>
<div class="callout-body-container callout-body">
<p>Use the reproject() method and other rioxarray methods individually</p>
</div>
</div>
<p>This time let’s do it the other way around by cropping the crop_fields image using the true_color_image image:</p>
<div class="cell" data-execution_count="110">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Crop and reproject</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>cropped_raster <span class="op">=</span> crop_fields.rio.reproject_match(true_color_image)</span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize</span></span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>cropped_raster.plot.imshow(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="110">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7fa20b647c10&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-95-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Key Points:<br>
- use clip_box in DataArray.rio to crop a raster with a bounding box<br>
- use clip in DataArray.rio to crop a raster with a given polygon<br>
- use buffer in geopandas to make a buffer polygon of a (multi)point or a polyline. This polygon can be used to crop data<br>
- use reproject_match function in DataArray.rio to reproject and crop a raster data using another raster data</p>
</div>
</div>
</section>
</section>
<section id="raster-calculations-in-python" class="level2">
<h2 class="anchored" data-anchor-id="raster-calculations-in-python">9. Raster Calculations in Python</h2>
<p>We often want to combine values of and perform calculations on rasters to create a new output raster. This episode covers how to perform basic math operations using raster datasets. It also illustrates how to match rasters with different resolutions so that they can be used in the same calculation. As an example, we will calculate a vegetation index over one of the satellite scenes.</p>
<section id="normalized-difference-vegetation-index-ndvi" class="level3">
<h3 class="anchored" data-anchor-id="normalized-difference-vegetation-index-ndvi">Normalized Difference Vegetation Index (NDVI)</h3>
<p>Suppose we are interested in monitoring vegetation fluctuations using satellite remote sensors. Scientists have defined a vegetation index to quantify the amount of green leaf vegetation using the light reflected in different wavelengths. This index, named <a href="https://gisgeography.com/ndvi-normalized-difference-vegetation-index/">Normalized Difference Vegetation Index (NDVI)</a>, exploits the fact that healthy green leaves strongly absorb red visible light while they mostly reflect light in the <a href="https://en.wikipedia.org/wiki/Near-infrared_spectroscopy">near infrared (NIR)</a>. The NDVI is computed as:</p>
<p>NDVI = <span class="math inline">\(\frac{NIR - red}{NIR + red}\)</span></p>
<p>where NIR and red label the reflectance values of the corresponding wavelengths. NDVI values range from -1 to +1.</p>
<p>Values close to one indicate high density of green leaves. Poorly vegetated areas typically have NDVI values close to zero. Negative NDVI values often indicate cloud and water bodies.</p>
<p><img src="ndvi.jpg" width="600" height="600"></p>
<p>Source: Wu C-D, McNeely E, Cedeño-Laurent JG, Pan W-C, Adamkiewicz G, Dominici F, et al.&nbsp;(2014) Linking Student Performance in Massachusetts Elementary Schools with the “Greenness” of School Surroundings Using Remote Sensing. PLoS ONE 9(10): e108548. https://doi.org/10.1371/journal.pone.0108548</p>
<p>Check out more on NDVI in the NASA Earth Observatory portal: <a href="https://earthobservatory.nasa.gov/features/MeasuringVegetation/measuring_vegetation_2.php">Measuring Vegetation</a>.</p>
</section>
<section id="load-and-crop-the-data" class="level3">
<h3 class="anchored" data-anchor-id="load-and-crop-the-data">Load and crop the data</h3>
<p>We’ll continue from the results of the satellite image search that we have carried out in Section 5 previously. We will load data starting from the search.json file. You can download the raster data using <a href="https://figshare.com/ndownloader/files/36028100">this link</a>. Save the <em>geospatial-python-raster-dataset.tar.gz</em> file in your current working directory, and extract the archive file by double-clicking on it or by running the following command in your terminal <em>tar -zxvf geospatial-python-raster-dataset.tar.gz</em>. Use the file <em>geospatial-python-raster-dataset/search.json</em> (instead of search.json) to get started.</p>
<p>Let’s load the results of our initial imagery search using pystac:</p>
<div class="cell" data-execution_count="113">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pystac</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a><span class="co"># load in our imagery search</span></span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>items <span class="op">=</span> pystac.ItemCollection.from_file(<span class="st">"search.json"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then select the second item, and extract the URIs of the red and NIR bands (“B04” and “B8A”, respectively):</p>
<div class="cell" data-execution_count="114">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extract URIs of second items of red and NIR bands</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>red_uri <span class="op">=</span> items[<span class="dv">1</span>].assets[<span class="st">"B04"</span>].href</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>nir_uri <span class="op">=</span> items[<span class="dv">1</span>].assets[<span class="st">"B8A"</span>].href</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s load the rasters with open_rasterio using the argument masked=True.</p>
<div class="cell" data-execution_count="115">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rioxarray</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="co"># load in the rasters with argument masked=True which </span></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>red <span class="op">=</span> rioxarray.open_rasterio(red_uri, masked<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>nir <span class="op">=</span> rioxarray.open_rasterio(nir_uri, masked<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s also restrict our analysis to the same crop field area defined in the previous section by clipping the rasters using a bounding box:</p>
<div class="cell" data-execution_count="117">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co"># clip the rasters using a bounding box</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>bbox <span class="op">=</span> (<span class="dv">629_000</span>, <span class="dv">5_804_000</span>, <span class="dv">639_000</span>, <span class="dv">5_814_000</span>)</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>red_clip <span class="op">=</span> red.rio.clip_box(<span class="op">*</span>bbox)</span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>nir_clip <span class="op">=</span> nir.rio.clip_box(<span class="op">*</span>bbox)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now plot the two rasters. Using robust=True color values are stretched between the 2nd and 98th percentiles of the data, which results in clearer distinctions between high and low reflectances:</p>
<div class="cell" data-execution_count="118">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the red visible light wavelength raster</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>red_clip.plot(robust<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="118">
<pre><code>&lt;matplotlib.collections.QuadMesh at 0x7fa20b6031c0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-100-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The crop fields (rectangular shapes in the central part of the figure) appear as dark spots in the red-visible wavelength, suggesting the presence of leafy crop at the time of observation (end of March).
</div>
</div>
<div class="callout-body-container callout-body">
<p>The same fields would instead appear as bright spots in the off season.</p>
</div>
</div>
<div class="cell" data-execution_count="119">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the near infra red wavelength raster</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>nir_clip.plot(robust<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="119">
<pre><code>&lt;matplotlib.collections.QuadMesh at 0x7fa20ca6ff70&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-101-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The crop fields (rectangular shapes in the central part of the figure) appear as bright spots in the NIR wavelength, suggesting the presence of leafy crop at the time of observation (end of March).
</div>
</div>
<div class="callout-body-container callout-body">
<p>The same fields would instead appear as dark spots in the off season.</p>
</div>
</div>
<p>Let’s check this by grabbing scenes for an ‘off-season’ period</p>
<div class="cell" data-execution_count="139">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>api_url <span class="op">=</span> <span class="st">"https://earth-search.aws.element84.com/v0"</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pystac_client <span class="im">import</span> Client</span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> Client.<span class="bu">open</span>(api_url)</span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Sentinel-2, Level 2A, COGs</span></span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a>collection <span class="op">=</span> <span class="st">"sentinel-s2-l2a-cogs"</span> </span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-9"><a href="#cb174-9" aria-hidden="true" tabindex="-1"></a><span class="co"># AMS coordinates</span></span>
<span id="cb174-10"><a href="#cb174-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Point</span>
<span id="cb174-11"><a href="#cb174-11" aria-hidden="true" tabindex="-1"></a>point <span class="op">=</span> Point(<span class="fl">4.89</span>, <span class="fl">52.37</span>)  </span>
<span id="cb174-12"><a href="#cb174-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-13"><a href="#cb174-13" aria-hidden="true" tabindex="-1"></a>bound_box <span class="op">=</span> point.<span class="bu">buffer</span>(<span class="fl">0.01</span>).bounds</span>
<span id="cb174-14"><a href="#cb174-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-15"><a href="#cb174-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Search for scenes which intersect bounding box +- 0.01 deg in lat/lon from (4.89, 52.37) as prev defined</span></span>
<span id="cb174-16"><a href="#cb174-16" aria-hidden="true" tabindex="-1"></a><span class="co"># between 09/13/20 and 09/30/20 where cloud cover &lt; 10%</span></span>
<span id="cb174-17"><a href="#cb174-17" aria-hidden="true" tabindex="-1"></a>search <span class="op">=</span> client.search(</span>
<span id="cb174-18"><a href="#cb174-18" aria-hidden="true" tabindex="-1"></a>    collections<span class="op">=</span>[collection],</span>
<span id="cb174-19"><a href="#cb174-19" aria-hidden="true" tabindex="-1"></a>    bbox<span class="op">=</span>bound_box,</span>
<span id="cb174-20"><a href="#cb174-20" aria-hidden="true" tabindex="-1"></a>    datetime<span class="op">=</span><span class="st">"2020-09-13/2020-09-30"</span>,</span>
<span id="cb174-21"><a href="#cb174-21" aria-hidden="true" tabindex="-1"></a>    query<span class="op">=</span>[<span class="st">"eo:cloud_cover&lt;10"</span>]</span>
<span id="cb174-22"><a href="#cb174-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb174-23"><a href="#cb174-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-24"><a href="#cb174-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(search.matched())</span>
<span id="cb174-25"><a href="#cb174-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-26"><a href="#cb174-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Grab search items and save as a JSON file</span></span>
<span id="cb174-27"><a href="#cb174-27" aria-hidden="true" tabindex="-1"></a>items_off_season <span class="op">=</span> search.get_all_items()</span>
<span id="cb174-28"><a href="#cb174-28" aria-hidden="true" tabindex="-1"></a>items_off_season.save_object(<span class="st">"search_off_season.json"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3</code></pre>
</div>
</div>
<div class="cell" data-execution_count="140">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pystac</span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>items_off_season <span class="op">=</span> pystac.ItemCollection.from_file(<span class="st">"search_off_season.json"</span>)</span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a><span class="co"># extract URIs of second items of red and NIR bands</span></span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a>red_uri_off_season <span class="op">=</span> items_off_season[<span class="dv">1</span>].assets[<span class="st">"B04"</span>].href</span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a>nir_uri_off_season <span class="op">=</span> items_off_season[<span class="dv">1</span>].assets[<span class="st">"B8A"</span>].href</span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rioxarray</span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a>red_off_season <span class="op">=</span> rioxarray.open_rasterio(red_uri_off_season, masked<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb176-11"><a href="#cb176-11" aria-hidden="true" tabindex="-1"></a>nir_off_season <span class="op">=</span> rioxarray.open_rasterio(nir_uri_off_season, masked<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb176-12"><a href="#cb176-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-13"><a href="#cb176-13" aria-hidden="true" tabindex="-1"></a><span class="co"># clip the rasters using a bounding box</span></span>
<span id="cb176-14"><a href="#cb176-14" aria-hidden="true" tabindex="-1"></a>bbox <span class="op">=</span> (<span class="dv">629_000</span>, <span class="dv">5_804_000</span>, <span class="dv">639_000</span>, <span class="dv">5_814_000</span>)</span>
<span id="cb176-15"><a href="#cb176-15" aria-hidden="true" tabindex="-1"></a>red_off_season_clip <span class="op">=</span> red_off_season.rio.clip_box(<span class="op">*</span>bbox)</span>
<span id="cb176-16"><a href="#cb176-16" aria-hidden="true" tabindex="-1"></a>nir_off_season_clip <span class="op">=</span> nir_off_season.rio.clip_box(<span class="op">*</span>bbox)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="141">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the OFF SEASON red visible light wavelength raster</span></span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>red_off_season_clip.plot(robust<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="141">
<pre><code>&lt;matplotlib.collections.QuadMesh at 0x7fa20c4d8130&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-104-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="142">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the OFF SEASON near infra red wavelength raster</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>nir_off_season_clip.plot(robust<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="142">
<pre><code>&lt;matplotlib.collections.QuadMesh at 0x7fa20c4787c0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-105-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="raster-math" class="level3">
<h3 class="anchored" data-anchor-id="raster-math">Raster Math</h3>
<p>We can perform raster calculations by subtracting (or adding, multiplying, etc.) two rasters. In the geospatial world, we call this “raster math”, and typically it refers to operations on rasters that have the same width and height (including nodata pixels). We can check the shapes of the two rasters in the following way:</p>
<div class="cell" data-execution_count="143">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(red_clip.shape, nir_clip.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(1, 1000, 1000) (1, 500, 500)</code></pre>
</div>
</div>
<p>Both rasters include a single band, but their width and height do not match. We can now use the reproject_match function, which both reprojects and clips a raster to the CRS and extent of another raster.</p>
<div class="cell" data-execution_count="144">
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>red_clip_matched <span class="op">=</span> red_clip.rio.reproject_match(nir_clip)</span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(red_clip_matched.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(1, 500, 500)</code></pre>
</div>
</div>
<p>Let’s now compute the NDVI as a new raster using the formula</p>
<pre><code>NDVI = $\frac{NIR - red}{NIR + red}$</code></pre>
<p>We’ll use rioxarray objects so that we can easily plot our result and keep track of the metadata.</p>
<div class="cell" data-execution_count="145">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>ndvi <span class="op">=</span> (nir_clip <span class="op">-</span> red_clip_matched)<span class="op">/</span> (nir_clip <span class="op">+</span> red_clip_matched)</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ndvi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;xarray.DataArray (band: 1, y: 500, x: 500)&gt;
array([[[ 0.7379576 ,  0.77153456,  0.54531944, ...,  0.39254385,
          0.49227372,  0.4465174 ],
        [ 0.7024894 ,  0.7074668 ,  0.3903298 , ...,  0.423283  ,
          0.4706971 ,  0.45964912],
        [ 0.6557818 ,  0.5610572 ,  0.46742022, ...,  0.4510345 ,
          0.43815723,  0.6005133 ],
        ...,
        [ 0.02391171,  0.21843003,  0.02479339, ..., -0.50923485,
         -0.53367877, -0.4955414 ],
        [ 0.11376493,  0.17681159, -0.1673566 , ..., -0.5221932 ,
         -0.5271318 , -0.4852753 ],
        [ 0.45398772, -0.00518135,  0.03346133, ..., -0.5019455 ,
         -0.4987013 , -0.49081364]]], dtype=float32)
Coordinates:
  * band         (band) int64 1
  * x            (x) float64 6.29e+05 6.29e+05 6.29e+05 ... 6.39e+05 6.39e+05
  * y            (y) float64 5.814e+06 5.814e+06 ... 5.804e+06 5.804e+06
    spatial_ref  int64 0</code></pre>
</div>
</div>
<p>We can now plot the output NDVI:</p>
<div class="cell" data-execution_count="152">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>ndvi.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="152">
<pre><code>&lt;matplotlib.collections.QuadMesh at 0x7fa20b9cfdc0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-109-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-38-contents" aria-controls="callout-38" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notice that the range of values for the output NDVI is between -1 and 1. This makes sense for the selected region?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-38" class="callout-38-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Yes. Remember that NDVI values close to one indicate high density of green leaves, and negative NDVI values often indicate water bodies. This is consistent with our region.</p>
</div>
</div>
</div>
<p>Maps are great, but it can also be informative to plot histograms of values to better understand the distribution. We can accomplish this using a built-in xarray method we have already been using: .plot</p>
<div class="cell" data-execution_count="147">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>ndvi.plot.hist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="147">
<pre><code>(array([2.1000e+01, 1.2800e+02, 1.6076e+04, 1.3546e+04, 6.4030e+03,
        1.5811e+04, 2.4608e+04, 4.0979e+04, 8.2569e+04, 4.9858e+04]),
 array([-9.98647749e-01, -7.98825085e-01, -5.99002421e-01, -3.99179786e-01,
        -1.99357137e-01,  4.65512276e-04,  2.00288162e-01,  4.00110811e-01,
         5.99933445e-01,  7.99756110e-01,  9.99578774e-01]),
 &lt;BarContainer object of 10 artists&gt;)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-110-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="explore-ndvi-raster-values" class="level3">
<h3 class="anchored" data-anchor-id="explore-ndvi-raster-values">Explore NDVI Raster Values</h3>
<p>It’s often a good idea to explore the range of values in a raster dataset just like we might explore a dataset that we collected in the field. The histogram we just made is a good start but there’s more we can do to improve our understanding of the data.</p>
<div class="cell" data-execution_count="153">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="co"># What is the min and maximum value for the NDVI raster (ndvi) that we just created?</span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Are there missing values?</span></span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ndvi.<span class="bu">min</span>().values)</span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ndvi.<span class="bu">max</span>().values)</span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ndvi.isnull().<span class="bu">sum</span>().values)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-0.99864775
0.9995788
1</code></pre>
</div>
</div>
<div class="cell" data-execution_count="151">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot a histogram with 50 bins instead of 8. What do you notice that wasn’t clear before?</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>ndvi.plot.hist(bins<span class="op">=</span><span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="151">
<pre><code>(array([1.2000e+01, 2.0000e+00, 2.0000e+00, 3.0000e+00, 2.0000e+00,
        8.0000e+00, 7.0000e+00, 4.0000e+00, 2.9000e+01, 8.0000e+01,
        5.5800e+02, 2.0930e+03, 3.1920e+03, 4.6700e+03, 5.5630e+03,
        7.6140e+03, 2.9020e+03, 1.3340e+03, 9.5700e+02, 7.3900e+02,
        8.1800e+02, 1.0210e+03, 1.2840e+03, 1.4820e+03, 1.7980e+03,
        2.1740e+03, 2.8470e+03, 3.2340e+03, 3.7030e+03, 3.8530e+03,
        4.2410e+03, 4.6100e+03, 4.8320e+03, 5.3200e+03, 5.6050e+03,
        6.2230e+03, 6.9630e+03, 7.9370e+03, 9.0210e+03, 1.0835e+04,
        1.2352e+04, 1.3883e+04, 1.5219e+04, 1.8287e+04, 2.2828e+04,
        2.5534e+04, 1.9329e+04, 4.9850e+03, 8.0000e+00, 2.0000e+00]),
 array([-9.98647749e-01, -9.58683193e-01, -9.18718696e-01, -8.78754139e-01,
        -8.38789642e-01, -7.98825085e-01, -7.58860588e-01, -7.18896031e-01,
        -6.78931534e-01, -6.38966978e-01, -5.99002421e-01, -5.59037924e-01,
        -5.19073367e-01, -4.79108840e-01, -4.39144313e-01, -3.99179786e-01,
        -3.59215260e-01, -3.19250733e-01, -2.79286206e-01, -2.39321664e-01,
        -1.99357137e-01, -1.59392610e-01, -1.19428076e-01, -7.94635490e-02,
        -3.94990183e-02,  4.65512276e-04,  4.04300429e-02,  8.03945735e-02,
         1.20359100e-01,  1.60323635e-01,  2.00288162e-01,  2.40252689e-01,
         2.80217230e-01,  3.20181757e-01,  3.60146284e-01,  4.00110811e-01,
         4.40075338e-01,  4.80039865e-01,  5.20004392e-01,  5.59968948e-01,
         5.99933445e-01,  6.39898002e-01,  6.79862559e-01,  7.19827056e-01,
         7.59791613e-01,  7.99756110e-01,  8.39720666e-01,  8.79685163e-01,
         9.19649720e-01,  9.59614217e-01,  9.99578774e-01]),
 &lt;BarContainer object of 50 artists&gt;)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-112-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Increasing the number of bins gives us a much clearer view of the distribution. Also, there seem to be very few NDVI values larger than ~ 0.9.</p>
<div class="cell" data-execution_count="154">
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the ndvi raster using breaks that make sense for the data</span></span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>class_bins <span class="op">=</span> (<span class="op">-</span><span class="dv">1</span>, <span class="fl">0.</span>, <span class="fl">0.2</span>, <span class="fl">0.7</span>, <span class="dv">1</span>)</span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a>ndvi.plot(levels<span class="op">=</span>class_bins)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="154">
<pre><code>&lt;matplotlib.collections.QuadMesh at 0x7fa20b8f6e90&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-113-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>We can discretize the colour bar by specifying the intervals via the level argument to plot(). Suppose we want to bin our data in the following intervals:</p>
<ul>
<li>-1 <span class="math inline">\(\le\)</span> NDVI <span class="math inline">\(\lt\)</span> 0 for water</li>
<li>0 <span class="math inline">\(\le\)</span> NDVI <span class="math inline">\(\lt\)</span> 0.2 for no vegetation</li>
<li>0.2 <span class="math inline">\(\le\)</span> NDVI <span class="math inline">\(\lt\)</span> 0.7 for sparse vegetation</li>
<li>0.7 <span class="math inline">\(\le\)</span> NDVI <span class="math inline">\(\lt\)</span> 1 for dense vegetation</li>
</ul>
<p>Missing values can be interpolated from the values of neighbouring grid cells using the <strong>.interpolate_na</strong> method. We then save ndvi as a GeoTiff file:</p>
<div class="cell" data-execution_count="155">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>ndvi_nonan <span class="op">=</span> ndvi.interpolate_na(dim<span class="op">=</span><span class="st">"x"</span>)</span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>ndvi_nonan.rio.to_raster(<span class="st">"NDVI.tif"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="classifying-continuous-rasters-in-python" class="level3">
<h3 class="anchored" data-anchor-id="classifying-continuous-rasters-in-python">Classifying Continuous Rasters in Python</h3>
<p>Now that we have a sense of the distribution of our NDVI raster, we can reduce the complexity of our map by classifying it. Classification involves assigning each pixel in the raster to a class based on its value. In Python, we can accomplish this using the <strong><a href="https://numpy.org/doc/stable/reference/generated/numpy.digitize.html">numpy.digitize</a></strong> function.</p>
<p>First, we define NDVI classes based on a list of values, as defined in the last exercise: [-1, 0., 0.2, 0.7, 1]. When bins are ordered from low to high, as here, numpy.digitize assigns classes like so:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Working with Geospatial Data in Python_files/figure-html/f00d5934-85c3-4f11-bdfe-041308ef6566-1-dba266e0-a79b-46bd-bbb5-aa06958a072c.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">NDVI-classes.jpg</figcaption>
</figure>
</div>
<p>Source: Image (<a href="https://carpentries-incubator.github.io/geospatial-python/LICENSE.html">license</a>)</p>
<p>Note that, by default, each class includes the left but not the right bound. This is not an issue here, since the computed range of NDVI values is fully contained in the open interval (-1; 1).</p>
<div class="cell" data-execution_count="156">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray</span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Defines the bins for pixel values</span></span>
<span id="cb199-5"><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a>class_bins <span class="op">=</span> (<span class="op">-</span><span class="dv">1</span>, <span class="fl">0.</span>, <span class="fl">0.2</span>, <span class="fl">0.7</span>, <span class="dv">1</span>)</span>
<span id="cb199-6"><a href="#cb199-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-7"><a href="#cb199-7" aria-hidden="true" tabindex="-1"></a><span class="co"># The numpy.digitize function returns an unlabeled array, in this case, a</span></span>
<span id="cb199-8"><a href="#cb199-8" aria-hidden="true" tabindex="-1"></a><span class="co"># classified array without any metadata. That doesn't work--we need the</span></span>
<span id="cb199-9"><a href="#cb199-9" aria-hidden="true" tabindex="-1"></a><span class="co"># coordinates and other spatial metadata. We can get around this using</span></span>
<span id="cb199-10"><a href="#cb199-10" aria-hidden="true" tabindex="-1"></a><span class="co"># xarray.apply_ufunc, which can run the function across the data array while</span></span>
<span id="cb199-11"><a href="#cb199-11" aria-hidden="true" tabindex="-1"></a><span class="co"># preserving metadata.</span></span>
<span id="cb199-12"><a href="#cb199-12" aria-hidden="true" tabindex="-1"></a>ndvi_classified <span class="op">=</span> xarray.apply_ufunc(</span>
<span id="cb199-13"><a href="#cb199-13" aria-hidden="true" tabindex="-1"></a>    np.digitize,</span>
<span id="cb199-14"><a href="#cb199-14" aria-hidden="true" tabindex="-1"></a>    ndvi_nonan,</span>
<span id="cb199-15"><a href="#cb199-15" aria-hidden="true" tabindex="-1"></a>    class_bins</span>
<span id="cb199-16"><a href="#cb199-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now visualize the classified NDVI, customizing the plot with proper title and legend. We can use <a href="https://earthpy.readthedocs.io/en/latest/">EarthPy</a> to assist. We then export the figure in PNG format:</p>
<div class="cell" data-execution_count="158">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> earthpy.plot <span class="im">as</span> ep</span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.colors <span class="im">import</span> ListedColormap</span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-6"><a href="#cb200-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Define color map of the map legend</span></span>
<span id="cb200-7"><a href="#cb200-7" aria-hidden="true" tabindex="-1"></a>ndvi_colors <span class="op">=</span> [<span class="st">"blue"</span>, <span class="st">"gray"</span>, <span class="st">"green"</span>, <span class="st">"darkgreen"</span>]</span>
<span id="cb200-8"><a href="#cb200-8" aria-hidden="true" tabindex="-1"></a>ndvi_cmap <span class="op">=</span> ListedColormap(ndvi_colors)</span>
<span id="cb200-9"><a href="#cb200-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-10"><a href="#cb200-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Define class names for the legend</span></span>
<span id="cb200-11"><a href="#cb200-11" aria-hidden="true" tabindex="-1"></a>category_names <span class="op">=</span> [</span>
<span id="cb200-12"><a href="#cb200-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Water"</span>,</span>
<span id="cb200-13"><a href="#cb200-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"No Vegetation"</span>,</span>
<span id="cb200-14"><a href="#cb200-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sparse Vegetation"</span>,</span>
<span id="cb200-15"><a href="#cb200-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Dense Vegetation"</span></span>
<span id="cb200-16"><a href="#cb200-16" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb200-17"><a href="#cb200-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-18"><a href="#cb200-18" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to know in what order the legend items should be arranged</span></span>
<span id="cb200-19"><a href="#cb200-19" aria-hidden="true" tabindex="-1"></a>category_indices <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">len</span>(category_names)))</span>
<span id="cb200-20"><a href="#cb200-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-21"><a href="#cb200-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the plot</span></span>
<span id="cb200-22"><a href="#cb200-22" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> ndvi_classified.plot(cmap<span class="op">=</span>ndvi_cmap, add_colorbar<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb200-23"><a href="#cb200-23" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Classified NDVI"</span>)</span>
<span id="cb200-24"><a href="#cb200-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-25"><a href="#cb200-25" aria-hidden="true" tabindex="-1"></a><span class="co"># earthpy helps us by drawing a legend given an existing image plot and legend items, plus indices</span></span>
<span id="cb200-26"><a href="#cb200-26" aria-hidden="true" tabindex="-1"></a>ep.draw_legend(im_ax<span class="op">=</span>im, classes<span class="op">=</span>category_indices, titles<span class="op">=</span>category_names)</span>
<span id="cb200-27"><a href="#cb200-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-28"><a href="#cb200-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the figure</span></span>
<span id="cb200-29"><a href="#cb200-29" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">"NDVI_classified.png"</span>, bbox_inches<span class="op">=</span><span class="st">"tight"</span>, dpi<span class="op">=</span><span class="dv">300</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-116-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We can finally export the classified NDVI raster object to a GeoTiff file. The to_raster() function by default writes the output file to your working directory unless you specify a full file path.</p>
<div class="cell" data-execution_count="159">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>ndvi_classified.rio.to_raster(<span class="st">"NDVI_classified.tif"</span>, dtype<span class="op">=</span><span class="st">"int32"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="compute-the-ndvi-for-the-texel-island" class="level3">
<h3 class="anchored" data-anchor-id="compute-the-ndvi-for-the-texel-island">Compute the NDVI for the Texel island</h3>
<p>Data are often more interesting and powerful when we compare them across various locations. Let’s compare the computed NDVI map with the one of another region in the same Sentinel-2 scene: the <a href="https://www.google.com/maps/place/Texel,+Netherlands/@53.0731884,4.6384718,11z/data=!3m1!4b1!4m5!3m4!1s0x47c8e90662591ac5:0x93112ef2960b0ec6!8m2!3d53.0547626!4d4.7977149">Texel island</a>, located in the North Sea. You should have the red- and the NIR-band rasters already loaded (red and nir variables, respectively).</p>
<div class="cell" data-execution_count="185">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Crop the two rasters using the following bounding box: (610000, 5870000, 630000, 5900000)</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Don’t forget to check the shape of the data, and make sure the cropped areas have the same CRSs, heights and widths</span></span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a>bbox_texel <span class="op">=</span> (<span class="dv">610_000</span>, <span class="dv">5_870_000</span>, <span class="dv">630_000</span>, <span class="dv">5_900_000</span>)</span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-6"><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a><span class="co"># We crop the area of interest using clip_box</span></span>
<span id="cb202-7"><a href="#cb202-7" aria-hidden="true" tabindex="-1"></a>red_texel <span class="op">=</span> red.rio.clip_box(<span class="op">*</span>bbox_texel)</span>
<span id="cb202-8"><a href="#cb202-8" aria-hidden="true" tabindex="-1"></a>nir_texel <span class="op">=</span> nir.rio.clip_box(<span class="op">*</span>bbox_texel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="186">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reproject and clip one raster to the extent of the smaller raster using reproject_match. </span></span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a><span class="co"># The lines of code below assign a variable to the reprojected raster and calculate the NDVI</span></span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a>red_texel_matched <span class="op">=</span> red_texel.rio.reproject_match(nir_texel)</span>
<span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a>ndvi_texel <span class="op">=</span> (nir_texel <span class="op">-</span> red_texel_matched)<span class="op">/</span> (nir_texel <span class="op">+</span> red_texel_matched)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="187">
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the NDVI and save the raster data as a GeoTIFF file.</span></span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a>ndvi_texel.plot()</span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>ndvi_texel.rio.to_raster(<span class="st">"NDVI_Texel.tif"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-120-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="188">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the NDVI histogram and compare it with the region that we have previously investigated. </span></span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>ndvi_texel.plot.hist(bins<span class="op">=</span><span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="188">
<pre><code>(array([1.00000e+00, 1.00000e+00, 2.00000e+00, 5.40000e+01, 4.69000e+02,
        2.57300e+03, 1.62910e+04, 8.02330e+04, 1.78238e+05, 1.53825e+05,
        1.01914e+05, 9.36200e+04, 9.87920e+04, 1.01029e+05, 9.09090e+04,
        5.97100e+04, 2.73410e+04, 9.47800e+03, 3.04700e+03, 1.62600e+03,
        1.55700e+03, 1.65400e+03, 2.29600e+03, 3.89600e+03, 5.28800e+03,
        1.36810e+04, 4.09490e+04, 2.19440e+04, 1.86000e+04, 1.45780e+04,
        1.44360e+04, 1.21830e+04, 1.17350e+04, 1.19370e+04, 1.27390e+04,
        1.38190e+04, 1.53210e+04, 1.83800e+04, 2.38000e+04, 2.65840e+04,
        2.62420e+04, 2.41790e+04, 2.32460e+04, 2.33390e+04, 2.34600e+04,
        2.27600e+04, 2.10470e+04, 1.70200e+04, 1.20100e+04, 2.16700e+03]),
 array([-0.9191919 , -0.88229859, -0.84540534, -0.80851203, -0.77161872,
        -0.73472542, -0.69783217, -0.66093886, -0.62404555, -0.58715224,
        -0.55025899, -0.51336569, -0.47647238, -0.4395791 , -0.40268579,
        -0.36579251, -0.3288992 , -0.29200593, -0.25511262, -0.21821934,
        -0.18132605, -0.14443275, -0.10753946, -0.07064617, -0.03375287,
         0.00314042,  0.04003371,  0.07692701,  0.1138203 ,  0.15071359,
         0.18760689,  0.22450018,  0.26139346,  0.29828677,  0.33518004,
         0.37207335,  0.40896663,  0.44585994,  0.48275322,  0.51964653,
         0.55653983,  0.59343308,  0.63032639,  0.6672197 ,  0.70411301,
         0.74100626,  0.77789956,  0.81479287,  0.85168618,  0.88857943,
         0.92547274]),
 &lt;BarContainer object of 50 artists&gt;)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-121-output-2.png" class="img-fluid"></p>
</div>
</div>
<ul>
<li>many more grid cells have negative NDVI values, since the area of interest includes much more water</li>
<li>also, NDVI values close to zero are more abundant, indicating the presence of bare ground (sand) regions</li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Key Points:<br>
- Python’s built-in math operators are fast and simple options for raster math<br>
- numpy.digitize can be used to classify raster values in order to generate a less complicated map</p>
</div>
</div>
</section>
</section>
<section id="calculating-zonal-statistics-on-rasters" class="level2">
<h2 class="anchored" data-anchor-id="calculating-zonal-statistics-on-rasters">10. Calculating Zonal Statistics on Rasters</h2>
<p>Statistics on predefined zones of the raster data are commonly used for analysis and to better understand the data. These zones are often provided within a single vector dataset, identified by certain vector attributes. For example, in the previous sections, we used the crop field polygon dataset. The fields with the same crop type can be identified as a “zone”, resulting in multiple zones in one vector dataset. We might be interested in performing statistical analysis over these crop zones.</p>
<p>In this section, we will explore how to calculate zonal statistics based on the types of crops in *<strong>cropped_field.shp</strong> . To do this, we will first identify zones from the vector data, then rasterize these vector zones. Finally the zonal statistics for ndvi will be calculated over the rasterized zones.</p>
<section id="making-vector-and-raster-data-compatible" class="level3">
<h3 class="anchored" data-anchor-id="making-vector-and-raster-data-compatible">Making vector and raster data compatible</h3>
<p>First, let’s load the NDVI.tif file saved in the previous episode to obtained our calculated raster ndvi data. We also use the <strong>squeeze()</strong> function in order to reduce our raster data ndvi dimension to 2D by removing the singular band dimension - this is necessary for use with the rasterize and zonal_stats functions:</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rioxarray</span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a><span class="co"># load in raster data from .tif file</span></span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>ndvi <span class="op">=</span> rioxarray.open_rasterio(<span class="st">'Data/NDVI.tif'</span>)</span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a><span class="co"># reduce raster data dimension to 2D</span></span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a>ndvi_sq <span class="op">=</span> ndvi.squeeze()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s also read the crop fields vector data from our saved cropped_field.shp file and view the CRS information.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a><span class="co"># read in the vector data from the .shp file</span></span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a>field <span class="op">=</span> gpd.read_file(<span class="st">'Data/cropped_field.shp'</span>)</span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>field.crs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>&lt;Derived Projected CRS: EPSG:28992&gt;
Name: Amersfoort / RD New
Axis Info [cartesian]:
- X[east]: Easting (metre)
- Y[north]: Northing (metre)
Area of Use:
- name: Netherlands - onshore, including Waddenzee, Dutch Wadden Islands and 12-mile offshore coastal zone.
- bounds: (3.2, 50.75, 7.22, 53.7)
Coordinate Operation:
- name: RD New
- method: Oblique Stereographic
Datum: Amersfoort
- Ellipsoid: Bessel 1841
- Prime Meridian: Greenwich</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Loading a .shp file
</div>
</div>
<div class="callout-body-container callout-body">
<p>All the files which come with the .shp file MUST be in the same folder (.cp, .dbf, .prj, .shx)</p>
</div>
</div>
<p>In order to use the vector data as a classifier for our raster, we need to convert the vector data to the appropriate CRS. We can perform the CRS conversion from the vector <strong>CRS (EPSG:28992)</strong> to our raster ndvi CRS (EPSG:32631) and view the data with:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert vector data to appropriate CRS</span></span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a>field_to_raster_crs <span class="op">=</span> field.to_crs(ndvi.rio.crs)</span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>field_to_raster_crs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">category</th>
<th data-quarto-table-cell-role="th">gewas</th>
<th data-quarto-table-cell-role="th">gewascode</th>
<th data-quarto-table-cell-role="th">jaar</th>
<th data-quarto-table-cell-role="th">status</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Grasland</td>
<td>Grasland, blijvend</td>
<td>265</td>
<td>2020</td>
<td>Definitief</td>
<td>POLYGON ((627394.386 5812746.538, 627393.681 5...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Grasland</td>
<td>Grasland, blijvend</td>
<td>265</td>
<td>2020</td>
<td>Definitief</td>
<td>POLYGON ((627326.170 5813192.913, 627324.734 5...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Grasland</td>
<td>Grasland, blijvend</td>
<td>265</td>
<td>2020</td>
<td>Definitief</td>
<td>POLYGON ((627093.646 5812863.661, 627090.972 5...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Grasland</td>
<td>Grasland, blijvend</td>
<td>265</td>
<td>2020</td>
<td>Definitief</td>
<td>POLYGON ((627384.004 5813467.330, 627376.549 5...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Grasland</td>
<td>Grasland, natuurlijk. Hoofdfunctie landbouw.</td>
<td>331</td>
<td>2020</td>
<td>Definitief</td>
<td>POLYGON ((627179.293 5812870.376, 627160.747 5...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4867</td>
<td>Grasland</td>
<td>Grasland, natuurlijk. Hoofdfunctie landbouw.</td>
<td>331</td>
<td>2020</td>
<td>Definitief</td>
<td>POLYGON ((640710.959 5809885.718, 640703.030 5...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4868</td>
<td>Grasland</td>
<td>Grasland, natuurlijk. Hoofdfunctie landbouw.</td>
<td>331</td>
<td>2020</td>
<td>Definitief</td>
<td>POLYGON ((640753.587 5810143.151, 640751.454 5...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4869</td>
<td>Grasland</td>
<td>Grasland, blijvend</td>
<td>265</td>
<td>2020</td>
<td>Definitief</td>
<td>POLYGON ((640890.832 5809998.743, 640892.271 5...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4870</td>
<td>Grasland</td>
<td>Grasland, natuurlijk. Hoofdfunctie landbouw.</td>
<td>331</td>
<td>2020</td>
<td>Definitief</td>
<td>POLYGON ((640770.878 5810005.390, 640766.767 5...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4871</td>
<td>Grasland</td>
<td>Grasland, natuurlijk. Hoofdfunctie landbouw.</td>
<td>331</td>
<td>2020</td>
<td>Definitief</td>
<td>POLYGON ((640704.702 5809791.384, 640698.357 5...</td>
</tr>
</tbody>
</table>

<p>4872 rows × 6 columns</p>
</div>
</div>
</div>
</section>
<section id="rasterizing-our-vector-data" class="level3">
<h3 class="anchored" data-anchor-id="rasterizing-our-vector-data">Rasterizing our vector data</h3>
<p>Before calculating zonal statistics, we first need to rasterize our <em>field_to_raster_crs</em> vector geodataframe with the <strong>rasterio.features.rasterize</strong> function. With this function, we aim to produce a grid with numerical values representing the types of crop as defined by the column <strong>gewascode</strong> from <em>field_cropped</em>. gewascode stands for the crop codes as defined by the Netherlands Enterprise Agency (RVO) for different types of crops or gewas (Grassland, permanent; Grassland, temporary; corn fields; etc.). This grid of values thus defines the zones for the <strong>xrspatial.zonal_stats</strong> function, where each pixel in the zone grid overlaps with a corresponding pixel in our NDVI raster.</p>
<p>We can generate the <em>geometry, gewascode</em> pairs for each vector feature to be used as the first argument to <strong>rasterio.features.rasterize</strong> as:</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="co"># generate geometty,gewascode pairings</span></span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a>geom <span class="op">=</span> field_to_raster_crs[[<span class="st">'geometry'</span>, <span class="st">'gewascode'</span>]].values.tolist()</span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Limit output to firat 10 items</span></span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a>geom[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>[[&lt;POLYGON ((627394.386 5812746.538, 627393.681 5812749.022, 627384.063 581279...&gt;,
  265],
 [&lt;POLYGON ((627326.17 5813192.913, 627324.734 5813196.828, 627324.11 5813203....&gt;,
  265],
 [&lt;POLYGON ((627093.646 5812863.661, 627090.972 5812870.702, 627076.762 581286...&gt;,
  265],
 [&lt;POLYGON ((627384.004 5813467.33, 627376.549 5813470.117, 627385.233 5813495...&gt;,
  265],
 [&lt;POLYGON ((627179.293 5812870.376, 627160.747 5812846.868, 627159.505 581284...&gt;,
  331],
 [&lt;POLYGON ((627419.816 5812765.254, 627416.356 5812766.811, 627413.1 5812769....&gt;,
  265],
 [&lt;POLYGON ((627358.683 5813335.376, 627362.871 5813352.853, 627370.175 581337...&gt;,
  265],
 [&lt;POLYGON ((627423.06 5813550.358, 627421.409 5813550.392, 627427.293 5813568...&gt;,
  265],
 [&lt;POLYGON ((627191.219 5813028.547, 627189.596 5813028.866, 627186.64 5813029...&gt;,
  265],
 [&lt;POLYGON ((627349.601 5813329.836, 627343.37 5813330.159, 627341.775 5813330...&gt;,
  265]]</code></pre>
</div>
</div>
<p>We can now rasterize our vector data using <strong>rasterio.features.rasterize</strong>:</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio <span class="im">import</span> features</span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>field_cropped_raster <span class="op">=</span> features.rasterize(geom, out_shape<span class="op">=</span>ndvi_sq.shape, fill<span class="op">=</span><span class="dv">0</span>, transform<span class="op">=</span>ndvi.rio.transform())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The argument <strong>out_shape</strong> specifies the shape of the output grid in pixel units, while transform represents the projection from pixel space to the projected coordinate space. We also need to specify the <strong>fill</strong> value for pixels that are not contained within a polygon in our shapefile, which we do with <em>fill = 0</em>. It’s important to pick a fill value that is not the same as any value already defined in gewascode or else we won’t distinguish between this zone and the background.</p>
<p>We convert the output of the rasterio.features.rasterize function, which generates a numpy array np.ndarray, to xarray.DataArray which will be used further:</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>field_cropped_raster_xarr <span class="op">=</span> xr.DataArray(field_cropped_raster)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="calculate-zonal-statistics" class="level3">
<h3 class="anchored" data-anchor-id="calculate-zonal-statistics">Calculate zonal statistics</h3>
<p>In order to calculate the statistics for each crop zone, we call the function, <strong>xrspatial.zonal_stats</strong>. The xrspatial.zonal_stats function takes as input zones, a 2D xarray.DataArray, that defines different zones, and values, a 2D xarray.DataArray providing input values for calculating statistics.</p>
<p>We call the zonal_stats function with <em>field_cropped_raster_xarr</em> as our classifier and the 2D raster with our values of interest ndvi_sq to obtain the NDVI statistics for each crop type:</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xrspatial <span class="im">import</span> zonal_stats</span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a>zonal_stats(field_cropped_raster_xarr, ndvi_sq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">zone</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">max</th>
<th data-quarto-table-cell-role="th">min</th>
<th data-quarto-table-cell-role="th">sum</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">var</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>0.266528</td>
<td>0.999579</td>
<td>-0.998648</td>
<td>38887.554688</td>
<td>0.409970</td>
<td>0.168075</td>
<td>145904.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>259</td>
<td>0.520282</td>
<td>0.885242</td>
<td>0.289196</td>
<td>449.003052</td>
<td>0.111205</td>
<td>0.012366</td>
<td>863.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>265</td>
<td>0.775609</td>
<td>0.925955</td>
<td>0.060755</td>
<td>66478.976562</td>
<td>0.091089</td>
<td>0.008297</td>
<td>85712.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>266</td>
<td>0.794128</td>
<td>0.918048</td>
<td>0.544686</td>
<td>1037.925781</td>
<td>0.074009</td>
<td>0.005477</td>
<td>1307.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>331</td>
<td>0.703056</td>
<td>0.905304</td>
<td>0.142226</td>
<td>10725.819336</td>
<td>0.102255</td>
<td>0.010456</td>
<td>15256.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>332</td>
<td>0.681699</td>
<td>0.849158</td>
<td>0.178113</td>
<td>321.080261</td>
<td>0.123633</td>
<td>0.015285</td>
<td>471.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>335</td>
<td>0.648063</td>
<td>0.865804</td>
<td>0.239661</td>
<td>313.662598</td>
<td>0.146582</td>
<td>0.021486</td>
<td>484.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>863</td>
<td>0.388575</td>
<td>0.510572</td>
<td>0.185987</td>
<td>1.165724</td>
<td>0.144245</td>
<td>0.020807</td>
<td>3.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The zonal_stats function calculates the minimum, maximum, and sum for each zone along with statistical measures such as the mean, variance and standard deviation for each rasterized vector zone.</p>
<ul>
<li><p>In our raster data-set zone = 0, corresponding to non-crop areas, has the highest count followed by zone = 265 which corresponds to ‘Grasland, blijvend’ (‘Grassland, permanent’).</p></li>
<li><p>The highest mean NDVI is observed for zone = 266 for ‘Grasslands, temporary’ with the lowest mean, aside from non-crop area, going to zone = 863 representing ‘Forest without replanting obligation’.</p></li>
</ul>
<p>Thus, the zonal_stats function can be used to analyse and understand different sections of our raster data. The definition of the zones can be derived from vector data or from classified raster data as presented in the challenge below:</p>
</section>
<section id="calculate-zonal-statistics-for-zones-defined-by-ndvi_classified" class="level3">
<h3 class="anchored" data-anchor-id="calculate-zonal-statistics-for-zones-defined-by-ndvi_classified">Calculate zonal statistics for zones defined by ndvi_classified</h3>
<p>To apply what we have just learned, let’s now calculate NDVI zonal statistics for the different zones as classified by ndvi_classified in the previous section.</p>
<p>First we’ll load both raster data-sets and convert into 2D xarray.DataArray. Then, we’ll calculate zonal statistics for each class_bins, and inspect the output of the zonal_stats function.</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load both raster data-sets and convert into 2D xarray.DataArray</span></span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a>ndvi <span class="op">=</span> rioxarray.open_rasterio(<span class="st">'Data/NDVI.tif'</span>)</span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a>ndvi_classified <span class="op">=</span> rioxarray.open_rasterio(<span class="st">'Data/NDVI_classified.tif'</span>)</span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-5"><a href="#cb216-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-6"><a href="#cb216-6" aria-hidden="true" tabindex="-1"></a><span class="co"># reduce raster data dimension to 2D</span></span>
<span id="cb216-7"><a href="#cb216-7" aria-hidden="true" tabindex="-1"></a>ndvi_classified_sq <span class="op">=</span> ndvi_classified.squeeze()</span>
<span id="cb216-8"><a href="#cb216-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-9"><a href="#cb216-9" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate zonal statistics for each class_bins</span></span>
<span id="cb216-10"><a href="#cb216-10" aria-hidden="true" tabindex="-1"></a>zonal_stats(ndvi_classified_sq, ndvi_sq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">zone</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">max</th>
<th data-quarto-table-cell-role="th">min</th>
<th data-quarto-table-cell-role="th">sum</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">var</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>-0.355660</td>
<td>-0.000257</td>
<td>-0.998648</td>
<td>-12838.253906</td>
<td>0.145916</td>
<td>0.021291</td>
<td>36097.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>0.110731</td>
<td>0.199839</td>
<td>0.000000</td>
<td>1754.752441</td>
<td>0.055864</td>
<td>0.003121</td>
<td>15847.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>0.507998</td>
<td>0.700000</td>
<td>0.200000</td>
<td>50410.167969</td>
<td>0.140193</td>
<td>0.019654</td>
<td>99233.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>0.798281</td>
<td>0.999579</td>
<td>0.700025</td>
<td>78888.523438</td>
<td>0.051730</td>
<td>0.002676</td>
<td>98823.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Key Points:<br>
- zones can be extracted by attribute columns of a vector dataset<br>
- zones can be rasterized using rasterio.features.rasterize<br>
- calculate zonal statistics with xrspatial.zonal_stats over the rasterized zones</p>
</div>
</div>
</section>
</section>
<section id="parallel-raster-computations-using-dask" class="level2">
<h2 class="anchored" data-anchor-id="parallel-raster-computations-using-dask">11. Parallel raster computations using Dask</h2>
<p>Very often raster computations involve applying the same operation to different pieces of data. Think, for instance, to the “pixel”-wise sum of two raster datasets, where the same sum operation is applied to all the matching grid-cells of the two rasters. This class of tasks can benefit from chunking the input raster(s) into smaller pieces: operations on different pieces can be run in parallel using multiple computing units (e.g., multi-core CPUs), thus potentially speeding up calculations. In addition, working on chunked data can lead to smaller memory footprints, since one may bypass the need to store the full dataset in memory by processing it chunk by chunk.</p>
<p>In this section, we will introduce the use of <strong><a href="https://www.dask.org/">Dask</a></strong> in the context of raster calculations. Dask is a Python library for parallel and distributed computing. It provides a framework to work with different data structures, including chunked arrays (Dask Arrays). Dask is well integrated with (rio)xarray objects, which can use Dask arrays as underlying data structures.</p>
<p>This section shows how Dask can be used to parallelize operations on local CPUs. However, the same library can be configured to run tasks on large compute clusters. More resources on Dask:</p>
<p><a href="https://docs.dask.org/en/stable/array.html">Dask Array</a></p>
<p><a href="https://docs.xarray.dev/en/stable/user-guide/dask.html">Xarray with Dask</a></p>
<p>It is important to realize, however, that many details determine the extent to which using Dask’s chunked arrays instead of regular NumPy arrays leads to faster calculations (and lower memory requirements). The actual operations to carry out, the size of the dataset, and parameters such as the chunks’ shape and size, all affects the performance of our computations. Depending on the specifics of the calculations, serial calculations might actually turn out to be faster! Being able to profile the computational time is thus essential, and we will see how to do that in a Jupyter environment in the next section.</p>
<section id="time-profiling-in-jupyter" class="level3">
<h3 class="anchored" data-anchor-id="time-profiling-in-jupyter">Time profiling in Jupyter</h3>
<p><img src="stopwatch.jpg" width="300" height="300"></p>
<p>We’ll continue from the results of the satellite image search that we carried out in the previous sections. We will load data starting from the <em>search.json</em> file. You can download the raster data using <a href="https://figshare.com/ndownloader/files/36028100">this link</a>. Save the <em>geospatial-python-raster-dataset.tar.gz</em> file in your current working directory, and extract the archive file by double-clicking on it or by running the following command in your terminal <em>tar -zxvf geospatial-python-raster-dataset.tar.gz</em>. Use the file <em>geospatial-python-raster-dataset/search.json</em> (instead of search.json) to get started.</p>
<p>Let’s set up a raster calculation using assets from our previous search of satellite scenes. We first load the item collection using the pystac library:</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pystac</span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a>items <span class="op">=</span> pystac.ItemCollection.from_file(<span class="st">"search.json"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s select the last scene, and extract the URLs of two assets: - the true-color image (“visual”) and - the scene classification layer (“SCL”). The latter is a mask where each grid cell is assigned a label that represents a specific class e.g.&nbsp;“4” for vegetation, “6” for water, etc. (all classes and labels are reported in the <a href="https://sentinels.copernicus.eu/web/sentinel/technical-guides/sentinel-2-msi/level-2a/algorithm">Sentinel-2 documentation</a>.</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="co"># last item's assets</span></span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>assets <span class="op">=</span> items[<span class="op">-</span><span class="dv">1</span>].assets</span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a><span class="co"># true color image</span></span>
<span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a>visual_href <span class="op">=</span> assets[<span class="st">"visual"</span>].href  </span>
<span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-7"><a href="#cb218-7" aria-hidden="true" tabindex="-1"></a><span class="co"># scene classification layer</span></span>
<span id="cb218-8"><a href="#cb218-8" aria-hidden="true" tabindex="-1"></a>scl_href <span class="op">=</span> assets[<span class="st">"SCL"</span>].href </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Opening the two assets with rioxarray shows that the true-color image is available as a raster file with 10 m resolution, while the scene classification layer has a lower resolution (20 m):</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rioxarray</span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a>scl <span class="op">=</span> rioxarray.open_rasterio(scl_href)</span>
<span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a>visual <span class="op">=</span> rioxarray.open_rasterio(visual_href)</span>
<span id="cb219-4"><a href="#cb219-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(scl.rio.resolution(), visual.rio.resolution())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(20.0, -20.0) (10.0, -10.0)</code></pre>
</div>
</div>
<p>In order to match the image and the mask pixels, we take advantage of a feature of the cloud-optimized GeoTIFF (COG) format, which is used to store these raster files. COGs typically include multiple lower-resolution versions of the original image, called “overviews”, in the same file. This allows to avoid downloading high-resolution images when only quick previews are required.</p>
<p>Overviews are often computed using powers of 2 as down-sampling (or zoom) factors (e.g.&nbsp;2, 4, 8, 16). For the true-color image we thus open the first level overview (zoom factor 2) and check that the resolution is now also 20 m:</p>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a>visual <span class="op">=</span> rioxarray.open_rasterio(visual_href, overview_level<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(visual.rio.resolution())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(20.0, -20.0)</code></pre>
</div>
</div>
<p>We can now time profile the first step of our raster calculation: the (down)loading of the rasters’ content. We do it by using the Jupyter magic <strong>%%time</strong>, which returns the time required to run the content of a cell:</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a>scl <span class="op">=</span> scl.load()</span>
<span id="cb223-3"><a href="#cb223-3" aria-hidden="true" tabindex="-1"></a>visual <span class="op">=</span> visual.load()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 614 ms, sys: 241 ms, total: 855 ms
Wall time: 9.31 s</code></pre>
</div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb225"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a>visual.plot.imshow(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a>scl.squeeze().plot.imshow(levels<span class="op">=</span><span class="bu">range</span>(<span class="dv">13</span>), figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7f655d6225c0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-135-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-135-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>After loading the raster files into memory, we run the following steps:</p>
<ul>
<li>we create a mask of the grid cells that are labeled as “cloud” in the scene classification layer (values “8” and “9”, standing for medium- and high-cloud probability, respectively)</li>
<li>we use this mask to set the corresponding grid cells in the true-color image to null values</li>
<li>we save the masked image to disk as in COG format</li>
</ul>
<p>Again, we measure the cell execution time using %%time:</p>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb227"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> scl.squeeze().isin([<span class="dv">8</span>, <span class="dv">9</span>])</span>
<span id="cb227-3"><a href="#cb227-3" aria-hidden="true" tabindex="-1"></a>visual_masked <span class="op">=</span> visual.where(<span class="op">~</span>mask, other<span class="op">=</span>visual.rio.nodata)</span>
<span id="cb227-4"><a href="#cb227-4" aria-hidden="true" tabindex="-1"></a>visual_masked.rio.to_raster(<span class="st">"band_masked.tif"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 164 ms, sys: 154 ms, total: 318 ms
Wall time: 317 ms</code></pre>
</div>
</div>
<p>We can inspect the masked image as:</p>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb229"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a>visual_masked.plot.imshow(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7f655d3e7640&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-137-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>In the following sub-section we will see how to parallelize these raster calculations, and we will compare timings to the serial calculations that we just ran.</p>
</section>
<section id="dask-powered-rasters" class="level3">
<h3 class="anchored" data-anchor-id="dask-powered-rasters">Dask-powered rasters</h3>
<section id="chunked-arrays" class="level4">
<h4 class="anchored" data-anchor-id="chunked-arrays">Chunked arrays</h4>
<p>As we have mentioned, rioxarray supports the use of Dask’s chunked arrays as underlying data structure. When opening a raster file with open_rasterio and providing the chunks argument, Dask arrays are employed instead of regular Numpy arrays. chunks describes the shape of the blocks which the data will be split in. As an example, we open the blue band raster (“B02”) using a chunk shape of (1, 4000, 4000) (block size of 1 in the first dimension and of 4000 in the second and third dimensions):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb231"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a>blue_band_href <span class="op">=</span> assets[<span class="st">"B02"</span>].href</span>
<span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a>blue_band <span class="op">=</span> rioxarray.open_rasterio(blue_band_href, chunks<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">4000</span>, <span class="dv">4000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Xarray and Dask also provide a graphical representation of the raster data array and of its blocked structure:</p>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb232"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a>blue_band</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">

<div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewbox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewbox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class="xr-text-repr-fallback">&lt;xarray.DataArray (band: 1, y: 10980, x: 10980)&gt;
dask.array&lt;open_rasterio-bb9b2ce30f7d0b7c18c953045067cb21&lt;this-array&gt;, shape=(1, 10980, 10980), dtype=uint16, chunksize=(1, 4000, 4000), chunktype=numpy.ndarray&gt;
Coordinates:
  * band         (band) int64 1
  * x            (x) float64 6e+05 6e+05 6e+05 ... 7.098e+05 7.098e+05 7.098e+05
  * y            (y) float64 5.9e+06 5.9e+06 5.9e+06 ... 5.79e+06 5.79e+06
    spatial_ref  int64 0
Attributes:
    AREA_OR_POINT:       Area
    OVR_RESAMPLING_ALG:  AVERAGE
    _FillValue:          0
    scale_factor:        1.0
    add_offset:          0.0</pre><div class="xr-wrap" style="display:none"><div class="xr-header"><div class="xr-obj-type">xarray.DataArray</div><div class="xr-array-name"></div><ul class="xr-dim-list"><li><span class="xr-has-index">band</span>: 1</li><li><span class="xr-has-index">y</span>: 10980</li><li><span class="xr-has-index">x</span>: 10980</li></ul></div><ul class="xr-sections"><li class="xr-section-item"><div class="xr-array-wrap"><input id="section-5f0e0573-a6b6-4164-812a-1299112a8c61" class="xr-array-in" type="checkbox" checked=""><label for="section-5f0e0573-a6b6-4164-812a-1299112a8c61" title="Show/hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-array-preview xr-preview"><span>dask.array&lt;chunksize=(1, 4000, 4000), meta=np.ndarray&gt;</span></div><div class="xr-array-data">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<tbody>
<tr class="odd">
<td><table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th></th>
<th data-quarto-table-cell-role="th">Array</th>
<th data-quarto-table-cell-role="th">Chunk</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Bytes</td>
<td>229.95 MiB</td>
<td>30.52 MiB</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Shape</td>
<td>(1, 10980, 10980)</td>
<td>(1, 4000, 4000)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Count</td>
<td>2 Graph Layers</td>
<td>9 Chunks</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Type</td>
<td>uint16</td>
<td>numpy.ndarray</td>
</tr>
</tbody>
</table></td>
<td><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTk0IiBoZWlnaHQ9IjE4NCIgc3R5bGU9InN0cm9rZTpyZ2IoMCwwLDApO3N0cm9rZS13aWR0aDoxIj4KCiAgPCEtLSBIb3Jpem9udGFsIGxpbmVzIC0tPgogIDxsaW5lIHgxPSIxMCIgeTE9IjAiIHgyPSIyNCIgeTI9IjE0IiBzdHlsZT0ic3Ryb2tlLXdpZHRoOjIiPjwvbGluZT4KICA8bGluZSB4MT0iMTAiIHkxPSI0MyIgeDI9IjI0IiB5Mj0iNTgiPjwvbGluZT4KICA8bGluZSB4MT0iMTAiIHkxPSI4NyIgeDI9IjI0IiB5Mj0iMTAyIj48L2xpbmU+CiAgPGxpbmUgeDE9IjEwIiB5MT0iMTIwIiB4Mj0iMjQiIHkyPSIxMzQiIHN0eWxlPSJzdHJva2Utd2lkdGg6MiI+PC9saW5lPgoKICA8IS0tIFZlcnRpY2FsIGxpbmVzIC0tPgogIDxsaW5lIHgxPSIxMCIgeTE9IjAiIHgyPSIxMCIgeTI9IjEyMCIgc3R5bGU9InN0cm9rZS13aWR0aDoyIj48L2xpbmU+CiAgPGxpbmUgeDE9IjI0IiB5MT0iMTQiIHgyPSIyNCIgeTI9IjEzNCIgc3R5bGU9InN0cm9rZS13aWR0aDoyIj48L2xpbmU+CgogIDwhLS0gQ29sb3JlZCBSZWN0YW5nbGUgLS0+CiAgPHBvbHlnb24gcG9pbnRzPSIxMC4wLDAuMCAyNC45NDg1OTc5NDk3NTQ0LDE0Ljk0ODU5Nzk0OTc1NDQwMyAyNC45NDg1OTc5NDk3NTQ0LDEzNC45NDg1OTc5NDk3NTQ0IDEwLjAsMTIwLjAiIHN0eWxlPSJmaWxsOiNFQ0IxNzJBMDtzdHJva2Utd2lkdGg6MCI+PC9wb2x5Z29uPgoKICA8IS0tIEhvcml6b250YWwgbGluZXMgLS0+CiAgPGxpbmUgeDE9IjEwIiB5MT0iMCIgeDI9IjEzMCIgeTI9IjAiIHN0eWxlPSJzdHJva2Utd2lkdGg6MiI+PC9saW5lPgogIDxsaW5lIHgxPSIyNCIgeTE9IjE0IiB4Mj0iMTQ0IiB5Mj0iMTQiIHN0eWxlPSJzdHJva2Utd2lkdGg6MiI+PC9saW5lPgoKICA8IS0tIFZlcnRpY2FsIGxpbmVzIC0tPgogIDxsaW5lIHgxPSIxMCIgeTE9IjAiIHgyPSIyNCIgeTI9IjE0IiBzdHlsZT0ic3Ryb2tlLXdpZHRoOjIiPjwvbGluZT4KICA8bGluZSB4MT0iNTMiIHkxPSIwIiB4Mj0iNjgiIHkyPSIxNCI+PC9saW5lPgogIDxsaW5lIHgxPSI5NyIgeTE9IjAiIHgyPSIxMTIiIHkyPSIxNCI+PC9saW5lPgogIDxsaW5lIHgxPSIxMzAiIHkxPSIwIiB4Mj0iMTQ0IiB5Mj0iMTQiIHN0eWxlPSJzdHJva2Utd2lkdGg6MiI+PC9saW5lPgoKICA8IS0tIENvbG9yZWQgUmVjdGFuZ2xlIC0tPgogIDxwb2x5Z29uIHBvaW50cz0iMTAuMCwwLjAgMTMwLjAsMC4wIDE0NC45NDg1OTc5NDk3NTQ0LDE0Ljk0ODU5Nzk0OTc1NDQwMyAyNC45NDg1OTc5NDk3NTQ0LDE0Ljk0ODU5Nzk0OTc1NDQwMyIgc3R5bGU9ImZpbGw6I0VDQjE3MkEwO3N0cm9rZS13aWR0aDowIj48L3BvbHlnb24+CgogIDwhLS0gSG9yaXpvbnRhbCBsaW5lcyAtLT4KICA8bGluZSB4MT0iMjQiIHkxPSIxNCIgeDI9IjE0NCIgeTI9IjE0IiBzdHlsZT0ic3Ryb2tlLXdpZHRoOjIiPjwvbGluZT4KICA8bGluZSB4MT0iMjQiIHkxPSI1OCIgeDI9IjE0NCIgeTI9IjU4Ij48L2xpbmU+CiAgPGxpbmUgeDE9IjI0IiB5MT0iMTAyIiB4Mj0iMTQ0IiB5Mj0iMTAyIj48L2xpbmU+CiAgPGxpbmUgeDE9IjI0IiB5MT0iMTM0IiB4Mj0iMTQ0IiB5Mj0iMTM0IiBzdHlsZT0ic3Ryb2tlLXdpZHRoOjIiPjwvbGluZT4KCiAgPCEtLSBWZXJ0aWNhbCBsaW5lcyAtLT4KICA8bGluZSB4MT0iMjQiIHkxPSIxNCIgeDI9IjI0IiB5Mj0iMTM0IiBzdHlsZT0ic3Ryb2tlLXdpZHRoOjIiPjwvbGluZT4KICA8bGluZSB4MT0iNjgiIHkxPSIxNCIgeDI9IjY4IiB5Mj0iMTM0Ij48L2xpbmU+CiAgPGxpbmUgeDE9IjExMiIgeTE9IjE0IiB4Mj0iMTEyIiB5Mj0iMTM0Ij48L2xpbmU+CiAgPGxpbmUgeDE9IjE0NCIgeTE9IjE0IiB4Mj0iMTQ0IiB5Mj0iMTM0IiBzdHlsZT0ic3Ryb2tlLXdpZHRoOjIiPjwvbGluZT4KCiAgPCEtLSBDb2xvcmVkIFJlY3RhbmdsZSAtLT4KICA8cG9seWdvbiBwb2ludHM9IjI0Ljk0ODU5Nzk0OTc1NDQsMTQuOTQ4NTk3OTQ5NzU0NDAzIDE0NC45NDg1OTc5NDk3NTQ0LDE0Ljk0ODU5Nzk0OTc1NDQwMyAxNDQuOTQ4NTk3OTQ5NzU0NCwxMzQuOTQ4NTk3OTQ5NzU0NCAyNC45NDg1OTc5NDk3NTQ0LDEzNC45NDg1OTc5NDk3NTQ0IiBzdHlsZT0iZmlsbDojRUNCMTcyQTA7c3Ryb2tlLXdpZHRoOjAiPjwvcG9seWdvbj4KCiAgPCEtLSBUZXh0IC0tPgogIDx0ZXh0IHg9Ijg0Ljk0ODU5OCIgeT0iMTU0Ljk0ODU5OCIgZm9udC1zaXplPSIxLjByZW0iIGZvbnQtd2VpZ2h0PSIxMDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiPjEwOTgwPC90ZXh0PgogIDx0ZXh0IHg9IjE2NC45NDg1OTgiIHk9Ijc0Ljk0ODU5OCIgZm9udC1zaXplPSIxLjByZW0iIGZvbnQtd2VpZ2h0PSIxMDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIHRyYW5zZm9ybT0icm90YXRlKC05MCwxNjQuOTQ4NTk4LDc0Ljk0ODU5OCkiPjEwOTgwPC90ZXh0PgogIDx0ZXh0IHg9IjcuNDc0Mjk5IiB5PSIxNDcuNDc0Mjk5IiBmb250LXNpemU9IjEuMHJlbSIgZm9udC13ZWlnaHQ9IjEwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgdHJhbnNmb3JtPSJyb3RhdGUoNDUsNy40NzQyOTksMTQ3LjQ3NDI5OSkiPjE8L3RleHQ+Cjwvc3ZnPg==" class="img-fluid"></td>
</tr>
</tbody>
</table>
</div></div></li><li class="xr-section-item"><input id="section-94e5f447-9dcf-4b48-a682-0aefdb391584" class="xr-section-summary-in" type="checkbox" checked=""><label for="section-94e5f447-9dcf-4b48-a682-0aefdb391584" class="xr-section-summary">Coordinates: <span>(4)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><ul class="xr-var-list"><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">band</span></div><div class="xr-var-dims">(band)</div><div class="xr-var-dtype">int64</div><div class="xr-var-preview xr-preview">1</div><input id="attrs-c0dc272b-0120-4b66-837d-5ba3afbc04b2" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-c0dc272b-0120-4b66-837d-5ba3afbc04b2" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-d3d738e9-2fcc-456b-82e2-aa2732dcf315" class="xr-var-data-in" type="checkbox"><label for="data-d3d738e9-2fcc-456b-82e2-aa2732dcf315" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([1])</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">x</span></div><div class="xr-var-dims">(x)</div><div class="xr-var-dtype">float64</div><div class="xr-var-preview xr-preview">6e+05 6e+05 ... 7.098e+05 7.098e+05</div><input id="attrs-95a2fcb4-e0bf-4e2f-818e-586b3e96be28" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-95a2fcb4-e0bf-4e2f-818e-586b3e96be28" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-176a08d9-fb65-4f52-8b80-1bff175a3477" class="xr-var-data-in" type="checkbox"><label for="data-176a08d9-fb65-4f52-8b80-1bff175a3477" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([600005., 600015., 600025., ..., 709775., 709785., 709795.])</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">y</span></div><div class="xr-var-dims">(y)</div><div class="xr-var-dtype">float64</div><div class="xr-var-preview xr-preview">5.9e+06 5.9e+06 ... 5.79e+06</div><input id="attrs-ffd3e3ff-dea6-4bef-8d3e-83349ebdd05e" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-ffd3e3ff-dea6-4bef-8d3e-83349ebdd05e" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-207d7af6-cc1c-49f2-933c-8c96fed92e40" class="xr-var-data-in" type="checkbox"><label for="data-207d7af6-cc1c-49f2-933c-8c96fed92e40" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([5900035., 5900025., 5900015., ..., 5790265., 5790255., 5790245.])</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span>spatial_ref</span></div><div class="xr-var-dims">()</div><div class="xr-var-dtype">int64</div><div class="xr-var-preview xr-preview">0</div><input id="attrs-c2a9021d-0b7d-46a1-b489-fe9482eb3c56" class="xr-var-attrs-in" type="checkbox"><label for="attrs-c2a9021d-0b7d-46a1-b489-fe9482eb3c56" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-bd3fe9ab-67c8-43c5-abf1-bf7cabfa2dc4" class="xr-var-data-in" type="checkbox"><label for="data-bd3fe9ab-67c8-43c5-abf1-bf7cabfa2dc4" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"><dt><span>crs_wkt :</span></dt><dd>PROJCS["WGS 84 / UTM zone 31N",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",3],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","32631"]]</dd><dt><span>semi_major_axis :</span></dt><dd>6378137.0</dd><dt><span>semi_minor_axis :</span></dt><dd>6356752.314245179</dd><dt><span>inverse_flattening :</span></dt><dd>298.257223563</dd><dt><span>reference_ellipsoid_name :</span></dt><dd>WGS 84</dd><dt><span>longitude_of_prime_meridian :</span></dt><dd>0.0</dd><dt><span>prime_meridian_name :</span></dt><dd>Greenwich</dd><dt><span>geographic_crs_name :</span></dt><dd>WGS 84</dd><dt><span>horizontal_datum_name :</span></dt><dd>World Geodetic System 1984</dd><dt><span>projected_crs_name :</span></dt><dd>WGS 84 / UTM zone 31N</dd><dt><span>grid_mapping_name :</span></dt><dd>transverse_mercator</dd><dt><span>latitude_of_projection_origin :</span></dt><dd>0.0</dd><dt><span>longitude_of_central_meridian :</span></dt><dd>3.0</dd><dt><span>false_easting :</span></dt><dd>500000.0</dd><dt><span>false_northing :</span></dt><dd>0.0</dd><dt><span>scale_factor_at_central_meridian :</span></dt><dd>0.9996</dd><dt><span>spatial_ref :</span></dt><dd>PROJCS["WGS 84 / UTM zone 31N",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",3],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","32631"]]</dd><dt><span>GeoTransform :</span></dt><dd>600000.0 10.0 0.0 5900040.0 0.0 -10.0</dd></dl></div><div class="xr-var-data"><pre>array(0)</pre></div></li></ul></div></li><li class="xr-section-item"><input id="section-d8f3bf78-8ccf-4d71-9d6f-243f5c1e04a7" class="xr-section-summary-in" type="checkbox"><label for="section-d8f3bf78-8ccf-4d71-9d6f-243f5c1e04a7" class="xr-section-summary">Indexes: <span>(3)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><ul class="xr-var-list"><li class="xr-var-item"><div class="xr-index-name"><div>band</div></div><div class="xr-index-preview">PandasIndex</div><div></div><input id="index-d7799e44-ed43-4fbe-b89c-1654cbeddd31" class="xr-index-data-in" type="checkbox"><label for="index-d7799e44-ed43-4fbe-b89c-1654cbeddd31" title="Show/Hide index repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-index-data"><pre>PandasIndex(Int64Index([1], dtype='int64', name='band'))</pre></div></li><li class="xr-var-item"><div class="xr-index-name"><div>x</div></div><div class="xr-index-preview">PandasIndex</div><div></div><input id="index-e4e4ee8d-5a5e-40f5-a947-c445251a7e54" class="xr-index-data-in" type="checkbox"><label for="index-e4e4ee8d-5a5e-40f5-a947-c445251a7e54" title="Show/Hide index repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-index-data"><pre>PandasIndex(Float64Index([600005.0, 600015.0, 600025.0, 600035.0, 600045.0, 600055.0,
              600065.0, 600075.0, 600085.0, 600095.0,
              ...
              709705.0, 709715.0, 709725.0, 709735.0, 709745.0, 709755.0,
              709765.0, 709775.0, 709785.0, 709795.0],
             dtype='float64', name='x', length=10980))</pre></div></li><li class="xr-var-item"><div class="xr-index-name"><div>y</div></div><div class="xr-index-preview">PandasIndex</div><div></div><input id="index-a2896e9d-730f-481c-8bc7-f869d6543a5a" class="xr-index-data-in" type="checkbox"><label for="index-a2896e9d-730f-481c-8bc7-f869d6543a5a" title="Show/Hide index repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-index-data"><pre>PandasIndex(Float64Index([5900035.0, 5900025.0, 5900015.0, 5900005.0, 5899995.0, 5899985.0,
              5899975.0, 5899965.0, 5899955.0, 5899945.0,
              ...
              5790335.0, 5790325.0, 5790315.0, 5790305.0, 5790295.0, 5790285.0,
              5790275.0, 5790265.0, 5790255.0, 5790245.0],
             dtype='float64', name='y', length=10980))</pre></div></li></ul></div></li><li class="xr-section-item"><input id="section-adf30ea2-d31f-4792-8c56-fc68301204e1" class="xr-section-summary-in" type="checkbox" checked=""><label for="section-adf30ea2-d31f-4792-8c56-fc68301204e1" class="xr-section-summary">Attributes: <span>(5)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><dl class="xr-attrs"><dt><span>AREA_OR_POINT :</span></dt><dd>Area</dd><dt><span>OVR_RESAMPLING_ALG :</span></dt><dd>AVERAGE</dd><dt><span>_FillValue :</span></dt><dd>0</dd><dt><span>scale_factor :</span></dt><dd>1.0</dd><dt><span>add_offset :</span></dt><dd>0.0</dd></dl></div></li></ul></div></div>
</div>
</div>
<p>We have already seen how COGs are regular GeoTIFF files with a special internal structure. Another feature of COGs is that data is organized in “blocks” that can be accessed remotely via independent HTTP requests, enabling partial file readings. This is useful if you want to access only a portion of your raster file, but it also allows for efficient parallel reading. You can check the blocksize employed in a COG file with the following code snippet:</p>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb233"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> rasterio.<span class="bu">open</span>(visual_href) <span class="im">as</span> r:</span>
<span id="cb233-3"><a href="#cb233-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> r.is_tiled:</span>
<span id="cb233-4"><a href="#cb233-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Chunk size: </span><span class="sc">{</span>r<span class="sc">.</span>block_shapes<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chunk size: [(1024, 1024), (1024, 1024), (1024, 1024)]</code></pre>
</div>
</div>
<p>In order to optimally access COGs it is best to align the blocksize of the file with the chunks employed when loading the file.</p>
<p>Let’s open the blue-band asset (“B02”) of a Sentinel-2 scene as a chunked DataArray object using a suitable chunk size:</p>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb235"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> rasterio.<span class="bu">open</span>(blue_band_href) <span class="im">as</span> r:</span>
<span id="cb235-3"><a href="#cb235-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> r.is_tiled:</span>
<span id="cb235-4"><a href="#cb235-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Chunk size: </span><span class="sc">{</span>r<span class="sc">.</span>block_shapes<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chunk size: [(1024, 1024)]</code></pre>
</div>
</div>
<p>deal chunk size values for this raster are thus multiples of 1024. An element to consider is the number of resulting chunks and their size. Chunks should not be too big nor too small (i.e.&nbsp;too many). As a rule of thumb, chunk sizes of 100 MB typically work well with Dask (see, e.g., this <a href="https://blog.dask.org/2021/11/02/choosing-dask-chunk-sizes">blog post</a>. Also, the shape might be relevant, depending on the application! Here, we might select a chunks shape of (1, 6144, 6144):</p>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb237"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a>band <span class="op">=</span> rioxarray.open_rasterio(blue_band_href, chunks<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">6144</span>, <span class="dv">6144</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which leads to chunks 72 MB large: ((1 x 6144 x 6144) x 2 bytes / 2^20 = 72 MB). Also, we can let rioxarray and Dask figure out appropriate chunk shapes by setting chunks=“auto”:</p>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb238"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>band <span class="op">=</span> rioxarray.open_rasterio(blue_band_href, chunks<span class="op">=</span><span class="st">"auto"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which leads to (1, 8192, 8192) chunks (128 MB) as illustrated below:</p>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a>band</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">

<div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewbox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewbox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class="xr-text-repr-fallback">&lt;xarray.DataArray (band: 1, y: 10980, x: 10980)&gt;
dask.array&lt;open_rasterio-e0482a83b59aad29d7a36b8e8d497165&lt;this-array&gt;, shape=(1, 10980, 10980), dtype=uint16, chunksize=(1, 8192, 8192), chunktype=numpy.ndarray&gt;
Coordinates:
  * band         (band) int64 1
  * x            (x) float64 6e+05 6e+05 6e+05 ... 7.098e+05 7.098e+05 7.098e+05
  * y            (y) float64 5.9e+06 5.9e+06 5.9e+06 ... 5.79e+06 5.79e+06
    spatial_ref  int64 0
Attributes:
    AREA_OR_POINT:       Area
    OVR_RESAMPLING_ALG:  AVERAGE
    _FillValue:          0
    scale_factor:        1.0
    add_offset:          0.0</pre><div class="xr-wrap" style="display:none"><div class="xr-header"><div class="xr-obj-type">xarray.DataArray</div><div class="xr-array-name"></div><ul class="xr-dim-list"><li><span class="xr-has-index">band</span>: 1</li><li><span class="xr-has-index">y</span>: 10980</li><li><span class="xr-has-index">x</span>: 10980</li></ul></div><ul class="xr-sections"><li class="xr-section-item"><div class="xr-array-wrap"><input id="section-cf70764c-9b13-486d-a5a4-1bb4848807e7" class="xr-array-in" type="checkbox" checked=""><label for="section-cf70764c-9b13-486d-a5a4-1bb4848807e7" title="Show/hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-array-preview xr-preview"><span>dask.array&lt;chunksize=(1, 8192, 8192), meta=np.ndarray&gt;</span></div><div class="xr-array-data">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<tbody>
<tr class="odd">
<td><table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th></th>
<th data-quarto-table-cell-role="th">Array</th>
<th data-quarto-table-cell-role="th">Chunk</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Bytes</td>
<td>229.95 MiB</td>
<td>128.00 MiB</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Shape</td>
<td>(1, 10980, 10980)</td>
<td>(1, 8192, 8192)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Count</td>
<td>2 Graph Layers</td>
<td>4 Chunks</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Type</td>
<td>uint16</td>
<td>numpy.ndarray</td>
</tr>
</tbody>
</table></td>
<td><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTk0IiBoZWlnaHQ9IjE4NCIgc3R5bGU9InN0cm9rZTpyZ2IoMCwwLDApO3N0cm9rZS13aWR0aDoxIj4KCiAgPCEtLSBIb3Jpem9udGFsIGxpbmVzIC0tPgogIDxsaW5lIHgxPSIxMCIgeTE9IjAiIHgyPSIyNCIgeTI9IjE0IiBzdHlsZT0ic3Ryb2tlLXdpZHRoOjIiPjwvbGluZT4KICA8bGluZSB4MT0iMTAiIHkxPSI4OSIgeDI9IjI0IiB5Mj0iMTA0Ij48L2xpbmU+CiAgPGxpbmUgeDE9IjEwIiB5MT0iMTIwIiB4Mj0iMjQiIHkyPSIxMzQiIHN0eWxlPSJzdHJva2Utd2lkdGg6MiI+PC9saW5lPgoKICA8IS0tIFZlcnRpY2FsIGxpbmVzIC0tPgogIDxsaW5lIHgxPSIxMCIgeTE9IjAiIHgyPSIxMCIgeTI9IjEyMCIgc3R5bGU9InN0cm9rZS13aWR0aDoyIj48L2xpbmU+CiAgPGxpbmUgeDE9IjI0IiB5MT0iMTQiIHgyPSIyNCIgeTI9IjEzNCIgc3R5bGU9InN0cm9rZS13aWR0aDoyIj48L2xpbmU+CgogIDwhLS0gQ29sb3JlZCBSZWN0YW5nbGUgLS0+CiAgPHBvbHlnb24gcG9pbnRzPSIxMC4wLDAuMCAyNC45NDg1OTc5NDk3NTQ0LDE0Ljk0ODU5Nzk0OTc1NDQwMyAyNC45NDg1OTc5NDk3NTQ0LDEzNC45NDg1OTc5NDk3NTQ0IDEwLjAsMTIwLjAiIHN0eWxlPSJmaWxsOiNFQ0IxNzJBMDtzdHJva2Utd2lkdGg6MCI+PC9wb2x5Z29uPgoKICA8IS0tIEhvcml6b250YWwgbGluZXMgLS0+CiAgPGxpbmUgeDE9IjEwIiB5MT0iMCIgeDI9IjEzMCIgeTI9IjAiIHN0eWxlPSJzdHJva2Utd2lkdGg6MiI+PC9saW5lPgogIDxsaW5lIHgxPSIyNCIgeTE9IjE0IiB4Mj0iMTQ0IiB5Mj0iMTQiIHN0eWxlPSJzdHJva2Utd2lkdGg6MiI+PC9saW5lPgoKICA8IS0tIFZlcnRpY2FsIGxpbmVzIC0tPgogIDxsaW5lIHgxPSIxMCIgeTE9IjAiIHgyPSIyNCIgeTI9IjE0IiBzdHlsZT0ic3Ryb2tlLXdpZHRoOjIiPjwvbGluZT4KICA8bGluZSB4MT0iOTkiIHkxPSIwIiB4Mj0iMTE0IiB5Mj0iMTQiPjwvbGluZT4KICA8bGluZSB4MT0iMTMwIiB5MT0iMCIgeDI9IjE0NCIgeTI9IjE0IiBzdHlsZT0ic3Ryb2tlLXdpZHRoOjIiPjwvbGluZT4KCiAgPCEtLSBDb2xvcmVkIFJlY3RhbmdsZSAtLT4KICA8cG9seWdvbiBwb2ludHM9IjEwLjAsMC4wIDEzMC4wLDAuMCAxNDQuOTQ4NTk3OTQ5NzU0NCwxNC45NDg1OTc5NDk3NTQ0MDMgMjQuOTQ4NTk3OTQ5NzU0NCwxNC45NDg1OTc5NDk3NTQ0MDMiIHN0eWxlPSJmaWxsOiNFQ0IxNzJBMDtzdHJva2Utd2lkdGg6MCI+PC9wb2x5Z29uPgoKICA8IS0tIEhvcml6b250YWwgbGluZXMgLS0+CiAgPGxpbmUgeDE9IjI0IiB5MT0iMTQiIHgyPSIxNDQiIHkyPSIxNCIgc3R5bGU9InN0cm9rZS13aWR0aDoyIj48L2xpbmU+CiAgPGxpbmUgeDE9IjI0IiB5MT0iMTA0IiB4Mj0iMTQ0IiB5Mj0iMTA0Ij48L2xpbmU+CiAgPGxpbmUgeDE9IjI0IiB5MT0iMTM0IiB4Mj0iMTQ0IiB5Mj0iMTM0IiBzdHlsZT0ic3Ryb2tlLXdpZHRoOjIiPjwvbGluZT4KCiAgPCEtLSBWZXJ0aWNhbCBsaW5lcyAtLT4KICA8bGluZSB4MT0iMjQiIHkxPSIxNCIgeDI9IjI0IiB5Mj0iMTM0IiBzdHlsZT0ic3Ryb2tlLXdpZHRoOjIiPjwvbGluZT4KICA8bGluZSB4MT0iMTE0IiB5MT0iMTQiIHgyPSIxMTQiIHkyPSIxMzQiPjwvbGluZT4KICA8bGluZSB4MT0iMTQ0IiB5MT0iMTQiIHgyPSIxNDQiIHkyPSIxMzQiIHN0eWxlPSJzdHJva2Utd2lkdGg6MiI+PC9saW5lPgoKICA8IS0tIENvbG9yZWQgUmVjdGFuZ2xlIC0tPgogIDxwb2x5Z29uIHBvaW50cz0iMjQuOTQ4NTk3OTQ5NzU0NCwxNC45NDg1OTc5NDk3NTQ0MDMgMTQ0Ljk0ODU5Nzk0OTc1NDQsMTQuOTQ4NTk3OTQ5NzU0NDAzIDE0NC45NDg1OTc5NDk3NTQ0LDEzNC45NDg1OTc5NDk3NTQ0IDI0Ljk0ODU5Nzk0OTc1NDQsMTM0Ljk0ODU5Nzk0OTc1NDQiIHN0eWxlPSJmaWxsOiNFQ0IxNzJBMDtzdHJva2Utd2lkdGg6MCI+PC9wb2x5Z29uPgoKICA8IS0tIFRleHQgLS0+CiAgPHRleHQgeD0iODQuOTQ4NTk4IiB5PSIxNTQuOTQ4NTk4IiBmb250LXNpemU9IjEuMHJlbSIgZm9udC13ZWlnaHQ9IjEwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+MTA5ODA8L3RleHQ+CiAgPHRleHQgeD0iMTY0Ljk0ODU5OCIgeT0iNzQuOTQ4NTk4IiBmb250LXNpemU9IjEuMHJlbSIgZm9udC13ZWlnaHQ9IjEwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgdHJhbnNmb3JtPSJyb3RhdGUoLTkwLDE2NC45NDg1OTgsNzQuOTQ4NTk4KSI+MTA5ODA8L3RleHQ+CiAgPHRleHQgeD0iNy40NzQyOTkiIHk9IjE0Ny40NzQyOTkiIGZvbnQtc2l6ZT0iMS4wcmVtIiBmb250LXdlaWdodD0iMTAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB0cmFuc2Zvcm09InJvdGF0ZSg0NSw3LjQ3NDI5OSwxNDcuNDc0Mjk5KSI+MTwvdGV4dD4KPC9zdmc+" class="img-fluid"></td>
</tr>
</tbody>
</table>
</div></div></li><li class="xr-section-item"><input id="section-212b5437-cd3e-4589-a6f1-6063fef99e7b" class="xr-section-summary-in" type="checkbox" checked=""><label for="section-212b5437-cd3e-4589-a6f1-6063fef99e7b" class="xr-section-summary">Coordinates: <span>(4)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><ul class="xr-var-list"><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">band</span></div><div class="xr-var-dims">(band)</div><div class="xr-var-dtype">int64</div><div class="xr-var-preview xr-preview">1</div><input id="attrs-101483b5-3b66-4d15-a7fc-535255f61b34" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-101483b5-3b66-4d15-a7fc-535255f61b34" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-233880e3-8de0-49b9-9d4b-9793176746f3" class="xr-var-data-in" type="checkbox"><label for="data-233880e3-8de0-49b9-9d4b-9793176746f3" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([1])</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">x</span></div><div class="xr-var-dims">(x)</div><div class="xr-var-dtype">float64</div><div class="xr-var-preview xr-preview">6e+05 6e+05 ... 7.098e+05 7.098e+05</div><input id="attrs-7a4ee18f-4a5b-4328-86c9-f21e70dd83ea" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-7a4ee18f-4a5b-4328-86c9-f21e70dd83ea" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-8dcf64c6-7b55-470f-8f1e-c9d56711af46" class="xr-var-data-in" type="checkbox"><label for="data-8dcf64c6-7b55-470f-8f1e-c9d56711af46" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([600005., 600015., 600025., ..., 709775., 709785., 709795.])</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">y</span></div><div class="xr-var-dims">(y)</div><div class="xr-var-dtype">float64</div><div class="xr-var-preview xr-preview">5.9e+06 5.9e+06 ... 5.79e+06</div><input id="attrs-4eac12d2-e967-4902-8db3-d58eb85075aa" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-4eac12d2-e967-4902-8db3-d58eb85075aa" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-ac1d7504-ef57-4246-8686-47277f892f3b" class="xr-var-data-in" type="checkbox"><label for="data-ac1d7504-ef57-4246-8686-47277f892f3b" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([5900035., 5900025., 5900015., ..., 5790265., 5790255., 5790245.])</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span>spatial_ref</span></div><div class="xr-var-dims">()</div><div class="xr-var-dtype">int64</div><div class="xr-var-preview xr-preview">0</div><input id="attrs-88f990b6-bddb-40b1-ae8e-102331ce8bf1" class="xr-var-attrs-in" type="checkbox"><label for="attrs-88f990b6-bddb-40b1-ae8e-102331ce8bf1" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-dafb84c8-4059-499d-bf4e-4d94371f4a5f" class="xr-var-data-in" type="checkbox"><label for="data-dafb84c8-4059-499d-bf4e-4d94371f4a5f" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"><dt><span>crs_wkt :</span></dt><dd>PROJCS["WGS 84 / UTM zone 31N",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",3],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","32631"]]</dd><dt><span>semi_major_axis :</span></dt><dd>6378137.0</dd><dt><span>semi_minor_axis :</span></dt><dd>6356752.314245179</dd><dt><span>inverse_flattening :</span></dt><dd>298.257223563</dd><dt><span>reference_ellipsoid_name :</span></dt><dd>WGS 84</dd><dt><span>longitude_of_prime_meridian :</span></dt><dd>0.0</dd><dt><span>prime_meridian_name :</span></dt><dd>Greenwich</dd><dt><span>geographic_crs_name :</span></dt><dd>WGS 84</dd><dt><span>horizontal_datum_name :</span></dt><dd>World Geodetic System 1984</dd><dt><span>projected_crs_name :</span></dt><dd>WGS 84 / UTM zone 31N</dd><dt><span>grid_mapping_name :</span></dt><dd>transverse_mercator</dd><dt><span>latitude_of_projection_origin :</span></dt><dd>0.0</dd><dt><span>longitude_of_central_meridian :</span></dt><dd>3.0</dd><dt><span>false_easting :</span></dt><dd>500000.0</dd><dt><span>false_northing :</span></dt><dd>0.0</dd><dt><span>scale_factor_at_central_meridian :</span></dt><dd>0.9996</dd><dt><span>spatial_ref :</span></dt><dd>PROJCS["WGS 84 / UTM zone 31N",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",3],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","32631"]]</dd><dt><span>GeoTransform :</span></dt><dd>600000.0 10.0 0.0 5900040.0 0.0 -10.0</dd></dl></div><div class="xr-var-data"><pre>array(0)</pre></div></li></ul></div></li><li class="xr-section-item"><input id="section-f8e792b3-3158-4650-bf01-bc64f02269aa" class="xr-section-summary-in" type="checkbox"><label for="section-f8e792b3-3158-4650-bf01-bc64f02269aa" class="xr-section-summary">Indexes: <span>(3)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><ul class="xr-var-list"><li class="xr-var-item"><div class="xr-index-name"><div>band</div></div><div class="xr-index-preview">PandasIndex</div><div></div><input id="index-0fc5a555-0633-4b7d-9db7-d46c54bad47f" class="xr-index-data-in" type="checkbox"><label for="index-0fc5a555-0633-4b7d-9db7-d46c54bad47f" title="Show/Hide index repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-index-data"><pre>PandasIndex(Int64Index([1], dtype='int64', name='band'))</pre></div></li><li class="xr-var-item"><div class="xr-index-name"><div>x</div></div><div class="xr-index-preview">PandasIndex</div><div></div><input id="index-96a6b748-8787-43f3-9ab1-16a2bce043c8" class="xr-index-data-in" type="checkbox"><label for="index-96a6b748-8787-43f3-9ab1-16a2bce043c8" title="Show/Hide index repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-index-data"><pre>PandasIndex(Float64Index([600005.0, 600015.0, 600025.0, 600035.0, 600045.0, 600055.0,
              600065.0, 600075.0, 600085.0, 600095.0,
              ...
              709705.0, 709715.0, 709725.0, 709735.0, 709745.0, 709755.0,
              709765.0, 709775.0, 709785.0, 709795.0],
             dtype='float64', name='x', length=10980))</pre></div></li><li class="xr-var-item"><div class="xr-index-name"><div>y</div></div><div class="xr-index-preview">PandasIndex</div><div></div><input id="index-3fd898fc-e9c4-4d1b-823d-1a54d8611283" class="xr-index-data-in" type="checkbox"><label for="index-3fd898fc-e9c4-4d1b-823d-1a54d8611283" title="Show/Hide index repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-index-data"><pre>PandasIndex(Float64Index([5900035.0, 5900025.0, 5900015.0, 5900005.0, 5899995.0, 5899985.0,
              5899975.0, 5899965.0, 5899955.0, 5899945.0,
              ...
              5790335.0, 5790325.0, 5790315.0, 5790305.0, 5790295.0, 5790285.0,
              5790275.0, 5790265.0, 5790255.0, 5790245.0],
             dtype='float64', name='y', length=10980))</pre></div></li></ul></div></li><li class="xr-section-item"><input id="section-d19fc544-8759-4030-8d0a-c25cb28dcf03" class="xr-section-summary-in" type="checkbox" checked=""><label for="section-d19fc544-8759-4030-8d0a-c25cb28dcf03" class="xr-section-summary">Attributes: <span>(5)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><dl class="xr-attrs"><dt><span>AREA_OR_POINT :</span></dt><dd>Area</dd><dt><span>OVR_RESAMPLING_ALG :</span></dt><dd>AVERAGE</dd><dt><span>_FillValue :</span></dt><dd>0</dd><dt><span>scale_factor :</span></dt><dd>1.0</dd><dt><span>add_offset :</span></dt><dd>0.0</dd></dl></div></li></ul></div></div>
</div>
</div>
</section>
</section>
<section id="parallel-computations" class="level3">
<h3 class="anchored" data-anchor-id="parallel-computations">Parallel computations</h3>
<p>Operations performed on a DataArray that has been opened as a chunked Dask array are executed using Dask. Dask coordinates how the operations should be executed on the individual chunks of data, and runs these tasks in parallel as much as possible.</p>
<p>Let’s now repeat the raster calculations that we have carried out in the previous section, but running calculations in parallel over a multi-core CPU. We first open the relevant rasters as chunked arrays:</p>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb240"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a>scl <span class="op">=</span> rioxarray.open_rasterio(scl_href, lock<span class="op">=</span><span class="va">False</span>, chunks<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">2048</span>, <span class="dv">2048</span>))</span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a>visual <span class="op">=</span> rioxarray.open_rasterio(visual_href, overview_level<span class="op">=</span><span class="dv">0</span>, lock<span class="op">=</span><span class="va">False</span>, chunks<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">2048</span>, <span class="dv">2048</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Setting lock=False tells rioxarray that the individual data chunks can be loaded simultaneously from the source by the Dask workers.</p>
<p>As the next step, we trigger the download of the data using the .persist() method, see below. This makes sure that the downloaded chunks are stored in the form of a chunked Dask array (calling .load() would instead merge the chunks in a single Numpy array).</p>
<p>We explicitly tell Dask to parallelize the required workload over 4 threads. Don’t forget to add the Jupyter magic to record the timing!</p>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a>scl <span class="op">=</span> scl.persist(scheduler<span class="op">=</span><span class="st">"threads"</span>, num_workers<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a>visual <span class="op">=</span> visual.persist(scheduler<span class="op">=</span><span class="st">"threads"</span>, num_workers<span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 2.04 s, sys: 168 ms, total: 2.21 s
Wall time: 13.5 s</code></pre>
</div>
</div>
<p>So downloading chunks of data using 4 workers was actually slower (13.5 s vs 9.31 s).</p>
<p>Let’s now continue to the second step of the calculation. Note how the same syntax as for its serial version is employed for creating and applying the cloud mask. Only the raster saving includes additional arguments:</p>
<ul>
<li>tiled=True: write raster as a chunked GeoTIFF.</li>
<li>lock=threading.Lock(): the threads which are splitting the workload must “synchronise” when writing to the same file (they might otherwise overwrite each other’s output).</li>
<li>compute=False: do not immediately run the calculation, more on this later.</li>
</ul>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb243"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> threading <span class="im">import</span> Lock</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb244"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> scl.squeeze().isin([<span class="dv">8</span>, <span class="dv">9</span>])</span>
<span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a>visual_masked <span class="op">=</span> visual.where(<span class="op">~</span>mask, other<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb244-4"><a href="#cb244-4" aria-hidden="true" tabindex="-1"></a>visual_store <span class="op">=</span> visual_masked.rio.to_raster(<span class="st">"band_masked.tif"</span>, tiled<span class="op">=</span><span class="va">True</span>, lock<span class="op">=</span>Lock(), compute<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 13.1 ms, sys: 12 ms, total: 25.1 ms
Wall time: 21.1 ms</code></pre>
</div>
</div>
<p>Did we just observe a 15x speed-up when comparing to the serial calculation (317 ms vs 21.1 ms)? Actually, no calculation has run yet. This is because operations performed on Dask arrays are executed “lazily”, i.e.&nbsp;they are not immediately run.</p>
</section>
<section id="dask-graph" class="level3">
<h3 class="anchored" data-anchor-id="dask-graph">Dask graph</h3>
<p>The sequence of operations to carry out is stored in a task graph, which can be visualized with:</p>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dask</span>
<span id="cb246-2"><a href="#cb246-2" aria-hidden="true" tabindex="-1"></a>dask.visualize(visual_store)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<p><img src="Working with Geospatial Data in Python_files/figure-html/cell-149-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The task graph gives Dask the complete “overview” of the calculation, thus enabling a better management of tasks and resources when dispatching calculations to be run in parallel.</p>
<p>While most methods of DataArray’s run operations lazily when Dask arrays are employed, some methods by default trigger immediate calculations, like the method to_raster() (we have changed this behaviour by specifying compute=False). In order to trigger calculations, we can use the .compute() method. Again, we explicitly tell Dask to run tasks on 4 threads. Let’s time the cell execution:</p>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb247"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a>visual_store.compute(scheduler<span class="op">=</span><span class="st">"threads"</span>, num_workers<span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 292 ms, sys: 39.3 ms, total: 331 ms
Wall time: 176 ms</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>[None, None, None, None, None, None, None, None, None]</code></pre>
</div>
</div>
<p>The timing that we have recorded for this step is about half the speed of the one recorded for the serial calculation, despite the overhead that Dask introduces to manage the tasks in the Dask graph. This overhead, which is typically of the order of milliseconds per task, can sometimes be larger than the parallelization gain, and this is typically the case for calculations with small chunks (note that here we have used chunks that are only 4 to 32 MB large).</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Key Points:<br>
- The %%time Jupyter magic command can be used to profile calculations<br>
- data ‘chunks’ are the unit of parallelization in raster calculations<br>
- (rio)xarray can open raster files as chunked arrays<br>
- the chunk shape and size can significantly affect the calculation performance<br>
- cloud-optimized GeoTIFFs have an internal structure that enables performant parallel read</p>
</div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>
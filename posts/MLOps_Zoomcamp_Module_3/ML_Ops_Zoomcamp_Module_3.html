<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Stephen Barrie">
<meta name="dcterms.date" content="2023-06-08">

<title>Into the Unknown - mlops-zoomcamp | Module 3: Orchestration</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Into the Unknown</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">Stephen Barrie</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Stephen137" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://linkedin.com/in/sjbarrie" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">mlops-zoomcamp | Module 3: Orchestration</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">MLOps</div>
                <div class="quarto-category">DataTalksClub</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Stephen Barrie </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">June 8, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction-to-workflow-orchestration" id="toc-introduction-to-workflow-orchestration" class="nav-link active" data-scroll-target="#introduction-to-workflow-orchestration">3.1 Introduction to Workflow Orchestration</a></li>
  <li><a href="#introduction-to-prefect" id="toc-introduction-to-prefect" class="nav-link" data-scroll-target="#introduction-to-prefect">3.2 Introduction to Prefect</a></li>
  <li><a href="#prefect-workflow" id="toc-prefect-workflow" class="nav-link" data-scroll-target="#prefect-workflow">3.3 Prefect Workflow</a></li>
  <li><a href="#deploying-your-workflow" id="toc-deploying-your-workflow" class="nav-link" data-scroll-target="#deploying-your-workflow">3.4 Deploying your Workflow</a></li>
  <li><a href="#working-with-deployments" id="toc-working-with-deployments" class="nav-link" data-scroll-target="#working-with-deployments">3.5 Working with Deployments</a></li>
  <li><a href="#prefect-cloud" id="toc-prefect-cloud" class="nav-link" data-scroll-target="#prefect-cloud">3.6 Prefect Cloud</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="introduction-to-workflow-orchestration" class="level3">
<h3 class="anchored" data-anchor-id="introduction-to-workflow-orchestration">3.1 Introduction to Workflow Orchestration</h3>
<p>Orchestrating an ML workflow can be quite challenging. There are a lot of potential breakpoints in the flow, as indicated by the red crosses in the example typical flow below :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/7985c817-ae3f-4b06-b7ad-c4a5be6efb81-2-5c4a30a6-4a39-4bd2-a17a-5533062dd67e.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">typical_mlflow.PNG</figcaption>
</figure>
</div>
<p>Thankfully there are tools avaialable to help with this. <a href="https://www.prefect.io/">Prefect</a> provides a modern, robust, and user-friendly approach to workflow orchestration, simplifying the management of complex data pipelines and enabling efficient and reliable execution. monitoring and visualization of your workflows.</p>
<p>A screenshot of the Prefect UI illustrating how a typical flow might be orchestrated is included below :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/7985c817-ae3f-4b06-b7ad-c4a5be6efb81-1-2d954052-efcf-49dc-9214-2453d17ea473.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">prefect_ui.PNG</figcaption>
</figure>
</div>
</section>
<section id="introduction-to-prefect" class="level3">
<h3 class="anchored" data-anchor-id="introduction-to-prefect">3.2 Introduction to Prefect</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/cec5f8e8-85d2-4966-8e95-6a8af1e133a9-1-c372cec2-c169-43e5-bddc-af4cc2126188.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">goals_3.2.PNG</figcaption>
</figure>
</div>
<section id="why-use-prefect" class="level4">
<h4 class="anchored" data-anchor-id="why-use-prefect">3.2.1 Why use Prefect?</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/24f13b5a-1120-4a68-b62f-ce0ef243ea04-1-6f845297-335f-49cb-867c-c22357338b3b.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">why_prefect.PNG</figcaption>
</figure>
</div>
<p><code>Ease of Use:</code><br>
Prefect provides a user-friendly interface and a Python-based API, making it easy to define and manage workflows. It allows you to write workflows as code, leveraging your existing Python knowledge and infrastructure.</p>
<p><code>Flexibility:</code><br>
Prefect offers a flexible and extensible framework for defining workflows. It supports complex dependencies and allows you to handle dynamic data-driven workflows. You can easily create, update, and version your workflows as your needs evolve.</p>
<p><code>Fault Tolerance:</code><br>
Prefect provides built-in fault tolerance and retry mechanisms. It handles failures gracefully by automatically retrying failed tasks and recovering from errors. You can configure custom error handling and notifications to ensure that your workflows run reliably.</p>
<p><code>Monitoring and Observability:</code><br>
Prefect offers comprehensive monitoring and observability features. It provides a web-based dashboard where you can visualize and track the status of your workflows, inspect task-level details, and monitor execution metrics. This allows for easy debugging, performance optimization, and troubleshooting.</p>
<p><code>Scalability:</code><br>
Prefect is designed to scale horizontally, allowing you to execute workflows on a distributed infrastructure. It supports parallel and distributed execution, enabling you to run tasks concurrently across multiple machines or containers. This makes it suitable for handling large-scale data processing and complex workflows.</p>
<p><code>Integration and Extensibility:</code><br>
Prefect integrates seamlessly with various technologies and services, such as databases, message queues, cloud platforms, and more. It provides a rich set of task libraries and allows you to extend its functionality through custom task definitions and hooks. This enables you to integrate Prefect into your existing tech stack and leverage the power of your ecosystem.</p>
<p><code>Workflow Visibility and Collaboration:</code><br>
Prefect promotes collaboration and visibility among teams. It offers features like version control, sharing, and collaborative editing of workflows. You can easily share and reuse workflows across projects, enabling better collaboration and knowledge sharing within your organization.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/48700e8c-7f1e-4f4b-8653-84f1c6f446b3-1-598ca6c1-9e24-4144-a8c0-a5eeb2f364a6.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">prefect_server.PNG</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/bae279ae-826a-4ff0-8d76-6ef536bda595-1-65cf645f-3220-4309-a291-897449294d68.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">task_flow.PNG</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/e340c1ac-f033-4ebf-ac57-c3109c692f49-1-953ecfb5-7726-457f-bdff-270d188d7b83.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">sub_flow.PNG</figcaption>
</figure>
</div>
<p>In the above example we have a <code>parent</code> flow named <code>Hellow Flow</code> which calls on the the subflow <code>Subflow</code>.</p>
</section>
<section id="clone-prefect-github-repo" class="level4">
<h4 class="anchored" data-anchor-id="clone-prefect-github-repo">3.2.2 Clone Prefect GitHub repo</h4>
<p>To clone the <a href="https://github.com/discdiver/prefect-mlops-zoomcamp">Prefect repo</a> navigate to the directory where you want to clone to and from the command line :</p>
<pre><code>git clone git@github.com:discdiver/prefect-mlops-zoomcamp.git</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/46f2651c-2535-4887-a49e-c0961b0a98da-1-9319c51a-64a2-418a-a902-dd33761fe66b.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">clone_prefect_repo.PNG</figcaption>
</figure>
</div>
<p>Note I am using the SSH method for cloning. You can also use the HTTPS or CLI methods if you prefer.</p>
</section>
<section id="set-up-a-conda-environment" class="level4">
<h4 class="anchored" data-anchor-id="set-up-a-conda-environment">3.2.3 Set up a Conda environment</h4>
<p>Now, from within our cloned repo, let‚Äôs create a conda environment using the following :</p>
<pre><code>conda create -n prefect-ops python==3.9.12</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/1b6fd5b4-aaab-47d7-8008-96c0fd3a1694-1-7db82245-7780-41d7-8650-435ff1cac56e.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">create_env.PNG</figcaption>
</figure>
</div>
<p>and activate the environment using :</p>
<pre><code>conda activate prefect-ops   </code></pre>
<p>Quickly check we are using the correct Python version :</p>
<pre><code>python -V</code></pre>
<p>Then pip install the dependencies included in the <code>requirements.txt</code> file :</p>
<pre><code>pip install -r requirements.txt</code></pre>
<p><code>requirements.txt</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>black<span class="op">==</span><span class="fl">23.3.0</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>fastparquet<span class="op">==</span><span class="fl">2023.4.0</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>hyperopt<span class="op">==</span><span class="fl">0.2.7</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>mlflow<span class="op">==</span><span class="fl">2.3.1</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>pandas<span class="op">==</span><span class="fl">2.0.1</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>prefect<span class="op">==</span><span class="fl">2.10.8</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>prefect<span class="op">-</span>aws<span class="op">==</span><span class="fl">0.3.1</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>scikit_learn<span class="op">==</span><span class="fl">1.2.2</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>seaborn<span class="op">==</span><span class="fl">0.12.2</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>xgboost<span class="op">==</span><span class="fl">1.7.5</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>orjson<span class="op">==</span><span class="fl">3.8.1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/7643ad2f-d456-4027-9568-701f295d9fd1-1-ef281f8d-ebc9-496a-b2fa-a8d0167ae11d.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">requirements.PNG</figcaption>
</figure>
</div>
</section>
<section id="start-a-prefect-server" class="level4">
<h4 class="anchored" data-anchor-id="start-a-prefect-server">3.2.4 Start a Prefect Server</h4>
<p>We can start a Prefect server from the command line :</p>
<pre><code>prefect server start</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/d8f27570-3b50-489c-9578-e7871e9b0f77-1-c185b40e-a532-4b87-853e-7892b943fe94.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">server.PNG</figcaption>
</figure>
</div>
<p>Let‚Äôs grab the API URL and make sure that we apply this to our Prefect configuration so that we are pointing to the correct API URL.</p>
<p>Within a new terminal, navigate to the same directory as before, activate the conda environment and set the API URL:</p>
<pre><code>prefect config set PREFECT_API_URL=http://127.0.0.1:4200/api</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/8f395253-5ee0-4edc-9f33-51086b736a0f-1-02dabd73-c4c3-4a47-848b-593172019526.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">set_api_url.PNG</figcaption>
</figure>
</div>
<p>OK, let‚Äôs now navigate to the <code>3.2</code> folder where the scripts we will be using for illustration purposes live :</p>
<p><code>cat_facts.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> httpx</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prefect <span class="im">import</span> flow, task</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="at">@task</span>(retries<span class="op">=</span><span class="dv">4</span>, retry_delay_seconds<span class="op">=</span><span class="fl">0.1</span>, log_prints<span class="op">=</span><span class="va">True</span>) <span class="co"># decorator</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fetch_cat_fact():</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    cat_fact <span class="op">=</span> httpx.get(<span class="st">"https://f3-vyx5c2hfpq-ue.a.run.app/"</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#An endpoint that is designed to fail sporadically</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cat_fact.status_code <span class="op">&gt;=</span> <span class="dv">400</span>:</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">Exception</span>()</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(cat_fact.text) <span class="co"># this will be logged</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="at">@flow</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fetch():</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    fetch_cat_fact()</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    fetch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function calling the API has been decorated with a task decorator which has been configured with the arguments <code>retries</code>, <code>retry_delay_seconds</code>, and <code>log_prints</code>.</p>
<p>We can run the flow from the command line using :</p>
<pre><code>python cat_facts.py</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/4773c57b-ff21-4dcf-b381-d6b720e50d68-1-14c1442f-281a-440b-a65e-2badaaa7f0e8.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">cat_facts.PNG</figcaption>
</figure>
</div>
<p>and follow the run live from the Prefect UPI :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/4773c57b-ff21-4dcf-b381-d6b720e50d68-2-f076b5c0-04f2-4119-9782-da24b661fb9a.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">cat_facts_flow.PNG</figcaption>
</figure>
</div>
<p>As we can see, the flow failed a couple of times, but the <code>retries</code> argument included within the decorator kicked in. And we have our cat fact logged :</p>
<p>‚ÄúIn contrast to dogs, cats have not undergone major changes during their domestication process.‚Äù</p>
<p>Let‚Äôs now run the other script :</p>
<pre><code>python cat_dog_facts.py</code></pre>
<p><code>cat_dog_facts.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> httpx</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prefect <span class="im">import</span> flow</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="at">@flow</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fetch_cat_fact():</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''A flow that gets a cat fact'''</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> httpx.get(<span class="st">"https://catfact.ninja/fact?max_length=140"</span>).json()[<span class="st">"fact"</span>]</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="at">@flow</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fetch_dog_fact():</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''A flow that gets a dog fact'''</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> httpx.get(</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"https://dogapi.dog/api/v2/facts"</span>,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        headers<span class="op">=</span>{<span class="st">"accept"</span>: <span class="st">"application/json"</span>},</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    ).json()[<span class="st">"data"</span>][<span class="dv">0</span>][<span class="st">"attributes"</span>][<span class="st">"body"</span>] <span class="co"># index into the JSON file to retrieve the "body" - see below for example of JSON format</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="at">@flow</span>(log_prints<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> animal_facts():</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    cat_fact <span class="op">=</span> fetch_cat_fact()</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    dog_fact <span class="op">=</span> fetch_dog_fact()</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"üê±: </span><span class="sc">{</span>cat_fact<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">üê∂: </span><span class="sc">{</span>dog_fact<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    animal_facts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>{‚Äúdata‚Äù:[{‚Äúid‚Äù:‚Äú96f49d0c-64d1-43f4-87e1-6f7e8796d89d‚Äù,‚Äútype‚Äù:‚Äúfact‚Äù,‚Äúattributes‚Äù:{‚Äúbody‚Äù:‚ÄúThere are 703 breeds of purebred dogs.‚Äù}}]}</p>
<p>This script utilises <code>Subflows</code>. The parent flow <code>animal_facts</code> calls <code>fetch_cat_fact</code> and then <code>fetch_dog_fact</code>. Note that beacuse <code>log_prints=True</code> the output of the flows is printed and logged.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/a751fc3b-81cc-417c-be50-39bdab8b45ea-1-2f37b0ba-c549-4652-bd1e-9728ed7a421d.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">cat_dog.PNG</figcaption>
</figure>
</div>
<p>üê±: In the original Italian version of Cinderella, the benevolent fairy godmother figure was a cat.<br>
üê∂: The Beatles song ‚ÄúA day in the Life‚Äù has an extra high-pitched whistle, audible only to dogs. It was recorded by Paul McCartney for the enjoyment of his Shetland sheepdog.</p>
</section>
</section>
<section id="prefect-workflow" class="level3">
<h3 class="anchored" data-anchor-id="prefect-workflow">3.3 Prefect Workflow</h3>
<section id="improving-the-duration-prediction-notebook-from-module-2" class="level4">
<h4 class="anchored" data-anchor-id="improving-the-duration-prediction-notebook-from-module-2">3.3.1 Improving the duration prediction NoteBook from Module 2</h4>
<p>In Module 2 Alexey walked us through one possible approach to build a simple taxi trip duration prediction model. The code was deliberately compiled in a somewhat flow of consciousness <a href="https://github.com/DataTalksClub/mlops-zoomcamp/blob/main/03-orchestration/3.3/duration_prediction_original.ipynb">Jupyter NoteBook</a> to illustrate :</p>
<ul>
<li>the thought process and general steps involved in exploring and pre-processing raw data for machine learning training</li>
<li>that whilst a Jupyter Notebook is fine for internal experimentation, when it comes to production/deployment perhaps we need something more robust/scalable</li>
</ul>
<p>When code is scattered throughout a Jupyer NoteBook, things can quickly start to get messy, especially when you start iterating over different models and parameters. There can be a sense that you are losing control over your experiment. A first step towards improvement is to bring everything together into a single Python script.</p>
</section>
<section id="duration-prediction-notebook-pulled-together-into-a-python-script" class="level4">
<h4 class="anchored" data-anchor-id="duration-prediction-notebook-pulled-together-into-a-python-script">3.3.2 Duration prediction NoteBook pulled together into a Python script</h4>
<p>A first step towards improvement is to bring everything together into a single Python script :</p>
<p><code>orchestrate_pre_prefect.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pathlib</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.feature_extraction <span class="im">import</span> DictVectorizer</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xgboost <span class="im">as</span> xgb</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prefect <span class="im">import</span> flow, task</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_data(filename: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Read data into DataFrame"""</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_parquet(filename)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    df.tpep_dropoff_datetime <span class="op">=</span> pd.to_datetime(df.tpep_dropoff_datetime)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    df.tpep_pickup_datetime <span class="op">=</span> pd.to_datetime(df.tpep_pickup_datetime)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"duration"</span>] <span class="op">=</span> df.tpep_dropoff_datetime <span class="op">-</span> df.tpep_pickup_datetime</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    df.duration <span class="op">=</span> df.duration.<span class="bu">apply</span>(<span class="kw">lambda</span> td: td.total_seconds() <span class="op">/</span> <span class="dv">60</span>)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[(df.duration <span class="op">&gt;=</span> <span class="dv">1</span>) <span class="op">&amp;</span> (df.duration <span class="op">&lt;=</span> <span class="dv">60</span>)]</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    categorical <span class="op">=</span> [<span class="st">"PULocationID"</span>, <span class="st">"DOLocationID"</span>]</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    df[categorical] <span class="op">=</span> df[categorical].astype(<span class="bu">str</span>)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_features(</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    df_train: pd.DataFrame, df_val: pd.DataFrame</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">tuple</span>(</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>        scipy.sparse._csr.csr_matrix,</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>        scipy.sparse._csr.csr_matrix,</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>        np.ndarray,</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>        np.ndarray,</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>        sklearn.feature_extraction.DictVectorizer,</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Add features to the model"""</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>    df_train[<span class="st">"PU_DO"</span>] <span class="op">=</span> df_train[<span class="st">"PULocationID"</span>] <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> df_train[<span class="st">"DOLocationID"</span>]</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>    df_val[<span class="st">"PU_DO"</span>] <span class="op">=</span> df_val[<span class="st">"PULocationID"</span>] <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> df_val[<span class="st">"DOLocationID"</span>]</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>    categorical <span class="op">=</span> [<span class="st">"PU_DO"</span>]  <span class="co">#'PULocationID', 'DOLocationID']</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>    numerical <span class="op">=</span> [<span class="st">"trip_distance"</span>]</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>    dv <span class="op">=</span> DictVectorizer()</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>    train_dicts <span class="op">=</span> df_train[categorical <span class="op">+</span> numerical].to_dict(orient<span class="op">=</span><span class="st">"records"</span>)</span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>    X_train <span class="op">=</span> dv.fit_transform(train_dicts)</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>    val_dicts <span class="op">=</span> df_val[categorical <span class="op">+</span> numerical].to_dict(orient<span class="op">=</span><span class="st">"records"</span>)</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>    X_val <span class="op">=</span> dv.transform(val_dicts)</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>    y_train <span class="op">=</span> df_train[<span class="st">"duration"</span>].values</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>    y_val <span class="op">=</span> df_val[<span class="st">"duration"</span>].values</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X_train, X_val, y_train, y_val, dv</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_best_model(</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>    X_train: scipy.sparse._csr.csr_matrix,</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>    X_val: scipy.sparse._csr.csr_matrix,</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>    y_train: np.ndarray,</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>    y_val: np.ndarray,</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>    dv: sklearn.feature_extraction.DictVectorizer,</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""train a model with best hyperparams and write everything out"""</span></span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mlflow.start_run():</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>        train <span class="op">=</span> xgb.DMatrix(X_train, label<span class="op">=</span>y_train)</span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>        valid <span class="op">=</span> xgb.DMatrix(X_val, label<span class="op">=</span>y_val)</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>        best_params <span class="op">=</span> {</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">'learning_rate'</span>: <span class="fl">0.4434065752589766</span>,</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>        <span class="st">'max_depth'</span>: <span class="dv">81</span>,</span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>        <span class="st">'min_child_weight'</span>: <span class="fl">10.423237853746643</span>,</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>        <span class="st">'objective'</span>: <span class="st">'reg:linear'</span>,</span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reg_alpha'</span>: <span class="fl">0.2630756846813668</span>,</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reg_lambda'</span>: <span class="fl">0.1220536223877784</span>,</span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>        <span class="st">'seed'</span>: <span class="dv">42</span>    </span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>        mlflow.log_params(best_params)</span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>        booster <span class="op">=</span> xgb.train(</span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>            params<span class="op">=</span>best_params,</span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>            dtrain<span class="op">=</span>train,</span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>            num_boost_round<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a>            evals<span class="op">=</span>[(valid, <span class="st">"validation"</span>)],</span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>            early_stopping_rounds<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> booster.predict(valid)</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>        rmse <span class="op">=</span> mean_squared_error(y_val, y_pred, squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">"rmse"</span>, rmse)</span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>        pathlib.Path(<span class="st">"models"</span>).mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"models/preprocessor.b"</span>, <span class="st">"wb"</span>) <span class="im">as</span> f_out:</span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a>            pickle.dump(dv, f_out)</span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a>        mlflow.log_artifact(<span class="st">"models/preprocessor.b"</span>, artifact_path<span class="op">=</span><span class="st">"preprocessor"</span>)</span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a>        mlflow.xgboost.log_model(booster, artifact_path<span class="op">=</span><span class="st">"models_mlflow"</span>)</span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main_flow(</span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a>    train_path: <span class="bu">str</span> <span class="op">=</span> <span class="st">"./data/yellow_tripdata_2022-01.parquet"</span>,</span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a>    val_path: <span class="bu">str</span> <span class="op">=</span> <span class="st">"./data/yellow_tripdata_2022-02.parquet"</span>,</span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb13-113"><a href="#cb13-113" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""The main training pipeline"""</span></span>
<span id="cb13-114"><a href="#cb13-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-115"><a href="#cb13-115" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MLflow settings</span></span>
<span id="cb13-116"><a href="#cb13-116" aria-hidden="true" tabindex="-1"></a>    mlflow.set_tracking_uri(<span class="st">"sqlite:///mlflow.db"</span>)</span>
<span id="cb13-117"><a href="#cb13-117" aria-hidden="true" tabindex="-1"></a>    mlflow.set_experiment(<span class="st">"nyc-taxi-experiment"</span>)</span>
<span id="cb13-118"><a href="#cb13-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-119"><a href="#cb13-119" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load</span></span>
<span id="cb13-120"><a href="#cb13-120" aria-hidden="true" tabindex="-1"></a>    df_train <span class="op">=</span> read_data(train_path)</span>
<span id="cb13-121"><a href="#cb13-121" aria-hidden="true" tabindex="-1"></a>    df_val <span class="op">=</span> read_data(val_path)</span>
<span id="cb13-122"><a href="#cb13-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-123"><a href="#cb13-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform</span></span>
<span id="cb13-124"><a href="#cb13-124" aria-hidden="true" tabindex="-1"></a>    X_train, X_val, y_train, y_val, dv <span class="op">=</span> add_features(df_train, df_val)</span>
<span id="cb13-125"><a href="#cb13-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-126"><a href="#cb13-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train</span></span>
<span id="cb13-127"><a href="#cb13-127" aria-hidden="true" tabindex="-1"></a>    train_best_model(X_train, X_val, y_train, y_val, dv)</span>
<span id="cb13-128"><a href="#cb13-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-129"><a href="#cb13-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-130"><a href="#cb13-130" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb13-131"><a href="#cb13-131" aria-hidden="true" tabindex="-1"></a>    main_flow()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First navigate to the directory where <code>orchestrate_pre_prefect.py</code> lives and run from the command line :</p>
<pre><code>python orchestrate_pre_prefect.py</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/8f6682ab-6cf8-44ba-9d62-cb7291ff689d-1-80ff8819-923d-4324-9b2c-3bf6487fe58f.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">orchestrate_pre_prefect.PNG</figcaption>
</figure>
</div>
<p>Further refinement can be added using Prefect. Let‚Äôs take a look at this in action.</p>
</section>
<section id="leveraging-prefect-to-improve-the-script-further-through-orchestration" class="level4">
<h4 class="anchored" data-anchor-id="leveraging-prefect-to-improve-the-script-further-through-orchestration">3.3.2 Leveraging Prefect to improve the script further through orchestration</h4>
<p>We can build further on the Python script by adding <code>task</code> and <code>flow</code> decorators :</p>
<p><code>orchestrate.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pathlib</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.feature_extraction <span class="im">import</span> DictVectorizer</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xgboost <span class="im">as</span> xgb</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prefect <span class="im">import</span> flow, task</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="at">@task</span>(retries<span class="op">=</span><span class="dv">3</span>, retry_delay_seconds<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_data(filename: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Read data into DataFrame"""</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_parquet(filename)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    df.tpep_dropoff_datetime <span class="op">=</span> pd.to_datetime(df.tpep_dropoff_datetime)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    df.tpep_pickup_datetime <span class="op">=</span> pd.to_datetime(df.tpep_pickup_datetime)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"duration"</span>] <span class="op">=</span> df.tpep_dropoff_datetime <span class="op">-</span> df.tpep_pickup_datetime</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    df.duration <span class="op">=</span> df.duration.<span class="bu">apply</span>(<span class="kw">lambda</span> td: td.total_seconds() <span class="op">/</span> <span class="dv">60</span>)</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[(df.duration <span class="op">&gt;=</span> <span class="dv">1</span>) <span class="op">&amp;</span> (df.duration <span class="op">&lt;=</span> <span class="dv">60</span>)]</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    categorical <span class="op">=</span> [<span class="st">"PULocationID"</span>, <span class="st">"DOLocationID"</span>]</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    df[categorical] <span class="op">=</span> df[categorical].astype(<span class="bu">str</span>)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="at">@task</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_features(</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    df_train: pd.DataFrame, df_val: pd.DataFrame</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">tuple</span>(</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>        scipy.sparse._csr.csr_matrix,</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>        scipy.sparse._csr.csr_matrix,</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>        np.ndarray,</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>        np.ndarray,</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>        sklearn.feature_extraction.DictVectorizer,</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Add features to the model"""</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>    df_train[<span class="st">"PU_DO"</span>] <span class="op">=</span> df_train[<span class="st">"PULocationID"</span>] <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> df_train[<span class="st">"DOLocationID"</span>]</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>    df_val[<span class="st">"PU_DO"</span>] <span class="op">=</span> df_val[<span class="st">"PULocationID"</span>] <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> df_val[<span class="st">"DOLocationID"</span>]</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>    categorical <span class="op">=</span> [<span class="st">"PU_DO"</span>]  <span class="co">#'PULocationID', 'DOLocationID']</span></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>    numerical <span class="op">=</span> [<span class="st">"trip_distance"</span>]</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>    dv <span class="op">=</span> DictVectorizer()</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>    train_dicts <span class="op">=</span> df_train[categorical <span class="op">+</span> numerical].to_dict(orient<span class="op">=</span><span class="st">"records"</span>)</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>    X_train <span class="op">=</span> dv.fit_transform(train_dicts)</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>    val_dicts <span class="op">=</span> df_val[categorical <span class="op">+</span> numerical].to_dict(orient<span class="op">=</span><span class="st">"records"</span>)</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>    X_val <span class="op">=</span> dv.transform(val_dicts)</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>    y_train <span class="op">=</span> df_train[<span class="st">"duration"</span>].values</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>    y_val <span class="op">=</span> df_val[<span class="st">"duration"</span>].values</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X_train, X_val, y_train, y_val, dv</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a><span class="at">@task</span>(log_prints<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_best_model(</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>    X_train: scipy.sparse._csr.csr_matrix,</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>    X_val: scipy.sparse._csr.csr_matrix,</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>    y_train: np.ndarray,</span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>    y_val: np.ndarray,</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>    dv: sklearn.feature_extraction.DictVectorizer,</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""train a model with best hyperparams and write everything out"""</span></span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mlflow.start_run():</span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a>        train <span class="op">=</span> xgb.DMatrix(X_train, label<span class="op">=</span>y_train)</span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>        valid <span class="op">=</span> xgb.DMatrix(X_val, label<span class="op">=</span>y_val)</span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a>        best_params <span class="op">=</span> {</span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a>        <span class="st">'learning_rate'</span>: <span class="fl">0.4434065752589766</span>,</span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a>        <span class="st">'max_depth'</span>: <span class="dv">81</span>,</span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a>        <span class="st">'min_child_weight'</span>: <span class="fl">10.423237853746643</span>,</span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>        <span class="st">'objective'</span>: <span class="st">'reg:linear'</span>,</span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reg_alpha'</span>: <span class="fl">0.2630756846813668</span>,</span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reg_lambda'</span>: <span class="fl">0.1220536223877784</span>,</span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a>        <span class="st">'seed'</span>: <span class="dv">42</span>    </span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a>        mlflow.log_params(best_params)</span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a>        booster <span class="op">=</span> xgb.train(</span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>            params<span class="op">=</span>best_params,</span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a>            dtrain<span class="op">=</span>train,</span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>            num_boost_round<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a>            evals<span class="op">=</span>[(valid, <span class="st">"validation"</span>)],</span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>            early_stopping_rounds<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> booster.predict(valid)</span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a>        rmse <span class="op">=</span> mean_squared_error(y_val, y_pred, squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">"rmse"</span>, rmse)</span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a>        pathlib.Path(<span class="st">"models"</span>).mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"models/preprocessor.b"</span>, <span class="st">"wb"</span>) <span class="im">as</span> f_out:</span>
<span id="cb15-105"><a href="#cb15-105" aria-hidden="true" tabindex="-1"></a>            pickle.dump(dv, f_out)</span>
<span id="cb15-106"><a href="#cb15-106" aria-hidden="true" tabindex="-1"></a>        mlflow.log_artifact(<span class="st">"models/preprocessor.b"</span>, artifact_path<span class="op">=</span><span class="st">"preprocessor"</span>)</span>
<span id="cb15-107"><a href="#cb15-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-108"><a href="#cb15-108" aria-hidden="true" tabindex="-1"></a>        mlflow.xgboost.log_model(booster, artifact_path<span class="op">=</span><span class="st">"models_mlflow"</span>)</span>
<span id="cb15-109"><a href="#cb15-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb15-110"><a href="#cb15-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-111"><a href="#cb15-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-112"><a href="#cb15-112" aria-hidden="true" tabindex="-1"></a><span class="at">@flow</span></span>
<span id="cb15-113"><a href="#cb15-113" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main_flow(</span>
<span id="cb15-114"><a href="#cb15-114" aria-hidden="true" tabindex="-1"></a>    train_path: <span class="bu">str</span> <span class="op">=</span> <span class="st">"./data/yellow_tripdata_2022-01.parquet"</span>,</span>
<span id="cb15-115"><a href="#cb15-115" aria-hidden="true" tabindex="-1"></a>    val_path: <span class="bu">str</span> <span class="op">=</span> <span class="st">"./data/yellow_tripdata_2022-02.parquet"</span>,</span>
<span id="cb15-116"><a href="#cb15-116" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb15-117"><a href="#cb15-117" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""The main training pipeline"""</span></span>
<span id="cb15-118"><a href="#cb15-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-119"><a href="#cb15-119" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MLflow settings</span></span>
<span id="cb15-120"><a href="#cb15-120" aria-hidden="true" tabindex="-1"></a>    mlflow.set_tracking_uri(<span class="st">"sqlite:///mlflow.db"</span>)</span>
<span id="cb15-121"><a href="#cb15-121" aria-hidden="true" tabindex="-1"></a>    mlflow.set_experiment(<span class="st">"nyc-taxi-experiment"</span>)</span>
<span id="cb15-122"><a href="#cb15-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-123"><a href="#cb15-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load</span></span>
<span id="cb15-124"><a href="#cb15-124" aria-hidden="true" tabindex="-1"></a>    df_train <span class="op">=</span> read_data(train_path)</span>
<span id="cb15-125"><a href="#cb15-125" aria-hidden="true" tabindex="-1"></a>    df_val <span class="op">=</span> read_data(val_path)</span>
<span id="cb15-126"><a href="#cb15-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-127"><a href="#cb15-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform</span></span>
<span id="cb15-128"><a href="#cb15-128" aria-hidden="true" tabindex="-1"></a>    X_train, X_val, y_train, y_val, dv <span class="op">=</span> add_features(df_train, df_val)</span>
<span id="cb15-129"><a href="#cb15-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-130"><a href="#cb15-130" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train</span></span>
<span id="cb15-131"><a href="#cb15-131" aria-hidden="true" tabindex="-1"></a>    train_best_model(X_train, X_val, y_train, y_val, dv)</span>
<span id="cb15-132"><a href="#cb15-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-133"><a href="#cb15-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-134"><a href="#cb15-134" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb15-135"><a href="#cb15-135" aria-hidden="true" tabindex="-1"></a>    main_flow()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First navigate to the directory where <code>orchestrate.py</code> lives and run from the command line :</p>
<pre><code>python orchestrate.py</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/57d3e1bd-bdc2-48ad-b531-f282b566b908-1-122fbdb9-b25e-4ec8-acdd-9c3e82887f9f.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">orchestrated.PNG</figcaption>
</figure>
</div>
<p>And we can visualize the run using the Prefect UI :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/57d3e1bd-bdc2-48ad-b531-f282b566b908-2-955b674e-975a-411c-9718-1ffcdef50471.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">orchestrated_prefect_UI.PNG</figcaption>
</figure>
</div>
</section>
</section>
<section id="deploying-your-workflow" class="level3">
<h3 class="anchored" data-anchor-id="deploying-your-workflow">3.4 Deploying your Workflow</h3>
<p>In the last section we saw how we could take a Notebook, turn it into a script, and add some Prefect task and flow decorators to make it more resilient and observable. Let‚Äôs now take the next step in productionizing our workflows and make a deployment that will live on a server, and allow us to do scheduling.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/80eb171a-1938-491d-8c02-1102567d13a9-1-56af455e-270d-49c1-8be8-2fc1ef8dc013.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">prefect_project.PNG</figcaption>
</figure>
</div>
<section id="create-a-new-repo-on-github" class="level4">
<h4 class="anchored" data-anchor-id="create-a-new-repo-on-github">3.4.1 Create a new repo on GitHub</h4>
<p>To use the deployment feature you need to work with a GitHub repo. First, create a new repository :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/4a04a26e-9a3d-4737-abfa-c123491c2e26-2-b7b46039-02c6-4c00-84c5-237fda1dfb81.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">new_repo.PNG</figcaption>
</figure>
</div>
<p>Then clone that repository to your local machine :</p>
<pre><code>git clone git@github.com:Stephen137/mlops-prefect.git</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/4a04a26e-9a3d-4737-abfa-c123491c2e26-1-2cb83529-28de-49dd-af0d-675fa2a27985.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">git_clone.PNG</figcaption>
</figure>
</div>
<p>Note that I am using the password protected SSH key method to do this. The alternative is to use HTTPS :</p>
<pre><code>git clone https://github.com/Stephen137/mlops-prefect.git</code></pre>
<p>Let‚Äôs make a deployment using a Prefect project. Navigate to the cloned repo on your local machine and run this from the command line :</p>
<pre><code>prefect project init</code></pre>
<p>This creates four things :</p>
<p><code>.prefectignore</code> - we won‚Äôt be pushing any code up automatically from Prefect</p>
<p><code>deployment.yaml</code> - useful for templating, making multiple deployments from one project</p>
<p><code>prefect.yaml</code> -</p>
<p><code>.prefect/</code> - hidden folder</p>
<p>Note, that <strong>all</strong> associated code and files need to present within the newly created GitHub repo, so once you have initiated the project ensure you add the above files.</p>
<p>Let‚Äôs now create a Work Pool from the Prefect UI :</p>
<pre><code>prefect server start</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/fc75ddad-f569-4a2a-8dc5-d3b893e95c8f-1-24e68d4d-5486-4f26-abf8-2152e6724948.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">workpool.PNG</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/9b60c594-8b1c-4210-8a7d-7bd3a781ffc7-1-eae4d6f2-55a3-4833-88aa-0ec4d4c74e8c.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">pool.PNG</figcaption>
</figure>
</div>
<p>If you need help with Prefect config you can refer to <a href="https://docs.prefect.io/2.10.12/">the documentation</a> or use the command :</p>
<pre><code>prefect deploy --help</code></pre>
<p>Before we start a worker to poll from that pool, let‚Äôs go ahead and deploy our flow. The general template is as follows :</p>
<pre><code>prefect deploy &lt;folder_name&gt;/&lt;file_name&gt;:&lt;flow_name&gt; -n &lt;deploy_name&gt; -p &lt;work_pool_name&gt;</code></pre>
<p>In my specific case here :</p>
<pre><code>prefect deploy orchestrate.py:main_flow -n nyc_taxi_yellow_2022 -p mlops-zoompool</code></pre>
<p>This will send the deployment up to the server :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/a9fb9c74-8827-44e0-91a7-30fccd1f1745-1-e1336e1a-71d2-4e24-ab74-137f9c48d007.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">deployment.PNG</figcaption>
</figure>
</div>
<p>As we can see our deployment has been successfully created, and we are now prompted to start a worker from the <code>mlops-zoompool</code>. We can do this using the following template :</p>
<pre><code>prefect worker start -p &lt;work_pool_name&gt; -t &lt;type&gt;</code></pre>
<p>In my particular case :</p>
<pre><code>prefect worker start -p mlops-zoompool -t process</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/6b0309d5-ab59-4d6b-92ba-b9b8c86e0438-1-f2788532-7beb-4700-bc9b-889def812590.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">worker.PNG</figcaption>
</figure>
</div>
<p>Finally, the last step is to start a run of the deployment. We can do this from the UI :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/84e91b95-df4c-4203-9c7e-96d98ba57020-2-9d37f904-434a-41a1-9507-6dd24372ab2d.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">quick_run.PNG</figcaption>
</figure>
</div>
<p>Or from the command line using the template :</p>
<pre><code>prefect deployment &lt;flow_name&gt;/&lt;deploy_name&gt;</code></pre>
<p>In my particular case :</p>
<pre><code>prefect deployment run main_flow/nyc_taxi_yellow_2022 </code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/84e91b95-df4c-4203-9c7e-96d98ba57020-1-65c0e2e0-8c4c-401c-a868-40487e396c57.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">deployed.PNG</figcaption>
</figure>
</div>
<p>The deployment has been successful. This allows us to collaborate and have something that we can schedule.</p>
</section>
</section>
<section id="working-with-deployments" class="level3">
<h3 class="anchored" data-anchor-id="working-with-deployments">3.5 Working with Deployments</h3>
<p>In this section we will continue with productionization of our deployments. Although the course covered grabbing data from S3, I was familiar with both Prefect and GCP (which offers a generous $300 90 day free trial) from the Data Engineering Zoomcamp and thought I would have a go at using GCP instead of S3 as my data lake. I set up a new GCP account, configured the Prefect blocks, and modified the orchestration script accordingly.</p>
<p>We will also look at creating multiple deployments from a single project, and add some schedules so we can run our flows in an automated manner.</p>
<section id="grabbing-data-from-gcp" class="level4">
<h4 class="anchored" data-anchor-id="grabbing-data-from-gcp">3.5.1 Grabbing data from GCP</h4>
<p>It‚Äôs very easy to create Prefect blocks from the UI. If you are feeling adventurous you can also create blocks using a script. You can refer to the <a href="https://prefecthq.github.io/prefect-gcp/">guidance documentation</a> for assistance or the <a href="https://github.com/PrefectHQ/prefect-gcp">GitHub repo</a>.</p>
<p>You need to create a Credentials Block, which you give a name and populate with the JSON file downloaded as part of the GCP config :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/ffdbb05c-10c2-44dd-a4bb-596a3885a652-2-ca591acd-9f90-4584-b86e-8b87d9a2ec9c.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">gcp_credentials.PNG</figcaption>
</figure>
</div>
<p>Then create a Bucket block, which references the data lake in GCP :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/ffdbb05c-10c2-44dd-a4bb-596a3885a652-1-37f3db67-3558-4f42-a936-c40a3081c7d2.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">bucket_block.PNG</figcaption>
</figure>
</div>
<p>I then modified the orchestration script to replace S3 block code snipppets with GCP snippets :</p>
<p><code>orchestrate_gcp.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pathlib</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.feature_extraction <span class="im">import</span> DictVectorizer</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xgboost <span class="im">as</span> xgb</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prefect <span class="im">import</span> flow, task</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prefect_gcp.cloud_storage <span class="im">import</span> GcsBucket <span class="co"># GCP code snippet to replace the S3 snippet</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prefect.artifacts <span class="im">import</span> create_markdown_artifact</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> date</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="at">@task</span>(retries<span class="op">=</span><span class="dv">3</span>, retry_delay_seconds<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_data(filename: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Read data into DataFrame"""</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_parquet(filename)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    df.tpep_dropoff_datetime <span class="op">=</span> pd.to_datetime(df.tpep_dropoff_datetime)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    df.tpep_pickup_datetime <span class="op">=</span> pd.to_datetime(df.tpep_pickup_datetime)</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"duration"</span>] <span class="op">=</span> df.tpep_dropoff_datetime <span class="op">-</span> df.tpep_pickup_datetime</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    df.duration <span class="op">=</span> df.duration.<span class="bu">apply</span>(<span class="kw">lambda</span> td: td.total_seconds() <span class="op">/</span> <span class="dv">60</span>)</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[(df.duration <span class="op">&gt;=</span> <span class="dv">1</span>) <span class="op">&amp;</span> (df.duration <span class="op">&lt;=</span> <span class="dv">60</span>)]</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    categorical <span class="op">=</span> [<span class="st">"PULocationID"</span>, <span class="st">"DOLocationID"</span>]</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    df[categorical] <span class="op">=</span> df[categorical].astype(<span class="bu">str</span>)</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a><span class="at">@task</span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_features(</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>    df_train: pd.DataFrame, df_val: pd.DataFrame</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">tuple</span>(</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>        scipy.sparse._csr.csr_matrix,</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>        scipy.sparse._csr.csr_matrix,</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>        np.ndarray,</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>        np.ndarray,</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>        sklearn.feature_extraction.DictVectorizer,</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Add features to the model"""</span></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>    df_train[<span class="st">"PU_DO"</span>] <span class="op">=</span> df_train[<span class="st">"PULocationID"</span>] <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> df_train[<span class="st">"DOLocationID"</span>]</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>    df_val[<span class="st">"PU_DO"</span>] <span class="op">=</span> df_val[<span class="st">"PULocationID"</span>] <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> df_val[<span class="st">"DOLocationID"</span>]</span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>    categorical <span class="op">=</span> [<span class="st">"PU_DO"</span>]  <span class="co">#'PULocationID', 'DOLocationID']</span></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>    numerical <span class="op">=</span> [<span class="st">"trip_distance"</span>]</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>    dv <span class="op">=</span> DictVectorizer()</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>    train_dicts <span class="op">=</span> df_train[categorical <span class="op">+</span> numerical].to_dict(orient<span class="op">=</span><span class="st">"records"</span>)</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>    X_train <span class="op">=</span> dv.fit_transform(train_dicts)</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>    val_dicts <span class="op">=</span> df_val[categorical <span class="op">+</span> numerical].to_dict(orient<span class="op">=</span><span class="st">"records"</span>)</span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>    X_val <span class="op">=</span> dv.transform(val_dicts)</span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>    y_train <span class="op">=</span> df_train[<span class="st">"duration"</span>].values</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>    y_val <span class="op">=</span> df_val[<span class="st">"duration"</span>].values</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X_train, X_val, y_train, y_val, dv</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a><span class="at">@task</span>(log_prints<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_best_model(</span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>    X_train: scipy.sparse._csr.csr_matrix,</span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>    X_val: scipy.sparse._csr.csr_matrix,</span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>    y_train: np.ndarray,</span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>    y_val: np.ndarray,</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a>    dv: sklearn.feature_extraction.DictVectorizer,</span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""train a model with best hyperparams and write everything out"""</span></span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mlflow.start_run():</span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>        train <span class="op">=</span> xgb.DMatrix(X_train, label<span class="op">=</span>y_train)</span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>        valid <span class="op">=</span> xgb.DMatrix(X_val, label<span class="op">=</span>y_val)</span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a>        best_params <span class="op">=</span> {</span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a>        <span class="st">'learning_rate'</span>: <span class="fl">0.4434065752589766</span>,</span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">'max_depth'</span>: <span class="dv">81</span>,</span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a>        <span class="st">'min_child_weight'</span>: <span class="fl">10.423237853746643</span>,</span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a>        <span class="st">'objective'</span>: <span class="st">'reg:linear'</span>,</span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reg_alpha'</span>: <span class="fl">0.2630756846813668</span>,</span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reg_lambda'</span>: <span class="fl">0.1220536223877784</span>,</span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a>        <span class="st">'seed'</span>: <span class="dv">42</span>    </span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a>        mlflow.log_params(best_params)</span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a>        booster <span class="op">=</span> xgb.train(</span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a>            params<span class="op">=</span>best_params,</span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a>            dtrain<span class="op">=</span>train,</span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a>            num_boost_round<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a>            evals<span class="op">=</span>[(valid, <span class="st">"validation"</span>)],</span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a>            early_stopping_rounds<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> booster.predict(valid)</span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a>        rmse <span class="op">=</span> mean_squared_error(y_val, y_pred, squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">"rmse"</span>, rmse)</span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a>        pathlib.Path(<span class="st">"models"</span>).mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"models/preprocessor.b"</span>, <span class="st">"wb"</span>) <span class="im">as</span> f_out:</span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a>            pickle.dump(dv, f_out)</span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a>        mlflow.log_artifact(<span class="st">"models/preprocessor.b"</span>, artifact_path<span class="op">=</span><span class="st">"preprocessor"</span>) <span class="co"># create an artifact which we can visualize in the UI</span></span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a>        mlflow.xgboost.log_model(booster, artifact_path<span class="op">=</span><span class="st">"models_mlflow"</span>)</span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a>        markdown__rmse_report <span class="op">=</span> <span class="ss">f"""# RMSE Report</span></span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a><span class="ss">        ## Summary</span></span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a><span class="ss">        Duration Prediction </span></span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a><span class="ss">        ## RMSE XGBoost Model</span></span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a><span class="ss">        | Region    | RMSE |</span></span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a><span class="ss">        |:----------|-------:|</span></span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a><span class="ss">        | </span><span class="sc">{</span>date<span class="sc">.</span>today()<span class="sc">}</span><span class="ss"> | </span><span class="sc">{</span>rmse<span class="sc">:.2f}</span><span class="ss"> |</span></span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a><span class="ss">        """</span></span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a>        create_markdown_artifact(</span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a>            key<span class="op">=</span><span class="st">"duration-model-report"</span>, markdown<span class="op">=</span>markdown__rmse_report</span>
<span id="cb28-128"><a href="#cb28-128" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb28-131"><a href="#cb28-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-132"><a href="#cb28-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-133"><a href="#cb28-133" aria-hidden="true" tabindex="-1"></a><span class="at">@flow</span></span>
<span id="cb28-134"><a href="#cb28-134" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main_flow_gcp(</span>
<span id="cb28-135"><a href="#cb28-135" aria-hidden="true" tabindex="-1"></a>    train_path: <span class="bu">str</span> <span class="op">=</span> <span class="st">"data/yellow_tripdata_2022-01.parquet"</span>,</span>
<span id="cb28-136"><a href="#cb28-136" aria-hidden="true" tabindex="-1"></a>    val_path: <span class="bu">str</span> <span class="op">=</span> <span class="st">"data/yellow_tripdata_2022-02.parquet"</span>,</span>
<span id="cb28-137"><a href="#cb28-137" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb28-138"><a href="#cb28-138" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""The main training pipeline"""</span></span>
<span id="cb28-139"><a href="#cb28-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-140"><a href="#cb28-140" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MLflow settings</span></span>
<span id="cb28-141"><a href="#cb28-141" aria-hidden="true" tabindex="-1"></a>    mlflow.set_tracking_uri(<span class="st">"sqlite:///mlflow.db"</span>)</span>
<span id="cb28-142"><a href="#cb28-142" aria-hidden="true" tabindex="-1"></a>    mlflow.set_experiment(<span class="st">"nyc-taxi-experiment"</span>)</span>
<span id="cb28-143"><a href="#cb28-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-144"><a href="#cb28-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load</span></span>
<span id="cb28-145"><a href="#cb28-145" aria-hidden="true" tabindex="-1"></a>    gcp_cloud_storage_bucket_block <span class="op">=</span> GcsBucket.load(<span class="st">"mlops-zoomcamp-bucket"</span>) <span class="co"># GCP code snippet to replace the S3 snippet</span></span>
<span id="cb28-146"><a href="#cb28-146" aria-hidden="true" tabindex="-1"></a>    gcp_cloud_storage_bucket_block.download_folder_to_path(from_folder<span class="op">=</span><span class="st">"data"</span>, to_folder<span class="op">=</span><span class="st">"data"</span>) <span class="co"># GCP code snippet to replace the S3 snippet</span></span>
<span id="cb28-147"><a href="#cb28-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-148"><a href="#cb28-148" aria-hidden="true" tabindex="-1"></a>    df_train <span class="op">=</span> read_data(train_path)</span>
<span id="cb28-149"><a href="#cb28-149" aria-hidden="true" tabindex="-1"></a>    df_val <span class="op">=</span> read_data(val_path)</span>
<span id="cb28-150"><a href="#cb28-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-151"><a href="#cb28-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform</span></span>
<span id="cb28-152"><a href="#cb28-152" aria-hidden="true" tabindex="-1"></a>    X_train, X_val, y_train, y_val, dv <span class="op">=</span> add_features(df_train, df_val)</span>
<span id="cb28-153"><a href="#cb28-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-154"><a href="#cb28-154" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train</span></span>
<span id="cb28-155"><a href="#cb28-155" aria-hidden="true" tabindex="-1"></a>    train_best_model(X_train, X_val, y_train, y_val, dv)</span>
<span id="cb28-156"><a href="#cb28-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-157"><a href="#cb28-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-158"><a href="#cb28-158" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb28-159"><a href="#cb28-159" aria-hidden="true" tabindex="-1"></a>    main_flow_gcp()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And then ran the script from the command line using :</p>
<pre><code>python orchestrate_gcp.py</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/6dc168f9-4bf9-4c05-a189-85ad3e42732e-1-7573356e-c063-4567-9911-23d31d6d05f0.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">prefect_gcp.PNG</figcaption>
</figure>
</div>
<p>The run completed successfully and we can see the artifact that we tagged in our script which logs the best RMSE in the UI :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/f12a79d0-602a-4e2b-affb-a8f7bbd6c32e-1-2829e4b2-56bf-480d-80a8-acc95c23f8c4.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">artifacts.PNG</figcaption>
</figure>
</div>
</section>
<section id="multiple-deployments-from-the-one-project" class="level4">
<h4 class="anchored" data-anchor-id="multiple-deployments-from-the-one-project">3.5.2 Multiple deployments from the one project</h4>
<p>To do this we need to re-configure<br>
<code>deployment.yaml</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>deployments:</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> name: nyc_taxi_yellow_2022</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  entrypoint: orchestrate.py:main_flow</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  work_pool: </span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    name: mlops<span class="op">-</span>zoompool</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> name: nyc_taxi_yellow_2022_gcp</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  entrypoint: orchestrate_gcp.py:main_flow_gcp</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  work_pool: </span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    name: mlops<span class="op">-</span>zoompool</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can deploy both of the above from the command line :</p>
<pre><code>prefect deploy --all</code></pre>
<p>And then starting a worker :</p>
<pre><code>prefect worker start -p mlops-zoompool</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/d621440b-b1b0-4e60-a3e3-e3240327553a-1-18a7113c-e302-4fc6-8ea9-b16e7c8c7b42.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">deploy_all.PNG</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/fc858651-9d5b-477b-9717-e3765e90d883-1-ec5893fd-a1ce-4387-9c36-c41ab0a74b6e.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">deployment_gcp.PNG</figcaption>
</figure>
</div>
</section>
<section id="customized-runs-scheduling" class="level4">
<h4 class="anchored" data-anchor-id="customized-runs-scheduling">3.5.3 Customized runs (scheduling)</h4>
<p>We can customize our run from the UI :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/d716505a-b565-45ef-9fb5-80976d6c01e6-2-e5357aeb-e70a-405d-826e-6995431c1207.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">custom_run_UI.PNG</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/d716505a-b565-45ef-9fb5-80976d6c01e6-1-1e1c9461-6a13-46c7-a05d-0a40ecad1265.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">custom_run.PNG</figcaption>
</figure>
</div>
<p>We can also schedule runs from the UI :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/1cc530b9-e7ef-488e-8865-029c39d01fe4-1-9e705a9a-f7d5-4d2f-b2ac-a15c33dd6220.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">add_schedule.PNG</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/1cc530b9-e7ef-488e-8865-029c39d01fe4-2-a51a675d-22e5-4921-8d42-c68eb8c70f1c.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">scheduler.PNG</figcaption>
</figure>
</div>
<p>It is also possible to schedule runs from the command line, for example :</p>
<pre><code>prefect deployment set-schedule main_flow/taxi --interval 120 # default is seconds</code></pre>
<p>We‚Äôve covered a lot in this section. We‚Äôve seen how to schedule deployments, add artifacts, load data from GCP using blocks, and how to change the parameters of our runs using both the UI and the command line.</p>
</section>
</section>
<section id="prefect-cloud" class="level3">
<h3 class="anchored" data-anchor-id="prefect-cloud">3.6 Prefect Cloud</h3>
<p>First, navigate to <a href="https://app.prefect.cloud/auth/login">Prefect Cloud</a> and sign in.</p>
<p>Then to get up and running from the command line :</p>
<pre><code>prefect cloud login</code></pre>
<p>You need to authenticate, either by log in with a web browser (which didn‚Äôt work for me) or by an API key which you can create from the Ui :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/18d6fc8e-ae29-4160-a486-d4b2c63f680a-1-9f3232c0-693e-4097-bf1c-bb5441c73afc.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">prefect_cloud_login.PNG</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/18d6fc8e-ae29-4160-a486-d4b2c63f680a-2-e0dd22c1-e210-4de9-9f58-ba70c56d1294.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">prefect_cloud_api.PNG</figcaption>
</figure>
</div>
<p>The next step is to register and configure any necessary <code>Blocks</code> as described in the previous section, and then we can start a worker as before :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/6f21e1f6-15ab-4bd6-827b-881ad5c1fafb-1-539a53ed-4053-4ee7-89ad-39fa065471c9.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">prefect_cloud_worker.PNG</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/6f21e1f6-15ab-4bd6-827b-881ad5c1fafb-2-bc1c06a9-b356-420b-af6b-3e7b4efc9323.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">prefect_cloud_workpool.PNG</figcaption>
</figure>
</div>
<section id="automations" class="level4">
<h4 class="anchored" data-anchor-id="automations">3.6.1 Automations</h4>
<p>A useful feature within Prefect is <code>Automations</code> which allows us to configure a variety of customizable notifications. For example, here we will see how to set up an email notification, from the cloud UI. First we need to add the required blocks :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/6f95549c-f0b5-4422-8a55-6895c7e7faf9-2-8725fc02-60b4-493c-823e-a8d410dceb14.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">email_block.PNG</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/6f95549c-f0b5-4422-8a55-6895c7e7faf9-1-385b211e-3bd3-42d6-8291-aea7b62f836e.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">email_block_2.PNG</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/6f95549c-f0b5-4422-8a55-6895c7e7faf9-3-fddab651-cecd-4c68-bc23-276d7cbe5b10.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">email_creds_block.PNG</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/b39dd7c8-0025-4011-a17d-a50de7b318aa-3-50b7c02c-3b7f-4655-b045-808efcb97362.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">automations_trigger.PNG</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/b39dd7c8-0025-4011-a17d-a50de7b318aa-1-3cc114c7-2dfe-4cb0-9865-a60679ed3ce1.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">automations_actions.PNG</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/b39dd7c8-0025-4011-a17d-a50de7b318aa-2-3ed5edbf-ab9f-4efa-a40c-5374b92c7bd8.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">automations_details.PNG</figcaption>
</figure>
</div>
<p>I then deployed the following script :<br>
<code>orchestrate_f_m_23.py</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pathlib</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.feature_extraction <span class="im">import</span> DictVectorizer</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xgboost <span class="im">as</span> xgb</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prefect <span class="im">import</span> flow, task</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prefect.artifacts <span class="im">import</span> create_markdown_artifact</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> date</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="at">@task</span>(retries<span class="op">=</span><span class="dv">3</span>, retry_delay_seconds<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_data(filename: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Read data into DataFrame"""</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_parquet(filename)</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    df.lpep_dropoff_datetime <span class="op">=</span> pd.to_datetime(df.lpep_dropoff_datetime)</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    df.lpep_pickup_datetime <span class="op">=</span> pd.to_datetime(df.lpep_pickup_datetime)</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"duration"</span>] <span class="op">=</span> df.lpep_dropoff_datetime <span class="op">-</span> df.lpep_pickup_datetime</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    df.duration <span class="op">=</span> df.duration.<span class="bu">apply</span>(<span class="kw">lambda</span> td: td.total_seconds() <span class="op">/</span> <span class="dv">60</span>)</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[(df.duration <span class="op">&gt;=</span> <span class="dv">1</span>) <span class="op">&amp;</span> (df.duration <span class="op">&lt;=</span> <span class="dv">60</span>)]</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    categorical <span class="op">=</span> [<span class="st">"PULocationID"</span>, <span class="st">"DOLocationID"</span>]</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>    df[categorical] <span class="op">=</span> df[categorical].astype(<span class="bu">str</span>)</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a><span class="at">@task</span></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_features(</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>    df_train: pd.DataFrame, df_val: pd.DataFrame</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">tuple</span>(</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>        scipy.sparse._csr.csr_matrix,</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>        scipy.sparse._csr.csr_matrix,</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>        np.ndarray,</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>        np.ndarray,</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>        sklearn.feature_extraction.DictVectorizer,</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Add features to the model"""</span></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>    df_train[<span class="st">"PU_DO"</span>] <span class="op">=</span> df_train[<span class="st">"PULocationID"</span>] <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> df_train[<span class="st">"DOLocationID"</span>]</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>    df_val[<span class="st">"PU_DO"</span>] <span class="op">=</span> df_val[<span class="st">"PULocationID"</span>] <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> df_val[<span class="st">"DOLocationID"</span>]</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>    categorical <span class="op">=</span> [<span class="st">"PU_DO"</span>]  <span class="co">#'PULocationID', 'DOLocationID']</span></span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>    numerical <span class="op">=</span> [<span class="st">"trip_distance"</span>]</span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>    dv <span class="op">=</span> DictVectorizer()</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>    train_dicts <span class="op">=</span> df_train[categorical <span class="op">+</span> numerical].to_dict(orient<span class="op">=</span><span class="st">"records"</span>)</span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>    X_train <span class="op">=</span> dv.fit_transform(train_dicts)</span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>    val_dicts <span class="op">=</span> df_val[categorical <span class="op">+</span> numerical].to_dict(orient<span class="op">=</span><span class="st">"records"</span>)</span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>    X_val <span class="op">=</span> dv.transform(val_dicts)</span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a>    y_train <span class="op">=</span> df_train[<span class="st">"duration"</span>].values</span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a>    y_val <span class="op">=</span> df_val[<span class="st">"duration"</span>].values</span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X_train, X_val, y_train, y_val, dv</span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a><span class="at">@task</span>(log_prints<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_best_model(</span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>    X_train: scipy.sparse._csr.csr_matrix,</span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a>    X_val: scipy.sparse._csr.csr_matrix,</span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a>    y_train: np.ndarray,</span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a>    y_val: np.ndarray,</span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a>    dv: sklearn.feature_extraction.DictVectorizer,</span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""train a model with best hyperparams and write everything out"""</span></span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mlflow.start_run():</span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a>        train <span class="op">=</span> xgb.DMatrix(X_train, label<span class="op">=</span>y_train)</span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a>        valid <span class="op">=</span> xgb.DMatrix(X_val, label<span class="op">=</span>y_val)</span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a>        best_params <span class="op">=</span> {</span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a>            <span class="st">"learning_rate"</span>: <span class="fl">0.09585355369315604</span>,</span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_depth"</span>: <span class="dv">30</span>,</span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a>            <span class="st">"min_child_weight"</span>: <span class="fl">1.060597050922164</span>,</span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a>            <span class="st">"objective"</span>: <span class="st">"reg:linear"</span>,</span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a>            <span class="st">"reg_alpha"</span>: <span class="fl">0.018060244040060163</span>,</span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a>            <span class="st">"reg_lambda"</span>: <span class="fl">0.011658731377413597</span>,</span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a>            <span class="st">"seed"</span>: <span class="dv">42</span>,</span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-90"><a href="#cb35-90" aria-hidden="true" tabindex="-1"></a>        mlflow.log_params(best_params)</span>
<span id="cb35-91"><a href="#cb35-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a>        booster <span class="op">=</span> xgb.train(</span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a>            params<span class="op">=</span>best_params,</span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a>            dtrain<span class="op">=</span>train,</span>
<span id="cb35-95"><a href="#cb35-95" aria-hidden="true" tabindex="-1"></a>            num_boost_round<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb35-96"><a href="#cb35-96" aria-hidden="true" tabindex="-1"></a>            evals<span class="op">=</span>[(valid, <span class="st">"validation"</span>)],</span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a>            early_stopping_rounds<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> booster.predict(valid)</span>
<span id="cb35-101"><a href="#cb35-101" aria-hidden="true" tabindex="-1"></a>        rmse <span class="op">=</span> mean_squared_error(y_val, y_pred, squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb35-102"><a href="#cb35-102" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">"rmse"</span>, rmse)</span>
<span id="cb35-103"><a href="#cb35-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-104"><a href="#cb35-104" aria-hidden="true" tabindex="-1"></a>        pathlib.Path(<span class="st">"models"</span>).mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb35-105"><a href="#cb35-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"models/preprocessor.b"</span>, <span class="st">"wb"</span>) <span class="im">as</span> f_out:</span>
<span id="cb35-106"><a href="#cb35-106" aria-hidden="true" tabindex="-1"></a>            pickle.dump(dv, f_out)</span>
<span id="cb35-107"><a href="#cb35-107" aria-hidden="true" tabindex="-1"></a>        mlflow.log_artifact(<span class="st">"models/preprocessor.b"</span>, artifact_path<span class="op">=</span><span class="st">"preprocessor"</span>)</span>
<span id="cb35-108"><a href="#cb35-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-109"><a href="#cb35-109" aria-hidden="true" tabindex="-1"></a>        mlflow.xgboost.log_model(booster, artifact_path<span class="op">=</span><span class="st">"models_mlflow"</span>)</span>
<span id="cb35-110"><a href="#cb35-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-111"><a href="#cb35-111" aria-hidden="true" tabindex="-1"></a>        markdown__rmse_report <span class="op">=</span> <span class="ss">f"""# RMSE Report</span></span>
<span id="cb35-112"><a href="#cb35-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-113"><a href="#cb35-113" aria-hidden="true" tabindex="-1"></a><span class="ss">        ## Summary</span></span>
<span id="cb35-114"><a href="#cb35-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-115"><a href="#cb35-115" aria-hidden="true" tabindex="-1"></a><span class="ss">        Duration Prediction </span></span>
<span id="cb35-116"><a href="#cb35-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-117"><a href="#cb35-117" aria-hidden="true" tabindex="-1"></a><span class="ss">        ## RMSE XGBoost Model</span></span>
<span id="cb35-118"><a href="#cb35-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-119"><a href="#cb35-119" aria-hidden="true" tabindex="-1"></a><span class="ss">        | Region    | RMSE |</span></span>
<span id="cb35-120"><a href="#cb35-120" aria-hidden="true" tabindex="-1"></a><span class="ss">        |:----------|-------:|</span></span>
<span id="cb35-121"><a href="#cb35-121" aria-hidden="true" tabindex="-1"></a><span class="ss">        | </span><span class="sc">{</span>date<span class="sc">.</span>today()<span class="sc">}</span><span class="ss"> | </span><span class="sc">{</span>rmse<span class="sc">:.2f}</span><span class="ss"> |</span></span>
<span id="cb35-122"><a href="#cb35-122" aria-hidden="true" tabindex="-1"></a><span class="ss">        """</span></span>
<span id="cb35-123"><a href="#cb35-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-124"><a href="#cb35-124" aria-hidden="true" tabindex="-1"></a>        create_markdown_artifact(</span>
<span id="cb35-125"><a href="#cb35-125" aria-hidden="true" tabindex="-1"></a>            key<span class="op">=</span><span class="st">"duration-model-report"</span>, markdown<span class="op">=</span>markdown__rmse_report</span>
<span id="cb35-126"><a href="#cb35-126" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-127"><a href="#cb35-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-128"><a href="#cb35-128" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb35-129"><a href="#cb35-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-130"><a href="#cb35-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-131"><a href="#cb35-131" aria-hidden="true" tabindex="-1"></a><span class="at">@flow</span></span>
<span id="cb35-132"><a href="#cb35-132" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main_flow_f_m_23(</span>
<span id="cb35-133"><a href="#cb35-133" aria-hidden="true" tabindex="-1"></a>    train_path: <span class="bu">str</span> <span class="op">=</span> <span class="st">"./data/green_tripdata_2023-02.parquet"</span>,</span>
<span id="cb35-134"><a href="#cb35-134" aria-hidden="true" tabindex="-1"></a>    val_path: <span class="bu">str</span> <span class="op">=</span> <span class="st">"./data/green_tripdata_2023-03.parquet"</span>,</span>
<span id="cb35-135"><a href="#cb35-135" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb35-136"><a href="#cb35-136" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""The main training pipeline"""</span></span>
<span id="cb35-137"><a href="#cb35-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-138"><a href="#cb35-138" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MLflow settings</span></span>
<span id="cb35-139"><a href="#cb35-139" aria-hidden="true" tabindex="-1"></a>    mlflow.set_tracking_uri(<span class="st">"sqlite:///mlflow.db"</span>)</span>
<span id="cb35-140"><a href="#cb35-140" aria-hidden="true" tabindex="-1"></a>    mlflow.set_experiment(<span class="st">"nyc-taxi-experiment"</span>)</span>
<span id="cb35-141"><a href="#cb35-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-142"><a href="#cb35-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load</span></span>
<span id="cb35-143"><a href="#cb35-143" aria-hidden="true" tabindex="-1"></a>    df_train <span class="op">=</span> read_data(train_path)</span>
<span id="cb35-144"><a href="#cb35-144" aria-hidden="true" tabindex="-1"></a>    df_val <span class="op">=</span> read_data(val_path)</span>
<span id="cb35-145"><a href="#cb35-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-146"><a href="#cb35-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform</span></span>
<span id="cb35-147"><a href="#cb35-147" aria-hidden="true" tabindex="-1"></a>    X_train, X_val, y_train, y_val, dv <span class="op">=</span> add_features(df_train, df_val)</span>
<span id="cb35-148"><a href="#cb35-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-149"><a href="#cb35-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train</span></span>
<span id="cb35-150"><a href="#cb35-150" aria-hidden="true" tabindex="-1"></a>    train_best_model(X_train, X_val, y_train, y_val, dv)</span>
<span id="cb35-151"><a href="#cb35-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-152"><a href="#cb35-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-153"><a href="#cb35-153" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb35-154"><a href="#cb35-154" aria-hidden="true" tabindex="-1"></a>    main_flow_f_m_23()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>from the command line using :</p>
<pre><code>prefect deploy orchestrate_f_m_23.py:main_flow_f_m_23 -n nyc_taxi_green_f_m_23 -p mlops-zoompool</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/384d59a3-d900-421c-81f2-53a128058517-1-904d2c4d-d365-4bb0-aace-1de3061bbfb7.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">discreet_roadrunner.PNG</figcaption>
</figure>
</div>
<p>When the run was succesfully completed I received the following email notification :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/a49b160a-278b-47a9-ba7c-6dd67db7a006-1-b3baf72d-4068-41f0-9b86-5fc2d9fb8fbe.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">email_notification.PNG</figcaption>
</figure>
</div>
<p>We can see a timeline summary of events in the <code>Event Feed</code> :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ML_Ops_Zoomcamp_Module_3_files/figure-html/65c43352-2bea-4ea0-8ebb-3dd6fddb67be-1-caba3094-11c5-44d5-a4fe-cf7f3c070d36.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">event_feed.PNG</figcaption>
</figure>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Stephen Barrie">
<meta name="dcterms.date" content="2023-01-23">

<title>Into the Unknown - Credit Risk Modeling in Python</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Into the Unknown</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">Stephen Barrie</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"><i class="bi bi-rss" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Stephen137"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://linkedin.com/in/sjbarrie"><i class="bi bi-linkedin" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Credit Risk Modeling in Python</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">XGBoost</div>
                <div class="quarto-category">Logistic Regression</div>
                <div class="quarto-category">DataCamp</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Stephen Barrie </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 23, 2023</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#exploring-and-preparing-loan-data" id="toc-exploring-and-preparing-loan-data" class="nav-link active" data-scroll-target="#exploring-and-preparing-loan-data">1. Exploring and Preparing Loan Data</a>
  <ul class="collapse">
  <li><a href="#explore-the-credit-data" id="toc-explore-the-credit-data" class="nav-link" data-scroll-target="#explore-the-credit-data">1.1 Explore the credit data</a></li>
  <li><a href="#crosstab-and-pivot-tables" id="toc-crosstab-and-pivot-tables" class="nav-link" data-scroll-target="#crosstab-and-pivot-tables">1.2 Crosstab and pivot tables</a></li>
  <li><a href="#finding-outliers-with-cross-tables" id="toc-finding-outliers-with-cross-tables" class="nav-link" data-scroll-target="#finding-outliers-with-cross-tables">1.3 Finding outliers with cross tables</a></li>
  <li><a href="#visualizing-credit-outliers" id="toc-visualizing-credit-outliers" class="nav-link" data-scroll-target="#visualizing-credit-outliers">1.4 Visualizing credit outliers</a></li>
  <li><a href="#replacing-missing-credit-data" id="toc-replacing-missing-credit-data" class="nav-link" data-scroll-target="#replacing-missing-credit-data">1.5 Replacing missing credit data</a></li>
  <li><a href="#removing-missing-data" id="toc-removing-missing-data" class="nav-link" data-scroll-target="#removing-missing-data">1.6 Removing missing data</a></li>
  </ul></li>
  <li><a href="#logistic-regression-for-defaults" id="toc-logistic-regression-for-defaults" class="nav-link" data-scroll-target="#logistic-regression-for-defaults">2. Logistic Regression for Defaults</a>
  <ul class="collapse">
  <li><a href="#logistic-regression-basics" id="toc-logistic-regression-basics" class="nav-link" data-scroll-target="#logistic-regression-basics">2.1 Logistic regression basics</a></li>
  <li><a href="#multivariate-logistic-regression" id="toc-multivariate-logistic-regression" class="nav-link" data-scroll-target="#multivariate-logistic-regression">2.2 Multivariate logistic regression</a></li>
  <li><a href="#creating-training-and-test-sets" id="toc-creating-training-and-test-sets" class="nav-link" data-scroll-target="#creating-training-and-test-sets">2.3 Creating training and test sets</a></li>
  <li><a href="#changing-coefficients" id="toc-changing-coefficients" class="nav-link" data-scroll-target="#changing-coefficients">2.4 Changing coefficients</a></li>
  <li><a href="#one-hot-encoding-credit-data" id="toc-one-hot-encoding-credit-data" class="nav-link" data-scroll-target="#one-hot-encoding-credit-data">2.5 One-hot encoding credit data</a></li>
  <li><a href="#predicting-probability-of-default" id="toc-predicting-probability-of-default" class="nav-link" data-scroll-target="#predicting-probability-of-default">2.6 Predicting probability of default</a></li>
  <li><a href="#default-classification-reporting" id="toc-default-classification-reporting" class="nav-link" data-scroll-target="#default-classification-reporting">2.7 Default classification reporting</a></li>
  <li><a href="#selecting-report-metrics" id="toc-selecting-report-metrics" class="nav-link" data-scroll-target="#selecting-report-metrics">2.8 Selecting report metrics</a></li>
  <li><a href="#visually-scoring-credit-models" id="toc-visually-scoring-credit-models" class="nav-link" data-scroll-target="#visually-scoring-credit-models">2.9 Visually scoring credit models</a></li>
  <li><a href="#thresholds-and-confusion-matrices" id="toc-thresholds-and-confusion-matrices" class="nav-link" data-scroll-target="#thresholds-and-confusion-matrices">2.10 Thresholds and confusion matrices</a></li>
  <li><a href="#how-thresholds-affect-performance" id="toc-how-thresholds-affect-performance" class="nav-link" data-scroll-target="#how-thresholds-affect-performance">2.11 How thresholds affect performance</a></li>
  <li><a href="#threshold-selection" id="toc-threshold-selection" class="nav-link" data-scroll-target="#threshold-selection">2.12 Threshold selection</a></li>
  </ul></li>
  <li><a href="#gradient-boosted-trees-using-xgboost" id="toc-gradient-boosted-trees-using-xgboost" class="nav-link" data-scroll-target="#gradient-boosted-trees-using-xgboost">3. Gradient Boosted Trees Using XGBoost</a>
  <ul class="collapse">
  <li><a href="#trees-for-defaults" id="toc-trees-for-defaults" class="nav-link" data-scroll-target="#trees-for-defaults">3.1 Trees for defaults</a></li>
  <li><a href="#gradient-boosted-portfolio-performance" id="toc-gradient-boosted-portfolio-performance" class="nav-link" data-scroll-target="#gradient-boosted-portfolio-performance">3.2 Gradient boosted portfolio performance</a></li>
  <li><a href="#assessing-gradient-boosted-trees" id="toc-assessing-gradient-boosted-trees" class="nav-link" data-scroll-target="#assessing-gradient-boosted-trees">3.3 Assessing gradient boosted trees</a></li>
  <li><a href="#column-importance-and-default-prediction" id="toc-column-importance-and-default-prediction" class="nav-link" data-scroll-target="#column-importance-and-default-prediction">3.4 Column importance and default prediction</a></li>
  <li><a href="#visualizing-column-importance" id="toc-visualizing-column-importance" class="nav-link" data-scroll-target="#visualizing-column-importance">3.5 Visualizing column importance</a></li>
  <li><a href="#column-selection-and-model-performance" id="toc-column-selection-and-model-performance" class="nav-link" data-scroll-target="#column-selection-and-model-performance">3.6 Column selection and model performance</a></li>
  <li><a href="#cross-validating-credit-models" id="toc-cross-validating-credit-models" class="nav-link" data-scroll-target="#cross-validating-credit-models">3.7 Cross validating credit models</a></li>
  <li><a href="#limits-to-cross-validation-testing" id="toc-limits-to-cross-validation-testing" class="nav-link" data-scroll-target="#limits-to-cross-validation-testing">3.8 Limits to cross-validation testing</a></li>
  <li><a href="#cross-validation-scoring" id="toc-cross-validation-scoring" class="nav-link" data-scroll-target="#cross-validation-scoring">3.9 Cross-validation scoring</a></li>
  <li><a href="#undersampling-training-data" id="toc-undersampling-training-data" class="nav-link" data-scroll-target="#undersampling-training-data">3.10 Undersampling training data</a></li>
  <li><a href="#undersampled-tree-performance" id="toc-undersampled-tree-performance" class="nav-link" data-scroll-target="#undersampled-tree-performance">3.11 Undersampled tree performance</a></li>
  <li><a href="#undersampling-intuition" id="toc-undersampling-intuition" class="nav-link" data-scroll-target="#undersampling-intuition">3.12 Undersampling intuition</a></li>
  </ul></li>
  <li><a href="#model-evaluation-and-implementation" id="toc-model-evaluation-and-implementation" class="nav-link" data-scroll-target="#model-evaluation-and-implementation">4. Model evaluation and implementation</a>
  <ul class="collapse">
  <li><a href="#comparing-model-reports" id="toc-comparing-model-reports" class="nav-link" data-scroll-target="#comparing-model-reports">4.1 Comparing model reports</a></li>
  <li><a href="#comparing-with-rocs-and-aucs" id="toc-comparing-with-rocs-and-aucs" class="nav-link" data-scroll-target="#comparing-with-rocs-and-aucs">4.2 Comparing with ROCs and AUCs</a></li>
  <li><a href="#calibration-curves" id="toc-calibration-curves" class="nav-link" data-scroll-target="#calibration-curves">4.3 Calibration curves</a></li>
  <li><a href="#acceptance-rates" id="toc-acceptance-rates" class="nav-link" data-scroll-target="#acceptance-rates">4.4 Acceptance rates</a></li>
  <li><a href="#visualizing-quantiles-of-acceptance" id="toc-visualizing-quantiles-of-acceptance" class="nav-link" data-scroll-target="#visualizing-quantiles-of-acceptance">4.5 Visualizing quantiles of acceptance</a></li>
  <li><a href="#bad-rates" id="toc-bad-rates" class="nav-link" data-scroll-target="#bad-rates">4.6 Bad rates</a></li>
  <li><a href="#acceptance-rate-impact" id="toc-acceptance-rate-impact" class="nav-link" data-scroll-target="#acceptance-rate-impact">4.7 Acceptance rate impact</a></li>
  <li><a href="#making-the-strategy-table" id="toc-making-the-strategy-table" class="nav-link" data-scroll-target="#making-the-strategy-table">4.8 Making the strategy table</a></li>
  <li><a href="#visualizing-the-strategy" id="toc-visualizing-the-strategy" class="nav-link" data-scroll-target="#visualizing-the-strategy">4.9 Visualizing the strategy</a></li>
  <li><a href="#estimated-value-profiling" id="toc-estimated-value-profiling" class="nav-link" data-scroll-target="#estimated-value-profiling">4.10 Estimated value profiling</a></li>
  <li><a href="#total-expected-loss" id="toc-total-expected-loss" class="nav-link" data-scroll-target="#total-expected-loss">4.11 Total expected loss</a></li>
  </ul></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways">Key takeaways</a></li>
  <li><a href="#leaving-thoughts-and-acknowledgements" id="toc-leaving-thoughts-and-acknowledgements" class="nav-link" data-scroll-target="#leaving-thoughts-and-acknowledgements">Leaving thoughts and acknowledgements</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>If you’ve ever applied for a credit card or loan, you know that financial firms process your information before making a decision. This is because giving you a loan can have a serious financial impact on their business. But how do they make a decision? In this blog, we will learn how to prepare credit application data. After that, we will apply machine learning and business rules to reduce risk and ensure profitability. We will use two data sets that emulate real credit applications while focusing on business value.</p>
<section id="exploring-and-preparing-loan-data" class="level2">
<h2 class="anchored" data-anchor-id="exploring-and-preparing-loan-data">1. Exploring and Preparing Loan Data</h2>
<p>In this first section, we will discuss the concept of credit risk and define how it is calculated. Using cross tables and plots, we will explore a real-world data set. Before applying machine learning, we will process this data by finding and resolving problems.</p>
<section id="explore-the-credit-data" class="level3">
<h3 class="anchored" data-anchor-id="explore-the-credit-data">1.1 Explore the credit data</h3>
<p>Well begin by loading in the dataset <code>cr_loan</code>.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import required packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.colors</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># load in our dataset</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>cr_loan <span class="op">=</span> pd.read_csv(<span class="st">'Data/cr_loan2.csv'</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>cr_loan</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>person_age</th>
      <th>person_income</th>
      <th>person_home_ownership</th>
      <th>person_emp_length</th>
      <th>loan_intent</th>
      <th>loan_grade</th>
      <th>loan_amnt</th>
      <th>loan_int_rate</th>
      <th>loan_status</th>
      <th>loan_percent_income</th>
      <th>cb_person_default_on_file</th>
      <th>cb_person_cred_hist_length</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>22</td>
      <td>59000</td>
      <td>RENT</td>
      <td>123.0</td>
      <td>PERSONAL</td>
      <td>D</td>
      <td>35000</td>
      <td>16.02</td>
      <td>1</td>
      <td>0.59</td>
      <td>Y</td>
      <td>3</td>
    </tr>
    <tr>
      <th>1</th>
      <td>21</td>
      <td>9600</td>
      <td>OWN</td>
      <td>5.0</td>
      <td>EDUCATION</td>
      <td>B</td>
      <td>1000</td>
      <td>11.14</td>
      <td>0</td>
      <td>0.10</td>
      <td>N</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>25</td>
      <td>9600</td>
      <td>MORTGAGE</td>
      <td>1.0</td>
      <td>MEDICAL</td>
      <td>C</td>
      <td>5500</td>
      <td>12.87</td>
      <td>1</td>
      <td>0.57</td>
      <td>N</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>23</td>
      <td>65500</td>
      <td>RENT</td>
      <td>4.0</td>
      <td>MEDICAL</td>
      <td>C</td>
      <td>35000</td>
      <td>15.23</td>
      <td>1</td>
      <td>0.53</td>
      <td>N</td>
      <td>2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>24</td>
      <td>54400</td>
      <td>RENT</td>
      <td>8.0</td>
      <td>MEDICAL</td>
      <td>C</td>
      <td>35000</td>
      <td>14.27</td>
      <td>1</td>
      <td>0.55</td>
      <td>Y</td>
      <td>4</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>32576</th>
      <td>57</td>
      <td>53000</td>
      <td>MORTGAGE</td>
      <td>1.0</td>
      <td>PERSONAL</td>
      <td>C</td>
      <td>5800</td>
      <td>13.16</td>
      <td>0</td>
      <td>0.11</td>
      <td>N</td>
      <td>30</td>
    </tr>
    <tr>
      <th>32577</th>
      <td>54</td>
      <td>120000</td>
      <td>MORTGAGE</td>
      <td>4.0</td>
      <td>PERSONAL</td>
      <td>A</td>
      <td>17625</td>
      <td>7.49</td>
      <td>0</td>
      <td>0.15</td>
      <td>N</td>
      <td>19</td>
    </tr>
    <tr>
      <th>32578</th>
      <td>65</td>
      <td>76000</td>
      <td>RENT</td>
      <td>3.0</td>
      <td>HOMEIMPROVEMENT</td>
      <td>B</td>
      <td>35000</td>
      <td>10.99</td>
      <td>1</td>
      <td>0.46</td>
      <td>N</td>
      <td>28</td>
    </tr>
    <tr>
      <th>32579</th>
      <td>56</td>
      <td>150000</td>
      <td>MORTGAGE</td>
      <td>5.0</td>
      <td>PERSONAL</td>
      <td>B</td>
      <td>15000</td>
      <td>11.48</td>
      <td>0</td>
      <td>0.10</td>
      <td>N</td>
      <td>26</td>
    </tr>
    <tr>
      <th>32580</th>
      <td>66</td>
      <td>42000</td>
      <td>RENT</td>
      <td>2.0</td>
      <td>MEDICAL</td>
      <td>B</td>
      <td>6475</td>
      <td>9.99</td>
      <td>0</td>
      <td>0.15</td>
      <td>N</td>
      <td>30</td>
    </tr>
  </tbody>
</table>
<p>32581 rows × 12 columns</p>
</div>
</div>
</div>
<p>In this data set, <code>loan_status</code> shows whether the loan is currently in default with 1 being default and 0 being non-default.</p>
<p>We have eleven other columns within the data, and many could have a relationship with the values in <code>loan_status</code>. We will explore the data and these relationships more with further analysis to understand the impact of the data on credit loan defaults.</p>
<p>Checking the structure of the data as well as seeing a snapshot helps us better understand what’s inside the set. Let’s check what type of data we are dealing with here and then look at the first five rows:</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the structure of the data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>cr_loan.dtypes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>person_age                      int64
person_income                   int64
person_home_ownership          object
person_emp_length             float64
loan_intent                    object
loan_grade                     object
loan_amnt                       int64
loan_int_rate                 float64
loan_status                     int64
loan_percent_income           float64
cb_person_default_on_file      object
cb_person_cred_hist_length      int64
dtype: object</code></pre>
</div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the first five rows of the data</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>cr_loan.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>person_age</th>
      <th>person_income</th>
      <th>person_home_ownership</th>
      <th>person_emp_length</th>
      <th>loan_intent</th>
      <th>loan_grade</th>
      <th>loan_amnt</th>
      <th>loan_int_rate</th>
      <th>loan_status</th>
      <th>loan_percent_income</th>
      <th>cb_person_default_on_file</th>
      <th>cb_person_cred_hist_length</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>22</td>
      <td>59000</td>
      <td>RENT</td>
      <td>123.0</td>
      <td>PERSONAL</td>
      <td>D</td>
      <td>35000</td>
      <td>16.02</td>
      <td>1</td>
      <td>0.59</td>
      <td>Y</td>
      <td>3</td>
    </tr>
    <tr>
      <th>1</th>
      <td>21</td>
      <td>9600</td>
      <td>OWN</td>
      <td>5.0</td>
      <td>EDUCATION</td>
      <td>B</td>
      <td>1000</td>
      <td>11.14</td>
      <td>0</td>
      <td>0.10</td>
      <td>N</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>25</td>
      <td>9600</td>
      <td>MORTGAGE</td>
      <td>1.0</td>
      <td>MEDICAL</td>
      <td>C</td>
      <td>5500</td>
      <td>12.87</td>
      <td>1</td>
      <td>0.57</td>
      <td>N</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>23</td>
      <td>65500</td>
      <td>RENT</td>
      <td>4.0</td>
      <td>MEDICAL</td>
      <td>C</td>
      <td>35000</td>
      <td>15.23</td>
      <td>1</td>
      <td>0.53</td>
      <td>N</td>
      <td>2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>24</td>
      <td>54400</td>
      <td>RENT</td>
      <td>8.0</td>
      <td>MEDICAL</td>
      <td>C</td>
      <td>35000</td>
      <td>14.27</td>
      <td>1</td>
      <td>0.55</td>
      <td>Y</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get an overview of the numeric columns</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>cr_loan.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>person_age</th>
      <th>person_income</th>
      <th>person_emp_length</th>
      <th>loan_amnt</th>
      <th>loan_int_rate</th>
      <th>loan_status</th>
      <th>loan_percent_income</th>
      <th>cb_person_cred_hist_length</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>32581.000000</td>
      <td>3.258100e+04</td>
      <td>31686.000000</td>
      <td>32581.000000</td>
      <td>29465.000000</td>
      <td>32581.000000</td>
      <td>32581.000000</td>
      <td>32581.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>27.734600</td>
      <td>6.607485e+04</td>
      <td>4.789686</td>
      <td>9589.371106</td>
      <td>11.011695</td>
      <td>0.218164</td>
      <td>0.170203</td>
      <td>5.804211</td>
    </tr>
    <tr>
      <th>std</th>
      <td>6.348078</td>
      <td>6.198312e+04</td>
      <td>4.142630</td>
      <td>6322.086646</td>
      <td>3.240459</td>
      <td>0.413006</td>
      <td>0.106782</td>
      <td>4.055001</td>
    </tr>
    <tr>
      <th>min</th>
      <td>20.000000</td>
      <td>4.000000e+03</td>
      <td>0.000000</td>
      <td>500.000000</td>
      <td>5.420000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>2.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>23.000000</td>
      <td>3.850000e+04</td>
      <td>2.000000</td>
      <td>5000.000000</td>
      <td>7.900000</td>
      <td>0.000000</td>
      <td>0.090000</td>
      <td>3.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>26.000000</td>
      <td>5.500000e+04</td>
      <td>4.000000</td>
      <td>8000.000000</td>
      <td>10.990000</td>
      <td>0.000000</td>
      <td>0.150000</td>
      <td>4.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>30.000000</td>
      <td>7.920000e+04</td>
      <td>7.000000</td>
      <td>12200.000000</td>
      <td>13.470000</td>
      <td>0.000000</td>
      <td>0.230000</td>
      <td>8.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>144.000000</td>
      <td>6.000000e+06</td>
      <td>123.000000</td>
      <td>35000.000000</td>
      <td>23.220000</td>
      <td>1.000000</td>
      <td>0.830000</td>
      <td>30.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get an overview of the numeric columns</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>cr_loan.describe(include<span class="op">=</span><span class="st">'object'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>person_home_ownership</th>
      <th>loan_intent</th>
      <th>loan_grade</th>
      <th>cb_person_default_on_file</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>32581</td>
      <td>32581</td>
      <td>32581</td>
      <td>32581</td>
    </tr>
    <tr>
      <th>unique</th>
      <td>4</td>
      <td>6</td>
      <td>7</td>
      <td>2</td>
    </tr>
    <tr>
      <th>top</th>
      <td>RENT</td>
      <td>EDUCATION</td>
      <td>A</td>
      <td>N</td>
    </tr>
    <tr>
      <th>freq</th>
      <td>16446</td>
      <td>6453</td>
      <td>10777</td>
      <td>26836</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Similarly, visualizations provide a high level view of the data in addition to important trends and patterns. Let’s plot a histogram of <code>loan_amt</code> which will provide us with a visual of the distribution of loan amounts.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the distribution of loan amounts with a histogram</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>n, bins, patches <span class="op">=</span> plt.hist(x<span class="op">=</span>cr_loan[<span class="st">'loan_amnt'</span>], bins<span class="op">=</span><span class="st">'auto'</span>, color<span class="op">=</span><span class="st">'blue'</span>,alpha<span class="op">=</span><span class="fl">0.7</span>, rwidth<span class="op">=</span><span class="fl">0.85</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Loan Amount"</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Credit_Risk_Modelling_files/figure-html/cell-7-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Let’s investigate the relationship between income and age, by creating a scatter plot. In this case, <code>income</code> is the <code>independent</code> variable and <code>age</code> is the <code>dependent</code> variable.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"There are over 32 000 rows of data so the scatter plot may take a little while to plot."</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot a scatter plot of income against age</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>plt.scatter(cr_loan[<span class="st">'person_income'</span>], cr_loan[<span class="st">'person_age'</span>],c<span class="op">=</span><span class="st">'blue'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Personal Income'</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Person Age'</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are over 32 000 rows of data so the scatter plot may take a little while to plot.</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Credit_Risk_Modelling_files/figure-html/cell-8-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Starting with data exploration helps us keep from getting <em>a.head()</em> of ourselves! We can already see a positive correlation with age and income, which could mean these older recipients are further along in their career and therefore earn higher salaries. There also appears to be an outlier in the data.</p>
</section>
<section id="crosstab-and-pivot-tables" class="level3">
<h3 class="anchored" data-anchor-id="crosstab-and-pivot-tables">1.2 Crosstab and pivot tables</h3>
<p>Often, financial data is viewed as a pivot table in spreadsheets like Excel. With <code>cross tables</code>, we can get a high level view of selected columns and even aggregation like a count or average. For most credit risk models, especially for probability of default, columns like <code>person_emp_length</code> and <code>person_home_ownership</code> are common to begin investigating.</p>
<p>We will be able to see how the values are populated throughout the data, and visualize them. For now, we need to check how <code>loan_status</code> is affected by factors like home ownership status, loan grade, and loan percentage of income.</p>
<p>Let’s dive in, and create a cross table of <code>loan_intent</code> and <code>loan_status</code> :</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a cross table of the loan intent and loan status</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>pd.crosstab(cr_loan[<span class="st">'loan_intent'</span>], cr_loan[<span class="st">'loan_status'</span>], margins <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>loan_status</th>
      <th>0</th>
      <th>1</th>
      <th>All</th>
    </tr>
    <tr>
      <th>loan_intent</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>DEBTCONSOLIDATION</th>
      <td>3722</td>
      <td>1490</td>
      <td>5212</td>
    </tr>
    <tr>
      <th>EDUCATION</th>
      <td>5342</td>
      <td>1111</td>
      <td>6453</td>
    </tr>
    <tr>
      <th>HOMEIMPROVEMENT</th>
      <td>2664</td>
      <td>941</td>
      <td>3605</td>
    </tr>
    <tr>
      <th>MEDICAL</th>
      <td>4450</td>
      <td>1621</td>
      <td>6071</td>
    </tr>
    <tr>
      <th>PERSONAL</th>
      <td>4423</td>
      <td>1098</td>
      <td>5521</td>
    </tr>
    <tr>
      <th>VENTURE</th>
      <td>4872</td>
      <td>847</td>
      <td>5719</td>
    </tr>
    <tr>
      <th>All</th>
      <td>25473</td>
      <td>7108</td>
      <td>32581</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>So, the largest number of loan defaults <code>1,621</code> happen when the reason for the loan was to cover medical expenses. That is perhaps not surprising - in some cases the medical conditon might mean that the loan customer is unable to work and therefore might struggle to keep up with the loan repayments.</p>
<p>Let’s now look at home ownership grouped by <code>loan_status</code> and <code>loan_grade</code> :</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a cross table of home ownership, loan status, and grade</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>pd.crosstab(cr_loan[<span class="st">'person_home_ownership'</span>],[cr_loan[<span class="st">'loan_status'</span>],cr_loan[<span class="st">'loan_grade'</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>loan_status</th>
      <th colspan="7" halign="left">0</th>
      <th colspan="7" halign="left">1</th>
    </tr>
    <tr>
      <th>loan_grade</th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
      <th>D</th>
      <th>E</th>
      <th>F</th>
      <th>G</th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
      <th>D</th>
      <th>E</th>
      <th>F</th>
      <th>G</th>
    </tr>
    <tr>
      <th>person_home_ownership</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>MORTGAGE</th>
      <td>5219</td>
      <td>3729</td>
      <td>1934</td>
      <td>658</td>
      <td>178</td>
      <td>36</td>
      <td>0</td>
      <td>239</td>
      <td>324</td>
      <td>321</td>
      <td>553</td>
      <td>161</td>
      <td>61</td>
      <td>31</td>
    </tr>
    <tr>
      <th>OTHER</th>
      <td>23</td>
      <td>29</td>
      <td>11</td>
      <td>9</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>5</td>
      <td>6</td>
      <td>11</td>
      <td>6</td>
      <td>2</td>
      <td>0</td>
    </tr>
    <tr>
      <th>OWN</th>
      <td>860</td>
      <td>770</td>
      <td>464</td>
      <td>264</td>
      <td>26</td>
      <td>7</td>
      <td>0</td>
      <td>66</td>
      <td>34</td>
      <td>31</td>
      <td>18</td>
      <td>31</td>
      <td>8</td>
      <td>5</td>
    </tr>
    <tr>
      <th>RENT</th>
      <td>3602</td>
      <td>4222</td>
      <td>2710</td>
      <td>554</td>
      <td>137</td>
      <td>28</td>
      <td>1</td>
      <td>765</td>
      <td>1338</td>
      <td>981</td>
      <td>1559</td>
      <td>423</td>
      <td>99</td>
      <td>27</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>So the largest amount of loan defaults <code>1,559</code> happen where the customer is a renter, and has taken out a loan grade <code>D</code>. We don’t know what these gradings mean and should find out more to aid our understanding.</p>
<p>Let’s now look at home ownership grouped by <code>loan_status</code> and average <code>loan_percent_income</code> :</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a cross table of home ownership, loan status, and average percent income</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>pd.crosstab(cr_loan[<span class="st">'person_home_ownership'</span>], cr_loan[<span class="st">'loan_status'</span>],</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>              values<span class="op">=</span>cr_loan[<span class="st">'loan_percent_income'</span>], aggfunc<span class="op">=</span><span class="st">'mean'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>loan_status</th>
      <th>0</th>
      <th>1</th>
    </tr>
    <tr>
      <th>person_home_ownership</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>MORTGAGE</th>
      <td>0.146504</td>
      <td>0.184882</td>
    </tr>
    <tr>
      <th>OTHER</th>
      <td>0.143784</td>
      <td>0.300000</td>
    </tr>
    <tr>
      <th>OWN</th>
      <td>0.180013</td>
      <td>0.297358</td>
    </tr>
    <tr>
      <th>RENT</th>
      <td>0.144611</td>
      <td>0.264859</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Let’s now create a <code>boxplot</code> of the loan’s percent of the person’s income grouped by <code>loan_status</code> :</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a box plot of percentage income by loan status</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>cr_loan.boxplot(column <span class="op">=</span> [<span class="st">'loan_percent_income'</span>], by <span class="op">=</span> <span class="st">'loan_status'</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Average Percent Income by Loan Status'</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">''</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Credit_Risk_Modelling_files/figure-html/cell-12-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>It looks like the average percentage of income for defaults is higher. This could indicate those recipients have a debt-to-income ratio that’s already too high.</p>
</section>
<section id="finding-outliers-with-cross-tables" class="level3">
<h3 class="anchored" data-anchor-id="finding-outliers-with-cross-tables">1.3 Finding outliers with cross tables</h3>
<p>Now we need to find and remove outliers we suspect might be in the data. For this exercise, we can use cross tables and aggregate functions.</p>
<p>Have a look at the person_emp_length column. We used the aggfunc = <code>mean</code> argument to see the average of a numeric column before, but to detect outliers we can use other functions like <code>min</code> and <code>max</code>.</p>
<p>It may not be possible for a person to have an employment length of less than 0 or greater than 60. We can use cross tables to check the data and see if there are any instances of this!</p>
<p>Let’s print the cross table of <code>loan_status</code> and <code>person_home_ownership</code> with the <strong>max</strong> <code>person_emp_length</code> :</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the cross table for loan status, home ownership, and the max employment length</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>pd.crosstab(cr_loan[<span class="st">'loan_status'</span>],cr_loan[<span class="st">'person_home_ownership'</span>],</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span>cr_loan[<span class="st">'person_emp_length'</span>], aggfunc<span class="op">=</span><span class="st">'max'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>person_home_ownership</th>
      <th>MORTGAGE</th>
      <th>OTHER</th>
      <th>OWN</th>
      <th>RENT</th>
    </tr>
    <tr>
      <th>loan_status</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>123.0</td>
      <td>24.0</td>
      <td>31.0</td>
      <td>41.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>34.0</td>
      <td>11.0</td>
      <td>17.0</td>
      <td>123.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Let’s now create an array of indices for records with an employment length greater than 60. Store it as indices.</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an array of indices where employment length is greater than 60</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>indices <span class="op">=</span> cr_loan[cr_loan[<span class="st">'person_emp_length'</span>] <span class="op">&gt;</span> <span class="dv">60</span>].index</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And then drop those records from the data :</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop the records from the data based on the indices and create a new dataframe</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>cr_loan <span class="op">=</span> cr_loan.drop(indices)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>cr_loan</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>person_age</th>
      <th>person_income</th>
      <th>person_home_ownership</th>
      <th>person_emp_length</th>
      <th>loan_intent</th>
      <th>loan_grade</th>
      <th>loan_amnt</th>
      <th>loan_int_rate</th>
      <th>loan_status</th>
      <th>loan_percent_income</th>
      <th>cb_person_default_on_file</th>
      <th>cb_person_cred_hist_length</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>21</td>
      <td>9600</td>
      <td>OWN</td>
      <td>5.0</td>
      <td>EDUCATION</td>
      <td>B</td>
      <td>1000</td>
      <td>11.14</td>
      <td>0</td>
      <td>0.10</td>
      <td>N</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>25</td>
      <td>9600</td>
      <td>MORTGAGE</td>
      <td>1.0</td>
      <td>MEDICAL</td>
      <td>C</td>
      <td>5500</td>
      <td>12.87</td>
      <td>1</td>
      <td>0.57</td>
      <td>N</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>23</td>
      <td>65500</td>
      <td>RENT</td>
      <td>4.0</td>
      <td>MEDICAL</td>
      <td>C</td>
      <td>35000</td>
      <td>15.23</td>
      <td>1</td>
      <td>0.53</td>
      <td>N</td>
      <td>2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>24</td>
      <td>54400</td>
      <td>RENT</td>
      <td>8.0</td>
      <td>MEDICAL</td>
      <td>C</td>
      <td>35000</td>
      <td>14.27</td>
      <td>1</td>
      <td>0.55</td>
      <td>Y</td>
      <td>4</td>
    </tr>
    <tr>
      <th>5</th>
      <td>21</td>
      <td>9900</td>
      <td>OWN</td>
      <td>2.0</td>
      <td>VENTURE</td>
      <td>A</td>
      <td>2500</td>
      <td>7.14</td>
      <td>1</td>
      <td>0.25</td>
      <td>N</td>
      <td>2</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>32576</th>
      <td>57</td>
      <td>53000</td>
      <td>MORTGAGE</td>
      <td>1.0</td>
      <td>PERSONAL</td>
      <td>C</td>
      <td>5800</td>
      <td>13.16</td>
      <td>0</td>
      <td>0.11</td>
      <td>N</td>
      <td>30</td>
    </tr>
    <tr>
      <th>32577</th>
      <td>54</td>
      <td>120000</td>
      <td>MORTGAGE</td>
      <td>4.0</td>
      <td>PERSONAL</td>
      <td>A</td>
      <td>17625</td>
      <td>7.49</td>
      <td>0</td>
      <td>0.15</td>
      <td>N</td>
      <td>19</td>
    </tr>
    <tr>
      <th>32578</th>
      <td>65</td>
      <td>76000</td>
      <td>RENT</td>
      <td>3.0</td>
      <td>HOMEIMPROVEMENT</td>
      <td>B</td>
      <td>35000</td>
      <td>10.99</td>
      <td>1</td>
      <td>0.46</td>
      <td>N</td>
      <td>28</td>
    </tr>
    <tr>
      <th>32579</th>
      <td>56</td>
      <td>150000</td>
      <td>MORTGAGE</td>
      <td>5.0</td>
      <td>PERSONAL</td>
      <td>B</td>
      <td>15000</td>
      <td>11.48</td>
      <td>0</td>
      <td>0.10</td>
      <td>N</td>
      <td>26</td>
    </tr>
    <tr>
      <th>32580</th>
      <td>66</td>
      <td>42000</td>
      <td>RENT</td>
      <td>2.0</td>
      <td>MEDICAL</td>
      <td>B</td>
      <td>6475</td>
      <td>9.99</td>
      <td>0</td>
      <td>0.15</td>
      <td>N</td>
      <td>30</td>
    </tr>
  </tbody>
</table>
<p>32579 rows × 12 columns</p>
</div>
</div>
</div>
<p>We now have 32,759 rows - two have been removed following our removal of records with an employment length greater than 60.</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the cross table from earlier and include minimum employment length</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>pd.crosstab(cr_loan[<span class="st">'loan_status'</span>],cr_loan[<span class="st">'person_home_ownership'</span>],</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>            values<span class="op">=</span>cr_loan[<span class="st">'person_emp_length'</span>], aggfunc<span class="op">=</span>[<span class="st">'min'</span>,<span class="st">'max'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th colspan="4" halign="left">min</th>
      <th colspan="4" halign="left">max</th>
    </tr>
    <tr>
      <th>person_home_ownership</th>
      <th>MORTGAGE</th>
      <th>OTHER</th>
      <th>OWN</th>
      <th>RENT</th>
      <th>MORTGAGE</th>
      <th>OTHER</th>
      <th>OWN</th>
      <th>RENT</th>
    </tr>
    <tr>
      <th>loan_status</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>38.0</td>
      <td>24.0</td>
      <td>31.0</td>
      <td>41.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>34.0</td>
      <td>11.0</td>
      <td>17.0</td>
      <td>27.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Generally with credit data, key columns like <code>person_emp_length</code> are of high quality, but there is always room for error. With this in mind, we build our intuition for detecting outliers!</p>
</section>
<section id="visualizing-credit-outliers" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-credit-outliers">1.4 Visualizing credit outliers</h3>
<p>We discovered outliers in <code>person_emp_length</code> where values greater than 60 were far above the norm. <code>person_age</code> is another column in which a person can use a common sense approach to say it is very unlikely that a person applying for a loan will be over 100 years old.</p>
<p>Visualizing the data here can be another easy way to detect outliers. We can use other numeric columns like <code>loan_amnt</code> and <code>loan_int_rate</code> to create plots with <code>person_age</code> to search for outliers.</p>
<p>Let’s create a scatter plot of <code>person_age</code> on the x-axis and <code>loan_amnt</code> on the y-axis :</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the scatter plot for age and amount</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>plt.scatter(cr_loan[<span class="st">'person_age'</span>], cr_loan[<span class="st">'loan_amnt'</span>], c<span class="op">=</span><span class="st">'blue'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Person Age"</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Loan Amount"</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Credit_Risk_Modelling_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Let’s use the <code>.drop()</code> method from Pandas to remove the outliers :</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use Pandas to drop the record from the data frame and create a new one</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>cr_loan <span class="op">=</span> cr_loan.drop(cr_loan[cr_loan[<span class="st">'person_age'</span>] <span class="op">&gt;</span> <span class="dv">100</span>].index)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>cr_loan</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>person_age</th>
      <th>person_income</th>
      <th>person_home_ownership</th>
      <th>person_emp_length</th>
      <th>loan_intent</th>
      <th>loan_grade</th>
      <th>loan_amnt</th>
      <th>loan_int_rate</th>
      <th>loan_status</th>
      <th>loan_percent_income</th>
      <th>cb_person_default_on_file</th>
      <th>cb_person_cred_hist_length</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>21</td>
      <td>9600</td>
      <td>OWN</td>
      <td>5.0</td>
      <td>EDUCATION</td>
      <td>B</td>
      <td>1000</td>
      <td>11.14</td>
      <td>0</td>
      <td>0.10</td>
      <td>N</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>25</td>
      <td>9600</td>
      <td>MORTGAGE</td>
      <td>1.0</td>
      <td>MEDICAL</td>
      <td>C</td>
      <td>5500</td>
      <td>12.87</td>
      <td>1</td>
      <td>0.57</td>
      <td>N</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>23</td>
      <td>65500</td>
      <td>RENT</td>
      <td>4.0</td>
      <td>MEDICAL</td>
      <td>C</td>
      <td>35000</td>
      <td>15.23</td>
      <td>1</td>
      <td>0.53</td>
      <td>N</td>
      <td>2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>24</td>
      <td>54400</td>
      <td>RENT</td>
      <td>8.0</td>
      <td>MEDICAL</td>
      <td>C</td>
      <td>35000</td>
      <td>14.27</td>
      <td>1</td>
      <td>0.55</td>
      <td>Y</td>
      <td>4</td>
    </tr>
    <tr>
      <th>5</th>
      <td>21</td>
      <td>9900</td>
      <td>OWN</td>
      <td>2.0</td>
      <td>VENTURE</td>
      <td>A</td>
      <td>2500</td>
      <td>7.14</td>
      <td>1</td>
      <td>0.25</td>
      <td>N</td>
      <td>2</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>32576</th>
      <td>57</td>
      <td>53000</td>
      <td>MORTGAGE</td>
      <td>1.0</td>
      <td>PERSONAL</td>
      <td>C</td>
      <td>5800</td>
      <td>13.16</td>
      <td>0</td>
      <td>0.11</td>
      <td>N</td>
      <td>30</td>
    </tr>
    <tr>
      <th>32577</th>
      <td>54</td>
      <td>120000</td>
      <td>MORTGAGE</td>
      <td>4.0</td>
      <td>PERSONAL</td>
      <td>A</td>
      <td>17625</td>
      <td>7.49</td>
      <td>0</td>
      <td>0.15</td>
      <td>N</td>
      <td>19</td>
    </tr>
    <tr>
      <th>32578</th>
      <td>65</td>
      <td>76000</td>
      <td>RENT</td>
      <td>3.0</td>
      <td>HOMEIMPROVEMENT</td>
      <td>B</td>
      <td>35000</td>
      <td>10.99</td>
      <td>1</td>
      <td>0.46</td>
      <td>N</td>
      <td>28</td>
    </tr>
    <tr>
      <th>32579</th>
      <td>56</td>
      <td>150000</td>
      <td>MORTGAGE</td>
      <td>5.0</td>
      <td>PERSONAL</td>
      <td>B</td>
      <td>15000</td>
      <td>11.48</td>
      <td>0</td>
      <td>0.10</td>
      <td>N</td>
      <td>26</td>
    </tr>
    <tr>
      <th>32580</th>
      <td>66</td>
      <td>42000</td>
      <td>RENT</td>
      <td>2.0</td>
      <td>MEDICAL</td>
      <td>B</td>
      <td>6475</td>
      <td>9.99</td>
      <td>0</td>
      <td>0.15</td>
      <td>N</td>
      <td>30</td>
    </tr>
  </tbody>
</table>
<p>32574 rows × 12 columns</p>
</div>
</div>
</div>
<p>We now have 32,574 rows - a further five have been removed following our removal of records with an age greater than 100.</p>
<p>Then, let’s create a scatter plot of <code>person_age</code> on the x-axis and <code>loan_int_rate</code> on the y-axis with a label for <code>loan_status</code> :</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a scatter plot of age and interest rate</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">"blue"</span>,<span class="st">"red"</span>] <span class="co"># default is red</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>plt.scatter(cr_loan[<span class="st">'person_age'</span>], cr_loan[<span class="st">'loan_int_rate'</span>],</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>            c <span class="op">=</span> cr_loan[<span class="st">'loan_status'</span>],</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>            cmap <span class="op">=</span> matplotlib.colors.ListedColormap(colors),</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>            alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Person Age"</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Loan Interest Rate"</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Credit_Risk_Modelling_files/figure-html/cell-19-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Notice that in the last plot we have <code>loan_status</code> as a label for colors. This shows a different color depending on the class (red for default). In this case, it’s loan default and non-default, and it looks like there are more defaults with high interest rates.</p>
</section>
<section id="replacing-missing-credit-data" class="level3">
<h3 class="anchored" data-anchor-id="replacing-missing-credit-data">1.5 Replacing missing credit data</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/ae76b6c7-d527-40d5-b186-e45591e905bd.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">missing_data.JPG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/e6ef49f1-7d30-4031-972f-2c272ce91644.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">missing_data_perf.JPG</figcaption><p></p>
</figure>
</div>
<p>Now, we should check for missing data. If we find missing data within <code>loan_status</code>, we would not be able to use the data for predicting probability of default because we wouldn’t know if the loan was a default or not. Missing data within <code>person_emp_length</code> would not be as damaging, but would still cause training errors.</p>
<p>So, let’s check for missing data in the <code>person_emp_length</code> column and replace any missing values with the median.</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print a null value column array</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>cr_loan.columns[cr_loan.isnull().<span class="bu">any</span>()]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>Index(['person_emp_length', 'loan_int_rate'], dtype='object')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the top five rows with nulls for employment length</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>cr_loan[cr_loan[<span class="st">'person_emp_length'</span>].isnull()].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>person_age</th>
      <th>person_income</th>
      <th>person_home_ownership</th>
      <th>person_emp_length</th>
      <th>loan_intent</th>
      <th>loan_grade</th>
      <th>loan_amnt</th>
      <th>loan_int_rate</th>
      <th>loan_status</th>
      <th>loan_percent_income</th>
      <th>cb_person_default_on_file</th>
      <th>cb_person_cred_hist_length</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>105</th>
      <td>22</td>
      <td>12600</td>
      <td>MORTGAGE</td>
      <td>NaN</td>
      <td>PERSONAL</td>
      <td>A</td>
      <td>2000</td>
      <td>5.42</td>
      <td>1</td>
      <td>0.16</td>
      <td>N</td>
      <td>4</td>
    </tr>
    <tr>
      <th>222</th>
      <td>24</td>
      <td>185000</td>
      <td>MORTGAGE</td>
      <td>NaN</td>
      <td>EDUCATION</td>
      <td>B</td>
      <td>35000</td>
      <td>12.42</td>
      <td>0</td>
      <td>0.19</td>
      <td>N</td>
      <td>2</td>
    </tr>
    <tr>
      <th>379</th>
      <td>24</td>
      <td>16800</td>
      <td>MORTGAGE</td>
      <td>NaN</td>
      <td>DEBTCONSOLIDATION</td>
      <td>A</td>
      <td>3900</td>
      <td>NaN</td>
      <td>1</td>
      <td>0.23</td>
      <td>N</td>
      <td>3</td>
    </tr>
    <tr>
      <th>407</th>
      <td>25</td>
      <td>52000</td>
      <td>RENT</td>
      <td>NaN</td>
      <td>PERSONAL</td>
      <td>B</td>
      <td>24000</td>
      <td>10.74</td>
      <td>1</td>
      <td>0.46</td>
      <td>N</td>
      <td>2</td>
    </tr>
    <tr>
      <th>408</th>
      <td>22</td>
      <td>17352</td>
      <td>MORTGAGE</td>
      <td>NaN</td>
      <td>EDUCATION</td>
      <td>C</td>
      <td>2250</td>
      <td>15.27</td>
      <td>0</td>
      <td>0.13</td>
      <td>Y</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Impute the null values with the median value for all employment lengths</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>cr_loan[<span class="st">'person_emp_length'</span>].fillna((cr_loan[<span class="st">'person_emp_length'</span>].median()), inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a histogram of employment length</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>n, bins, patches <span class="op">=</span> plt.hist(cr_loan[<span class="st">'person_emp_length'</span>], bins<span class="op">=</span><span class="st">'auto'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Person Employment Length"</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Credit_Risk_Modelling_files/figure-html/cell-22-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We can use several different functions like <code>mean()</code> and <code>median()</code> to replace missing data. The goal here is to keep as much of our data as we can! It’s also important to check the distribution of that feature to see if it changed.</p>
</section>
<section id="removing-missing-data" class="level3">
<h3 class="anchored" data-anchor-id="removing-missing-data">1.6 Removing missing data</h3>
<p>We replaced missing data in <code>person_emp_length</code>, but in the previous section we saw that <code>loan_int_rate</code> has missing data as well.</p>
<p>Similar to having missing data within <code>loan_status</code>, having missing data within <code>loan_int_rate</code> will make predictions difficult.</p>
<p>Because interest rates are set by our company, having missing data in this column is very strange. It’s possible that data ingestion issues created errors, but we cannot know for sure. For now, it’s best to <code>.drop()</code> these records before moving forward.</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the number of nulls</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cr_loan[<span class="st">'loan_int_rate'</span>].isnull().<span class="bu">sum</span>())</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Store the array on indices</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>indices <span class="op">=</span> cr_loan[cr_loan[<span class="st">'loan_int_rate'</span>].isnull()].index</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                  </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the new data without missing data</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>cr_loan_clean <span class="op">=</span> cr_loan.drop(indices)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3115</code></pre>
</div>
</div>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>cr_loan_clean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>person_age</th>
      <th>person_income</th>
      <th>person_home_ownership</th>
      <th>person_emp_length</th>
      <th>loan_intent</th>
      <th>loan_grade</th>
      <th>loan_amnt</th>
      <th>loan_int_rate</th>
      <th>loan_status</th>
      <th>loan_percent_income</th>
      <th>cb_person_default_on_file</th>
      <th>cb_person_cred_hist_length</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>21</td>
      <td>9600</td>
      <td>OWN</td>
      <td>5.0</td>
      <td>EDUCATION</td>
      <td>B</td>
      <td>1000</td>
      <td>11.14</td>
      <td>0</td>
      <td>0.10</td>
      <td>N</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>25</td>
      <td>9600</td>
      <td>MORTGAGE</td>
      <td>1.0</td>
      <td>MEDICAL</td>
      <td>C</td>
      <td>5500</td>
      <td>12.87</td>
      <td>1</td>
      <td>0.57</td>
      <td>N</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>23</td>
      <td>65500</td>
      <td>RENT</td>
      <td>4.0</td>
      <td>MEDICAL</td>
      <td>C</td>
      <td>35000</td>
      <td>15.23</td>
      <td>1</td>
      <td>0.53</td>
      <td>N</td>
      <td>2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>24</td>
      <td>54400</td>
      <td>RENT</td>
      <td>8.0</td>
      <td>MEDICAL</td>
      <td>C</td>
      <td>35000</td>
      <td>14.27</td>
      <td>1</td>
      <td>0.55</td>
      <td>Y</td>
      <td>4</td>
    </tr>
    <tr>
      <th>5</th>
      <td>21</td>
      <td>9900</td>
      <td>OWN</td>
      <td>2.0</td>
      <td>VENTURE</td>
      <td>A</td>
      <td>2500</td>
      <td>7.14</td>
      <td>1</td>
      <td>0.25</td>
      <td>N</td>
      <td>2</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>32576</th>
      <td>57</td>
      <td>53000</td>
      <td>MORTGAGE</td>
      <td>1.0</td>
      <td>PERSONAL</td>
      <td>C</td>
      <td>5800</td>
      <td>13.16</td>
      <td>0</td>
      <td>0.11</td>
      <td>N</td>
      <td>30</td>
    </tr>
    <tr>
      <th>32577</th>
      <td>54</td>
      <td>120000</td>
      <td>MORTGAGE</td>
      <td>4.0</td>
      <td>PERSONAL</td>
      <td>A</td>
      <td>17625</td>
      <td>7.49</td>
      <td>0</td>
      <td>0.15</td>
      <td>N</td>
      <td>19</td>
    </tr>
    <tr>
      <th>32578</th>
      <td>65</td>
      <td>76000</td>
      <td>RENT</td>
      <td>3.0</td>
      <td>HOMEIMPROVEMENT</td>
      <td>B</td>
      <td>35000</td>
      <td>10.99</td>
      <td>1</td>
      <td>0.46</td>
      <td>N</td>
      <td>28</td>
    </tr>
    <tr>
      <th>32579</th>
      <td>56</td>
      <td>150000</td>
      <td>MORTGAGE</td>
      <td>5.0</td>
      <td>PERSONAL</td>
      <td>B</td>
      <td>15000</td>
      <td>11.48</td>
      <td>0</td>
      <td>0.10</td>
      <td>N</td>
      <td>26</td>
    </tr>
    <tr>
      <th>32580</th>
      <td>66</td>
      <td>42000</td>
      <td>RENT</td>
      <td>2.0</td>
      <td>MEDICAL</td>
      <td>B</td>
      <td>6475</td>
      <td>9.99</td>
      <td>0</td>
      <td>0.15</td>
      <td>N</td>
      <td>30</td>
    </tr>
  </tbody>
</table>
<p>29459 rows × 12 columns</p>
</div>
</div>
</div>
<p>Our clean dataset now has 29,459 - 3,115 have been removed as these contained nulls.</p>
<p>Now that the missing data and outliers have been processed, the data is ready for modeling! More often than not, financial data is fairly tidy, but it’s always good to practice preparing data for analytical work.</p>
</section>
</section>
<section id="logistic-regression-for-defaults" class="level2">
<h2 class="anchored" data-anchor-id="logistic-regression-for-defaults">2. Logistic Regression for Defaults</h2>
<p>With the loan data fully prepared, we will discuss the <code>logistic regression</code> model which is a standard in risk modeling. We will understand the components of this model as well as how to score its performance. Once we’ve created predictions, we can explore the financial impact of utilizing this model.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/7742599d-26b8-42d0-9b64-567d871f418d.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">deafult_prob.JPG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/bf2d962c-3834-47ca-b393-2ea4221aca1e.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">probabilities.JPG</figcaption><p></p>
</figure>
</div>
<section id="logistic-regression-basics" class="level3">
<h3 class="anchored" data-anchor-id="logistic-regression-basics">2.1 Logistic regression basics</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/d772c79a-8bd8-4f8f-9fb1-e48f7790f152.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">logistic_regression.JPG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/139db9b9-ef43-4785-8f0e-ce9af9225562.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">scikit_learn.JPG</figcaption><p></p>
</figure>
</div>
<p>YWe have now cleaned up the data and created the new data set <code>cr_loan_clean</code>.</p>
<p>Think back to the final scatter plot from section 1 which showed more defaults with high <code>loan_int_rate</code>. Interest rates are easy to understand, but how useful are they for predicting the probability of default?</p>
<p>Since we haven’t tried predicting the probability of default yet, let’s test out creating and training a logistic regression model with <strong>just</strong> <code>loan_int_rate</code>. Also check the model’s internal parameters, which are like settings, to see the structure of the model with this one column.</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">## import required packages</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> metrics</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> precision_recall_fscore_support</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> roc_curve</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> roc_auc_score</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> recall_score</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the X and y data sets</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> cr_loan_clean[[<span class="st">'loan_int_rate'</span>]]</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> cr_loan_clean[[<span class="st">'loan_status'</span>]]</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and fit a logistic regression model</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>clf_logistic_single <span class="op">=</span> LogisticRegression(solver<span class="op">=</span><span class="st">'lbfgs'</span>) <span class="co"># solver is the optimizer like we have in Excel for gradient descent</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>clf_logistic_single.fit(X, np.ravel(y))</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the parameters of the model</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(clf_logistic_single.get_params())</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the intercept of the model</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(clf_logistic_single.intercept_)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'C': 1.0, 'class_weight': None, 'dual': False, 'fit_intercept': True, 'intercept_scaling': 1, 'l1_ratio': None, 'max_iter': 100, 'multi_class': 'auto', 'n_jobs': None, 'penalty': 'l2', 'random_state': None, 'solver': 'lbfgs', 'tol': 0.0001, 'verbose': 0, 'warm_start': False}
[-4.45785901]</code></pre>
</div>
</div>
<p>Note the <code>solver</code> included within the Logistic Regression model. This is like the solver function within Excel which is used to optimize the randomized initial weightings, a bit like <code>Stochastic Gradient Descent (SGD)</code>. The particular solver or algorithm used here is <code>lbfgs</code> which stands for <a href="https://en.wikipedia.org/wiki/Limited-memory_BFGS">Limited-memory - Broyden–Fletcher–Goldfarb–Shanno</a>.</p>
<p>Note that we use Numpy’s <strong><a href="https://numpy.org/doc/stable/reference/generated/numpy.ravel.html">np.ravel</a></strong> to make our labels a one-dimensional <code>array</code> instead of a DataFrame as this is the format our model requires.</p>
<p>Notice that the model was able to fit to the data, and establish some parameters internally. It’s even produced a y <code>.intercept_</code> value <code>[-4.45785901]</code> which represents the overall <code>log-odds</code> of non-default. What if we use more than one column?</p>
</section>
<section id="multivariate-logistic-regression" class="level3">
<h3 class="anchored" data-anchor-id="multivariate-logistic-regression">2.2 Multivariate logistic regression</h3>
<p>Generally, we won’t use only <code>loan_int_rate</code> to predict the probability of default. We will want to use all the data we have to make predictions.</p>
<p>With this in mind, let’s try training a new model with different columns, called features, from the <code>cr_loan_clean</code> data. Will this model differ from the first one? For this, we can easily check the <code>.intercept_</code> of the logistic regression. Remember that this is the y-intercept of the function and the overall <code>log-odds</code> of non-default.</p>
<p>Let’s add employment length to our features:</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create X data for the model</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>X_multi <span class="op">=</span> cr_loan_clean[[<span class="st">'loan_int_rate'</span>,<span class="st">'person_emp_length'</span>]]</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a set of y data for training</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> cr_loan_clean[[<span class="st">'loan_status'</span>]]</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and train a new logistic regression</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>clf_logistic_multi <span class="op">=</span> LogisticRegression(solver<span class="op">=</span><span class="st">'lbfgs'</span>).fit(X_multi, np.ravel(y))</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the intercept of the model</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(clf_logistic_multi.intercept_)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[-4.21645549]</code></pre>
</div>
</div>
<p>Take a closer look at each model’s <code>.intercept_</code> value. The values have changed! The new <code>clf_logistic_multi model</code> has an <code>.intercept_ value</code> closer to zero. This means the log odds of a non-default is approaching zero.</p>
</section>
<section id="creating-training-and-test-sets" class="level3">
<h3 class="anchored" data-anchor-id="creating-training-and-test-sets">2.3 Creating training and test sets</h3>
<p><img src="Credit_Risk_Modelling_files/figure-html/99c966fd-5072-4e08-94be-a37eec31bd5f.JPG" class="img-fluid" alt="train_test_split.JPG"><img src="Credit_Risk_Modelling_files/figure-html/9e878d03-fc72-4bb4-bd30-4a61f6fc73d9.jpg" class="img-fluid" alt="download.jpg"></p>
<p>We’ve just trained LogisticRegression() models on different columns. we know that the data should be separated into training and test sets. <code>test_train_split()</code> is used to create both at the same time. The training set is used to make predictions, while the test set is used for evaluation. Without evaluating the model, we have no way to tell how well it will perform on new loan data.</p>
<p>In addition to the <code>intercept_</code>, which is an attribute of the model, <code>LogisticRegression()</code> models also have the <code>.coef_ attribute</code>. This shows how important each training column is for predicting the probability of default.</p>
<p>Let’s create a data set <code>X</code> using interest rate, employment length, and income. Create the <code>y</code> set as always using our target variable (label) loan status :</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the X and y data sets</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> cr_loan_clean[[<span class="st">'loan_int_rate'</span>,<span class="st">'person_emp_length'</span>,<span class="st">'person_income'</span>]]</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> cr_loan_clean[[<span class="st">'loan_status'</span>]]</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Use test_train_split to create the training and test sets</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">.4</span>, random_state<span class="op">=</span><span class="dv">123</span>)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and fit the logistic regression model to our training set</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>clf_logistic <span class="op">=</span> LogisticRegression(solver<span class="op">=</span><span class="st">'lbfgs'</span>).fit(X_train, np.ravel(y_train))</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the model coefficients</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(clf_logistic .coef_)</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the model intercept</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(clf_logistic.intercept_)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[ 1.28517496e-09 -2.27622202e-09 -2.17211991e-05]]
[-3.30582292e-10]</code></pre>
</div>
</div>
<p>We can see that three columns were used for training and there are three values in .coef_. This tells us how important each column, or feature, was for predicting. The more positive the value, the more it predicts defaults, for example look at the value for <code>loan_int_rate</code> - 1.28517496e-09. This makes sense, the higher the interest rate the higher the loan repayments and therefore an increased risk of default. On the other hand we have negative values for both employment length and income. This also makes sense. A long time in employment suggests stability and the higher a person’s income is the less likely they are to default, as they are more likely to meet the loan repayments.</p>
<p>We can plug these 4 values into our Logistic Regression formula to arrive at the overall prediciton for loan default :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/876fe21e-9d15-4ff4-8448-f75d784b3bd9.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">co_efficients.JPG</figcaption><p></p>
</figure>
</div>
</section>
<section id="changing-coefficients" class="level3">
<h3 class="anchored" data-anchor-id="changing-coefficients">2.4 Changing coefficients</h3>
<p>With this understanding of the coefficients of a <code>LogisticRegression()</code> model, let’s have a closer look at them to see how they change depending on what columns are used for training. Will the column coefficients change from model to model?</p>
<p>We should <code>.fit()</code> two different <code>LogisticRegression()</code> models on different groups of columns to check. We should also consider what the potential impact on the probability of default might be.</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create X1, X2 and y datasets</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>X1 <span class="op">=</span> cr_loan_clean[[<span class="st">'person_income'</span>,<span class="st">'person_emp_length'</span>,<span class="st">'loan_amnt'</span>]]</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>X2 <span class="op">=</span> cr_loan_clean[[<span class="st">'person_income'</span>,<span class="st">'loan_percent_income'</span>,<span class="st">'cb_person_cred_hist_length'</span>]]</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> cr_loan_clean[[<span class="st">'loan_status'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># train, test, split</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>X1_train, X1_test, y_train, y_test <span class="op">=</span> train_test_split(X1, y, test_size<span class="op">=</span><span class="fl">.4</span>, random_state<span class="op">=</span><span class="dv">123</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>X2_train, X2_test, y_train, y_test <span class="op">=</span> train_test_split(X2, y, test_size<span class="op">=</span><span class="fl">.4</span>, random_state<span class="op">=</span><span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the first five rows of each training set</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(X1_train.head())</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(X2_train.head())</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and train a model on the first training data</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>clf_logistic1 <span class="op">=</span> LogisticRegression(solver<span class="op">=</span><span class="st">'lbfgs'</span>).fit(X1_train, np.ravel(y_train))</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and train a model on the second training data</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>clf_logistic2 <span class="op">=</span> LogisticRegression(solver<span class="op">=</span><span class="st">'lbfgs'</span>).fit(X2_train, np.ravel(y_train))</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the coefficients of each model</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(clf_logistic1.coef_)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(clf_logistic2.coef_)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       person_income  person_emp_length  loan_amnt
24407          72000                3.0       9000
2528           21000                2.0       3000
15961           4800                0.0       1200
6966           92000                0.0       6000
13832          96000                1.0       7000
       person_income  loan_percent_income  cb_person_cred_hist_length
24407          72000                 0.13                           6
2528           21000                 0.14                           2
15961           4800                 0.25                           2
6966           92000                 0.07                           3
13832          96000                 0.07                           4
[[-4.02643517e-05 -3.06659219e-08  1.06277246e-04]]
[[-2.17213449e-05  5.29012401e-10 -2.80735543e-09]]</code></pre>
</div>
</div>
<p>Notice that the coefficient for the <code>person_income</code> changed when we changed the data from <strong>X1</strong> <code>-4.02643517e-05</code> to <strong>X2</strong> <code>-2.17213449e-05</code>. This is a reason to keep most of the data like we did in section 1, because the models will learn differently depending on what data they’re given!</p>
</section>
<section id="one-hot-encoding-credit-data" class="level3">
<h3 class="anchored" data-anchor-id="one-hot-encoding-credit-data">2.5 One-hot encoding credit data</h3>
<p>Python does not know how to deal with non-numeric columns, and so we have to use <code>one-hot encoding</code> to convert categorical data to a number - either 0 or 1.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/aab85b30-d0f3-478c-a2c7-59824b8de7ec.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">one_hot_encoding.JPG</figcaption><p></p>
</figure>
</div>
<p>We can use <code>get_dummies()</code> from the <code>pandas</code> library to do this.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/2a21da28-1f73-4d0a-b9d4-c4a6a9b9b3a8.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">get_dummies.JPG</figcaption><p></p>
</figure>
</div>
<p>It’s time to prepare the non-numeric columns so they can be added to our <code>LogisticRegression()</code> model. Once the new columns have been created using <strong>one-hot encoding</strong>, we can concatenate them with the numeric columns to create a new data frame which will be used throughout the rest of the course for predicting probability of default.</p>
<p>Remember to only one-hot encode the non-numeric columns. Doing this to the numeric columns would create an incredibly wide data set!</p>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create two data sets for numeric and non-numeric data</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>cred_num <span class="op">=</span> cr_loan_clean.select_dtypes(exclude<span class="op">=</span>[<span class="st">'object'</span>])</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>cred_str <span class="op">=</span> cr_loan_clean.select_dtypes(include<span class="op">=</span>[<span class="st">'object'</span>])</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co"># One-hot encode the non-numeric columns</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>cred_str_onehot <span class="op">=</span> pd.get_dummies(cred_str)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Union the one-hot encoded columns to the numeric ones</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>cr_loan_prep <span class="op">=</span> pd.concat([cred_num, cred_str_onehot], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the columns in the new data set</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cr_loan_prep.columns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Index(['person_age', 'person_income', 'person_emp_length', 'loan_amnt',
       'loan_int_rate', 'loan_status', 'loan_percent_income',
       'cb_person_cred_hist_length', 'person_home_ownership_MORTGAGE',
       'person_home_ownership_OTHER', 'person_home_ownership_OWN',
       'person_home_ownership_RENT', 'loan_intent_DEBTCONSOLIDATION',
       'loan_intent_EDUCATION', 'loan_intent_HOMEIMPROVEMENT',
       'loan_intent_MEDICAL', 'loan_intent_PERSONAL', 'loan_intent_VENTURE',
       'loan_grade_A', 'loan_grade_B', 'loan_grade_C', 'loan_grade_D',
       'loan_grade_E', 'loan_grade_F', 'loan_grade_G',
       'cb_person_default_on_file_N', 'cb_person_default_on_file_Y'],
      dtype='object')</code></pre>
</div>
</div>
<p>Look at all those columns! If you’ve ever seen a credit scorecard, the <code>column_name_value</code> format should look familiar. If you haven’t seen one, look up some pictures during your next break!</p>
</section>
<section id="predicting-probability-of-default" class="level3">
<h3 class="anchored" data-anchor-id="predicting-probability-of-default">2.6 Predicting probability of default</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/4281aeed-4f49-41d1-b99b-6d9af7f8a94e.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">predict.JPG</figcaption><p></p>
</figure>
</div>
<p>All of the data processing is complete and it’s time to begin creating predictions for probability of default. We want to train a <code>LogisticRegression()</code> model on the data, and examine how it predicts the probability of default.</p>
<p>So that we can better grasp what the model produces with <code>predict_proba</code>, you should look at an example record alongside the predicted probability of default. How do the first five predictions look against the actual values of loan_status?</p>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>cr_loan_prep</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>person_age</th>
      <th>person_income</th>
      <th>person_emp_length</th>
      <th>loan_amnt</th>
      <th>loan_int_rate</th>
      <th>loan_status</th>
      <th>loan_percent_income</th>
      <th>cb_person_cred_hist_length</th>
      <th>person_home_ownership_MORTGAGE</th>
      <th>person_home_ownership_OTHER</th>
      <th>...</th>
      <th>loan_intent_VENTURE</th>
      <th>loan_grade_A</th>
      <th>loan_grade_B</th>
      <th>loan_grade_C</th>
      <th>loan_grade_D</th>
      <th>loan_grade_E</th>
      <th>loan_grade_F</th>
      <th>loan_grade_G</th>
      <th>cb_person_default_on_file_N</th>
      <th>cb_person_default_on_file_Y</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>21</td>
      <td>9600</td>
      <td>5.0</td>
      <td>1000</td>
      <td>11.14</td>
      <td>0</td>
      <td>0.10</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>25</td>
      <td>9600</td>
      <td>1.0</td>
      <td>5500</td>
      <td>12.87</td>
      <td>1</td>
      <td>0.57</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>23</td>
      <td>65500</td>
      <td>4.0</td>
      <td>35000</td>
      <td>15.23</td>
      <td>1</td>
      <td>0.53</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>24</td>
      <td>54400</td>
      <td>8.0</td>
      <td>35000</td>
      <td>14.27</td>
      <td>1</td>
      <td>0.55</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>5</th>
      <td>21</td>
      <td>9900</td>
      <td>2.0</td>
      <td>2500</td>
      <td>7.14</td>
      <td>1</td>
      <td>0.25</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>32576</th>
      <td>57</td>
      <td>53000</td>
      <td>1.0</td>
      <td>5800</td>
      <td>13.16</td>
      <td>0</td>
      <td>0.11</td>
      <td>30</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>32577</th>
      <td>54</td>
      <td>120000</td>
      <td>4.0</td>
      <td>17625</td>
      <td>7.49</td>
      <td>0</td>
      <td>0.15</td>
      <td>19</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>32578</th>
      <td>65</td>
      <td>76000</td>
      <td>3.0</td>
      <td>35000</td>
      <td>10.99</td>
      <td>1</td>
      <td>0.46</td>
      <td>28</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>32579</th>
      <td>56</td>
      <td>150000</td>
      <td>5.0</td>
      <td>15000</td>
      <td>11.48</td>
      <td>0</td>
      <td>0.10</td>
      <td>26</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>32580</th>
      <td>66</td>
      <td>42000</td>
      <td>2.0</td>
      <td>6475</td>
      <td>9.99</td>
      <td>0</td>
      <td>0.15</td>
      <td>30</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>29459 rows × 27 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set features and target variable</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> cr_loan_prep.drop(<span class="st">'loan_status'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> cr_loan_prep[[<span class="st">'loan_status'</span>]]</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co"># train, test, split</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">.4</span>, random_state<span class="op">=</span><span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train the logistic regression model on the training data</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>clf_logistic <span class="op">=</span> LogisticRegression(solver<span class="op">=</span><span class="st">'lbfgs'</span>).fit(X_train, np.ravel(y_train))</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create predictions of probability for loan status using test data</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> clf_logistic.predict_proba(X_test)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dataframes of first five predictions</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>preds_df <span class="op">=</span> pd.DataFrame(preds[:,<span class="dv">1</span>][<span class="dv">0</span>:<span class="dv">5</span>], columns <span class="op">=</span> [<span class="st">'prob_default'</span>])</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dataframe of first five true labels</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>true_df <span class="op">=</span> y_test.head()</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Concatenate and print the two data frames for comparison</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.concat([true_df.reset_index(drop <span class="op">=</span> <span class="va">True</span>), preds_df], axis <span class="op">=</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   loan_status  prob_default
0            1      0.445779
1            1      0.223447
2            0      0.288558
3            0      0.169358
4            1      0.114182</code></pre>
</div>
</div>
<p>We have some predictions now, but they don’t look very accurate do they? It looks like most of the rows with <code>loan_status</code> at <code>1</code> have a low probability of default. How good are the rest of the predictions? Next, let’s see if we can determine how accurate the entire model is.</p>
</section>
<section id="default-classification-reporting" class="level3">
<h3 class="anchored" data-anchor-id="default-classification-reporting">2.7 Default classification reporting</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/c392bb32-bcd6-4355-90c5-d6dc7409f1c1.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">accuracy.JPG</figcaption><p></p>
</figure>
</div>
<p>It’s time to take a closer look at the evaluation of our model. Here is where setting the threshold for probability of default will help us analyze the model’s performance through classification reporting.</p>
<p>Creating a data frame of the probabilities makes them easier to work with, because we can use all the power of <strong>pandas</strong>. Apply the threshold to the data and check the value counts for both classes of <code>loan_status</code> to see how many predictions of each are being created. This will help with insight into the scores from the classification report.</p>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>preds_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>prob_default</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.445779</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.223447</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.288558</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.169358</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.114182</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a dataframe for the probabilities of default</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>preds_df <span class="op">=</span> pd.DataFrame(preds[:,<span class="dv">1</span>], columns <span class="op">=</span> [<span class="st">'prob_default'</span>])</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Reassign loan status based on the threshold</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>preds_df[<span class="st">'loan_status'</span>] <span class="op">=</span> preds_df[<span class="st">'prob_default'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="dv">1</span> <span class="cf">if</span> x <span class="op">&gt;</span> <span class="fl">0.5</span> <span class="cf">else</span> <span class="dv">0</span>) <span class="co"># lambda alllows us to use a function without defining it using def:</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the row counts for each loan status</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(preds_df[<span class="st">'loan_status'</span>].value_counts())</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the classification report</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>target_names <span class="op">=</span> [<span class="st">'Non-Default'</span>, <span class="st">'Default'</span>] <span class="co"># our labels</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test, preds_df[<span class="st">'loan_status'</span>], target_names<span class="op">=</span>target_names))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0    11175
1      609
Name: loan_status, dtype: int64
              precision    recall  f1-score   support

 Non-Default       0.81      0.98      0.89      9198
     Default       0.71      0.17      0.27      2586

    accuracy                           0.80     11784
   macro avg       0.76      0.57      0.58     11784
weighted avg       0.79      0.80      0.75     11784
</code></pre>
</div>
</div>
<p>Well isn’t this a surprise! It looks like almost all of our test set was predicted to be non-default. The recall for defaults is 0.17 meaning 17% of our true defaults were predicted correctly.</p>
</section>
<section id="selecting-report-metrics" class="level3">
<h3 class="anchored" data-anchor-id="selecting-report-metrics">2.8 Selecting report metrics</h3>
<p>The <code>classification_report()</code> has many different metrics within it, but you may not always want to print out the full report. Sometimes you just want specific values to compare models or use for other purposes.</p>
<p>There is a function within scikit-learn that pulls out the values for you. That function is <code>precision_recall_fscore_support()</code> and it takes in the same parameters as <code>classification_report</code>.</p>
<p>It is imported and used like this:</p>
<pre><code># Import function
from sklearn.metrics import precision_recall_fscore_support
# Select all non-averaged values from the report
precision_recall_fscore_support(y_true,predicted_values)</code></pre>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the classification report</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>target_names <span class="op">=</span> [<span class="st">'Non-Default'</span>, <span class="st">'Default'</span>]</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test, preds_df[<span class="st">'loan_status'</span>], target_names<span class="op">=</span>target_names))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              precision    recall  f1-score   support

 Non-Default       0.81      0.98      0.89      9198
     Default       0.71      0.17      0.27      2586

    accuracy                           0.80     11784
   macro avg       0.76      0.57      0.58     11784
weighted avg       0.79      0.80      0.75     11784
</code></pre>
</div>
</div>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print all the non-average values from the report</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(precision_recall_fscore_support(y_test,preds_df[<span class="st">'loan_status'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(array([0.80742729, 0.71264368]), array([0.98097412, 0.16782676]), array([0.8857802 , 0.27167449]), array([9198, 2586]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the first two numbers from the report</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(precision_recall_fscore_support(y_test,preds_df[<span class="st">'loan_status'</span>])[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[0.80742729 0.71264368]</code></pre>
</div>
</div>
<p>Now we know how to pull out specific values from the report to either store later for comparison, or use to check against portfolio performance. Remember the impact of recall for defaults? This way, we can store that value for later calculations.</p>
</section>
<section id="visually-scoring-credit-models" class="level3">
<h3 class="anchored" data-anchor-id="visually-scoring-credit-models">2.9 Visually scoring credit models</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/64d45c75-a3b7-442b-bd2b-ac64d5cb3005.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">ROC.JPG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/fce5d618-1f18-44ce-90b2-4b7044a70d91.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">ROC_chart.JPG</figcaption><p></p>
</figure>
</div>
<p>Now, we want to visualize the performance of the model. In ROC charts, the X and Y axes are two metrics we’ve already looked at: the <strong>false positive rate (fall-out)</strong>, and the <strong>true positive rate (sensitivity)</strong>.</p>
<p>We can create a ROC chart of it’s performance with the following code:</p>
<pre><code>fallout, sensitivity, thresholds = roc_curve(y_test, prob_default)
plt.plot(fallout, sensitivity)</code></pre>
<p>To calculate the AUC score, you use <code>roc_auc_score()</code></p>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create predictions and store them in a variable</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>preds<span class="op">=</span> clf_logistic.predict_proba(X_test)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the accuracy score the model</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(clf_logistic.score(X_test, y_test))</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the ROC curve of the probabilities of default</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>prob_default <span class="op">=</span> preds[:, <span class="dv">1</span>]</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>fallout, sensitivity, thresholds <span class="op">=</span> roc_curve(y_test, prob_default)</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>plt.plot(fallout, sensitivity, color <span class="op">=</span> <span class="st">'darkorange'</span>)</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'False Positive Rate (Fallout)'</span>)</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'True Positive Rate (Sensitivity)'</span>)</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the AUC and store it in a variable</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>auc <span class="op">=</span> roc_auc_score(y_test, prob_default)</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>auc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.8025288526816021</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Credit_Risk_Modelling_files/figure-html/cell-41-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>0.7643248801355148</code></pre>
</div>
</div>
<p>So the accuracy for this model is just over 80.3% and the AUC score is 76.4%. Notice that what the ROC chart above shows us is the tradeoff between all values of our false positive rate (fallout) and true positive rate (sensitivity).</p>
</section>
<section id="thresholds-and-confusion-matrices" class="level3">
<h3 class="anchored" data-anchor-id="thresholds-and-confusion-matrices">2.10 Thresholds and confusion matrices</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/82faa313-393e-4358-9983-1d4b05ae4862.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">thresholds.JPG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/6b2d7310-e334-4fdd-8110-2ffddd205175.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">confusion_matrix.JPG</figcaption><p></p>
</figure>
</div>
<p>The <code>recall</code> score for loan defaults is the number of correctly predicted defaults divided by the total number of defaults. Note that if we were to predict ALL of our loans to default, then our recall score would be 100%!<br>
The <code>recall</code> score for non-defaults is the number of correctly predicted non-defaults, divided by the total number of non-defaults.</p>
<p>The <code>precision</code> score for loan defaults is the number of correctly predicted defaults divided by the total number of predicted defaults.<br>
The <code>precision</code> score for non-loan defaults is the number of correctly predicted non-defaults, divided by the total number of predicted non-defaults.</p>
<p>We’ve looked at setting thresholds for defaults, but how does this impact overall performance? To do this, we can start by looking at the effects with confusion matrices. Set different values for the threshold on probability of default, and use a confusion matrix to see how the changing values affect the model’s performance.</p>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the threshold for defaults to 0.5</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>preds_df[<span class="st">'loan_status'</span>] <span class="op">=</span> preds_df[<span class="st">'prob_default'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="dv">1</span> <span class="cf">if</span> x <span class="op">&gt;</span> <span class="fl">0.5</span> <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the confusion matrix</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(confusion_matrix(y_test,preds_df[<span class="st">'loan_status'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[9023  175]
 [2152  434]]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(recall_score(y_test,preds_df[<span class="st">'loan_status'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.16782675947409126</code></pre>
</div>
</div>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the threshold for defaults to 0.4</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>preds_df[<span class="st">'loan_status'</span>] <span class="op">=</span> preds_df[<span class="st">'prob_default'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="dv">1</span> <span class="cf">if</span> x <span class="op">&gt;</span> <span class="fl">0.4</span> <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the confusion matrix</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>y_test,preds_df[<span class="st">'loan_status'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>(       loan_status
 31622            1
 24935            1
 15342            0
 3460             0
 16424            1
 ...            ...
 25231            0
 30380            0
 29849            0
 1780             0
 11446            0
 
 [11784 rows x 1 columns],
 0        1
 1        0
 2        0
 3        0
 4        0
         ..
 11779    0
 11780    0
 11781    1
 11782    0
 11783    0
 Name: loan_status, Length: 11784, dtype: int64)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(recall_score(y_test,preds_df[<span class="st">'loan_status'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.46403712296983757</code></pre>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/5c22b3ef-3384-4908-93a9-e23f30bb22ed.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">recall_precision_accuracy.JPG</figcaption><p></p>
</figure>
</div>
</section>
<section id="how-thresholds-affect-performance" class="level3">
<h3 class="anchored" data-anchor-id="how-thresholds-affect-performance">2.11 How thresholds affect performance</h3>
<p>Setting the threshold to <code>0.4</code> shows promising results for model evaluation. Now we can assess the financial impact using the default recall which is selected from the classification reporting using the function <code>precision_recall_fscore_support()</code>.</p>
<p>For this, we will estimate the amount of unexpected loss using the default recall to find what proportion of defaults you did not catch with the new threshold. This will be a dollar amount which tells you how much in losses you would have if all the unfound defaults were to default all at once.</p>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reassign the values of loan status based on the new threshold</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>preds_df[<span class="st">'loan_status'</span>] <span class="op">=</span> preds_df[<span class="st">'prob_default'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="dv">1</span> <span class="cf">if</span> x <span class="op">&gt;</span> <span class="fl">0.4</span> <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Store the number of loan defaults from the prediction data</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>num_defaults <span class="op">=</span> preds_df[<span class="st">'loan_status'</span>].value_counts()[<span class="dv">1</span>]</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Store the default recall from the classification report</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>default_recall <span class="op">=</span> precision_recall_fscore_support(y_test,preds_df[<span class="st">'loan_status'</span>])[<span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the estimated impact of the new default recall rate</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cr_loan_prep[<span class="st">'loan_amnt'</span>].mean() <span class="op">*</span> num_defaults <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> default_recall))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>9872265.223119883</code></pre>
</div>
</div>
<p>By our estimates, this loss would be around $9.8 million. That seems like a lot! Try rerunning this code with threshold values of 0.3 and 0.5. Do you see the estimated losses changing? How do we find a good threshold value based on these metrics alone?</p>
</section>
<section id="threshold-selection" class="level3">
<h3 class="anchored" data-anchor-id="threshold-selection">2.12 Threshold selection</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/2d809438-0708-4ea6-98a4-f7093dab4f76.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">thresholds_apply.JPG</figcaption><p></p>
</figure>
</div>
<p>We know there is a trade off between metrics like <code>default recall</code>, <code>non-default recall</code>, and model <code>accuracy</code>. One easy way to approximate a good starting threshold value is to look at a plot of all three using <code>matplotlib</code>. With this graph, you can see how each of these metrics look as you change the threshold values and find the point at which the performance of all three is good enough to use for the credit data.</p>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate values</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>thresh <span class="op">=</span>  [<span class="fl">0.2</span>, <span class="fl">0.225</span>, <span class="fl">0.25</span>, <span class="fl">0.275</span>, <span class="fl">0.3</span>, <span class="fl">0.325</span>, <span class="fl">0.35</span>, <span class="fl">0.375</span>, <span class="fl">0.4</span>, <span class="fl">0.425</span>, <span class="fl">0.45</span>, <span class="fl">0.475</span>, <span class="fl">0.5</span>, <span class="fl">0.525</span>, <span class="fl">0.55</span>, <span class="fl">0.575</span>, <span class="fl">0.6</span>, <span class="fl">0.625</span>, <span class="fl">0.65</span>]</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>def_recalls <span class="op">=</span> [<span class="fl">0.7981438515081206</span>, <span class="fl">0.7583139984532096</span>, <span class="fl">0.7157772621809745</span>, <span class="fl">0.6759474091260634</span>, <span class="fl">0.6349574632637278</span>, <span class="fl">0.594354215003867</span>, <span class="fl">0.5467904098994586</span>, <span class="fl">0.5054137664346481</span>,</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a> <span class="fl">0.46403712296983757</span>, <span class="fl">0.39984532095901004</span>, <span class="fl">0.32211910286156226</span>, <span class="fl">0.2354988399071926</span>, <span class="fl">0.16782675947409126</span>, <span class="fl">0.1148491879350348</span>, <span class="fl">0.07733952049497293</span>, <span class="fl">0.05529775715390565</span>,</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a> <span class="fl">0.03750966744006187</span>, <span class="fl">0.026295436968290797</span>, <span class="fl">0.017788089713843776</span>]</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>nondef_recalls <span class="op">=</span> [<span class="fl">0.5342465753424658</span>, <span class="fl">0.5973037616873234</span>, <span class="fl">0.6552511415525114</span>, <span class="fl">0.708306153511633</span>, <span class="fl">0.756468797564688</span>, <span class="fl">0.8052837573385518</span>, <span class="fl">0.8482278756251359</span>, <span class="fl">0.8864970645792564</span>,</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a> <span class="fl">0.9215046749293324</span>, <span class="fl">0.9492280930637095</span>, <span class="fl">0.9646662317895195</span>, <span class="fl">0.9733637747336378</span>, <span class="fl">0.9809741248097412</span>, <span class="fl">0.9857577734290063</span>, <span class="fl">0.9902152641878669</span>, <span class="fl">0.992280930637095</span>, <span class="fl">0.9948901935203305</span>,</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a> <span class="fl">0.9966297021091541</span>, <span class="fl">0.997499456403566</span>]</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>accs <span class="op">=</span> [<span class="fl">0.5921588594704684</span>, <span class="fl">0.6326374745417516</span>, <span class="fl">0.6685336048879837</span>, <span class="fl">0.7012050237610319</span>, <span class="fl">0.7298031228784793</span>, <span class="fl">0.7589952477936185</span>, <span class="fl">0.7820773930753564</span>, <span class="fl">0.8028682959945689</span>,</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a> <span class="fl">0.8211133740665308</span>, <span class="fl">0.8286659877800407</span>, <span class="fl">0.8236591989137814</span>, <span class="fl">0.811439239646979</span>, <span class="fl">0.8025288526816021</span>, <span class="fl">0.7946367956551256</span>, <span class="fl">0.7898845892735913</span>, <span class="fl">0.7866598778004074</span>,</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a> <span class="fl">0.7847929395790902</span>, <span class="fl">0.7836897488119484</span>, <span class="fl">0.7825016972165648</span>]</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>ticks <span class="op">=</span> [<span class="fl">0.2</span>, <span class="fl">0.25</span>, <span class="fl">0.3</span>, <span class="fl">0.35</span>, <span class="fl">0.4</span>, <span class="fl">0.45</span>, <span class="fl">0.5</span>, <span class="fl">0.55</span>, <span class="fl">0.6</span>, <span class="fl">0.65</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note, the above values were pre-loaded within the DataCamp workspace for this lesson, however I have recreated here for reproduceability.</p>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>plt.plot(thresh,def_recalls)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>plt.plot(thresh,nondef_recalls)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>plt.plot(thresh,accs)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Probability Threshold"</span>)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>plt.xticks(ticks)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Default Recall"</span>,<span class="st">"Non-default Recall"</span>,<span class="st">"Model Accuracy"</span>])</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Credit_Risk_Modelling_files/figure-html/cell-48-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Have a closer look at this plot. In fact, expand the window to get a really good look. Think about the threshold values from thresh and how they affect each of these three metrics. Approximately what starting threshold value would maximize these scores evenly?</p>
<p>This is the easiest pattern to see on this graph, because it’s the point where all three lines converge. This threshold would make a great starting point, but declaring all loans about <code>0.275</code> to be a default is probably not practical.</p>
</section>
</section>
<section id="gradient-boosted-trees-using-xgboost" class="level2">
<h2 class="anchored" data-anchor-id="gradient-boosted-trees-using-xgboost">3. Gradient Boosted Trees Using XGBoost</h2>
<p>Decision trees are another standard credit risk model. We will go beyond decision trees by using the trendy XGBoost package in Python to create gradient boosted trees. After developing sophisticated models, we will stress test their performance and discuss column selection in unbalanced data.</p>
<section id="trees-for-defaults" class="level3">
<h3 class="anchored" data-anchor-id="trees-for-defaults">3.1 Trees for defaults</h3>
<p>We will now train a <code>Gradient Boosted Tree</code> model on the credit data, and see a sample of some of the predictions. Do you remember when we first looked at the predictions of the <code>logistic Regression</code> model? They didn’t look good. Do you think this model will be different?</p>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train a model</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install xgboost</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xgboost <span class="im">as</span> xgb</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>clf_gbt <span class="op">=</span> xgb.XGBClassifier().fit(X_train, np.ravel(y_train))</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict with a model</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>gbt_preds <span class="op">=</span> clf_gbt.predict_proba(X_test)</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dataframes of first five predictions, and first five true labels</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>preds_df <span class="op">=</span> pd.DataFrame(gbt_preds[:,<span class="dv">1</span>][<span class="dv">0</span>:<span class="dv">5</span>], columns <span class="op">=</span> [<span class="st">'prob_default'</span>])</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>true_df <span class="op">=</span> y_test.head()</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Concatenate and print the two data frames for comparison</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.concat([true_df.reset_index(drop <span class="op">=</span> <span class="va">True</span>), preds_df], axis <span class="op">=</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Requirement already satisfied: xgboost in /home/stephen137/mambaforge/lib/python3.10/site-packages (1.7.3)
Requirement already satisfied: numpy in /home/stephen137/mambaforge/lib/python3.10/site-packages (from xgboost) (1.22.4)
Requirement already satisfied: scipy in /home/stephen137/mambaforge/lib/python3.10/site-packages (from xgboost) (1.9.1)
   loan_status  prob_default
0            1      0.990942
1            1      0.983987
2            0      0.000807
3            0      0.001239
4            1      0.084892</code></pre>
</div>
</div>
<p>The predictions don’t look the same as with the <code>LogisticRegression()</code>, do they? Notice that this model is already accurately predicting the probability of default for some loans with a true value of 1 in <code>loan_status</code>.</p>
</section>
<section id="gradient-boosted-portfolio-performance" class="level3">
<h3 class="anchored" data-anchor-id="gradient-boosted-portfolio-performance">3.2 Gradient boosted portfolio performance</h3>
<p>At this point we’ve looked at predicting probability of default using both a <code>LogisticRegression()</code> and <code>XGBClassifier()</code>. We’ve looked at some scoring and have seen samples of the predictions, but what is the overall affect on portfolio performance? Try using expected loss as a scenario to express the importance of testing different models.</p>
<p>A data frame called <code>portfolio</code> has been cretaed to combine the probabilities of default for both models, the loss given default (assume 20% for now), and the <code>loan_amnt</code> which will be assumed to be the exposure at default.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the first five rows of the portfolio data frame</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolio.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/f80b2180-cae2-4052-aadc-e6423e48d87d.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">portfolio_head.JPG</figcaption><p></p>
</figure>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create expected loss columns for each model using the formula</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>portfolio[<span class="st">'gbt_expected_loss'</span>] <span class="op">=</span> portfolio[<span class="st">'gbt_prob_default'</span>] <span class="op">*</span> portfolio[<span class="st">'lgd'</span>] <span class="op">*</span> portfolio[<span class="st">'loan_amnt'</span>]</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>portfolio[<span class="st">'lr_expected_loss'</span>] <span class="op">=</span> portfolio[<span class="st">'lr_prob_default'</span>] <span class="op">*</span> portfolio[<span class="st">'lgd'</span>] <span class="op">*</span> portfolio[<span class="st">'loan_amnt'</span>]</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the sum of the expected loss for lr</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'LR expected loss: '</span>, np.<span class="bu">sum</span>(portfolio[<span class="st">'lr_expected_loss'</span>]))</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the sum of the expected loss for gbt</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'GBT expected loss: '</span>, np.<span class="bu">sum</span>(portfolio[<span class="st">'gbt_expected_loss'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>LR expected loss: 5596776.979852879 GBT expected loss: 5383982.809227714</p>
<p>It looks like the total expected loss for the <code>XGBClassifier()</code> model is quite a bit lower. When we talk about accuracy and precision, the goal is to generate models which have a low expected loss. Looking at a <code>classification_report()</code> helps as well.</p>
</section>
<section id="assessing-gradient-boosted-trees" class="level3">
<h3 class="anchored" data-anchor-id="assessing-gradient-boosted-trees">3.3 Assessing gradient boosted trees</h3>
<p>So we’ve now used <code>XGBClassifier()</code> models to predict probability of default. These models can also use the <code>.predict()</code> method for creating predictions that give the actual class for <code>loan_status</code>.</p>
<p>We should check the model’s initial performance by looking at the metrics from the <code>classification_report()</code>. Keep in mind that we have not set thresholds for these models yet.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict the labels for loan status</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>gbt_preds<span class="op">=</span> clf_gbt.predict(X_test)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the values created by the predict method</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(gbt_preds)</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the classification report of the model</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>target_names <span class="op">=</span> [<span class="st">'Non-Default'</span>, <span class="st">'Default'</span>]</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test, gbt_preds, target_names<span class="op">=</span>target_names))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Have a look at the <code>precision</code> and <code>recall</code> scores! Remember the low default recall values we were getting from the <code>LogisticRegression()</code>? This model already appears to have serious potential.</p>
</section>
<section id="column-importance-and-default-prediction" class="level3">
<h3 class="anchored" data-anchor-id="column-importance-and-default-prediction">3.4 Column importance and default prediction</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/db771536-78b4-4e31-8c7f-f6d578673f3f.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">column_importance.JPG</figcaption><p></p>
</figure>
</div>
<p>When using multiple training sets with many different groups of columns, it’s important to keep an eye on which columns matter and which do not. It can be expensive or time-consuming to maintain a set of columns even though they might not have any impact on <code>loan_status</code>.</p>
<p>The <code>X</code> data for this exercise was created with the following code:</p>
<pre><code>X = cr_loan_prep[['person_income','loan_int_rate',
              'loan_percent_income','loan_amnt',
              'person_home_ownership_MORTGAGE','loan_grade_F']]
              </code></pre>
<p>Train an <code>XGBClassifier()</code> model on this data, and check the column importance to see how each one performs to predict <code>loan_status</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># redefine our feature columns</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> cr_loan_prep[[<span class="st">'person_income'</span>,<span class="st">'loan_int_rate'</span>,<span class="st">'loan_percent_income'</span>,<span class="st">'loan_amnt'</span>,<span class="st">'person_home_ownership_MORTGAGE'</span>,<span class="st">'loan_grade_F'</span>]]              </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># train, test, split</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">.4</span>, random_state<span class="op">=</span><span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and train the model on the training data</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>gbt <span class="op">=</span> xgb.XGBClassifier().fit(X_train,np.ravel(y_train))</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the column importances from the model</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(gbt.get_booster().get_score(importance_type <span class="op">=</span> <span class="st">'weight'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So, the importance for <code>loan_grade_F</code> is only 9 in this case. This could be because there are so few of the F-grade loans. While the F-grade loans don’t add much to predictions here, they might affect the importance of other training columns.</p>
</section>
<section id="visualizing-column-importance" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-column-importance">3.5 Visualizing column importance</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/876f2de5-61d6-4701-9408-90067bb33de3.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">column_importance_plot.JPG</figcaption><p></p>
</figure>
</div>
<p>When the model is trained on different sets of columns it changes the performance, but does the importance for the same column change depending on which group it’s in?</p>
<p>The data sets <code>X2</code> and <code>X3</code> have been created with the following code:</p>
<pre><code>X2 = cr_loan_prep[['loan_int_rate','person_emp_length']] \
X3 = cr_loan_prep[['person_income','loan_int_rate','loan_percent_income']]</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Redefine feature columns</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>X2 <span class="op">=</span> cr_loan_prep[[<span class="st">'loan_int_rate'</span>,<span class="st">'person_emp_length'</span>]] </span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>X3 <span class="op">=</span> cr_loan_prep[[<span class="st">'person_income'</span>,<span class="st">'loan_int_rate'</span>,<span class="st">'loan_percent_income'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># train, test, split</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>X2_train, X2_test, y_train, y_test <span class="op">=</span> train_test_split(X2, y, test_size<span class="op">=</span><span class="fl">.4</span>, random_state<span class="op">=</span><span class="dv">123</span>)</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>X3_train, X3_test, y_train, y_test <span class="op">=</span> train_test_split(X3, y, test_size<span class="op">=</span><span class="fl">.4</span>, random_state<span class="op">=</span><span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Understanding how different columns are used to arrive at a <code>loan_status</code> prediction is very important for model interpretability.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train a model on the X data with 2 columns</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>gbt2 <span class="op">=</span> xgb.XGBClassifier().fit(X2_train,np.ravel(y_train))</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the column importance for this model</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>xgb.plot_importance(gbt2, importance_type <span class="op">=</span> <span class="st">'weight'</span>)</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train a model on the X data with 3 columns</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>gbt3 <span class="op">=</span> xgb.XGBClassifier().fit(X3_train,np.ravel(y_train))</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the column importance for this model</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>xgb.plot_importance(gbt3, importance_type <span class="op">=</span> <span class="st">'weight'</span>)</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Take a closer look at the plots. Did you notice that the importance of <code>loan_int_rate</code> went from 1490 to 1013? Initially, this was the most important column, but <code>person_income</code> ended up taking the top spot here.</p>
</section>
<section id="column-selection-and-model-performance" class="level3">
<h3 class="anchored" data-anchor-id="column-selection-and-model-performance">3.6 Column selection and model performance</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/874cfea6-b780-45df-a77c-4edcf0399606.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">train_columns.JPG</figcaption><p></p>
</figure>
</div>
<p>Creating the training set from different combinations of columns affects the model and the importance values of the columns. Does a different selection of columns also affect the F-1 scores, the combination of the <code>precision</code> and <code>recall</code>, of the model? You can answer this question by training two different models on two different sets of columns, and checking the performance.</p>
<p>Inaccurately predicting defaults as non-default can result in unexpected losses if the probability of default for these loans was very low. You can use the F-1 score for defaults to see how the models will accurately predict the defaults.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict the loan_status using each model</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>gbt_preds <span class="op">=</span> gbt.predict(X_test)</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>gbt2_preds <span class="op">=</span> gbt2.predict(X2_test)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the classification report of the first model</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>target_names <span class="op">=</span> [<span class="st">'Non-Default'</span>, <span class="st">'Default'</span>]</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test,gbt_preds, target_names<span class="op">=</span>target_names))</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the classification report of the second model</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test, gbt2_preds, target_names<span class="op">=</span>target_names))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Originally, it looked like the selection of columns affected model <code>accuracy</code> the most, but now we see that the selection of columns also affects <code>recall</code> by quite a bit.</p>
</section>
<section id="cross-validating-credit-models" class="level3">
<h3 class="anchored" data-anchor-id="cross-validating-credit-models">3.7 Cross validating credit models</h3>
<p>We cannot create more loan data to help us to develop our model but we can use <code>cross-validation</code> to simulate how our model will perform on new laon data before it comes in.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/5f721045-b2a9-4b48-be0b-132cb3e4b12a.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">cross_validation.JPG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/457a85e6-cacb-4e22-92a7-ed6d18ec8f96.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">k_fold.JPG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/31461a29-791f-44e7-b880-e905a444ff9c.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">xgb_cross_valid_setup.JPG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/d79dd6e8-81d1-4581-9c82-65f3eaa19bd1.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">xgb_cross_valid_setup_2.JPG</figcaption><p></p>
</figure>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the values for number of folds and stopping iterations</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>n_folds <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>early_stopping <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="co"># define params dictionary</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> {<span class="st">'objective'</span>: <span class="st">'binary:logistic'</span>, <span class="st">'seed'</span>: <span class="dv">123</span>, <span class="st">'eval_metric'</span>: <span class="st">'auc'</span>}</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the DTrain matrix for XGBoost</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>DTrain <span class="op">=</span> xgb.DMatrix(X_train, label <span class="op">=</span> y_train)</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the data frame of cross validations</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>cv_df <span class="op">=</span> xgb.cv(params, DTrain, num_boost_round <span class="op">=</span> <span class="dv">5</span>, nfold<span class="op">=</span>n_folds,</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>            early_stopping_rounds<span class="op">=</span>early_stopping)</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the cross validations data frame</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cv_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Looks good! Note how the AUC for both <code>train-auc-mean</code> and <code>test-auc-mean</code> improves at each iteration of cross-validation. The improvements suggest that our model has stability, however if we increase iterations will our scores improve until they eventually reach 1.0 ?</p>
</section>
<section id="limits-to-cross-validation-testing" class="level3">
<h3 class="anchored" data-anchor-id="limits-to-cross-validation-testing">3.8 Limits to cross-validation testing</h3>
<p>We can specify very large numbers for both <code>nfold</code> and <code>num_boost_round</code> if we want to perform an extreme amount of cross-validation. The data frame <code>cv_results_big</code> was created with the following code:</p>
<pre><code>cv = xgb.cv(params, DTrain, num_boost_round = 600, nfold=10,
        shuffle = True)
        </code></pre>
<p>Here, <code>cv()</code> performed 600 iterations of cross-validation! The parameter shuffle tells the function to shuffle the records each time.</p>
<p>Have a look at this data to see what the AUC are, and check to see if they reach 1.0 using cross validation. We should also plot the test AUC score to see the progression.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>cv_results_big <span class="op">=</span> xgb.cv(params, DTrain, num_boost_round <span class="op">=</span> <span class="dv">600</span>, nfold<span class="op">=</span><span class="dv">10</span>, shuffle <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the first five rows of the CV results data frame</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>cv_results_big.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean of the test AUC scores</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>np.mean(cv_results_big.head()[<span class="st">'test-auc-mean'</span>]).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the test AUC scores for each iteration</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>plt.plot(cv_results_big[<span class="st">'test-auc-mean'</span>])</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Test AUC Score Over 600 Iterations'</span>)</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Iteration Number'</span>)</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Test AUC Score'</span>)</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that the test AUC score never quite reaches 1.0 and begins to decrease slightly after 100 iterations. This is because this much cross-validation can actually cause the model to overfit. So, there is a <code>limit</code> to how much cross-validation we should do.</p>
</section>
<section id="cross-validation-scoring" class="level3">
<h3 class="anchored" data-anchor-id="cross-validation-scoring">3.9 Cross-validation scoring</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/e5010ef6-4fbe-444f-956b-6e3fe64072da.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">cross_val_score.JPG</figcaption><p></p>
</figure>
</div>
<p>Now, we should use cross-validation scoring with <code>cross_val_score()</code> to check the overall performance.</p>
<p>This is exercise presents an excellent opportunity to test out the use of the hyperparameters <code>learning_rate</code> and <code>max_depth</code>. Remember, hyperparameters are like settings which can help create optimum performance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>cr_loan_prep</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> cr_loan_prep.drop(<span class="st">'loan_status'</span>, axis <span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="co"># train, test, split</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">.4</span>, random_state<span class="op">=</span><span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>X_train</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_val_score</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a gradient boosted tree model using two hyperparameters</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>gbt <span class="op">=</span> xgb.XGBClassifier(learning_rate <span class="op">=</span> <span class="fl">0.1</span>, max_depth <span class="op">=</span> <span class="dv">7</span>)</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the cross validation scores for 4 folds</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>cv_scores <span class="op">=</span> cross_val_score(gbt, X_train, np.ravel(y_train), cv<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the cross validation scores</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cv_scores)</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the average accuracy and standard deviation of the scores</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Average accuracy: </span><span class="sc">%0.2f</span><span class="st"> (+/- </span><span class="sc">%0.2f</span><span class="st">)"</span> <span class="op">%</span> (cv_scores.mean(),</span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>                                              cv_scores.std() <span class="op">*</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our average cv_score for this model is getting higher! With only a couple of hyperparameters and cross-validation, we can get the average accuracy up to 93%. This is a great way to validate how robust the model is.</p>
</section>
<section id="undersampling-training-data" class="level3">
<h3 class="anchored" data-anchor-id="undersampling-training-data">3.10 Undersampling training data</h3>
<p>We just used <code>cross validation</code> to check the robustness of our model but let’s look at how the data impacts the robustness of our model. In our training dataset there are far more <code>non-defaults</code> than defaults. This is referred to as <code>class imbalance</code> and is a problem.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/7e60e6f9-093f-494b-9609-04f9c5240926.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">imbalance_causes.JPG</figcaption><p></p>
</figure>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>y_train[<span class="st">'loan_status'</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have 13,798 non defaults (78%) and 3,877 defaults (22%).</p>
<p>Our tree models use a function called <code>log-loss</code> which our model tries to minimise. Take the example below, where we have one default and one non-default. Each of the predictions is equally far away from the true outcome, and so the log-losss value is the same - however, the financial implications of an incorrect <code>default</code> prediction are much more severe than an incorrect non-default prediction.</p>
<p>One strategy we can adopt to restore the balance of our training data is <code>undersampling</code> :</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/467d7494-6dcf-4f12-9172-42264379b8f6.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">undersampling.JPG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/f44b158b-ed4d-4f6b-ab94-148d1ef3de93.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">undersample_train_test_split_1.JPG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/2cc99b89-b60b-4428-82c8-682cf7960509.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">undersample_train_test_split_2.JPG</figcaption><p></p>
</figure>
</div>
<p>It’s time to undersample the training set with a few lines of code from pandas. Once the undersampling is complete, we can check the value counts for <code>loan_status</code> to verify the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Concat the training sets</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>X_y_train <span class="op">=</span> pd.concat([X_train.reset_index(drop <span class="op">=</span> <span class="va">True</span>),</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>                       y_train.reset_index(drop <span class="op">=</span> <span class="va">True</span>)], axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get counts of non default and defaults</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>count_nondefault, count_default <span class="op">=</span> X_y_train[<span class="st">'loan_status'</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data sets for defaults and non-defaults</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>nondefaults <span class="op">=</span> X_y_train[X_y_train[<span class="st">'loan_status'</span>] <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>defaults <span class="op">=</span>  X_y_train[ X_y_train[<span class="st">'loan_status'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Undersample the non-defaults</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>nondefaults_under <span class="op">=</span> nondefaults.sample(count_default)</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Concatenate the undersampled nondefaults with defaults</span></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>X_y_train_under <span class="op">=</span> pd.concat([nondefaults_under.reset_index(drop <span class="op">=</span> <span class="va">True</span>),</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>                             defaults.reset_index(drop <span class="op">=</span> <span class="va">True</span>)], axis <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the value counts for loan status</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(X_y_train_under[<span class="st">'loan_status'</span>].value_counts())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Great. We now have a training set with an equal number of defaults and non-defaults. Let’s test out some machine learning models on this new undersampled data set and compare their performance to the models trained on the regular data set.</p>
</section>
<section id="undersampled-tree-performance" class="level3">
<h3 class="anchored" data-anchor-id="undersampled-tree-performance">3.11 Undersampled tree performance</h3>
<p>We’ve undersampled the training set and trained a model on the undersampled set.</p>
<p>The performance of the model’s predictions not only impact the probability of default on the test set, but also on the scoring of new loan applications as they come in. We also now know that it is even more important that the <code>recall</code> of defaults be high, because a default predicted as non-default is more costly.</p>
<p>The next crucial step is to compare the new model’s performance to the original model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the classification reports</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>target_names <span class="op">=</span> [<span class="st">'Non-Default'</span>, <span class="st">'Default'</span>]</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="co"># print classification report for old model</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test, gbt_preds, target_names<span class="op">=</span>target_names))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>             precision    recall  f1-score   support

 Non-Default       0.93      0.99      0.96      9198
     Default       0.95      0.73      0.83      2586

    accuracy                           0.93     11784
   macro avg       0.94      0.86      0.89     11784
weighted avg       0.93      0.93      0.93     11784 </code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print classification report for new model</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test, gbt2_preds, target_names<span class="op">=</span>target_names))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>             precision    recall  f1-score   support

 Non-Default       0.95      0.91      0.93      9198
     Default       0.72      0.84      0.77      2586

    accuracy                           0.89     11784
   macro avg       0.83      0.87      0.85     11784
weighted avg       0.90      0.89      0.89     11784</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the confusion matrix for old model</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(confusion_matrix(y_test,gbt_preds))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>[[9105 93] [ 691 1895]]</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the confusion matrix for new model</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(confusion_matrix(y_test,gbt2_preds))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>[[8338 860] [ 426 2160]]</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print and compare the AUC scores of the old model</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(roc_auc_score(y_test, gbt_preds))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>0.8613405315086655</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print and compare the AUC scores of the new model</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(roc_auc_score(y_test,gbt2_preds))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>0.870884117348218</p>
<p>Looks like this is classified as a success! Undersampling the training data results in more false positives, but the recall for defaults and the AUC score are both higher than the original model. This means overall it predicts defaults much more accurately.</p>
</section>
<section id="undersampling-intuition" class="level3">
<h3 class="anchored" data-anchor-id="undersampling-intuition">3.12 Undersampling intuition</h3>
<p>Now we’ve seen the effects of undersampling the training set to improve default prediction. We undersampled the training data set X_train, and it had a positive impact on the new model’s AUC score and recall for defaults. The training data had class imbalance which is normal for most credit loan data.</p>
<p>We did not undersample the test data X_test. Why not undersample the test set as well?</p>
<p>The test set represents the type of data that will be seen by the model in the real world, so changing it would test the model on unrealistic data.</p>
</section>
</section>
<section id="model-evaluation-and-implementation" class="level2">
<h2 class="anchored" data-anchor-id="model-evaluation-and-implementation">4. Model evaluation and implementation</h2>
<p>After developing and testing two powerful machine learning models, we use key performance <code>metrics</code> to compare them. Using advanced model selection techniques specifically for financial modeling, we will select one model. With that model, we will:</p>
<ul>
<li>develop a business strategy</li>
<li>estimate portfolio value, and</li>
<li>minimize expected loss</li>
</ul>
<section id="comparing-model-reports" class="level3">
<h3 class="anchored" data-anchor-id="comparing-model-reports">4.1 Comparing model reports</h3>
<p>We’ve used <code>logistic regression</code> models and <code>gradient boosted trees</code>. It’s time to compare these two to see which model will be used to make the final predictions.</p>
<p>One of the easiest first steps for comparing different models’ ability to predict the probability of default is to look at their metrics from the <code>classification_report()</code>. With this, we can see many different scoring <code>metrics</code> side-by-side for each model. Because the data and models are normally unbalanced with few defaults, focus on the metrics for defaults for now.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the logistic regression classification report</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>target_names <span class="op">=</span> [<span class="st">'Non-Default'</span>, <span class="st">'Default'</span>]</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test, preds_df_lr[<span class="st">'loan_status'</span>], target_names<span class="op">=</span>target_names))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>               precision    recall  f1-score   support

 Non-Default       0.86      0.92      0.89      9198
     Default       0.62      0.46      0.53      2586

    accuracy                           0.82     11784
   macro avg       0.74      0.69      0.71     11784
weighted avg       0.81      0.82      0.81     11784</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the gradient boosted tree classification report</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test, preds_df_gbt[<span class="st">'loan_status'</span>], target_names<span class="op">=</span>target_names))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>              precision    recall  f1-score   support

 Non-Default       0.93      0.99      0.96      9198
     Default       0.94      0.73      0.82      2586

    accuracy                           0.93     11784
   macro avg       0.93      0.86      0.89     11784
weighted avg       0.93      0.93      0.93     11784</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the default F-1 scores for the logistic regression</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(precision_recall_fscore_support(y_test,preds_df_lr[<span class="st">'loan_status'</span>], average <span class="op">=</span> <span class="st">'macro'</span>)[<span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>0.7108943782814463</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the default F-1 scores for the gradient boosted tree</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(precision_recall_fscore_support(y_test,preds_df_gbt[<span class="st">'loan_status'</span>], average <span class="op">=</span> <span class="st">'macro'</span>)[<span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>0.8909014142736051</p>
<p>There is a noticeable difference between these two models. The scores from the <code>classification_report()</code> are all higher for the gradient boosted tree. This means the tree model is better in all of these aspects. Let’s check the ROC curve.</p>
</section>
<section id="comparing-with-rocs-and-aucs" class="level3">
<h3 class="anchored" data-anchor-id="comparing-with-rocs-and-aucs">4.2 Comparing with ROCs and AUCs</h3>
<p>We should use ROC charts and AUC scores to compare the two models. Sometimes, visuals can really help you and potential business users understand the differences between the various models under consideration.</p>
<p>With the graph in mind, we will be more equipped to make a decision. The lift is how far the curve is from the random prediction. The AUC is the area between the curve and the random prediction. The model with more lift, and a higher AUC, is the one that’s better at making predictions accurately.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ROC chart components</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>fallout_lr, sensitivity_lr, thresholds_lr <span class="op">=</span> roc_curve(y_test, clf_logistic_preds)</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>fallout_gbt, sensitivity_gbt, thresholds_gbt <span class="op">=</span> roc_curve(y_test, clf_gbt_preds)</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ROC Chart with both</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>plt.plot(fallout_lr, sensitivity_lr, color <span class="op">=</span> <span class="st">'blue'</span>, label<span class="op">=</span><span class="st">'</span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> <span class="st">'Logistic Regression'</span>)</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>plt.plot(fallout_gbt, sensitivity_gbt, color <span class="op">=</span> <span class="st">'green'</span>, label<span class="op">=</span><span class="st">'</span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> <span class="st">'GBT'</span>)</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], linestyle<span class="op">=</span><span class="st">'--'</span>, label<span class="op">=</span><span class="st">'</span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> <span class="st">'Random Prediction'</span>)</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"ROC Chart for LR and GBT on the Probability of Default"</span>)</span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Fall-out'</span>)</span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Sensitivity'</span>)</span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="ROC_lr_gbt.svg" width="600" height="600"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the logistic regression AUC with formatting</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Logistic Regression AUC Score: </span><span class="sc">%0.2f</span><span class="st">"</span> <span class="op">%</span> roc_auc_score(y_test, clf_logistic_preds))</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the gradient boosted tree AUC with formatting</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Gradient Boosted Tree AUC Score: </span><span class="sc">%0.2f</span><span class="st">"</span> <span class="op">%</span> roc_auc_score(y_test, clf_gbt_preds))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Logistic Regression AUC Score: 0.76 Gradient Boosted Tree AUC Score: 0.94</p>
<p>Look at the ROC curve for the gradient boosted tree. Not only is the lift much higher, the calculated AUC score is also quite a bit higher. It’s beginning to look like the gradient boosted tree is best. Let’s check the calibration to be sure.</p>
</section>
<section id="calibration-curves" class="level3">
<h3 class="anchored" data-anchor-id="calibration-curves">4.3 Calibration curves</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/a84da456-3cf6-481f-83fc-c078323ad14f.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">calibration.JPG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/67ede203-7a31-4063-9059-eb0e9569dba8.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">calibration_calc.JPG</figcaption><p></p>
</figure>
</div>
<p>We now know that the gradient boosted tree <code>clf_gbt</code> has the best overall performance. You need to check the calibration of the two models to see how stable the default prediction performance is across probabilities. We can use a chart of each model’s calibration to check this by calling the <code>calibration_curve()</code> function.</p>
<p>Calibration curves can require many lines of code in python, so we will go through each step slowly to add the different components.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set calibration curve outputs</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>frac_of_pos_lr <span class="op">=</span> ([<span class="fl">0.07886231</span>, <span class="fl">0.06610942</span>, <span class="fl">0.10835913</span>, <span class="fl">0.13505074</span>, <span class="fl">0.16063348</span>, <span class="fl">0.18333333</span>, <span class="fl">0.21268657</span>, <span class="fl">0.24099099</span>, <span class="fl">0.48036649</span>, <span class="fl">0.72677596</span>,</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>       <span class="fl">0.73354232</span>, <span class="fl">0.70547945</span>, <span class="fl">0.68</span> , <span class="fl">0.73913043</span>, <span class="fl">0.55555556</span>, <span class="fl">0.4</span> ])</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>mean_pred_val_lr <span class="op">=</span> ([<span class="fl">0.02111464</span>, <span class="fl">0.07548788</span>, <span class="fl">0.12582662</span>, <span class="fl">0.17502903</span>, <span class="fl">0.22449499</span>, <span class="fl">0.27491676</span>, <span class="fl">0.32488847</span>, <span class="fl">0.37486698</span>, <span class="fl">0.42302912</span>, <span class="fl">0.47397249</span>,</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>       <span class="fl">0.52304288</span>, <span class="fl">0.57259508</span>, <span class="fl">0.62200793</span>, <span class="fl">0.67156702</span>, <span class="fl">0.71909209</span>, <span class="fl">0.77024859</span>])</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>frac_of_pos_gbt <span class="op">=</span> ([<span class="fl">0.01916168</span>, <span class="fl">0.06385752</span>, <span class="fl">0.12795793</span>, <span class="fl">0.17460317</span>, <span class="fl">0.21806854</span>, <span class="fl">0.32620321</span>, <span class="fl">0.32653061</span>, <span class="fl">0.33333333</span>, <span class="fl">0.40677966</span>, <span class="fl">0.43181818</span>,</span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>       <span class="fl">0.6</span>, <span class="fl">0.42105263</span>, <span class="fl">0.31578947</span>, <span class="fl">0.6875</span>, <span class="fl">0.78571429</span>, <span class="fl">0.83333333</span>, <span class="fl">0.90697674</span>, <span class="fl">0.95238095</span>, <span class="fl">0.98850575</span>, <span class="fl">1.</span>])</span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>mean_pred_val_gbt <span class="op">=</span> ([<span class="fl">0.01937249</span>, <span class="fl">0.07211534</span>, <span class="fl">0.12178284</span>, <span class="fl">0.17298488</span>, <span class="fl">0.22318428</span>, <span class="fl">0.2716055</span>, <span class="fl">0.32285183</span>, <span class="fl">0.369344</span>, <span class="fl">0.42164062</span>, <span class="fl">0.47158214</span>,</span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>       <span class="fl">0.52230485</span>, <span class="fl">0.57041398</span>, <span class="fl">0.62149714</span>, <span class="fl">0.67234764</span>, <span class="fl">0.72826275</span>, <span class="fl">0.77567046</span>, <span class="fl">0.82827961</span>, <span class="fl">0.87636708</span>, <span class="fl">0.92830987</span>, <span class="fl">0.98579916</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/00451667-5c10-46e5-af24-a07a67f89559.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">calibration_plot.JPG</figcaption><p></p>
</figure>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the calibration curve plot with the guideline</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">'k:'</span>, label<span class="op">=</span> <span class="st">"Perfectly calibrated"</span>)    </span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Fraction of positives'</span>)</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Average Predicted Probability'</span>)</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Calibration Curve'</span>)</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the calibration curve for the logistic regression to the plot</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">'k:'</span>, label<span class="op">=</span><span class="st">'Perfectly calibrated'</span>)    </span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>plt.plot(mean_pred_val_lr, frac_of_pos_lr,</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>         <span class="st">'s-'</span>, label<span class="op">=</span><span class="st">'</span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> <span class="st">'Logistic Regression'</span>)</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Fraction of positives'</span>)</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Average Predicted Probability'</span>)</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Calibration Curve'</span>)</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the calibration curve for the gradient boosted tree</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">'k:'</span>, label<span class="op">=</span><span class="st">'Perfectly calibrated'</span>)    </span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>plt.plot(mean_pred_val_lr, frac_of_pos_lr,</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>         <span class="st">'s-'</span>, label<span class="op">=</span><span class="st">'</span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> <span class="st">'Logistic Regression'</span>)</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>plt.plot(mean_pred_val_gbt, frac_of_pos_gbt,</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">'s-'</span>, label<span class="op">=</span><span class="st">'</span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> <span class="st">'Gradient Boosted tree'</span>)</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Fraction of positives'</span>)</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Average Predicted Probability'</span>)</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Calibration Curve'</span>)</span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Take a good look at this. Notice that for the logistic regression, the calibration for probabilities starts off great but then gets more erratic as it the average probability approaches 0.4. Something similar happens to the gradient boosted tree around 0.5, but the model eventually stabilizes. We will be focusing only on the <code>gbt</code> model from now on.</p>
</section>
<section id="acceptance-rates" class="level3">
<h3 class="anchored" data-anchor-id="acceptance-rates">4.4 Acceptance rates</h3>
<p>Setting an acceptance rate and calculating the threshold for that rate can be used to set the percentage of new loans we want to accept.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/6ddc1852-ff33-4b52-8d3e-4e87d5c49e85.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">acceptance_rate.JPG</figcaption><p></p>
</figure>
</div>
<p>In the above example, the distribution of our loans is represented in terms of their probability of default. 85% of our loans are to the left of the dashed line, with and 15% are to the right of the dashed line. If our policy is to ensure that 15% of loans are rejected, then the dashed line represents the <code>acceptance threshold</code>. We can see by reading off the graph that we should therefore reject any new loan applications with predicted probability of default of around 78% or above.</p>
<p>In our example, the exact <code>acceptance threshold</code> can be calculated using <a href="https://numpy.org/doc/stable/reference/generated/numpy.quantile.html">Numpy quantile</a>.</p>
<pre><code>import numpy as np
threshold = np.quantile(prob_default, 0.85)</code></pre>
<p>We would then reassign our <code>loan_status</code> values as we did before arbitrarily, with the calculated threshold:</p>
<pre><code>preds_df['loan_status'] = preds_df['prob_default'].apply(lambda x: 1 if x &gt; 0.78 else 0)        </code></pre>
<p>Let’s see how this works in more detail by applying to our loan data. For this exercise, assume the test data is a fresh batch of new loans. We will need to use the quantile() function from numpy to calculate the threshold.</p>
<p>The threshold should be used to assign new loan_status values. Does the number of defaults and non-defaults in the data change?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the statistics of the probabilities of default</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(test_pred_df[<span class="st">'prob_default'</span>].describe())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/bdb631d0-35b6-40ec-bbce-1847f469be3e.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">default_stats.JPG</figcaption><p></p>
</figure>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the threshold for a 85% acceptance rate</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>threshold_85<span class="op">=</span> np.quantile(test_pred_df[<span class="st">'prob_default'</span>], <span class="fl">0.85</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>0.8039963573217376</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply acceptance rate threshold</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>test_pred_df[<span class="st">'pred_loan_status'</span>] <span class="op">=</span> test_pred_df[<span class="st">'prob_default'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="dv">1</span> <span class="cf">if</span> x <span class="op">&gt;</span> threshold_85 <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the counts of loan status after the threshold</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(test_pred_df[<span class="st">'pred_loan_status'</span>].value_counts())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/2ddd5dbd-1bc4-4a39-ae94-c4b8c739f6e2.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">loan_status_counts.JPG</figcaption><p></p>
</figure>
</div>
<p>In the results of <code>.describe()</code> we can see how it’s not until 75% that we start to see double-digit numbers. That’s because the majority of our test set is non-default loans. Next let’s look at how the acceptance rate and threshold split up the data.</p>
</section>
<section id="visualizing-quantiles-of-acceptance" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-quantiles-of-acceptance">4.5 Visualizing quantiles of acceptance</h3>
<p>We know how <code>quantile()</code> works to compute a threshold, and we’ve seen an example of what it does to split the loans into accepted and rejected. What does this threshold look like for the test set, and how can you visualize it? To check this, we can create a <code>histogram</code> of the probabilities and add a reference line for the threshold. With this, we can visually show where the threshold exists in the distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the predicted probabilities of default</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>plt.hist(clf_gbt_preds, color <span class="op">=</span> <span class="st">'blue'</span>, bins <span class="op">=</span> <span class="dv">40</span>)</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the threshold with quantile</span></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>threshold <span class="op">=</span> np.quantile(clf_gbt_preds, <span class="fl">0.85</span>)</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a reference line to the plot for the threshold</span></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>plt.axvline(x <span class="op">=</span> threshold, color <span class="op">=</span> <span class="st">'red'</span>)</span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="acceptance_threshold.svg" width="600" height="600"></p>
<p>Here, we can clearly see where the threshold is on the range of predicted probabilities - 0.804 as calculated in section 4.4 - and indicated by the red line. Not only can we see how many loans will be accepted (left side), but also how many loans will be rejected (right side).</p>
</section>
<section id="bad-rates" class="level3">
<h3 class="anchored" data-anchor-id="bad-rates">4.6 Bad rates</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/a149d043-6d19-4093-a8cf-3a4c2fcf0433.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">bad_rate.JPG</figcaption><p></p>
</figure>
</div>
<p>With acceptance rate in mind, we can now analyze the <code>bad rate</code> within the accepted loans. This way we will be able to see the percentage of defaults that have been accepted. Think about the impact of the <code>acceptance rate</code> and <code>bad rate</code>. We set an acceptance rate to have fewer defaults in the portfolio because defaults are more costly. Will the bad rate be less than the percentage of defaults in the test data?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the top 5 rows of the new data frame</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(test_pred_df.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>    true_loan_status  prob_default  pred_loan_status
0                 1         0.982                 1
1                 1         0.975                 1
2                 0         0.003                 0
3                 0         0.005                 0
4                 1         0.120                 0</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a subset of only accepted loans</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>accepted_loans <span class="op">=</span> test_pred_df[test_pred_df[<span class="st">'pred_loan_status'</span>] <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the bad rate</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(np.<span class="bu">sum</span>(accepted_loans[<span class="st">'true_loan_status'</span>]) <span class="op">/</span> accepted_loans[<span class="st">'true_loan_status'</span>].count())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>0.08256789137380191</p>
<p>This bad rate doesn’t look half bad! The bad rate with the threshold set by the 85% <code>quantile()</code> is just over 8%. This means that of all the loans we’ve decided to accept from the test set, only 8% were actual defaults! If we accepted all loans, the percentage of defaults would be around 22%.</p>
</section>
<section id="acceptance-rate-impact" class="level3">
<h3 class="anchored" data-anchor-id="acceptance-rate-impact">4.7 Acceptance rate impact</h3>
<p>Now, look at the <code>loan_amnt</code> of each loan to understand the impact on the portfolio for the acceptance rates. We can use cross tables with calculated values, like the average loan amount, of the new set of loans <code>X_test</code>. For this, we will multiply the number of each with an average <code>loan_amnt</code> value.</p>
<p>When printing these values, try formatting them as currency so that the numbers look more realistic. After all, credit risk is all about money. This is accomplished with the following code:</p>
<pre><code>pd.options.display.float_format = '${:,.2f}'.format</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the statistics of the loan amount column</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(test_pred_df[<span class="st">'loan_amnt'</span>].describe())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/fdfdf456-c75b-44ef-a961-6e5ee55ccfe4.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">loan_amount_stats.JPG</figcaption><p></p>
</figure>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Store the average loan amount</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>avg_loan <span class="op">=</span> np.mean(test_pred_df[<span class="st">'loan_amnt'</span>])</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the formatting for currency, and print the cross tab</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>pd.options.display.float_format <span class="op">=</span> <span class="st">'${:,.2f}'</span>.<span class="bu">format</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a><span class="co"># print the cross table</span></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.crosstab(test_pred_df[<span class="st">'true_loan_status'</span>],</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>                 test_pred_df[<span class="st">'pred_loan_status_15'</span>]).<span class="bu">apply</span>(<span class="kw">lambda</span> x: x <span class="op">*</span> avg_loan, axis <span class="op">=</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/28b89639-e7ba-4487-8c0f-7ab9e8208439.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">pred_loan_status.JPG</figcaption><p></p>
</figure>
</div>
<p>With this, we can see that our bad rate of about 8% represents an estimated loan value of about 7.9 million dollars. This may seem like a lot at first, but compare it to the total value of non-default loans! With this, we are ready to start talking about our acceptance strategy going forward.</p>
</section>
<section id="making-the-strategy-table" class="level3">
<h3 class="anchored" data-anchor-id="making-the-strategy-table">4.8 Making the strategy table</h3>
<p>Before we implement a strategy, we should first create a strategy table containing all the possible acceptance rates we wish to look at along with their associated bad rates and threshold values. This way, we can begin to see each part of our strategy and how it affects our portfolio.</p>
<p>Automatically calculating all of these values only requires a for loop, but requires many lines of python code.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/eb96b0a7-aa66-437f-b8f9-32437a99c74a.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">strategy_table_setup.JPG</figcaption><p></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/f70c6468-7f3f-4758-ba49-38458985472f.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">strategy_table_calcs.JPG</figcaption><p></p>
</figure>
</div>
<div class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create empty lists for thresholds and bad rates - to be appended</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>thresholds <span class="op">=</span> []</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>bad_rates <span class="op">=</span> []</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># let's set the accept rates that we would like to compare calculations for</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>accept_rates <span class="op">=</span> [<span class="fl">1.0</span>, <span class="fl">0.95</span>, <span class="fl">0.9</span>, <span class="fl">0.85</span>, <span class="fl">0.8</span>, <span class="fl">0.75</span>, <span class="fl">0.7</span>, <span class="fl">0.65</span>, <span class="fl">0.6</span>, <span class="fl">0.55</span>, <span class="fl">0.5</span>, <span class="fl">0.45</span>, <span class="fl">0.4</span>, <span class="fl">0.35</span>, <span class="fl">0.3</span>, <span class="fl">0.25</span>, <span class="fl">0.2</span>, <span class="fl">0.15</span>, <span class="fl">0.1</span>, <span class="fl">0.05</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Populate the arrays for the strategy table with a for loop</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> rate <span class="kw">in</span> accept_rates:</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the threshold for the acceptance rate</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>    thresh <span class="op">=</span> np.quantile(preds_df_gbt[<span class="st">'prob_default'</span>], rate).<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the threshold value to the list of thresholds</span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>    thresholds.append(np.quantile(preds_df_gbt[<span class="st">'prob_default'</span>], rate).<span class="bu">round</span>(<span class="dv">3</span>))</span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reassign the loan_status value using the threshold</span></span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>    test_pred_df[<span class="st">'pred_loan_status'</span>] <span class="op">=</span> test_pred_df[<span class="st">'prob_default'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="dv">1</span> <span class="cf">if</span> x <span class="op">&gt;</span> thresh <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a set of accepted loans using this acceptance rate</span></span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a>    accepted_loans <span class="op">=</span> test_pred_df[test_pred_df[<span class="st">'pred_loan_status'</span>] <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate and append the bad rate using the acceptance rate</span></span>
<span id="cb132-17"><a href="#cb132-17" aria-hidden="true" tabindex="-1"></a>    bad_rates.append(np.<span class="bu">sum</span>((accepted_loans[<span class="st">'true_loan_status'</span>]) <span class="op">/</span> <span class="bu">len</span>(accepted_loans[<span class="st">'true_loan_status'</span>])).<span class="bu">round</span>(<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate the values for thresholds and bad rates</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>thresholds <span class="op">=</span> [<span class="fl">1.0</span>, <span class="fl">0.992</span>, <span class="fl">0.976</span>, <span class="fl">0.804</span>, <span class="fl">0.254</span>, <span class="fl">0.178</span>, <span class="fl">0.138</span>, <span class="fl">0.111</span>, <span class="fl">0.093</span>, <span class="fl">0.078</span>, <span class="fl">0.066</span>, <span class="fl">0.055</span>, <span class="fl">0.045</span>, <span class="fl">0.037</span>, <span class="fl">0.03</span>, <span class="fl">0.022</span>, <span class="fl">0.015</span>, <span class="fl">0.008</span>, <span class="fl">0.004</span>, <span class="fl">0.002</span>]</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>bad_rates <span class="op">=</span> [<span class="fl">0.219</span>, <span class="fl">0.179</span>, <span class="fl">0.132</span>, <span class="fl">0.083</span>, <span class="fl">0.061</span>, <span class="fl">0.052</span>, <span class="fl">0.043</span>, <span class="fl">0.036</span>, <span class="fl">0.03</span>, <span class="fl">0.027</span>, <span class="fl">0.023</span>, <span class="fl">0.02</span>, <span class="fl">0.017</span>, <span class="fl">0.014</span>, <span class="fl">0.01</span>, <span class="fl">0.008</span>, <span class="fl">0.005</span>, <span class="fl">0.001</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a data frame of the strategy table</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>strat_df <span class="op">=</span> pd.DataFrame(<span class="bu">zip</span>(accept_rates, thresholds, bad_rates),</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>                        columns <span class="op">=</span> [<span class="st">'Acceptance Rate'</span>,<span class="st">'Threshold'</span>,<span class="st">'Bad Rate'</span>])</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the entire table</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>strat_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Acceptance Rate</th>
      <th>Threshold</th>
      <th>Bad Rate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.00</td>
      <td>1.000</td>
      <td>0.219</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.95</td>
      <td>0.992</td>
      <td>0.179</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.90</td>
      <td>0.976</td>
      <td>0.132</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.85</td>
      <td>0.804</td>
      <td>0.083</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.80</td>
      <td>0.254</td>
      <td>0.061</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.75</td>
      <td>0.178</td>
      <td>0.052</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.70</td>
      <td>0.138</td>
      <td>0.043</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.65</td>
      <td>0.111</td>
      <td>0.036</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.60</td>
      <td>0.093</td>
      <td>0.030</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.55</td>
      <td>0.078</td>
      <td>0.027</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.50</td>
      <td>0.066</td>
      <td>0.023</td>
    </tr>
    <tr>
      <th>11</th>
      <td>0.45</td>
      <td>0.055</td>
      <td>0.020</td>
    </tr>
    <tr>
      <th>12</th>
      <td>0.40</td>
      <td>0.045</td>
      <td>0.017</td>
    </tr>
    <tr>
      <th>13</th>
      <td>0.35</td>
      <td>0.037</td>
      <td>0.014</td>
    </tr>
    <tr>
      <th>14</th>
      <td>0.30</td>
      <td>0.030</td>
      <td>0.010</td>
    </tr>
    <tr>
      <th>15</th>
      <td>0.25</td>
      <td>0.022</td>
      <td>0.008</td>
    </tr>
    <tr>
      <th>16</th>
      <td>0.20</td>
      <td>0.015</td>
      <td>0.005</td>
    </tr>
    <tr>
      <th>17</th>
      <td>0.15</td>
      <td>0.008</td>
      <td>0.001</td>
    </tr>
    <tr>
      <th>18</th>
      <td>0.10</td>
      <td>0.004</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>19</th>
      <td>0.05</td>
      <td>0.002</td>
      <td>0.000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>That for loop was a lot of code, but look at the strategy table we have now. This uses our specific predictions on the credit data, and can be used to see the acceptance rates, bad rates, and financial impact all at once. One of these values has the highest estimated value.</p>
</section>
<section id="visualizing-the-strategy" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-the-strategy">4.9 Visualizing the strategy</h3>
<p>Now we have the extended strategy table <code>strat_df</code>. The table is not so big that it’s difficult to analyze, but visuals can help us see the overview all at once.</p>
<p>We should check the distribution of each column with a box plot. If the distribution of <code>Acceptance Rate</code> looks the same as the <code>Bad Rate</code> column, that could be a problem. That means that the model’s calibration is likely much worse than we thought.</p>
<p>We can also visualize the strategy curve with a line plot. The <code>Acceptance Rate</code> would be the <code>independent</code> variable with the <code>Bad Rate</code> as the <code>dependent</code> variable.</p>
<div class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the distributions in the strategy table with a boxplot</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>strat_df.boxplot()</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Credit_Risk_Modelling_files/figure-html/cell-101-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The boxplots above show us the distribution for each column.</p>
<div class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the strategy curve</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>plt.plot(strat_df[<span class="st">'Acceptance Rate'</span>], strat_df[<span class="st">'Bad Rate'</span>]) </span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>plt.plot()</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Acceptance Rate'</span>)</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Bad Rate'</span>)</span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Acceptance and Bad Rates'</span>)</span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Credit_Risk_Modelling_files/figure-html/cell-102-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The bad rates are very low up until the acceptance rate 0.6 where they suddenly increase. This suggests that many of the accepted defaults may have a prob_default value between 0.6 and 0.8.</p>
</section>
<section id="estimated-value-profiling" class="level3">
<h3 class="anchored" data-anchor-id="estimated-value-profiling">4.10 Estimated value profiling</h3>
<p>The strategy table, <code>strat_df</code>, can be used to maximize the estimated portfolio value and minimize expected loss. Extending this table and creating some plots can be very helpful to this end.</p>
<p>The strat_df data frame is loaded and has been enhanced already with the following columns:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/799515b6-2467-421f-a536-a0f13e026eb8.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">strategy_table_prepop.JPG</figcaption><p></p>
</figure>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a line plot of estimated value</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>plt.plot(strat_df[<span class="st">'Acceptance Rate'</span>],strat_df[<span class="st">'Estimated Value'</span>])</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Estimated Value by Acceptance Rate'</span>)</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Acceptance Rate'</span>)</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Estimated Value'</span>)</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="estimated_value_plot.svg" width="600" height="600"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the row with the max estimated value</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(strat_df.loc[strat_df[<span class="st">'Estimated Value'</span>] <span class="op">==</span> np.<span class="bu">max</span>(strat_df[<span class="st">'Estimated Value'</span>])])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/db10abe3-2d9d-4bfc-9c70-78aeb85a1a45.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">max_est_value.JPG</figcaption><p></p>
</figure>
</div>
<p>Interesting! With our credit data and our estimated averag loan value, we clearly see that the acceptance rate 0.85 has the highest potential estimated value. Normally, the allowable bad rate is set, but we can use analyses like this to explore other options.</p>
</section>
<section id="total-expected-loss" class="level3">
<h3 class="anchored" data-anchor-id="total-expected-loss">4.11 Total expected loss</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/67a6780f-028b-45ed-9aea-526cd0ce3993.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">total_expected_loss.JPG</figcaption><p></p>
</figure>
</div>
<p>It’s time to estimate the total expected loss given all our decisions. The data frame <code>test_pred_df</code> has the probability of default for each loan and that loan’s value. Use these two values to calculate the expected loss for each loan. Then, we can sum those values and get the total expected loss.</p>
<p>For this exercise, we will assume that the exposure is the full value of the loan, and the loss given default is 100%. This means that a default on each the loan is a loss of the entire amount.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the first five rows of the data frame</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(test_pred_df.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Credit_Risk_Modelling_files/figure-html/a74628a3-6509-40aa-8a26-7a6197e090c4.JPG" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">test_pred_df.JPG</figcaption><p></p>
</figure>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the bank's expected loss and assign it to a new column</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>test_pred_df[<span class="st">'expected_loss'</span>] <span class="op">=</span> test_pred_df[<span class="st">'prob_default'</span>] <span class="op">*</span> test_pred_df[<span class="st">'loss_given_default'</span>] <span class="op">*</span> test_pred_df[<span class="st">'loan_amnt'</span>]</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the total expected loss to two decimal places</span></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>tot_exp_loss<span class="op">=</span> <span class="bu">round</span>(np.<span class="bu">sum</span>(test_pred_df[<span class="st">'expected_loss'</span>]),<span class="dv">2</span>)</span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the total expected loss</span></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Total expected loss: '</span>, <span class="st">'${:,.2f}'</span>.<span class="bu">format</span>(tot_exp_loss))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Total expected loss: $27,084,153.38</p>
<p>This is the total expected loss for the entire portfolio using the gradient boosted tree. 27 million US dollars may seem like a lot, but the total expected loss would have been over 28 million US dollars with the <code>logistic regression</code>. Some losses are unavoidable, but our work here might have saved the company a million dollars!</p>
</section>
</section>
<section id="key-takeaways" class="level2">
<h2 class="anchored" data-anchor-id="key-takeaways">Key takeaways</h2>
<p>Our first step was to prepare credit data for machine learning models:</p>
<ul>
<li>important to understand the data</li>
<li>improving the data allows for high performing simple models</li>
</ul>
<p>We then developed, scored and now understand <code>Logistic Regression</code> and <code>Gradient Boosted Trees</code>:</p>
<ul>
<li>these models are simple and explainable</li>
<li>their performance on probabilities is acceptable</li>
</ul>
<p>We then analyzed the performance of models by changing the data, and now understand the financial impact of results.</p>
<p>We implemented the model with an understanding of strategy. The models and framework covered:</p>
<ul>
<li>discrete-time hazard model (point in time): the probability of default is a point-in-time event</li>
<li>structural model framework: the model explains the default even based on other factors</li>
</ul>
<p>Many financial sectors prefer model interpretability:</p>
<ul>
<li><p>complex or black-box models are a risk because the business cannot explain their decisions fully. This is important, particularly when considering loan applications. The customer has a right to know on which basis their application was rejected</p></li>
<li><p>deep neural networks are often too complex</p></li>
</ul>
</section>
<section id="leaving-thoughts-and-acknowledgements" class="level2">
<h2 class="anchored" data-anchor-id="leaving-thoughts-and-acknowledgements">Leaving thoughts and acknowledgements</h2>
<p>Focus on the data:</p>
<ul>
<li>gather as much data as possible</li>
<li>use many different techniques to prepare and enhance data</li>
<li>learn about the business</li>
<li>increase value through data</li>
</ul>
<p>Model complexity can be a double-edged sword:</p>
<ul>
<li>really complex models may perform well, but are seen as a <code>black box</code></li>
<li>in many cases, business users will not accept a model they cannot understand</li>
<li>complex models can be very large and difficult to put into production</li>
</ul>
<p>Thanks to <a href="https://www.linkedin.com/in/mikecrabtree2/">Michael Crabtree</a> for creating this course on <strong>DataCamp</strong>. It explains how to interpret the <em>coefficients</em> and <em>intercepts</em> of a <code>Logistic Regression</code> model particularly well in my view.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>